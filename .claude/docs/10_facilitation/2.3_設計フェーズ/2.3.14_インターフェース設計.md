# 2.3.14 インターフェース設計

## 目的

**アプリケーション設計とインフラ設計の境界面（インターフェース）を明確化**し、
設計間の不整合を防止します。

---

## 🎯 なぜインターフェース設計が必要か

### よくある問題

| 問題 | 原因 | 影響 |
|------|------|------|
| ポート番号不一致 | Dockerfile:80、ALB:8000 | コンテナ起動失敗 |
| 環境変数未定義 | アプリが必要とする変数がインフラで未設定 | 実行時エラー |
| ヘルスチェック失敗 | エンドポイントパス不一致 | デプロイ失敗 |
| DB接続エラー | 接続文字列形式の不一致 | アプリ起動失敗 |

### 解決策

**App-Architect と Infra-Architect が同じインターフェース仕様書を参照**

```
docs/03_アプリケーション設計/01_基本設計/07_インターフェース仕様.md
  ↑ 参照                    ↑ 参照
App-Architect            Infra-Architect
```

---

## 📋 インターフェース仕様書テンプレート

### 出力先

```
docs/03_アプリケーション設計/01_基本設計/07_インターフェース仕様.md
```

**重要**: このファイルは App-Architect が作成し、Infra-Architect がレビュー・承認します。

---

### テンプレート

```markdown
# インターフェース仕様書

## 1. 概要

### 1.1 目的
アプリケーションとインフラストラクチャの境界面を定義し、
両設計の整合性を担保する。

### 1.2 対象読者
- App-Architect
- Infra-Architect
- Coder
- SRE

### 1.3 承認状況

| 役割 | 承認者 | 日付 | ステータス |
|------|-------|------|----------|
| App-Architect | - | - | 作成中 |
| Infra-Architect | - | - | 未レビュー |

---

## 2. ネットワークインターフェース

### 2.1 ポート定義

| サービス名 | コンテナポート | ホストポート | プロトコル | 用途 |
|-----------|--------------|------------|----------|------|
| api | 8000 | 8000 | HTTP | REST API |
| web | 3000 | 80 | HTTP | フロントエンド |
| db | 5432 | - | TCP | PostgreSQL（内部のみ） |

**重要**: コンテナポートとホストポートは必ず一致させる（マッピングの複雑さを避ける）

### 2.2 エンドポイント定義

| パス | メソッド | 用途 | 備考 |
|------|--------|------|------|
| /health | GET | ヘルスチェック | ALB/ECSから参照 |
| /ready | GET | レディネスチェック | Kubernetes向け（オプション） |
| /metrics | GET | メトリクス出力 | Prometheus向け（オプション） |

---

## 3. 環境変数インターフェース

### 3.1 必須環境変数

| 変数名 | 説明 | 例 | 設定元 |
|-------|------|-----|-------|
| DATABASE_URL | DB接続文字列 | postgresql://user:pass@host:5432/db | Secrets Manager |
| PORT | アプリ待受ポート | 8000 | タスク定義 |
| NODE_ENV | 実行環境 | production | タスク定義 |
| LOG_LEVEL | ログレベル | info | タスク定義 |

### 3.2 オプション環境変数

| 変数名 | 説明 | デフォルト値 | 設定元 |
|-------|------|------------|-------|
| CACHE_TTL | キャッシュ有効期間(秒) | 300 | タスク定義 |
| MAX_CONNECTIONS | 最大接続数 | 100 | タスク定義 |

### 3.3 シークレット管理

| シークレット名 | 格納先 | 参照方法 |
|--------------|-------|---------|
| database-credentials | AWS Secrets Manager | ECSタスク定義のsecrets |
| api-keys | AWS Secrets Manager | ECSタスク定義のsecrets |

**禁止事項**:
- ❌ ハードコーディング
- ❌ 環境変数での直接設定（シークレットの場合）
- ❌ ソースコードへのコミット

---

## 4. データベースインターフェース

### 4.1 接続情報

| 項目 | 値 | 備考 |
|------|-----|------|
| エンジン | PostgreSQL 15 | |
| ホスト | 環境変数 DATABASE_HOST | RDSエンドポイント |
| ポート | 5432 | 標準ポート |
| データベース名 | appdb | |
| 文字コード | UTF-8 | |
| タイムゾーン | UTC | |

### 4.2 接続文字列形式

```
postgresql://{user}:{password}@{host}:{port}/{database}?sslmode=require
```

**重要**: `sslmode=require` は本番環境で必須

### 4.3 接続プール設定

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| 最小接続数 | 2 | 10 |
| 最大接続数 | 10 | 100 |
| アイドルタイムアウト | 30秒 | 60秒 |

---

## 5. ヘルスチェックインターフェース

### 5.1 ヘルスチェックエンドポイント

```
GET /health
```

**レスポンス（正常時）**:
```json
{
  "status": "healthy",
  "timestamp": "2025-01-01T00:00:00Z",
  "checks": {
    "database": "ok",
    "cache": "ok"
  }
}
```

**レスポンス（異常時）**:
```json
{
  "status": "unhealthy",
  "timestamp": "2025-01-01T00:00:00Z",
  "checks": {
    "database": "error: connection timeout",
    "cache": "ok"
  }
}
```

### 5.2 ヘルスチェック設定

| 項目 | 値 | 備考 |
|------|-----|------|
| パス | /health | |
| 間隔 | 30秒 | ALB/ECS設定 |
| タイムアウト | 5秒 | |
| 正常閾値 | 2回 | 連続成功でHealthy |
| 異常閾値 | 3回 | 連続失敗でUnhealthy |
| 成功コード | 200 | |

---

## 6. ログインターフェース

### 6.1 ログ出力先

| 環境 | 出力先 | 形式 |
|------|-------|------|
| 開発 | stdout | 人間可読 |
| 本番 | stdout → CloudWatch Logs | JSON |

### 6.2 ログフォーマット（本番）

```json
{
  "timestamp": "2025-01-01T00:00:00.000Z",
  "level": "INFO",
  "message": "Request processed",
  "service": "api",
  "trace_id": "abc123",
  "request_id": "req-456"
}
```

### 6.3 ログレベル

| レベル | 用途 |
|-------|------|
| ERROR | エラー、例外 |
| WARN | 警告、非推奨 |
| INFO | 正常処理、リクエスト |
| DEBUG | デバッグ情報（本番では無効） |

---

## 7. 整合性チェックリスト

### App-Architect → Infra-Architect 引き継ぎ時

- [ ] ポート番号がDockerfile/タスク定義で一致しているか
- [ ] 環境変数一覧が過不足なく定義されているか
- [ ] シークレットの格納先・参照方法が明確か
- [ ] ヘルスチェックエンドポイントが定義されているか
- [ ] ログ出力形式が定義されているか

### Infra-Architect → SRE 引き継ぎ時

- [ ] インフラ設計がインターフェース仕様に準拠しているか
- [ ] ALB/ロードバランサーのポート設定が正しいか
- [ ] ECSタスク定義の環境変数が仕様通りか
- [ ] Secrets Manager の設定が完了しているか
- [ ] ヘルスチェック設定が仕様通りか

### Coder 実装開始前

- [ ] インターフェース仕様書を読んだか
- [ ] ポート番号を確認したか
- [ ] 環境変数一覧を確認したか
- [ ] ヘルスチェックエンドポイントを実装するか
```

---

## 🔄 インターフェース設計のワークフロー

### 1. 作成フロー

```
1. App-Architect がドラフト作成
   ↓
2. Infra-Architect がレビュー
   - 実現可能性確認
   - インフラ観点の追加・修正
   ↓
3. 両者で合意
   ↓
4. 承認状況を更新
   ↓
5. Coder/SRE が参照して実装
```

### 2. 変更フロー

```
1. 変更提案（どちらからでも可）
   ↓
2. 影響範囲の確認
   - アプリ側影響: App-Architect
   - インフラ側影響: Infra-Architect
   ↓
3. 両者で合意
   ↓
4. インターフェース仕様書を更新
   ↓
5. 関連する設計書・実装を更新
```

---

## ⚠️ よくある不整合パターンと対策

### パターン1: ポート番号の不一致

**症状**:
```
ECS Task failed health check
Connection refused on port 8000
```

**原因**:
- Dockerfile: `EXPOSE 80`
- タスク定義: `containerPort: 8000`
- ALB: `targetPort: 8000`

**対策**:
1. インターフェース仕様書でポート番号を一元管理
2. Dockerfileの`EXPOSE`は実際のアプリポートと一致させる
3. 環境変数`PORT`でアプリのポートを設定

### パターン2: 環境変数の未定義

**症状**:
```
Error: DATABASE_URL is not defined
```

**原因**:
- アプリが`DATABASE_URL`を期待
- インフラ側で`DB_CONNECTION_STRING`として定義

**対策**:
1. インターフェース仕様書で変数名を明確化
2. 変数名はアプリ側の命名規則に合わせる
3. インフラ側でアプリの期待する名前で設定

### パターン3: ヘルスチェックパスの不一致

**症状**:
```
ALB health check failing
Target group has no healthy targets
```

**原因**:
- アプリ: `/api/health`
- ALB設定: `/health`

**対策**:
1. インターフェース仕様書でパスを明確化
2. 標準パス `/health` を推奨
3. ALB設定時にインターフェース仕様書を参照

---

## 📝 関連ドキュメント

- `.claude/docs/10_facilitation/0.1_成果物構成設計.md` - 成果物構成の全体像
- `.claude/docs/10_facilitation/2.3_設計フェーズ/2.3.5_製造物_基本設計書構成.md` - 基本設計書構成
- `.claude/helpers/cross-review-guide.md` - クロスレビューガイド
- `.claude/helpers/implementation-checker.md` - 実装チェッカー

---

**作成日**: 2025-12-12
**対象フェーズ**: 設計
**重要度**: ⭐⭐⭐ 必須
**担当**: App-Architect（作成）、Infra-Architect（レビュー）
