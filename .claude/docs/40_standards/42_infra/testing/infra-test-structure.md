# インフラテスト標準

QAエンジニアがインフラテスト計画を作成・実施する際の標準を定義。

---

## 担当エージェント

| エージェント | 役割 |
|------------|------|
| **QA** | テスト計画作成、テスト実施、結果記録 |
| **Coder** | テストコードレビュー |
| **SRE** | テスト環境準備、CI/CD組み込み |

---

## ディレクトリ構造

プロジェクトの `docs/` 配下に以下の構造でテストドキュメントを配置:

```
docs/03_テスト/インフラテスト/
├── 00_テスト計画/
│   ├── テスト計画書.md              # 全体計画
│   └── テスト環境構成.md            # 環境説明
│
├── 01_静的検証/
│   ├── README.md
│   ├── テンプレート構文検証.md      # cfn-lint, terraform validate
│   └── ポリシー検証.md              # cfn-nag, Guard
│
├── 02_デプロイ確認/
│   ├── README.md
│   ├── シナリオ/
│   │   ├── 01-network.md
│   │   ├── 02-security.md
│   │   ├── 03-database.md
│   │   ├── 04-compute-base.md
│   │   ├── 05-compute-app.md
│   │   ├── 06-monitoring.md
│   │   └── ...
│   └── チェックリスト.md
│
├── 03_設定確認/
│   ├── README.md
│   ├── シナリオ/
│   │   ├── ネットワーク設定.md      # VPC, Subnet, SG
│   │   ├── IAM設定.md               # 最小権限
│   │   ├── データベース設定.md
│   │   ├── 暗号化設定.md            # KMS, S3
│   │   └── ログ設定.md              # CloudTrail
│   └── チェックリスト.md
│
├── 04_動作確認/
│   ├── README.md
│   ├── シナリオ/
│   │   ├── 通信疎通確認.md
│   │   ├── 監視アラーム確認.md
│   │   ├── ログ出力確認.md
│   │   └── バックアップ動作確認.md
│   └── チェックリスト.md
│
├── 05_セキュリティテスト/
│   ├── README.md
│   ├── シナリオ/
│   │   ├── 脆弱性スキャン.md
│   │   ├── IAM最小権限確認.md
│   │   ├── ネットワーク隔離確認.md
│   │   └── WAF動作確認.md
│   └── チェックリスト.md
│
├── 06_障害試験/
│   ├── README.md
│   ├── シナリオ/
│   │   ├── サーバー障害.md          # ECS停止
│   │   ├── データベース障害.md      # RDS Multi-AZ
│   │   ├── ネットワーク障害.md      # AZ障害
│   │   ├── リソース枯渇.md          # CPU/メモリ
│   │   └── バックアップ復旧.md      # リストア
│   └── チェックリスト.md
│
├── 07_性能試験/
│   ├── README.md
│   ├── シナリオ/
│   │   ├── 単体性能/
│   │   │   ├── API応答時間.md
│   │   │   └── DB応答時間.md
│   │   └── 負荷試験/
│   │       ├── ロードテスト.md
│   │       ├── ストレステスト.md
│   │       ├── スパイクテスト.md
│   │       └── 耐久テスト.md
│   ├── スクリプト/
│   │   └── k6/
│   └── チェックリスト.md
│
├── 08_スケーラビリティ/
│   ├── README.md
│   └── シナリオ/
│       ├── AutoScaling動作.md
│       └── キャパシティ確認.md
│
├── 09_コンプライアンス/
│   ├── README.md
│   └── シナリオ/
│       ├── CISベンチマーク.md
│       └── タグ付け規約.md
│
├── テスト結果/
│   └── YYYY-MM-DD/
│
└── 共通/
    ├── ロールバック手順.md
    └── テストデータ管理.md
```

---

## テスト観点

### 必須観点

| No | 観点 | 概要 | 実施環境 |
|----|------|------|---------|
| 01 | 静的検証 | IaCテンプレートの構文・ポリシー検証 | CI/CD |
| 02 | デプロイ確認 | 各リソースのデプロイ成功確認 | dev/stg/prd |
| 03 | 設定確認 | 設計通りの設定値確認 | dev/stg/prd |
| 04 | 動作確認 | 通信疎通、監視、ログ出力確認 | dev/stg |
| 05 | セキュリティテスト | 脆弱性、IAM、ネットワーク隔離確認 | dev/stg |
| 06 | 障害試験 | フェイルオーバー、復旧確認 | stg |
| 07 | 性能試験 | 応答時間、負荷耐性確認 | stg |

### 追加観点（推奨）

| No | 観点 | 概要 | 実施環境 |
|----|------|------|---------|
| 08 | スケーラビリティ | Auto Scaling動作確認 | stg |
| 09 | コンプライアンス | CISベンチマーク、タグ付け規約 | stg/prd |

---

## テストフェーズと実施順序

```
Phase 1: 開発環境 (dev)
├── 1. 静的検証（CI/CD）
├── 2. デプロイ確認
├── 3. 設定確認
├── 4. 動作確認
└── 5. セキュリティテスト

Phase 2: ステージング環境 (stg)
├── 6. 障害試験
├── 7. 性能試験
├── 8. スケーラビリティ
└── 9. コンプライアンス

Phase 3: 本番環境 (prd)
├── デプロイ前チェックリスト
├── スモークテスト
└── 定期障害試験（月1回）
```

---

## テスト計画のタイミング区分

| 区分 | タイミング | 実施者 | 内容 |
|-----|-----------|-------|------|
| **事前策定** | 設計フェーズ | QA | テスト計画全体を策定 |
| **CI/CD組み込み** | デプロイ時 | 自動 | 静的検証、デプロイ確認、設定確認 |
| **手動/定期実行** | デプロイ後 | QA | 動作確認、障害試験、性能試験 |

---

## ドキュメントテンプレート

### テストシナリオ（*.md）

```markdown
# [テスト名]

## 1. 目的

テストの目的を記述

## 2. 前提条件

- 必要なリソース
- 環境要件

## 3. テスト項目

| No | 項目 | 確認内容 | 期待結果 | 自動化 |
|----|------|---------|---------|--------|
| 1 | xxx | xxx | xxx | 可/不可 |

## 4. 実行手順

### 4.1 手順1

```bash
# コマンド例
aws ec2 describe-vpcs --query 'Vpcs[*].{ID:VpcId,CIDR:CidrBlock}'
```

**期待結果**: xxx

### 4.2 手順2

...

## 5. 判定基準

| 結果 | 条件 |
|------|------|
| Pass | 全項目が期待結果を満たす |
| Fail | 1つでも期待結果を満たさない |

## 6. 備考

- 注意事項
- 参考情報
```

---

## 品質基準

### 性能基準

| 項目 | 目標値 |
|------|--------|
| レスポンスタイム（95%ile） | < 500ms |
| エラー率 | < 0.1% |
| CPU使用率 | < 70% |
| メモリ使用率 | < 80% |

### 可用性基準

| 項目 | 目標値 |
|------|--------|
| フェイルオーバー時間 | < 60秒 |
| RTO（目標復旧時間） | < 1時間 |
| RPO（目標復旧時点） | < 5分 |

---

## 自動化ツール

| テスト種別 | 自動化率 | ツール |
|-----------|---------|--------|
| 静的検証 | 100% | cfn-lint, cfn-nag, terraform validate |
| ポリシー検証 | 100% | CloudFormation Guard, Conftest |
| デプロイ確認 | 100% | AWS CLI, boto3 |
| 設定確認 | 95% | InSpec, AWS Config Rules |
| 動作確認 | 90% | テストスクリプト |
| セキュリティ | 90% | Trivy, Snyk, AWS Inspector |
| 障害試験 | 95% | AWS FIS (Fault Injection Service) |
| 性能試験 | 100% | k6, Locust |

---

## PMハンドリングフロー

### インフラ開発プロセス全体

```
Phase 1: 設計
├── PM → Infra-Architect: 設計委譲
└── PM → レビュー委譲（SRE, Consultant）

Phase 2: IaC実装
├── PM → SRE: IaC実装委譲
├── PM → レビュー委譲（Infra-Architect）
└── CI: 静的検証（自動）← PR時

Phase 3: デプロイ + 単体テスト
├── PM → SRE: デプロイ委譲
└── CI/CD: デプロイ確認・設定確認（自動）
    ※ 結果は自動記録

Phase 4: テスト計画策定
├── PM → QA: テスト計画作成委譲
│   入力: docs/design/infra/, infra/cloudformation/
│   出力: docs/03_テスト/インフラテスト/
└── PM → レビュー委譲（Coder）

Phase 5: テスト実施
├── PM → QA: テスト実施委譲
└── 成果物: テスト結果記録
```

### PM委譲プロンプト例

#### テスト計画作成委譲

```
インフラテスト計画を作成してください。

**入力**:
- 設計書: docs/design/infra/
- IaCコード: infra/cloudformation/

**出力先**: docs/03_テスト/インフラテスト/

**参照標準**:
- `.claude/docs/40_standards/42_infra/testing/infra-test-structure.md`

標準に従ってテスト計画書とシナリオを作成してください。
```

#### テスト実施委譲

```
インフラテストを実施してください。

**テスト計画**: docs/03_テスト/インフラテスト/00_テスト計画/テスト計画書.md
**対象環境**: stg

テスト計画に従って以下を実施し、結果を記録してください：
- 動作確認
- 障害試験
- 性能試験

結果は `docs/03_テスト/インフラテスト/テスト結果/YYYY-MM-DD/` に記録してください。
```

---

## 参照ドキュメント

- [CloudFormation標準](../iac/cloudformation.md)
- [Terraform標準](../iac/terraform.md)
- [CI/CDセキュリティ標準](../cicd/cicd-security.md)
- [セキュリティ標準](../../49_common/security.md)
