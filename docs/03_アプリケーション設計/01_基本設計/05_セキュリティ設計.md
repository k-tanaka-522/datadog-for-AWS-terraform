# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

## ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1.1 |
| ä½œæˆæ—¥ | 2025-12-28 |
| ä½œæˆè€… | App-Architect |

---

## ğŸ¯ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆæ–¹é‡

### åŸºæœ¬æ–¹é‡
- **æœ€å°æ¨©é™ã®åŸå‰‡**: å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸
- **å¤šå±¤é˜²å¾¡**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã¨ã‚¤ãƒ³ãƒ•ãƒ©å±¤ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–
- **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†**: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç¦æ­¢ã€ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secrets Manageråˆ©ç”¨
- **ç›£æŸ»ãƒ­ã‚°**: ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ­ã‚°è¨˜éŒ²

### å‚ç…§ã—ãŸæŠ€è¡“æ¨™æº–
- `.claude/docs/40_standards/49_common/security.md` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºæº–

---

## ğŸ” èªè¨¼ãƒ»èªå¯è¨­è¨ˆ

### PoCç’°å¢ƒã®èªè¨¼
**æ–¹é‡**: PoCç’°å¢ƒã§ã¯èªè¨¼ã‚’å®Ÿè£…ã—ãªã„

| é …ç›® | PoCç’°å¢ƒ | æœ¬ç•ªç§»è¡Œæ™‚ã®æ¨å¥¨ |
|------|---------|-----------------|
| èªè¨¼æ–¹å¼ | ãªã— | API Key ã¾ãŸã¯ JWT |
| èªå¯æ–¹å¼ | ãªã— | RBACï¼ˆRole-Based Access Controlï¼‰ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | ãªã— | JWT ãƒˆãƒ¼ã‚¯ãƒ³ |

---

### æœ¬ç•ªç§»è¡Œæ™‚ã®èªè¨¼è¨­è¨ˆï¼ˆå‚è€ƒï¼‰

#### API Key èªè¨¼

```python
# å°†æ¥ã®å®Ÿè£…ä¾‹ï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ï¼‰
from fastapi import Header, HTTPException

async def verify_api_key(x_api_key: str = Header(...)):
    """
    API Key èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

    å‰ææ¡ä»¶: x-api-key ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¿…é ˆ
    å½±éŸ¿ç¯„å›²: ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    """
    valid_api_keys = await get_valid_api_keys()  # Secrets Manager ã‹ã‚‰å–å¾—
    if x_api_key not in valid_api_keys:
        raise HTTPException(status_code=401, detail="Invalid API Key")
```

---

## ğŸ›¡ï¸ ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢

### ãƒ†ãƒŠãƒ³ãƒˆæ¤œè¨¼

**æ–¹é‡**: ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ tenant_id ã‚’æ¤œè¨¼

#### æœ‰åŠ¹ãªãƒ†ãƒŠãƒ³ãƒˆãƒªã‚¹ãƒˆ

| ãƒ†ãƒŠãƒ³ãƒˆID | ç”¨é€” |
|-----------|------|
| tenant-a | åˆæœŸæ§‹ç¯‰ãƒ»åŸºæœ¬æ¤œè¨¼ |
| tenant-b | IaCè¿½åŠ ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼ |
| tenant-c | å†ç¾æ€§ç¢ºèª |

**è¨­å®šå ´æ‰€**: ç’°å¢ƒå¤‰æ•° `VALID_TENANTS`

```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®šä¾‹
VALID_TENANTS=tenant-a,tenant-b,tenant-c
```

---

#### ãƒ†ãƒŠãƒ³ãƒˆæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆtenant_service.pyï¼‰

```python
from fastapi import HTTPException
from config.settings import settings

class TenantService:
    """
    ãƒ†ãƒŠãƒ³ãƒˆæ¤œè¨¼ã‚µãƒ¼ãƒ“ã‚¹

    ç›®çš„: ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã‚’å®Ÿç¾ã—ã€ä¸æ­£ãªãƒ†ãƒŠãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²æ­¢
    å½±éŸ¿ç¯„å›²: ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    """

    @staticmethod
    def validate_tenant(tenant_id: str) -> bool:
        """
        ãƒ†ãƒŠãƒ³ãƒˆIDã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼

        å¼•æ•°:
            tenant_id (str): ãƒ†ãƒŠãƒ³ãƒˆID

        æˆ»ã‚Šå€¤:
            bool: æœ‰åŠ¹ãªå ´åˆ True

        ä¾‹å¤–:
            HTTPException: ç„¡åŠ¹ãªãƒ†ãƒŠãƒ³ãƒˆIDã®å ´åˆ
        """
        valid_tenants = settings.VALID_TENANTS.split(',')
        if tenant_id not in valid_tenants:
            raise HTTPException(
                status_code=400,
                detail={
                    "error": {
                        "code": "INVALID_TENANT",
                        "message": f"Tenant '{tenant_id}' is not valid",
                        "field": "tenant_id"
                    }
                }
            )
        return True
```

---

### Row-Level Securityï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ï¼‰

**æ–¹é‡**: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã« tenant_id ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨

#### ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢

```python
# items_repository.py ã§ã®å®Ÿè£…ä¾‹
class ItemsRepository:
    """
    Items ãƒªãƒã‚¸ãƒˆãƒª

    ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªã« tenant_id ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨
    """

    def find_by_tenant(self, tenant_id: str) -> List[Item]:
        """
        ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

        ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:
        - WHEREå¥ã«å¿…ãš tenant_id = ? ã‚’å«ã‚ã‚‹
        - ä»–ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ä¸å¯

        å¼•æ•°:
            tenant_id (str): ãƒ†ãƒŠãƒ³ãƒˆID

        æˆ»ã‚Šå€¤:
            List[Item]: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ
        """
        session = get_db_session()
        # â­é‡è¦: WHERE tenant_id = ? ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        return session.query(Item).filter(Item.tenant_id == tenant_id).all()

    def find_by_id(self, tenant_id: str, id: int) -> Item | None:
        """
        ID ã§ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ï¼‰

        ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:
        - id ã ã‘ã§ãªã tenant_id ã‚‚æ¤œè¨¼
        - ä»–ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ä¸å¯

        å¼•æ•°:
            tenant_id (str): ãƒ†ãƒŠãƒ³ãƒˆID
            id (int): ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ID

        æˆ»ã‚Šå€¤:
            Item | None: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆæœªå­˜åœ¨ã®å ´åˆ Noneï¼‰
        """
        session = get_db_session()
        # â­é‡è¦: WHERE id = ? AND tenant_id = ?
        return session.query(Item).filter(
            Item.id == id,
            Item.tenant_id == tenant_id
        ).first()
```

---

## ğŸ”’ ãƒ‡ãƒ¼ã‚¿ä¿è­·

### ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–

#### è»¢é€ä¸­ã®æš—å·åŒ–

| å¯¾è±¡ | æš—å·åŒ–æ–¹å¼ | è¨­å®šç®‡æ‰€ |
|------|----------|---------|
| **ALB â†’ ECS** | HTTPSï¼ˆTLS 1.2ä»¥ä¸Šï¼‰ | ALB ãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆï¼‰ |
| **ECS â†’ RDS** | TLS/SSLï¼ˆ`sslmode=require`ï¼‰ | RDSæ¥ç¶šæ–‡å­—åˆ—ï¼ˆ`database.py`ï¼‰ |
| **ECS â†’ Datadog** | HTTPS | Datadog Agent è¨­å®š |

**RDSæ¥ç¶šæ–‡å­—åˆ—ä¾‹ï¼ˆdatabase.py ã§ã®å®Ÿè£…ï¼‰**:
```python
# database.py ã§ã®å®Ÿè£…ä¾‹
from sqlalchemy import create_engine
from config.settings import settings

# â­é‡è¦: sslmode=require ã‚’å¿…ãšæŒ‡å®š
DATABASE_URL = settings.DATABASE_URL  # postgresql://user:password@rds-endpoint:5432/demo?sslmode=require

engine = create_engine(
    DATABASE_URL,
    connect_args={
        "sslmode": "require",  # SSL/TLS æ¥ç¶šã‚’å¼·åˆ¶
        "connect_timeout": 10,
    }
)
```

**ç’°å¢ƒå¤‰æ•°è¨­å®šä¾‹ï¼ˆ.envï¼‰**:
```bash
# SSL/TLS æ¥ç¶šå¿…é ˆ
DATABASE_URL=postgresql://user:password@rds-endpoint:5432/demo?sslmode=require
```

**é‡è¦**:
- `sslmode=require` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ECS â†’ RDS é–“ã®é€šä¿¡ã‚’ SSL/TLS ã§æš—å·åŒ–
- ã‚¤ãƒ³ãƒ•ãƒ©å´ã§ RDS ã® SSL/TLS è¨¼æ˜æ›¸ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã“ã¨ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆã§è©³ç´°åŒ–ï¼‰

---

#### ä¿ç®¡ä¸­ã®æš—å·åŒ–

| å¯¾è±¡ | æš—å·åŒ–æ–¹å¼ | è¨­å®šç®‡æ‰€ |
|------|----------|---------|
| **RDS ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸** | AWS KMSï¼ˆAES-256ï¼‰ | RDS ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®šï¼ˆã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆï¼‰ |
| **ECS ãƒ­ã‚°** | CloudWatch Logsï¼ˆæš—å·åŒ–ï¼‰ | ECS ã‚¿ã‚¹ã‚¯å®šç¾©ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆï¼‰ |

---

### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†

#### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã®ç¨®é¡

| ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | ç®¡ç†æ–¹æ³•ï¼ˆPoCï¼‰ | ç®¡ç†æ–¹æ³•ï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ï¼‰ |
|----------|----------------|---------------------|
| **RDS ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰** | ç’°å¢ƒå¤‰æ•° | AWS Secrets Manager |
| **Datadog API Key** | ç’°å¢ƒå¤‰æ•° | AWS Secrets Manager |
| **API Keyï¼ˆæœ¬ç•ªã®ã¿ï¼‰** | - | AWS Secrets Manager |

---

#### ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹ç®¡ç†ï¼ˆPoCç’°å¢ƒï¼‰

**ECS ã‚¿ã‚¹ã‚¯å®šç¾©ã§ã®ç’°å¢ƒå¤‰æ•°è¨­å®š**:
```json
{
  "containerDefinitions": [
    {
      "name": "demo-api",
      "environment": [
        {
          "name": "DATABASE_URL",
          "value": "postgresql://user:password@rds-endpoint:5432/demo?sslmode=require"
        },
        {
          "name": "DD_API_KEY",
          "value": "datadog_api_key_here"
        }
      ]
    }
  ]
}
```

**æ³¨æ„**: PoCç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹ãŒã€**æœ¬ç•ªç’°å¢ƒã§ã¯ Secrets Manager ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨**

---

#### Secrets Manager ã«ã‚ˆã‚‹ç®¡ç†ï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ï¼‰

```python
# å°†æ¥ã®å®Ÿè£…ä¾‹ï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ï¼‰
import boto3
import json

def get_db_credentials():
    """
    Secrets Manager ã‹ã‚‰ RDS èªè¨¼æƒ…å ±ã‚’å–å¾—

    æˆ»ã‚Šå€¤:
        dict: {'username': 'user', 'password': 'pass', 'host': 'rds-endpoint'}
    """
    client = boto3.client('secretsmanager', region_name='ap-northeast-1')
    response = client.get_secret_value(SecretId='demo-api/rds')
    return json.loads(response['SecretString'])

# ä½¿ç”¨ä¾‹
creds = get_db_credentials()
DATABASE_URL = f"postgresql://{creds['username']}:{creds['password']}@{creds['host']}/demo?sslmode=require"
```

---

### .gitignore è¨­å®š

**é‡è¦**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã‚’Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã“ã¨

```gitignore
# .gitignore
.env
*.pem
*.key
secrets.json
credentials.json
```

---

## ğŸš« SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª

**æ–¹é‡**: SQLAlchemy ORM ã‚’ä½¿ç”¨ã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã®ã¿è¨±å¯

#### âœ… Good Exampleï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªï¼‰

```python
# items_repository.py
def find_by_tenant(tenant_id: str) -> List[Item]:
    """
    SQLAlchemy ORM ã‚’ä½¿ç”¨ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª

    ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–æ¸ˆã¿
    """
    session = get_db_session()
    # â­ SQLAlchemy ãŒè‡ªå‹•çš„ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–
    return session.query(Item).filter(Item.tenant_id == tenant_id).all()
```

ç”Ÿæˆã•ã‚Œã‚‹SQL:
```sql
SELECT * FROM items WHERE tenant_id = :tenant_id_1
-- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: {'tenant_id_1': 'tenant-a'}
```

---

#### âŒ Bad Exampleï¼ˆç”ŸSQLã®ç›´æ¥å®Ÿè¡Œï¼‰

```python
# âŒ ç¦æ­¢: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å±é™ºæ€§
def find_by_tenant_bad(tenant_id: str):
    session = get_db_session()
    # âŒ æ–‡å­—åˆ—çµåˆã«ã‚ˆã‚‹ SQL å®Ÿè¡Œã¯ç¦æ­¢
    raw_sql = f"SELECT * FROM items WHERE tenant_id = '{tenant_id}'"
    return session.execute(raw_sql).fetchall()
```

**å±é™ºæ€§**:
```python
# æ”»æ’ƒä¾‹: tenant_id = "tenant-a' OR '1'='1"
# å®Ÿè¡Œã•ã‚Œã‚‹SQL: SELECT * FROM items WHERE tenant_id = 'tenant-a' OR '1'='1'
# â†’ ã™ã¹ã¦ã®ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã•ã‚Œã‚‹
```

---

## ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼æƒ…å ±ã®éœ²å‡ºé˜²æ­¢

**æ–¹é‡**: ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’å¤–éƒ¨ã«éœ²å‡ºã—ãªã„

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆerror_handler.pyï¼‰

```python
from fastapi import Request
from fastapi.responses import JSONResponse
from infrastructure.logger import get_logger
import traceback

logger = get_logger(__name__)

async def handle_exception(request: Request, exc: Exception):
    """
    ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

    ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:
    - ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã¯ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆå¤–éƒ¨ã«ã¯éå…¬é–‹ï¼‰
    - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯ç°¡æ½”ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¿”å´

    å¼•æ•°:
        request (Request): FastAPI Request
        exc (Exception): ä¾‹å¤–

    æˆ»ã‚Šå€¤:
        JSONResponse: ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    """
    # â­ ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã¯ãƒ­ã‚°ã®ã¿ï¼ˆå¤–éƒ¨ã«ã¯éå…¬é–‹ï¼‰
    logger.error(
        f"Unhandled exception: {str(exc)}",
        extra={
            "trace": traceback.format_exc(),
            "path": request.url.path,
            "method": request.method
        }
    )

    # â­ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯ç°¡æ½”ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿
    return JSONResponse(
        status_code=500,
        content={
            "error": {
                "code": "INTERNAL_SERVER_ERROR",
                "message": "An unexpected error occurred"
                # ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã¯å«ã‚ãªã„
            }
        }
    )
```

---

## ğŸ“ ãƒ­ã‚°ç®¡ç†

### æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›

**æ–¹é‡**: JSONå½¢å¼ã®æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å‡ºåŠ›

#### ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆlogger.pyï¼‰

```python
import logging
import json
from datetime import datetime

def get_logger(name: str) -> logging.Logger:
    """
    æ§‹é€ åŒ–ãƒ­ã‚°ã®ãƒ­ã‚¬ãƒ¼ã‚’å–å¾—

    ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: JSONå½¢å¼ï¼ˆDatadog ãƒ­ã‚°åé›†ã«æœ€é©ï¼‰
    """
    logger = logging.getLogger(name)
    logger.setLevel(logging.INFO)

    handler = logging.StreamHandler()
    handler.setFormatter(StructuredFormatter())
    logger.addHandler(handler)

    return logger

class StructuredFormatter(logging.Formatter):
    """
    JSONå½¢å¼ã®ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼
    """
    def format(self, record):
        log_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "message": record.getMessage(),
            "logger": record.name,
        }

        # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆtenant_id, trace_idç­‰ï¼‰
        if hasattr(record, 'tenant_id'):
            log_data['tenant_id'] = record.tenant_id
        if hasattr(record, 'trace_id'):
            log_data['trace_id'] = record.trace_id

        return json.dumps(log_data)
```

---

### ãƒ­ã‚°å‡ºåŠ›æ™‚ã®æ³¨æ„äº‹é …

#### âœ… Good Exampleï¼ˆã‚»ã‚­ãƒ¥ã‚¢ï¼‰

```python
logger.info(
    "User action",
    extra={"tenant_id": "tenant-a", "action": "get_items"}
)
# å‡ºåŠ›: {"timestamp": "...", "level": "INFO", "tenant_id": "tenant-a", "action": "get_items"}
```

---

#### âŒ Bad Exampleï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã®éœ²å‡ºï¼‰

```python
# âŒ ç¦æ­¢: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€API Key ã‚’ãƒ­ã‚°ã«å‡ºåŠ›
logger.info(f"Database connected with password: {password}")
logger.info(f"API Key: {api_key}")
```

---

## ğŸ” ç›£è¦–ãƒ»ç›£æŸ»

### ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°

**æ–¹é‡**: ã™ã¹ã¦ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ­ã‚°è¨˜éŒ²

| ãƒ­ã‚°é …ç›® | èª¬æ˜ |
|---------|------|
| timestamp | ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚åˆ» |
| method | HTTPãƒ¡ã‚½ãƒƒãƒ‰ |
| path | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹ |
| status_code | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ |
| tenant_id | ãƒ†ãƒŠãƒ³ãƒˆIDï¼ˆãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼‰ |
| user_agent | User-Agent ãƒ˜ãƒƒãƒ€ãƒ¼ |
| remote_addr | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ |
| duration_ms | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ï¼ˆãƒŸãƒªç§’ï¼‰ |

---

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°

| ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« | èª¬æ˜ |
|---------|----------|------|
| ç„¡åŠ¹ãªãƒ†ãƒŠãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹ | WARNING | tenant_id ãŒæœ‰åŠ¹ãƒªã‚¹ãƒˆã«ãªã„ |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå¤±æ•— | ERROR | RDSæ¥ç¶šã‚¨ãƒ©ãƒ¼ |
| 500ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ | ERROR | ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ |
| ã‚¿ã‚¹ã‚¯åœæ­¢ï¼ˆ/admin/shutdownï¼‰ | WARNING | ç®¡ç†è€…æ“ä½œ |

---

## ğŸ“‹ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤

- [x] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªï¼‰
- [x] ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ï¼ˆRow-Level Securityï¼‰
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹éå…¬é–‹ï¼‰
- [x] ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ï¼ˆç’°å¢ƒå¤‰æ•°ã€Secrets Managerï¼‰
- [x] ãƒ­ã‚°ç®¡ç†ï¼ˆæ§‹é€ åŒ–ãƒ­ã‚°ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆéå‡ºåŠ›ï¼‰
- [x] RDS SSL/TLSæ¥ç¶šï¼ˆ`sslmode=require`ï¼‰
- [ ] èªè¨¼ãƒ»èªå¯ï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ã«å®Ÿè£…ï¼‰
- [ ] XSSå¯¾ç­–ï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ã«å®Ÿè£…ï¼‰
- [ ] CSRFå¯¾ç­–ï¼ˆæœ¬ç•ªç§»è¡Œæ™‚ã«å®Ÿè£…ï¼‰

---

### ã‚¤ãƒ³ãƒ•ãƒ©å±¤ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆã§è©³ç´°åŒ–ï¼‰

- [ ] HTTPSå¼·åˆ¶ï¼ˆALB ãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼‰
- [ ] RDSæš—å·åŒ–æœ‰åŠ¹åŒ–
- [ ] SecurityGroup æœ€å°åŒ–
- [ ] IAMãƒ­ãƒ¼ãƒ«æœ€å°æ¨©é™
- [ ] VPCå†…ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆä½¿ç”¨

---

## ğŸš€ æœ¬ç•ªç§»è¡Œæ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

### è¿½åŠ ã™ã¹ãã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

| å¯¾ç­– | å„ªå…ˆåº¦ | èª¬æ˜ |
|------|--------|------|
| API Key èªè¨¼ | é«˜ | x-api-key ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚ˆã‚‹èªè¨¼ |
| JWT ãƒˆãƒ¼ã‚¯ãƒ³ | é«˜ | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | ä¸­ | DDoSå¯¾ç­–ï¼ˆAPI Gateway / ALBï¼‰ |
| WAFè¨­å®š | ä¸­ | SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSæ¤œçŸ¥ |
| GuardDutyæœ‰åŠ¹åŒ– | ä¸­ | è„…å¨æ¤œå‡º |
| CloudTrailæœ‰åŠ¹åŒ– | é«˜ | ç›£æŸ»ãƒ­ã‚° |
| Secrets Rotation | ä½ | å®šæœŸçš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ |

---

## ğŸ“ æ”¹è¨‚å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | åˆç‰ˆä½œæˆ | App-Architect |
| 2025-12-28 | 1.1 | RDSæ¥ç¶šæ™‚ã®SSL/TLSè¨­å®šï¼ˆ`sslmode=require`ï¼‰ã‚’æ˜è¨˜ | App-Architect |
