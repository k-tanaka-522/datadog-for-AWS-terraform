# ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

## ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1.1 |
| ä½œæˆæ—¥ | 2025-12-28 |
| ä½œæˆè€… | App-Architect |

---

## ğŸ§© ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

### å…¨ä½“ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆå›³

```mermaid
graph TB
    subgraph "demo-api"
        Main[main.py<br>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ]

        subgraph "api/"
            Controllers[controllers/<br>ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤]
            Routes[routes.py<br>ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®šç¾©]
        end

        subgraph "services/"
            Services[ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤]
        end

        subgraph "repositories/"
            Repositories[ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤]
        end

        subgraph "models/"
            Models[Item<br>SQLAlchemy Model]
        end

        subgraph "infrastructure/"
            Infrastructure[æ¨ªæ–­çš„é–¢å¿ƒäº‹]
        end

        subgraph "config/"
            Config[è¨­å®šç®¡ç†]
        end
    end

    Main --> Routes
    Routes --> Controllers
    Controllers --> Services
    Services --> Repositories
    Repositories --> Models

    Controllers -.ä¾å­˜.-> Infrastructure
    Services -.ä¾å­˜.-> Infrastructure
    Repositories -.ä¾å­˜.-> Infrastructure
    Main -.ä¾å­˜.-> Config

    style Main fill:#e1f5ff
    style Controllers fill:#e3f2fd
    style Services fill:#fff9c4
    style Repositories fill:#f3e5f5
    style Infrastructure fill:#fce4ec
```

---

## ğŸ“ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è©³ç´°

### 1. main.pyï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰

**è²¬å‹™**: FastAPI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã¨èµ·å‹•

| æ©Ÿèƒ½ | è©³ç´° |
|------|------|
| FastAPIã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åˆæœŸåŒ– |
| ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç™»éŒ² | Datadog APMã€CORSã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ |
| ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ² | routes.py ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®šç¾©ã‚’èª­ã¿è¾¼ã¿ |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ– | èµ·å‹•æ™‚ã«RDSæ¥ç¶šç¢ºèª |
| Uvicornã‚µãƒ¼ãƒãƒ¼èµ·å‹• | éåŒæœŸã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹• |

**ä¾å­˜é–¢ä¿‚**:
- `api/routes.py`
- `infrastructure/datadog_middleware.py`
- `infrastructure/error_handler.py`
- `config/settings.py`

---

### 2. api/routes.pyï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®šç¾©ï¼‰

**è²¬å‹™**: URLãƒ‘ã‚¹ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ | æ©Ÿèƒ½ |
|-------------|--------------|------|
| GET /{tenant_id}/health | health_controller.health_check | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ |
| POST /{tenant_id}/simulate/error | simulate_controller.simulate_error | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿãƒ†ã‚¹ãƒˆ |
| POST /{tenant_id}/simulate/latency | simulate_controller.simulate_latency | é…å»¶ç™ºç”Ÿãƒ†ã‚¹ãƒˆ |
| GET /{tenant_id}/items | items_controller.get_items | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ |
| POST /{tenant_id}/items | items_controller.create_item | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆ |
| GET /{tenant_id}/items/{id} | items_controller.get_item | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è©³ç´° |
| POST /admin/shutdown | admin_controller.shutdown | ECSã‚¿ã‚¹ã‚¯åœæ­¢ |

**ä¾å­˜é–¢ä¿‚**:
- `api/controllers/health_controller.py`
- `api/controllers/simulate_controller.py`
- `api/controllers/items_controller.py`
- `api/controllers/admin_controller.py`

---

### 3. api/controllers/ï¼ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼‰

#### 3.1 health_controller.py

**è²¬å‹™**: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‡¦ç†

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| health_check(tenant_id: str) | dict | ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚’è¿”ã™ |

**å‡¦ç†å†…å®¹**:
1. tenant_id ã®æ¤œè¨¼ï¼ˆtenant_serviceï¼‰
2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèªï¼ˆitems_repositoryï¼‰
3. ãƒ˜ãƒ«ã‚¹çŠ¶æ…‹ã®è¿”å´ï¼ˆJSONï¼‰

**Datadog ç›£è¦–**: FR-003-1ï¼ˆL3 ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç›£è¦–ï¼‰

---

#### 3.2 simulate_controller.py

**è²¬å‹™**: éšœå®³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| simulate_error(tenant_id: str, error_type: str) | dict | æ„å›³çš„ã«ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹ |
| simulate_latency(tenant_id: str, latency_ms: int) | dict | æ„å›³çš„ã«é…å»¶ã‚’ç™ºç”Ÿã•ã›ã‚‹ |

**å‡¦ç†å†…å®¹ï¼ˆsimulate_errorï¼‰**:
1. tenant_id ã®æ¤œè¨¼
2. error_type ã«å¿œã˜ã¦ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼ˆmonitoring_serviceï¼‰
3. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å‡ºåŠ›ï¼ˆloggerï¼‰
4. ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è¿”å´

**Datadog ç›£è¦–**: FR-003-2ï¼ˆL3 ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç›£è¦–ï¼‰

---

#### 3.3 items_controller.py

**è²¬å‹™**: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿CRUDå‡¦ç†

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| get_items(tenant_id: str) | List[dict] | ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã‚’è¿”ã™ |
| create_item(tenant_id: str, request: ItemCreateRequest) | dict | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ |
| get_item(tenant_id: str, id: int) | dict | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è©³ç´°ã‚’è¿”ã™ |

**å‡¦ç†å†…å®¹ï¼ˆget_itemsï¼‰**:
1. tenant_id ã®æ¤œè¨¼
2. items_service.get_items(tenant_id) ã‚’å‘¼ã³å‡ºã—
3. JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è¿”å´

**Datadog ç›£è¦–**: FR-001ï¼ˆL0 RDSç›£è¦–ï¼‰

---

#### 3.4 admin_controller.py

**è²¬å‹™**: ç®¡ç†æ©Ÿèƒ½å‡¦ç†

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| shutdown() | dict | ECSã‚¿ã‚¹ã‚¯ã‚’åœæ­¢ã•ã›ã‚‹ |

**å‡¦ç†å†…å®¹**:
1. os._exit(0) ã§ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†
2. ECS ãŒç•°å¸¸çµ‚äº†ã‚’æ¤œçŸ¥

**Datadog ç›£è¦–**: FR-002-2ï¼ˆL2 ECS Task åœæ­¢ç›£è¦–ï¼‰

---

### 4. services/ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ï¼‰

#### 4.1 tenant_service.py

**è²¬å‹™**: ãƒ†ãƒŠãƒ³ãƒˆæ¤œè¨¼ã€ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ãƒ­ã‚¸ãƒƒã‚¯

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| validate_tenant(tenant_id: str) | bool | ãƒ†ãƒŠãƒ³ãƒˆIDã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ |
| get_tenant_config(tenant_id: str) | dict | ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰è¨­å®šã‚’å–å¾— |

**å‡¦ç†å†…å®¹ï¼ˆvalidate_tenantï¼‰**:
1. tenant_id ãŒæœ‰åŠ¹ãªãƒ†ãƒŠãƒ³ãƒˆãƒªã‚¹ãƒˆï¼ˆtenant-a/b/cï¼‰ã«å«ã¾ã‚Œã‚‹ã‹ç¢ºèª
2. ç„¡åŠ¹ãªå ´åˆã¯ä¾‹å¤–ã‚’ç™ºç”Ÿ

---

#### 4.2 items_service.py

**è²¬å‹™**: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| get_items(tenant_id: str) | List[Item] | ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã‚’å–å¾— |
| create_item(tenant_id: str, name: str, description: str) | Item | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ |
| get_item(tenant_id: str, id: int) | Item | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è©³ç´°ã‚’å–å¾— |

**å‡¦ç†å†…å®¹ï¼ˆget_itemsï¼‰**:
1. items_repository.find_by_tenant(tenant_id) ã‚’å‘¼ã³å‡ºã—
2. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯é©ç”¨ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
3. Item ãƒªã‚¹ãƒˆã‚’è¿”å´

---

#### 4.3 monitoring_service.py

**è²¬å‹™**: ç›£è¦–ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆã‚¨ãƒ©ãƒ¼/ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| generate_error(error_type: str) | None | ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹ |
| generate_latency(latency_ms: int) | None | é…å»¶ã‚’ç™ºç”Ÿã•ã›ã‚‹ |

**å‡¦ç†å†…å®¹ï¼ˆgenerate_errorï¼‰**:
1. error_type ã«å¿œã˜ã¦ä¾‹å¤–ã‚’ç™ºç”Ÿ
   - "500": HTTP 500 Internal Server Error
   - "timeout": ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼
   - "db_error": ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
2. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºåŠ›ï¼ˆloggerï¼‰

---

### 5. repositories/ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼‰

#### 5.1 items_repository.py

**è²¬å‹™**: items ãƒ†ãƒ¼ãƒ–ãƒ«ã® CRUD æ“ä½œ

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| find_by_tenant(tenant_id: str) | List[Item] | ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã« items ã‚’å–å¾— |
| find_by_id(id: int) | Item \| None | ID ã§ item ã‚’å–å¾— |
| save(item: Item) | Item | item ã‚’ä¿å­˜ |
| delete(id: int) | None | item ã‚’å‰Šé™¤ |

**å‡¦ç†å†…å®¹ï¼ˆfind_by_tenantï¼‰**:
1. SQLAlchemy ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ï¼ˆdatabase.pyï¼‰
2. `SELECT * FROM items WHERE tenant_id = ?` å®Ÿè¡Œ
3. Item ãƒªã‚¹ãƒˆã‚’è¿”å´

**ä¾å­˜é–¢ä¿‚**:
- `models/item.py`
- `repositories/database.py`

---

#### 5.2 database.py

**è²¬å‹™**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€æ¥ç¶šè¨­å®š

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| get_db_session() | Session | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¿”ã™ |
| init_db() | None | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼‰ |

**å‡¦ç†å†…å®¹ï¼ˆget_db_sessionï¼‰**:
1. SQLAlchemy Engine ä½œæˆï¼ˆæ¥ç¶šãƒ—ãƒ¼ãƒ«ï¼‰
2. Session ä½œæˆ
3. ä¾å­˜æ€§æ³¨å…¥ï¼ˆFastAPI Dependsï¼‰ã§åˆ©ç”¨

**æ¥ç¶šæ–‡å­—åˆ—**:
- ç’°å¢ƒå¤‰æ•° `DATABASE_URL` ã‹ã‚‰å–å¾—
- æœ¬ç•ªç’°å¢ƒ: Secrets Manager ã‹ã‚‰å–å¾—ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã§è©³ç´°åŒ–ï¼‰

---

### 6. models/ï¼ˆSQLAlchemy Modelï¼‰

#### 6.1 item.py

**è²¬å‹™**: items ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®šç¾©

| ã‚«ãƒ©ãƒ  | å‹ | åˆ¶ç´„ | èª¬æ˜ |
|--------|-----|------|------|
| id | Integer | PK, AutoIncrement | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ID |
| tenant_id | String(50) | NOT NULL | ãƒ†ãƒŠãƒ³ãƒˆID |
| name | String(100) | NOT NULL | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿å |
| description | Text | NULL | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª¬æ˜ |
| created_at | DateTime | NOT NULL | ä½œæˆæ—¥æ™‚ |
| updated_at | DateTime | NOT NULL | æ›´æ–°æ—¥æ™‚ |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_tenant_id`: tenant_id ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆæ¤œç´¢é«˜é€ŸåŒ–ï¼‰

---

### 7. infrastructure/ï¼ˆæ¨ªæ–­çš„é–¢å¿ƒäº‹ï¼‰

#### 7.1 datadog_middleware.py

**è²¬å‹™**: Datadog APM çµ±åˆï¼ˆddtraceï¼‰

| æ©Ÿèƒ½ | è©³ç´° |
|------|------|
| ddtrace åˆæœŸåŒ– | FastAPI ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã« ddtrace ã‚’çµ±åˆ |
| ãƒˆãƒ¬ãƒ¼ã‚¹é€ä¿¡ | Datadog ã«ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’é€ä¿¡ |
| ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°è¨­å®š | **tenant_id ã‚’ã‚¿ã‚°ã¨ã—ã¦ä»˜ä¸**ï¼ˆé‡è¦ï¼‰ |

**è¨­å®š**:
- ç’°å¢ƒå¤‰æ•° `DD_SERVICE`ï¼ˆdemo-apiï¼‰
- ç’°å¢ƒå¤‰æ•° `DD_ENV`ï¼ˆpocï¼‰
- ç’°å¢ƒå¤‰æ•° `DD_VERSION`ï¼ˆã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰

**å®Ÿè£…è©³ç´°ï¼ˆtenant_id ã‚¿ã‚°è¨­å®šï¼‰**:

```python
# datadog_middleware.py ã§ã®å®Ÿè£…ä¾‹
from fastapi import Request
from ddtrace import tracer

async def datadog_middleware(request: Request, call_next):
    """
    Datadog APM ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

    å‡¦ç†å†…å®¹:
    1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰tenant_idã‚’æŠ½å‡º
    2. Datadog ãƒˆãƒ¬ãƒ¼ã‚¹ã«tenant_idã‚¿ã‚°ã‚’ä»˜ä¸
    3. ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ç›£è¦–ã‚’å®Ÿç¾

    å‰ææ¡ä»¶:
    - ddtrace ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
    - DD_SERVICE, DD_ENV ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šæ¸ˆã¿
    """
    # ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ tenant_id ã‚’å–å¾—
    tenant_id = request.path_params.get('tenant_id')

    # â­é‡è¦: Datadog ãƒˆãƒ¬ãƒ¼ã‚¹ã« tenant_id ã‚¿ã‚°ã‚’ä»˜ä¸
    if tenant_id:
        span = tracer.current_span()
        if span:
            span.set_tag('tenant_id', tenant_id)
            span.set_tag('http.url', request.url.path)
            span.set_tag('http.method', request.method)

    response = await call_next(request)
    return response
```

**ã‚¿ã‚°ä»˜ä¸ã®é‡è¦æ€§**:
- Datadog ã§ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯èƒ½
- `tenant:tenant-a` ã§ãƒ†ãƒŠãƒ³ãƒˆAã®ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º
- ã‚¤ãƒ³ãƒ•ãƒ©ç›£è¦–è¨­è¨ˆã¨ã®æ•´åˆæ€§ã‚’ç¢ºä¿ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ä»•æ§˜çµ±ä¸€ï¼‰

---

#### 7.2 error_handler.py

**è²¬å‹™**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| handle_exception(request, exc) | JSONResponse | ä¾‹å¤–ã‚’æ•æ‰ã—ã¦JSONå½¢å¼ã§ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ |

**å‡¦ç†å†…å®¹**:
1. ä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒ
2. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›ï¼ˆloggerï¼‰
3. HTTP 500 ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™

---

#### 7.3 logger.py

**è²¬å‹™**: æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›

| é–¢æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|------|--------|------|
| get_logger(name: str) | Logger | æ§‹é€ åŒ–ãƒ­ã‚°ã®ãƒ­ã‚¬ãƒ¼ã‚’è¿”ã™ |

**ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**:
- JSONå½¢å¼ï¼ˆDatadog ãƒ­ã‚°åé›†ã«æœ€é©ï¼‰
- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: timestamp, level, message, tenant_id, trace_id

---

### 8. config/ï¼ˆè¨­å®šç®¡ç†ï¼‰

#### 8.1 settings.py

**è²¬å‹™**: ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ã€è¨­å®šç®¡ç†

| è¨­å®šé …ç›® | ç’°å¢ƒå¤‰æ•° | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
|---------|---------|------------|
| DATABASE_URL | DATABASE_URL | postgresql://localhost/demo |
| DD_SERVICE | DD_SERVICE | demo-api |
| DD_ENV | DD_ENV | poc |
| VALID_TENANTS | VALID_TENANTS | tenant-a,tenant-b,tenant-c |

**å‡¦ç†å†…å®¹**:
- ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
- Pydantic Settings ã‚’ä½¿ç”¨ã—ã¦å‹å®‰å…¨ã«ç®¡ç†

---

## ğŸ“Š ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¾å­˜é–¢ä¿‚ãƒãƒˆãƒªã‚¯ã‚¹

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ä¾å­˜å…ˆ | ä¾å­˜å†…å®¹ |
|------------|--------|---------|
| main.py | routes.py, datadog_middleware, error_handler, settings | ã‚¢ãƒ—ãƒªåˆæœŸåŒ– |
| routes.py | controllers | ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®šç¾© |
| health_controller | tenant_service, items_repository | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ |
| simulate_controller | tenant_service, monitoring_service | ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| items_controller | tenant_service, items_service | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿CRUD |
| admin_controller | ãªã— | ã‚¿ã‚¹ã‚¯åœæ­¢ |
| tenant_service | settings | ãƒ†ãƒŠãƒ³ãƒˆæ¤œè¨¼ |
| items_service | items_repository | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ |
| monitoring_service | logger | ç›£è¦–ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ |
| items_repository | database, item | ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ |
| database | settings | DBæ¥ç¶šç®¡ç† |
| datadog_middleware | ddtrace | APMçµ±åˆ |
| error_handler | logger | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° |
| logger | settings | ãƒ­ã‚°è¨­å®š |

---

## ğŸ”„ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä¸€è¦§å–å¾—ï¼‰

```mermaid
sequenceDiagram
    participant Router as routes.py
    participant Controller as items_controller
    participant Service as items_service
    participant Repository as items_repository
    participant DB as database.py
    participant Model as Item

    Router->>Controller: GET /{tenant_id}/items
    Controller->>Service: get_items(tenant_id)
    Service->>Repository: find_by_tenant(tenant_id)
    Repository->>DB: get_db_session()
    DB-->>Repository: Session
    Repository->>Model: SELECT * FROM items WHERE tenant_id = ?
    Model-->>Repository: List[Item]
    Repository-->>Service: List[Item]
    Service-->>Controller: List[Item]
    Controller-->>Router: JSONResponse(List[dict])
```

---

## ğŸ“¦ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚µã‚¤ã‚ºè¦‹ç©ã‚‚ã‚Š

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | è¡Œæ•°ï¼ˆæ¨å®šï¼‰ | è¤‡é›‘åº¦ |
|----------|-------------|--------|
| main.py | 50è¡Œ | ä½ |
| routes.py | 30è¡Œ | ä½ |
| health_controller.py | 30è¡Œ | ä½ |
| simulate_controller.py | 60è¡Œ | ä¸­ |
| items_controller.py | 80è¡Œ | ä¸­ |
| admin_controller.py | 20è¡Œ | ä½ |
| tenant_service.py | 40è¡Œ | ä½ |
| items_service.py | 60è¡Œ | ä¸­ |
| monitoring_service.py | 50è¡Œ | ä¸­ |
| items_repository.py | 80è¡Œ | ä¸­ |
| database.py | 40è¡Œ | ä¸­ |
| item.py | 30è¡Œ | ä½ |
| datadog_middleware.py | 40è¡Œ | ä¸­ |
| error_handler.py | 30è¡Œ | ä½ |
| logger.py | 40è¡Œ | ä½ |
| settings.py | 30è¡Œ | ä½ |
| **åˆè¨ˆ** | **620è¡Œ** | - |

---

## ğŸ“ æ”¹è¨‚å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | åˆç‰ˆä½œæˆ | App-Architect |
| 2025-12-28 | 1.1 | datadog_middleware.py ã®å®Ÿè£…è©³ç´°ï¼ˆtenant_id ã‚¿ã‚°è¨­å®šï¼‰ã‚’è¿½è¨˜ | App-Architect |
