# 要件定義書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform |
| バージョン | 1.3 |
| 作成日 | 2025-12-28 |
| 更新日 | 2025-12-31 |
| ステータス | ドラフト |

---

## 2. プロジェクト概要

### 2.1 背景

オンプレミスからAWSへの移行を検討中。移行後の監視基盤としてDatadogを採用予定。
本プロジェクトは、マルチテナント環境におけるDatadog監視設計をTerraformでIaC化し、
その有効性を検証するPoC（Proof of Concept）である。

### 2.2 現状の課題

| 課題 | 詳細 |
|------|------|
| アラートストーム | プロセス障害時にエラーログが大量発生し、アラート地獄になる |
| 親子設計の欠如 | インフラ障害とアプリ障害が区別できず、原因特定に時間がかかる |
| 手動構築 | テナント追加時の監視設定が手作業で時間がかかる |

### 2.3 目的

1. **Composite Monitor による階層監視の実現**: L0/L1/L2/L3の4層親子関係でアラートストームを防止
2. **IaC によるテナント追加の効率化**: Terraform で新規テナントの監視を即座にデプロイ
3. **本番移行の判断材料**: PoC結果を基に本番環境への適用可否を判断

### 2.4 ビジネス価値（想定）

※本プロジェクトはPoCのため、以下は本番適用時の想定値

| 指標 | 現状（想定） | 目標 | 年間削減効果 |
|------|-------------|------|-------------|
| アラート対応時間 | 月20時間 | 月5時間 | 90万円/年 |
| 新規テナント追加時間 | 平均4時間 | 平均30分 | 17.5万円/年 |
| 監視設定ミスによる障害 | 年2件 | 0件 | 200万円/年 |
| **合計削減効果** | - | - | **307.5万円/年** |
| **ROI** | - | - | **15.4倍** |

---

## 3. スコープ

### 3.1 対象範囲（In Scope）

#### 監視対象リソース（影響範囲ベースの4層設計）

**設計思想**: OSI 7層モデルをベースに、影響範囲に基づく4層に分類

| レイヤー | リソース | 監視項目 | 影響範囲 | Composite役割 |
|---------|---------|----------|----------|--------------|
| **L0: ネットワーク層** | VPC | VPC Flow Logs（異常検知） | 全テナント（通信不可） | 親（最上位） |
| | ALB | Target Group Health, 5xx エラー | 全テナント（通信不可） | 親（最上位） |
| **L1: コンピュート層** | ECS Cluster | 実行タスク数 | 全テナント（処理不可） | L0の子、L2の親 |
| | ECS Service | Service状態、リソース使用率 | 全テナント（処理不可） | L0の子、L2の親 |
| | RDS | CPU、接続数、メモリ、ストレージ | 全テナント（DB接続不可） | L0の子、L2の親 |
| **L2: サービス層** | Health Check | /health E2Eヘルスチェック（Synthetics） | 全テナント（アプリ応答なし） | L1の子、L3の親 |
| **L3: テナント層** | Tenant Health | テナント別ヘルスエンドポイント（/{tenant}/health） | 特定テナントのみ | L2の子 |
| | APM | テナント別レイテンシ（p99）、エラー率 | 特定テナントのみ | L2の子 |
| | Error Logs | テナント別エラーログ数 | 特定テナントのみ | L2の子 |

#### Composite Monitor 親子関係（因果関係は検証により確定）

```
L0 (ネットワーク障害) → L1, L2, L3 抑制の可能性
 ↓ OK
L1 (コンピュート障害) → L2, L3 抑制の可能性
 ↓ OK
L2 (サービス障害) → L3 抑制の可能性
 ↓ OK
L3 (テナント固有) → アラート通知（抑制なし）
```

**注**: 親子関係は決め打ちせず、障害注入テストシナリオで因果関係を検証してから確定します。

#### テナント構成

| テナントID | 用途 |
|------------|------|
| tenant-a | 初期構築・基本検証 |
| tenant-b | IaC追加デプロイ検証 |
| tenant-c | 再現性確認 |

### 3.2 対象外（Out of Scope）

| 項目 | 理由 |
|------|------|
| CloudTrail（監査ログ） | 別途監査ログ基盤で対応 |
| ElastiCache | PoC環境では未使用 |
| Lambda | PoC環境では未使用 |
| S3 / CloudFront | PoC環境では未使用 |
| Route53 | PoC環境では未使用 |

---

## 4. 機能要件

### 4.1 Composite Monitor（階層監視）

#### FR-001: L0 ネットワーク層監視

| ID | 要件 | 影響範囲 |
|----|------|----------|
| FR-001-1 | VPC Flow Logs で異常パターン検知時にアラート発火 | 全テナント |
| FR-001-2 | ALB Target Group の Healthy Hosts が0になった場合にアラート発火 | 全テナント |
| FR-001-3 | ALB 5xx エラー率が閾値を超えた場合にアラート発火 | 全テナント |

#### FR-002: L1 コンピュート層監視

| ID | 要件 | 影響範囲 |
|----|------|----------|
| FR-002-1 | ECS Cluster の Running Tasks が0になった場合にアラート発火 | 全テナント |
| FR-002-2 | ECS Service が異常停止した場合にアラート発火 | 全テナント |
| FR-002-3 | RDS CPU使用率が95%を超えた場合にアラート発火 | 全テナント |
| FR-002-4 | RDS 接続数が上限の90%を超えた場合にアラート発火 | 全テナント |
| FR-002-5 | RDS FreeableMemory が総メモリの10%未満でアラート発火 | 全テナント |
| FR-002-6 | RDS FreeStorageSpace がストレージ総量の5%未満でアラート発火 | 全テナント |

#### FR-003: L2 サービス層監視

| ID | 要件 | 影響範囲 |
|----|------|----------|
| FR-003-1 | /health エンドポイントのE2Eヘルスチェック（Synthetics）が失敗した場合にアラート発火 | 全テナント |

#### FR-004: L3 テナント層監視

| ID | 要件 | 影響範囲 |
|----|------|----------|
| FR-004-1 | テナント別ヘルスエンドポイント（/{tenant_id}/health）が200以外を返した場合にアラート発火 | 特定テナント |
| FR-004-2 | テナント別エラーログが5分間で閾値を超えた場合にアラート発火 | 特定テナント |
| FR-004-3 | テナント別レイテンシ（p99）が閾値を超えた場合にアラート発火 | 特定テナント |
| FR-004-4 | テナント別APMエラー率が閾値を超えた場合にアラート発火 | 特定テナント |

#### FR-005: アラート抑制（Composite Monitor）

| ID | 要件 |
|----|------|
| FR-005-1 | L0 がアラート状態の場合、L1/L2/L3 のアラートを抑制する可能性（検証により確定） |
| FR-005-2 | L1 がアラート状態の場合、L2/L3 のアラートを抑制する可能性（検証により確定） |
| FR-005-3 | L2 がアラート状態の場合、L3 のアラートを抑制する可能性（検証により確定） |
| FR-005-4 | 抑制中も監視データは収集継続（復旧後の分析用） |

**注**: FR-005-1〜FR-005-3の因果関係は、障害注入テストシナリオで検証してから確定します。

### 4.2 IaC（Infrastructure as Code）

#### FR-006: Terraform モジュール

| ID | 要件 |
|----|------|
| FR-006-1 | L0/L1/L2/L3 監視を Terraform モジュールとして実装 |
| FR-006-2 | 新規テナント追加は変数追加のみで完了 |
| FR-006-3 | terraform plan で差分確認後、apply でデプロイ |

#### FR-007: テナント管理

| ID | 要件 |
|----|------|
| FR-007-1 | テナント固有の閾値をパラメータ化 |
| FR-007-2 | テナント追加・削除が既存テナントに影響しない |

---

## 5. 非機能要件

### 5.1 可用性

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-001 | 監視基盤（Datadog）のSLA | Datadog SLA に準拠（99.9%） |
| NFR-002 | アラート発報遅延 | 検知から5分以内 |

### 5.2 スケーラビリティ

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-003 | 対応テナント数 | 10〜100テナント |
| NFR-004 | テナント追加所要時間 | terraform apply 完了まで5分以内 |

### 5.3 運用性

| ID | 要件 |
|----|------|
| NFR-005 | Terraform state は安全に管理（S3 + DynamoDB Lock 推奨） |
| NFR-006 | 監視設定の変更履歴はGitで管理 |
| NFR-007 | dry-run（plan）を必ず実行してから apply |

### 5.4 セキュリティ

| ID | 要件 |
|----|------|
| NFR-008 | Datadog API Key は環境変数または Secrets Manager で管理 |
| NFR-009 | Terraform 実行環境は最小権限の IAM ロールを使用 |

---

## 6. 制約条件

| 項目 | 制約 |
|------|------|
| 開発環境 | Windows（c:\dev2\datadog-fro-AWS-terraform） |
| IaC ツール | Terraform |
| 監視ツール | Datadog |
| クラウド | AWS |
| スケジュール | 年末年始期間でPoC完了 |

---

## 7. 成功基準

| 基準 | 判定条件 |
|------|----------|
| アラートストーム防止 | L0/L1/L2障害時に下位層のアラートが抑制されること（因果関係は検証により確定） |
| IaC デプロイ | tenant-b, tenant-c の追加が変数設定のみで完了すること |
| 親子関係の可視化 | Datadog上で4層階層構造が確認できること |
| 因果関係の検証 | 障害注入で親子関係が正しく動作すること |

### 7.1 テストシナリオと測定方法

| 基準 | テストシナリオ | 判定基準 | 測定方法 |
|------|---------------|----------|----------|
| アラートストーム防止 | L0モニターを手動でALERT状態に設定 | L1/L2/L3への影響を確認、抑制が必要か判断 | Datadog Event Streamで確認 |
| アラートストーム防止 | L1モニターを手動でALERT状態に設定 | L2/L3への影響を確認、抑制が必要か判断 | Datadog Event Streamで確認 |
| アラートストーム防止 | L2モニターを手動でALERT状態に設定 | L3への影響を確認、抑制が必要か判断 | Datadog Event Streamで確認 |
| IaCデプロイ | tenant-b を tfvars に追加し apply | terraform apply 成功 & モニター作成完了 | Datadog Monitor一覧で確認 |
| IaCデプロイ | tenant-c を tfvars に追加し apply | terraform apply 成功 & モニター作成完了 | Datadog Monitor一覧で確認 |
| 親子関係の可視化 | Datadog Monitor Summary画面を確認 | L0/L1/L2/L3のタグで階層が識別可能 | スクリーンショット |
| 因果関係の検証 | RDS停止 → L1アラート → L2/L3への影響を確認 | 因果関係を特定し、Composite Monitor設計に反映 | 障害注入後のEvent Stream |

**テスト方針**: 障害注入は AWS CLI + 手動操作で実施。因果関係を検証してからComposite Monitor親子関係を確定する。

---

## 8. ステークホルダー

| 役割 | 責務 |
|------|------|
| 運用チーム | 監視の主利用者。アラート対応、ダッシュボード確認 |
| 開発チーム | アラート発生時の調査・対応 |
| インフラチーム | Terraform コード管理、監視設定変更 |

---

## 9. 用語定義

| 用語 | 定義 |
|------|------|
| Composite Monitor | Datadog の機能。複数モニターを論理演算で組み合わせ、親子関係でアラート抑制を実現 |
| L0 (ネットワーク層) | 最上位レイヤー。VPC, ALB を監視。全テナントに影響する通信障害を検知 |
| L1 (コンピュート層) | ECS, RDS を監視。全テナントの処理基盤障害を検知。L0の子、L2の親 |
| L2 (サービス層) | /health E2Eヘルスチェックを監視。アプリケーション全体の応答を確認。L1の子、L3の親 |
| L3 (テナント層) | テナント固有のヘルス、APM、ログを監視。特定テナントの障害を検知。L2の子 |
| アラートストーム | 障害時に大量のアラートが発生する状態 |
| 影響範囲ベース設計 | 障害の影響範囲に基づいて監視階層を分類する設計思想 |

---

## 10. 関連ドキュメント

| ドキュメント | パス |
|-------------|------|
| 事業計画書 | docs/01_企画/事業計画書.md |
| アーキテクチャ設計パターン | docs/01_企画/architecture.md |
| 監視設計（Composite Monitor） | docs/01_企画/monitoring-design.md |

---

## 11. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | PM |
| 2025-12-28 | 1.1 | レビュー指摘反映（ビジネス価値追加、RDS閾値%化、テストシナリオ追加） | PM |
| 2025-12-31 | 1.2 | 監視階層定義を4層に更新（L0:ネットワーク、L1:コンピュート、L2:サービス、L3:テナント）、影響範囲ベース設計を明記、因果関係検証シナリオ追加 | PM |
| 2025-12-31 | 1.3 | 監視階層の4層再定義（L0:ネットワーク、L1:コンピュート、L2:サービス、L3:テナント）、親子関係を「検証により確定」方針に変更、FR-001〜FR-004を4層に対応 | PM |
