# 要件定義書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform |
| バージョン | 1.0 |
| 作成日 | 2025-12-28 |
| ステータス | ドラフト |

---

## 2. プロジェクト概要

### 2.1 背景

オンプレミスからAWSへの移行を検討中。移行後の監視基盤としてDatadogを採用予定。
本プロジェクトは、マルチテナント環境におけるDatadog監視設計をTerraformでIaC化し、
その有効性を検証するPoC（Proof of Concept）である。

### 2.2 現状の課題

| 課題 | 詳細 |
|------|------|
| アラートストーム | プロセス障害時にエラーログが大量発生し、アラート地獄になる |
| 親子設計の欠如 | インフラ障害とアプリ障害が区別できず、原因特定に時間がかかる |
| 手動構築 | テナント追加時の監視設定が手作業で時間がかかる |

### 2.3 目的

1. **Composite Monitor による階層監視の実現**: L0/L2/L3の親子関係でアラートストームを防止
2. **IaC によるテナント追加の効率化**: Terraform で新規テナントの監視を即座にデプロイ
3. **本番移行の判断材料**: PoC結果を基に本番環境への適用可否を判断

### 2.4 ビジネス価値（想定）

※本プロジェクトはPoCのため、以下は本番適用時の想定値

| 指標 | 現状（想定） | 目標 | 年間削減効果 |
|------|-------------|------|-------------|
| アラート対応時間 | 月20時間 | 月5時間 | 90万円/年 |
| 新規テナント追加時間 | 平均4時間 | 平均30分 | 17.5万円/年 |
| 監視設定ミスによる障害 | 年2件 | 0件 | 200万円/年 |
| **合計削減効果** | - | - | **307.5万円/年** |
| **ROI** | - | - | **15.4倍** |

---

## 3. スコープ

### 3.1 対象範囲（In Scope）

#### 監視対象リソース

| レイヤー | リソース | 監視項目 |
|---------|---------|----------|
| **L0: インフラ基盤** | RDS | CPU、接続数、メモリ、ストレージ |
| | ECS Cluster | 実行タスク数 |
| | VPC | VPC Flow Logs（異常検知） |
| | Datadog Agent | Agent 死活監視 |
| **L2: サービス** | ALB | Target Group ヘルス、レスポンスタイム |
| | ECS Task | タスク状態、リソース使用率 |
| | ECR | イメージスキャン結果（脆弱性） |
| **L3: テナント** | Health Check | テナント別ヘルスエンドポイント |
| | Error Logs | テナント別エラーログ数 |
| | Latency | テナント別レイテンシ（p99） |

#### テナント構成

| テナントID | 用途 |
|------------|------|
| tenant-a | 初期構築・基本検証 |
| tenant-b | IaC追加デプロイ検証 |
| tenant-c | 再現性確認 |

### 3.2 対象外（Out of Scope）

| 項目 | 理由 |
|------|------|
| CloudTrail（監査ログ） | 別途監査ログ基盤で対応 |
| ElastiCache | PoC環境では未使用 |
| Lambda | PoC環境では未使用 |
| S3 / CloudFront | PoC環境では未使用 |
| Route53 | PoC環境では未使用 |

---

## 4. 機能要件

### 4.1 Composite Monitor（階層監視）

#### FR-001: L0 インフラ監視

| ID | 要件 |
|----|------|
| FR-001-1 | RDS CPU使用率が95%を超えた場合にアラート発火 |
| FR-001-2 | RDS 接続数が上限の90%を超えた場合にアラート発火 |
| FR-001-3 | RDS FreeableMemory が総メモリの10%未満でアラート発火 |
| FR-001-4 | RDS FreeStorageSpace がストレージ総量の5%未満でアラート発火 |
| FR-001-5 | ECS Cluster の Running Tasks が0になった場合にアラート発火 |
| FR-001-6 | VPC Flow Logs で異常パターン検知時にアラート発火 |
| FR-001-7 | Datadog Agent が停止した場合にアラート発火 |

#### FR-002: L2 サービス監視

| ID | 要件 |
|----|------|
| FR-002-1 | ALB Target Group の Healthy Hosts が0になった場合にアラート発火 |
| FR-002-2 | ECS Task が異常停止した場合にアラート発火 |
| FR-002-3 | ECR イメージスキャンで Critical 脆弱性検出時にアラート発火 |

#### FR-003: L3 テナント監視

| ID | 要件 |
|----|------|
| FR-003-1 | テナント別ヘルスエンドポイント（/{tenant_id}/health）が200以外を返した場合にアラート発火 |
| FR-003-2 | テナント別エラーログが5分間で閾値を超えた場合にアラート発火 |
| FR-003-3 | テナント別レイテンシ（p99）が閾値を超えた場合にアラート発火 |

#### FR-004: アラート抑制

| ID | 要件 |
|----|------|
| FR-004-1 | L0 がアラート状態の場合、L2/L3 のアラートを抑制 |
| FR-004-2 | L2 がアラート状態の場合、対応するテナントのL3アラートを抑制 |
| FR-004-3 | 抑制中も監視データは収集継続（復旧後の分析用） |

### 4.2 IaC（Infrastructure as Code）

#### FR-005: Terraform モジュール

| ID | 要件 |
|----|------|
| FR-005-1 | L0/L2/L3 監視を Terraform モジュールとして実装 |
| FR-005-2 | 新規テナント追加は変数追加のみで完了 |
| FR-005-3 | terraform plan で差分確認後、apply でデプロイ |

#### FR-006: テナント管理

| ID | 要件 |
|----|------|
| FR-006-1 | テナント固有の閾値をパラメータ化 |
| FR-006-2 | テナント追加・削除が既存テナントに影響しない |

---

## 5. 非機能要件

### 5.1 可用性

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-001 | 監視基盤（Datadog）のSLA | Datadog SLA に準拠（99.9%） |
| NFR-002 | アラート発報遅延 | 検知から5分以内 |

### 5.2 スケーラビリティ

| ID | 要件 | 目標値 |
|----|------|--------|
| NFR-003 | 対応テナント数 | 10〜100テナント |
| NFR-004 | テナント追加所要時間 | terraform apply 完了まで5分以内 |

### 5.3 運用性

| ID | 要件 |
|----|------|
| NFR-005 | Terraform state は安全に管理（S3 + DynamoDB Lock 推奨） |
| NFR-006 | 監視設定の変更履歴はGitで管理 |
| NFR-007 | dry-run（plan）を必ず実行してから apply |

### 5.4 セキュリティ

| ID | 要件 |
|----|------|
| NFR-008 | Datadog API Key は環境変数または Secrets Manager で管理 |
| NFR-009 | Terraform 実行環境は最小権限の IAM ロールを使用 |

---

## 6. 制約条件

| 項目 | 制約 |
|------|------|
| 開発環境 | Windows（c:\dev2\datadog-fro-AWS-terraform） |
| IaC ツール | Terraform |
| 監視ツール | Datadog |
| クラウド | AWS |
| スケジュール | 年末年始期間でPoC完了 |

---

## 7. 成功基準

| 基準 | 判定条件 |
|------|----------|
| アラートストーム防止 | L0障害時にL2/L3アラートが抑制されること |
| IaC デプロイ | tenant-b, tenant-c の追加が変数設定のみで完了すること |
| 親子関係の可視化 | Datadog上で階層構造が確認できること |

### 7.1 テストシナリオと測定方法

| 基準 | テストシナリオ | 判定基準 | 測定方法 |
|------|---------------|----------|----------|
| アラートストーム防止 | L0モニターを手動でALERT状態に設定 | L2/L3がComposite条件により抑制される | Datadog Event Streamで確認 |
| IaCデプロイ | tenant-b を tfvars に追加し apply | terraform apply 成功 & モニター作成完了 | Datadog Monitor一覧で確認 |
| IaCデプロイ | tenant-c を tfvars に追加し apply | terraform apply 成功 & モニター作成完了 | Datadog Monitor一覧で確認 |
| 親子関係の可視化 | Datadog Monitor Summary画面を確認 | L0/L2/L3のタグで階層が識別可能 | スクリーンショット |

**テスト方針**: 障害注入は AWS CLI + 手動操作で実施（詳細手順は設計フェーズで定義）

---

## 8. ステークホルダー

| 役割 | 責務 |
|------|------|
| 運用チーム | 監視の主利用者。アラート対応、ダッシュボード確認 |
| 開発チーム | アラート発生時の調査・対応 |
| インフラチーム | Terraform コード管理、監視設定変更 |

---

## 9. 用語定義

| 用語 | 定義 |
|------|------|
| Composite Monitor | Datadog の機能。複数モニターを論理演算で組み合わせ |
| L0 | Level 0。インフラ基盤レイヤー（RDS, ECS Cluster等） |
| L2 | Level 2。サービスレイヤー（ALB, ECS Task等） |
| L3 | Level 3。テナント固有レイヤー（ヘルス、ログ等） |
| アラートストーム | 障害時に大量のアラートが発生する状態 |

---

## 10. 関連ドキュメント

| ドキュメント | パス |
|-------------|------|
| 事業計画書 | docs/01_企画/事業計画書.md |
| アーキテクチャ設計パターン | docs/01_企画/architecture.md |
| 監視設計（Composite Monitor） | docs/01_企画/monitoring-design.md |

---

## 11. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | PM |
| 2025-12-28 | 1.1 | レビュー指摘反映（ビジネス価値追加、RDS閾値%化、テストシナリオ追加） | PM |
