# 検証環境

## 1. システム構成図

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Internet                                   │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────────┐
│                        ALB (Public)                                  │
│  datadog-poc-alb-2037337052.ap-northeast-1.elb.amazonaws.com        │
│                                                                       │
│  /{tenant-id}/health → Target Group                                 │
│  /{tenant-id}/items  → Target Group                                 │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
┌───────▼──────┐       ┌───────▼──────┐       ┌───────▼──────┐
│ ECS Service  │       │ ECS Service  │       │ ECS Service  │
│ tenant-a     │       │ tenant-b     │       │ tenant-c     │
│ (2 tasks)    │       │ (2 tasks)    │       │ (2 tasks)    │
│ 10.0.1.x     │       │ 10.0.1.x     │       │ 10.0.1.x     │
│ 10.0.2.x     │       │ 10.0.2.x     │       │ 10.0.2.x     │
└───────┬──────┘       └───────┬──────┘       └───────┬──────┘
        │                      │                      │
        └──────────────────────┼──────────────────────┘
                               │
                      ┌────────▼────────┐
                      │  RDS PostgreSQL │
                      │  (Shared DB)    │
                      │  10.0.2.x:5432  │
                      └─────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                          Datadog Cloud                               │
│                                                                       │
│  L0 Monitors: RDS CPU/接続数/メモリ/ストレージ, ECS Task, Agent       │
│  L2 Monitors: Synthetic Test, ECS Service, ALB                       │
│  L3 Monitors: Health Check × 3, Latency × 3 (per tenant)            │
│  Composite: L0 → L2/L3 親子関係                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. AWS環境

### 2.1 VPC/Subnet構成

| リソース | 値 | 説明 |
|---------|-----|------|
| **VPC CIDR** | 10.0.0.0/16 | 検証環境用VPC |
| **Public Subnet 1** | 10.0.1.0/24 (ap-northeast-1a) | ECS Fargate タスク配置 |
| **Public Subnet 2** | 10.0.2.0/24 (ap-northeast-1c) | ECS Fargate タスク配置、RDS配置 |
| **Internet Gateway** | あり | ALB、ECSタスクからのインターネット接続 |
| **NAT Gateway** | なし | PoC環境のため省略（本番では推奨） |

**注記**: PoC簡素化のため、全リソースをPublic Subnetに配置。本番環境ではPrivate Subnet + NAT Gateway推奨。

### 2.2 ECS Fargate構成

| 項目 | 設定値 | 説明 |
|-----|-------|------|
| **クラスター名** | datadog-poc-cluster | 全テナント共通クラスター |
| **サービス数** | 3（tenant-a, tenant-b, tenant-c） | テナントごとに独立サービス |
| **タスク定義** | demo-api:latest | FastAPI アプリケーション |
| **タスク数/サービス** | 2タスク | 合計6タスク稼働 |
| **CPU** | 256 (.25 vCPU) | 全テナント共通 |
| **Memory** | 512 MB | 全テナント共通 |
| **ネットワークモード** | awsvpc | Fargate必須設定 |
| **起動タイプ** | FARGATE | サーバーレスコンテナ |
| **プラットフォームバージョン** | LATEST | |
| **Security Group** | ecs-tasks-sg | ALBからの80ポート許可 |

**環境変数（タスク定義）**:
```json
{
  "TENANT_ID": "tenant-a",  // テナントごとに異なる
  "DB_HOST": "datadog-poc-rds.xxxxx.ap-northeast-1.rds.amazonaws.com",
  "DB_PORT": "5432",
  "DB_NAME": "demo_db",
  "DB_USER": "demo_user",
  "DB_PASSWORD": "***",
  "DD_AGENT_HOST": "localhost",
  "DD_TRACE_ENABLED": "true",
  "DD_SERVICE": "demo-api-tenant-a",  // テナントごとに異なる
  "DD_ENV": "poc",
  "DD_VERSION": "1.0"
}
```

### 2.3 RDS PostgreSQL構成

| 項目 | 設定値 | 説明 |
|-----|-------|------|
| **エンジン** | PostgreSQL 15.4 | |
| **インスタンスクラス** | db.t3.micro | 1 vCPU, 1 GB RAM |
| **ストレージ** | 20 GB gp2 | 汎用SSD |
| **Multi-AZ** | 無効 | PoC環境のため単一AZ（本番では有効化推奨） |
| **バックアップ保持期間** | 7日 | 自動バックアップ有効 |
| **暗号化** | 無効 | PoC環境のため省略（本番では有効化推奨） |
| **パブリックアクセス** | 無効 | VPC内部からのみアクセス |
| **Security Group** | rds-sg | ECS tasks-sgからの5432ポート許可 |
| **エンドポイント** | datadog-poc-rds.xxxxx.ap-northeast-1.rds.amazonaws.com | |

**データベース構成**:
- データベース名: `demo_db`
- ユーザー: `demo_user`
- テーブル: `items` (id, tenant_id, name, description, created_at)
- サンプルデータ: 各テナント100件 × 3テナント = 300件

### 2.4 ALB構成

| 項目 | 設定値 | 説明 |
|-----|-------|------|
| **ALB名** | datadog-poc-alb | |
| **スキーム** | internet-facing | インターネットからアクセス可能 |
| **DNS名** | datadog-poc-alb-2037337052.ap-northeast-1.elb.amazonaws.com | |
| **リスナー** | HTTP:80 | PoC環境のためHTTP（本番ではHTTPS推奨） |
| **アベイラビリティゾーン** | ap-northeast-1a, ap-northeast-1c | 2AZ構成 |
| **Security Group** | alb-sg | インターネットからの80ポート許可 |

**ターゲットグループ構成**:

| ターゲットグループ名 | ターゲット | ヘルスチェックパス | ヘルスチェック間隔 |
|------------------|----------|-----------------|-----------------|
| datadog-poc-tg-tenant-a | ECSタスク × 2 | `/tenant-a/health` | 30秒 |
| datadog-poc-tg-tenant-b | ECSタスク × 2 | `/tenant-b/health` | 30秒 |
| datadog-poc-tg-tenant-c | ECSタスク × 2 | `/tenant-c/health` | 30秒 |

**リスナールール（パスベースルーティング）**:

| 優先度 | 条件 | アクション | ターゲットグループ |
|---------|------|--------|----------------|
| 100 | パス: `/tenant-a/*` | forward | tg-tenant-a |
| 101 | パス: `/tenant-b/*` | forward | tg-tenant-b |
| 102 | パス: `/tenant-c/*` | forward | tg-tenant-c |
| デフォルト | - | 503エラー | - |

### 2.5 CloudWatch Logs構成

| ログストリーム | ロググループ | 保持期間 |
|------------|-----------|---------|
| ECSタスク（tenant-a） | /ecs/demo-api-tenant-a | 7日 |
| ECSタスク（tenant-b） | /ecs/demo-api-tenant-b | 7日 |
| ECSタスク（tenant-c） | /ecs/demo-api-tenant-c | 7日 |

---

## 3. Datadog環境

### 3.1 モニター階層構成

本PoCでは、**Composite Monitor**を用いた3階層の監視設計を実装しました。

```
L0: インフラ監視（親アラート）
  ├─ RDS CPU使用率 (> 80%)
  ├─ RDS 接続数 (> 80)
  ├─ RDS メモリ使用率 (> 80%)
  ├─ RDS ストレージ使用率 (> 80%)
  ├─ ECS タスク数 (< 1)
  ├─ ECS Agent接続 (disconnected)
  └─ VPC フローログ異常 (保留: Log Management未契約)

L2: サービス監視（子アラート）
  ├─ Synthetic Test: ALB ヘルスチェック (failed)
  ├─ ECS Service desired_count不一致
  ├─ ALB 5xx エラー (> 10%)
  └─ ALB Unhealthy ターゲット (> 0)

L3: テナント別監視（子アラート）
  ├─ tenant-a
  │   ├─ ヘルスチェック失敗
  │   └─ レイテンシ (> 1000ms)
  ├─ tenant-b
  │   ├─ ヘルスチェック失敗
  │   └─ レイテンシ (> 1000ms)
  └─ tenant-c
      ├─ ヘルスチェック失敗
      └─ レイテンシ (> 1000ms)

Composite Monitor（親子関係）
  - L0アラート発報時 → L2/L3アラート抑制
  - L2アラート発報時 → L3アラート抑制
```

**アラート抑制ロジック**:
- L0（RDS停止）発報時 → L2（Synthetic Test失敗）、L3（ヘルスチェック失敗）を抑制
- L2（ECSタスク停止）発報時 → L3（ヘルスチェック失敗）を抑制

### 3.2 Synthetic Test構成

| 項目 | 設定値 |
|-----|-------|
| **テスト名** | ALB Health Check - Global |
| **URL** | http://datadog-poc-alb-2037337052.ap-northeast-1.elb.amazonaws.com/tenant-a/health |
| **実行間隔** | 1分 |
| **実行ロケーション** | Tokyo (AWS) |
| **失敗条件** | HTTP Status ≠ 200 OR レスポンスタイム > 3秒 |
| **アラート条件** | 連続2回失敗 |

### 3.3 APM (Application Performance Monitoring)

| 項目 | 設定値 |
|-----|-------|
| **トレース送信** | 有効（ddtrace-py） |
| **サービス名** | demo-api-tenant-a, demo-api-tenant-b, demo-api-tenant-c |
| **環境** | poc |
| **サンプリングレート** | 100%（PoC環境） |

---

## 4. テナント定義

| テナントID | CPU | Memory | 優先度 | タスク数 | ヘルスチェックURL |
|-----------|-----|--------|-------|---------|-----------------|
| **tenant-a** | 256 | 512 MB | 100 | 2 | http://alb/tenant-a/health |
| **tenant-b** | 256 | 512 MB | 101 | 2 | http://alb/tenant-b/health |
| **tenant-c** | 256 | 512 MB | 102 | 2 | http://alb/tenant-c/health |

**テナント定義ファイル** (`terraform/shared/tenants.tfvars`):
```hcl
tenants = {
  tenant-a = {
    cpu       = 256
    memory    = 512
    priority  = 100
  }
  tenant-b = {
    cpu       = 256
    memory    = 512
    priority  = 101
  }
  tenant-c = {
    cpu       = 256
    memory    = 512
    priority  = 102
  }
}
```

**テナント追加手順**:
1. `tenants.tfvars` に新テナント追加
2. `terraform apply` 実行（約3分）
3. 自動的に以下が作成される:
   - ECS Service + Task Definition
   - ALB Target Group + Listener Rule
   - Datadog L3 Monitor × 2（ヘルスチェック、レイテンシ）

---

## 5. 環境パラメータ一覧

### 5.1 Terraform変数

| 変数名 | 値 | 説明 |
|--------|-----|------|
| `region` | ap-northeast-1 | AWSリージョン |
| `vpc_cidr` | 10.0.0.0/16 | VPC CIDR |
| `public_subnet_cidrs` | ["10.0.1.0/24", "10.0.2.0/24"] | Public Subnet CIDR |
| `availability_zones` | ["ap-northeast-1a", "ap-northeast-1c"] | AZ |
| `db_instance_class` | db.t3.micro | RDSインスタンスクラス |
| `db_name` | demo_db | データベース名 |
| `db_username` | demo_user | DBユーザー名 |
| `ecs_task_cpu` | 256 | ECS タスクCPU |
| `ecs_task_memory` | 512 | ECS タスクメモリ |

### 5.2 Datadog環境変数

| 変数名 | 説明 |
|--------|------|
| `DD_API_KEY` | Datadog APIキー（Terraform実行時に必要） |
| `DD_APP_KEY` | Datadog アプリケーションキー |
| `DD_SITE` | datadoghq.com |

### 5.3 アプリケーション環境変数

| 変数名 | 値（例） | 説明 |
|--------|---------|------|
| `TENANT_ID` | tenant-a | テナント識別子 |
| `DB_HOST` | datadog-poc-rds.xxxxx.ap-northeast-1.rds.amazonaws.com | RDSエンドポイント |
| `DB_PORT` | 5432 | PostgreSQLポート |
| `DB_NAME` | demo_db | データベース名 |
| `DB_USER` | demo_user | DBユーザー名 |
| `DD_AGENT_HOST` | localhost | Datadog Agent（サイドカー不要、Fargate直接送信） |
| `DD_SERVICE` | demo-api-tenant-a | サービス名 |
| `DD_ENV` | poc | 環境名 |
| `PYTHONPATH` | /app/src | Pythonモジュール検索パス |

---

## 6. IaC構成

### 6.1 Terraformモジュール構成

```
infra/terraform/
├── aws/                     # AWS基盤IaC
│   ├── main.tf             # VPC, ECS, RDS, ALB統合
│   ├── vpc.tf              # VPC, Subnet, IGW, Security Group
│   ├── ecs.tf              # ECS Cluster, Service, Task Definition
│   ├── rds.tf              # RDS PostgreSQL
│   ├── alb.tf              # ALB, Target Group, Listener
│   ├── cloudwatch.tf       # CloudWatch Logs
│   ├── iam.tf              # IAM Role（ECS Task, Execution）
│   ├── variables.tf        # 変数定義
│   └── outputs.tf          # 出力定義
│
└── datadog/                # Datadog監視IaC
    ├── modules/
    │   ├── level0-infra/   # L0 インフラ監視（7モニター）
    │   ├── level2-service/ # L2 サービス監視（4モニター）
    │   ├── level3-tenant/  # L3 テナント監視（2モニター/テナント）
    │   └── composite/      # Composite Monitor（親子関係）
    ├── main.tf
    ├── variables.tf
    └── providers.tf
```

### 6.2 リソース数

| カテゴリ | リソース数 |
|---------|----------|
| **AWS** | 17リソース |
| **Datadog** | 18モニター |
| **合計** | 35リソース |

---

**作成者**: システムコンサルタント
**レビュアー**: インフラアーキテクト
**承認日**: 2025年12月30日
