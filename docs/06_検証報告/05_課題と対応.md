# 課題と対応

## 1. 発生した課題一覧

| 課題ID | カテゴリ | 課題概要 | 重要度 | 対応状況 |
|-------|---------|---------|-------|---------|
| **ISS-001** | 設計 | DATABASE_URL vs DB_* 環境変数不整合 | 高 | ✅ **解決済** |
| **ISS-002** | 設計 | PYTHONPATH設定不足 | 高 | ✅ **解決済** |
| **ISS-003** | 制約 | Log Management未有効化 | 中 | ⏸️ **対応保留** |
| **ISS-004** | 制約 | Composite Monitorクエリ検証エラー | 中 | ⏸️ **対応保留** |

---

## 2. 課題詳細

### 2.1 ISS-001: DATABASE_URL vs DB_* 環境変数不整合

#### 概要（What）

**現象**: ECSタスク起動時にDB接続エラーが発生し、ヘルスチェックが失敗。

```
psycopg2.OperationalError: could not connect to server: Connection refused
```

#### 発生原因（Why）

**根本原因**: 設計書とTerraform実装の環境変数設定方式が不一致。

- **設計書**: `DATABASE_URL`（単一URL形式）を想定
  ```
  DATABASE_URL="postgresql://user:password@host:5432/dbname"
  ```

- **Terraform実装**: `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`（個別変数形式）

- **settings.py**: `DATABASE_URL`のみ読み込む実装

#### 影響範囲（Where）

- **影響コンポーネント**: FastAPI アプリケーション（全テナント）
- **影響機能**: RDS接続、ヘルスチェック、全API
- **影響期間**: 2024年12月28日（実装フェーズ） 〜 修正完了まで（約30分）

#### 対応内容（How）

**修正方針**: settings.pyを修正し、両方の環境変数形式に対応。

**修正内容** (`src/config/settings.py`):
```python
# 修正前（DATABASE_URLのみ）
DATABASE_URL: str

# 修正後（両方に対応）
DATABASE_URL: Optional[str] = None
DB_HOST: Optional[str] = None
DB_PORT: str = "5432"
DB_NAME: Optional[str] = None
DB_USER: Optional[str] = None
DB_PASSWORD: Optional[str] = None

@property
def database_url(self) -> str:
    """DATABASE_URL優先、なければ個別変数から構築"""
    if self.DATABASE_URL:
        return self.DATABASE_URL
    return f"postgresql://{self.DB_USER}:{self.DB_PASSWORD}@{self.DB_HOST}:{self.DB_PORT}/{self.DB_NAME}"
```

**結果**: ECSタスク起動成功、ヘルスチェック正常応答。

#### 再発防止策

1. **設計レビュー強化**: 設計書と実装の環境変数定義を統一
2. **単体テスト追加**: `database_url` propertyの単体テスト追加
3. **ドキュメント整備**: 環境変数設定ガイドを`README.md`に明記

**教訓**: 設計書と実装の整合性を保つため、環境変数定義を一元管理（例: `.env.template`）する。

---

### 2.2 ISS-002: PYTHONPATH設定不足

#### 概要（What）

**現象**: ECSタスク起動時に`ModuleNotFoundError`が発生。

```
ModuleNotFoundError: No module named 'infrastructure'
```

#### 発生原因（Why）

**根本原因**: Dockerfile内で`PYTHONPATH`未設定。

- **Dockerfileの起動コマンド**: `uvicorn src.main:app`
- **モジュール構造**: `src/infrastructure/`, `src/models/`等
- **問題**: Pythonが`src`ディレクトリをモジュールルートとして認識せず、`infrastructure`モジュールが見つからない

#### 影響範囲（Where）

- **影響コンポーネント**: FastAPI アプリケーション（全テナント）
- **影響機能**: モジュールインポート、アプリケーション起動
- **影響期間**: 2024年12月28日（実装フェーズ） 〜 修正完了まで（約15分）

#### 対応内容（How）

**修正内容** (`app/Dockerfile`):
```dockerfile
# 修正前
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "80"]

# 修正後
ENV PYTHONPATH=/app/src
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "80"]
```

**結果**: モジュールインポート成功、ECSタスク正常起動。

#### 再発防止策

1. **ローカルテスト強化**: Docker起動テストを開発フローに組み込む
2. **CI/CDパイプライン**: ECRプッシュ前に起動テスト実行
3. **Dockerfileテンプレート**: PYTHONPATH設定を標準化

**教訓**: Dockerコンテナ実行前に、ローカルで`docker run`テストを実施する。

---

### 2.3 ISS-003: Log Management未有効化

#### 概要（What）

**現象**: Datadog Log Management機能が未契約のため、一部モニターが使用不可。

**影響を受けるモニター**:
- L0: `VPC Flow Logs`モニター（VPCフローログ異常検知）
- L3: `Error Logs`モニター（テナント別エラーログ監視）

#### 影響（Impact）

**機能的影響**:
- VPCネットワークトラフィック異常を検知できない
- アプリケーションエラーログをDatadogで集約・分析できない
- CloudWatch Logsにログは保存されているが、Datadog上で統合監視できない

**ビジネス的影響**:
- **低**: PoC環境ではCloudWatch Logsで代替可能
- **中**: 本番環境では統合監視の利便性低下

#### 対応方針（本番移行時）

**選択肢1: Log Management契約**
- **メリット**: ログ統合監視、APMとログの相関分析が可能
- **デメリット**: 月額コスト増加（詳細: 06_本番移行に向けた提言.md参照）
- **推奨**: 本番環境では契約推奨

**選択肢2: CloudWatch Logsのみ使用**
- **メリット**: コスト削減
- **デメリット**: Datadog上で統合監視できない
- **推奨**: PoC環境では許容、本番環境では非推奨

**推奨**: 本番移行時にLog Management契約締結。

---

### 2.4 ISS-004: Composite Monitorクエリ検証エラー

#### 概要（What）

**現象**: L2/L3 Composite Monitorがクエリ検証エラーで無効化。

```
Error: datadog_monitor_config_policy validation failed:
monitor [ID:xxxxx] query syntax error
```

**影響を受けるモニター**:
- L2/L3 Composite Monitor（L2 → L3アラート抑制）

**正常動作しているモニター**:
- L0 → L2/L3 Composite Monitor（L0 → L2/L3アラート抑制）

#### 影響（Impact）

**機能的影響**:
- L2（ECSサービス）障害時に、L3（テナント別）アラートが抑制されない
- L0（インフラ）障害時のアラート抑制は正常動作

**ビジネス的影響**:
- **低**: L0 → L2/L3抑制は動作しており、主要なアラートストーム防止は達成
- **中**: L2障害時のアラート数が若干増加する可能性

#### 対応方針（本番移行時）

**原因分析**:
- Datadog Composite Monitor APIのクエリ構文要件が複雑
- L0 → L2/L3のクエリは動作するが、L2 → L3のクエリが検証エラー

**対応方針**:
1. **Datadog社への技術問い合わせ**: サポートチケット起票
2. **クエリ構文調査**: Datadog公式ドキュメント、コミュニティフォーラム確認
3. **代替手段検討**: Terraform provider version更新、手動UI作成

**推奨**: 本番移行前にDatadog社サポートに問い合わせ、正しいクエリ構文を確認。

---

## 3. 対応サマリー

| 対応状況 | 件数 | 課題ID |
|---------|-----|-------|
| **解決済** | 2件 | ISS-001, ISS-002 |
| **対応保留** | 2件 | ISS-003, ISS-004 |
| **未対応** | 0件 | - |

### 解決済課題の効果

| 課題ID | 解決前の影響 | 解決後の効果 |
|-------|------------|------------|
| **ISS-001** | ECSタスク起動不可 | 全テナント正常稼働 |
| **ISS-002** | モジュールインポートエラー | アプリケーション正常起動 |

### 対応保留課題のリスク評価

| 課題ID | リスクレベル | 本番移行への影響 | 対応期限 |
|-------|------------|----------------|---------|
| **ISS-003** | 中 | Log Management契約が必要 | 本番移行前（Week 1） |
| **ISS-004** | 低 | L0 → L2/L3抑制は動作、L2 → L3は要追加検証 | 本番移行前（Week 2） |

---

## 4. 残課題（本番移行までに対応が必要）

### 4.1 技術的課題

| 課題ID | 課題内容 | 優先度 | 担当 | 期限 |
|-------|---------|-------|------|------|
| **ISS-003** | Log Management契約締結 | 高 | PM, 調達部門 | Week 1 |
| **ISS-004** | Composite Monitorクエリ検証エラー解決 | 中 | Infra-Architect, SRE | Week 2 |

### 4.2 セキュリティ強化課題

| 課題ID | 課題内容 | 優先度 | 担当 | 期限 |
|-------|---------|-------|------|------|
| **SEC-001** | VPC Private Subnet化（NAT Gateway追加） | 高 | Infra-Architect, SRE | Week 2 |
| **SEC-002** | RDS SSL接続強制化 | 高 | Infra-Architect, SRE | Week 2 |
| **SEC-003** | ALB HTTPS化（ACM証明書設定） | 中 | Infra-Architect, SRE | Week 3 |
| **SEC-004** | RDS Multi-AZ有効化 | 中 | Infra-Architect, SRE | Week 3 |

### 4.3 運用改善課題

| 課題ID | 課題内容 | 優先度 | 担当 | 期限 |
|-------|---------|-------|------|------|
| **OPS-001** | 運用手順書作成 | 高 | SRE | Week 3 |
| **OPS-002** | アラート通知先設定（PagerDuty, Slack等） | 中 | SRE | Week 3 |
| **OPS-003** | コスト監視設定（AWS Cost Explorer, Datadog Billing） | 低 | SRE | Week 4 |

---

## 5. 教訓（Lessons Learned）

### 5.1 設計フェーズでの教訓

- **環境変数定義の一元管理**: 設計書、Terraform、アプリケーションで環境変数定義を統一する
- **Dockerfileの標準化**: PYTHONPATH等の共通設定をテンプレート化する

### 5.2 実装フェーズでの教訓

- **ローカルテストの重要性**: Docker起動テストを開発フローに組み込む
- **段階的デプロイ**: AWS環境構築 → アプリデプロイ → Datadog監視の順に段階的に進める

### 5.3 検証フェーズでの教訓

- **外部サービス制約の事前確認**: Log Management等の契約要件を企画段階で確認する
- **Composite Monitorクエリ複雑性**: Datadog公式ドキュメントだけでは不十分、サポート問い合わせが必要

---

**作成者**: システムコンサルタント
**レビュアー**: プロジェクトマネージャー
**承認日**: 2025年12月30日
