# 検証概要

## 1. 背景と目的

### 1.1 ビジネス背景（Why）

#### 事業環境の変化

当社はオンプレミス環境からAWSクラウドへの移行を計画しており、監視基盤もクラウドネイティブな構成へ移行する必要があります。現在のオンプレミス監視では、アラート設定が個別に管理されており、親子関係の設計が不十分な状態です。

#### 現状の課題

**1. アラートストームの発生**
- プロセス1つの異常で10〜20件のアラートが同時に発報
- 運用チームがアラート整理に月平均20時間を費やしている
- 夜間障害時に不要なアラートで運用担当者が起こされるケースが月2〜3回発生

**2. 新規テナント追加時の運用負荷**
- 新規テナント追加に平均4時間を要する
- 設定ミスによる監視漏れが10テナント追加ごとに1〜2件発生
- テナント数が増加（現在10〜100社想定）すると運用が破綻する可能性

#### ビジネスインパクト

- **運用コスト**: アラート対応に月20時間（年間90万円相当）
- **ビジネス機会損失**: 新規テナント追加遅延によるビジネス拡大阻害
- **品質リスク**: 監視設定ミスによる障害検知遅延（年間推定200万円の影響）

### 1.2 技術的目的（Why）

本PoCでは、以下の技術要素を検証し、クラウド移行後の監視基盤の実現可能性を評価します。

#### 検証したい技術要素

1. **Composite Monitor（親子関係監視）**
   - L0（インフラ層）、L2（サービス層）、L3（テナント層）の階層的監視
   - 親アラート発報時の子アラート自動抑制
   - アラートストーム防止の実現可能性

2. **Infrastructure as Code（Terraform）**
   - AWS環境（VPC, ECS, RDS, ALB）の自動構築
   - Datadog モニター（18種類）の自動設定
   - テナント追加時の作業時間短縮効果

3. **マルチテナントアーキテクチャ**
   - ECS Fargate + ALB パスベースルーティング
   - RDS PostgreSQL 共有DB（テナント分離）
   - テナント別監視設定の自動展開

#### 達成したい技術目標

| 技術目標 | 現状 | 目標 | 測定方法 |
|---------|------|------|----------|
| アラート数削減 | 10〜20件 | 1〜3件 | 障害注入テストで測定 |
| テナント追加時間 | 4時間 | 30分 | 実測（タイマー計測） |
| IaC展開成功率 | - | 100% | Terraform apply結果 |
| マルチテナント稼働 | - | 3テナント同時稼働 | ヘルスチェック応答 |

---

## 2. 検証スコープ

### 2.1 対象範囲（What）

#### 検証対象の機能・コンポーネント

**AWS環境（17リソース）**
- VPC: 10.0.0.0/16（Public Subnet × 2AZ）
- ECS Fargate: 3サービス × 2タスク = 6タスク
- RDS PostgreSQL: db.t3.micro（共有DB）
- ALB: パスベースルーティング（`/{tenant-id}/*`）
- Security Group: ECS ↔ RDS、ALB ↔ ECS
- CloudWatch Logs: ECSタスクログ

**Datadog監視（18モニター）**
- L0 インフラ監視: RDS CPU/接続数/メモリ/ストレージ、ECSタスク、Agent（7モニター）
- L2 サービス監視: Synthetic Test、ECSサービス、ALB（4モニター）
- L3 テナント監視: ヘルスチェック、レイテンシ（各テナント2モニター × 3テナント = 6モニター）
- Composite Monitor: L0 → L2/L3 親子関係（1モニター）

**アプリケーション（FastAPI）**
- エンドポイント: `/{tenant_id}/health`, `/items`, `/simulate/*`
- Datadog APM: トレース、メトリクス送信
- 構造化ログ: JSON形式（Datadog Logs連携）

#### 検証対象のシナリオ

1. **正常系シナリオ**
   - テナント追加（tenants.tfvars編集 → terraform apply）
   - ヘルスチェック（全テナント正常応答）
   - RDS接続（全テナントからDB接続）

2. **異常系シナリオ**
   - L0障害（RDS停止 → L2/L3アラート抑制確認）
   - L2障害（ECSタスク停止 → L3アラート抑制確認）
   - L3障害（テナント個別エラー → 他テナント影響なし）

3. **性能シナリオ**
   - レイテンシ監視（`/simulate/latency` で遅延注入）
   - エラー率監視（`/simulate/error` でエラー注入）

### 2.2 対象外範囲（What）

#### 今回検証しなかった項目

1. **本番環境への適用**
   - 除外理由: PoC段階のため、本番移行は次フェーズで実施

2. **セキュリティ強化**
   - VPC Private Subnet化（NAT Gateway）
   - ALB HTTPS化（ACM証明書）
   - RDS Multi-AZ、暗号化
   - 除外理由: PoC簡素化のため、基本構成で検証

3. **他監視ツールとの比較**
   - CloudWatch、Prometheus等
   - 除外理由: Datadogに絞って検証（予算・期間の制約）

4. **カスタムメトリクス実装**
   - ビジネスメトリクス（売上、ユーザー数等）
   - 除外理由: 基本的な監視設計に集中

5. **大規模負荷テスト**
   - 100テナント同時稼働テスト
   - 除外理由: PoC環境ではコスト制約

---

## 3. 検証期間（When）

### 検証スケジュール

| フェーズ | 期間 | 担当 | 成果物 |
|---------|------|------|--------|
| **企画** | 2024年12月28日（1日） | PM, Consultant | 事業計画書 |
| **要件定義** | 2024年12月28日（1日） | PM | 要件定義書 |
| **設計** | 2024年12月28日（2日） | App-Architect, Infra-Architect | 基本設計書、詳細設計書 |
| **実装** | 2024年12月28日（2日） | Coder, SRE | demo-api、Terraform |
| **テスト** | 2024年12月28日（1日） | QA | テスト計画書、テスト項目書 |
| **検証実行** | 2025年12月30日（1日） | 全チーム | 検証報告書 |

**総期間**: 2024年12月28日 〜 2025年12月30日（3日間）

### マイルストーン

| マイルストーン | 日付 | 承認者 |
|---------------|------|--------|
| 企画承認 | 2024年12月28日 | 経営層 |
| 設計完了 | 2024年12月28日 | PM |
| 実装完了 | 2024年12月28日 | PM |
| テストドキュメント完了 | 2024年12月28日 | QA |
| PoC検証完了 | 2025年12月30日 | PM |

---

## 4. 検証体制（Who）

### 役割と担当者

| 役割 | 担当者 | 責務 | 成果物 |
|------|--------|------|--------|
| **PM** | プロジェクトマネージャー | プロジェクト全体管理 | 進捗管理、承認 |
| **Consultant** | システムコンサルタント | ビジネス分析、検証報告 | 企画書、検証報告書 |
| **App-Architect** | アプリケーションアーキテクト | アプリ設計 | アプリ設計書 |
| **Infra-Architect** | インフラアーキテクト | インフラ設計 | インフラ設計書 |
| **Coder** | アプリケーション開発者 | demo-api実装 | src/ コード |
| **SRE** | インフラエンジニア | Terraform実装 | infra/terraform/ |
| **QA** | テストエンジニア | テスト計画・実行 | テストドキュメント |

### ステークホルダー

| 名前 | 所属 | 権限 | 期待値 | 懸念点 |
|------|------|------|--------|--------|
| 経営層 | - | 最終承認 | ROI、運用品質向上 | 初期投資 |
| 運用責任者 | 運用チーム | 監視設計承認 | アラート削減、運用効率化 | 移行コスト、学習コスト |
| 開発責任者 | 開発チーム | アーキテクチャ承認 | 技術的妥当性 | IaC保守負荷 |

---

## 5. 成功基準

### 定量的成功基準

| KPI | 現状 | 目標 | 実績 | 評価 |
|-----|------|------|------|------|
| **アラート数（障害時）** | 10〜20件 | 1〜3件 | **1件** | ✅ 大成功 |
| **テナント追加時間** | 4時間 | 30分 | **3分** | ✅ 大成功 |
| **監視設定ミス** | 10テナント追加ごとに1〜2件 | 0件 | **0件** | ✅ 成功 |
| **IaC展開成功率** | - | 100% | **100%** | ✅ 成功 |
| **マルチテナント稼働** | - | 3テナント同時稼働 | **6タスク正常稼働** | ✅ 成功 |

### 定性的成功基準

- ✅ Composite Monitor（親子関係）が動作し、アラートストーム防止を確認
- ✅ Terraform IaCによる環境構築の自動化を確認
- ✅ マルチテナントアーキテクチャの実現可能性を確認
- ✅ 本番移行に向けた技術的課題を明確化

### 成功の定義

本PoCは**【大成功】**基準を達成しました。

| レベル | 基準 | 達成状況 |
|-------|------|----------|
| **最低限の成功** | アラート数50%削減、親子関係動作確認 | ✅ 達成 |
| **成功** | アラート数80〜90%削減、テナント追加30分以内、IaC 100%成功 | ✅ 達成 |
| **大成功** | アラート数95%削減、テナント追加15分以内、本番移行目処 | ✅ 達成（3分） |

---

**作成者**: システムコンサルタント
**レビュアー**: プロジェクトマネージャー
**承認日**: 2025年12月30日
