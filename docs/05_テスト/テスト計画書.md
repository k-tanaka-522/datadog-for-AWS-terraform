# テスト計画書（全体）

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| バージョン | 1.1 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | Draft |

---

## 2. テスト概要

### 2.1 テストの目的

本PoCの実装成果物（demo-api、Terraform Datadog Monitors）の品質を検証し、以下を確認する:

1. **機能要件の充足**: 要件定義書（FR-001〜FR-006）の機能が実装されていること
2. **非機能要件の充足**: NFR-001〜NFR-009 の非機能要件を満たすこと
3. **成功基準の達成**: アラートストーム防止、IaCデプロイ、親子関係可視化が動作すること
4. **本番適用の判断材料**: PoC結果を基に本番環境への適用可否を判断できること

### 2.2 テスト対象システム

| コンポーネント | 技術スタック | テスト対象 |
|------------|------------|----------|
| **demo-api** | Python 3.10+ / FastAPI | 8つのAPIエンドポイント、ヘルスチェック、障害シミュレーション、Datadog APM統合 |
| **Terraform** | Terraform 1.0+ / Datadog Provider 3.x | L0/L2/L3 Monitors、Composite Monitors、テナント管理（for_each） |
| **Datadog** | Datadog APM/Logs/Monitors | 監視データ収集、アラート発火、Composite Monitor 親子関係 |

### 2.3 テストフェーズ構成

本テストは4つのフェーズで構成されます:

| フェーズ | テストレベル | 主な目的 | 実施タイミング |
|--------|----------|----------|-------------|
| **01_単体テスト** | Unit Test | コードの正確性（関数/クラス単位） | 実装フェーズで完了済み |
| **02_統合テスト** | Integration Test | モジュール間連携（API-DB、Terraform-Datadog） | Day 1-2 |
| **03_E2Eテスト** | End-to-End Test | ユーザーシナリオ全体（PoCの成功基準検証） | Day 3-4 |
| **04_障害注入テスト** | Fault Injection Test | 監視動作確認（L0/L2/L3 Monitor検証） | Day 5-6 |

---

## 3. テスト戦略

### 3.1 テストレベル

| テストレベル | 目的 | 担当 | 優先度 | 詳細ドキュメント |
|------------|------|------|--------|---------------|
| **単体テスト** | コードの正確性 | Coder（実施済み） | ⭐⭐⭐ 必須 | docs/05_テスト/01_単体テスト/ |
| **統合テスト** | モジュール間連携 | QA | ⭐⭐⭐ 必須 | docs/05_テスト/02_統合テスト/ |
| **E2Eテスト** | ユーザーシナリオ全体 | QA | ⭐⭐⭐ 必須 | docs/05_テスト/03_E2Eテスト/ |
| **障害注入テスト** | 監視動作確認 | QA | ⭐⭐⭐ 必須 | docs/05_テスト/04_障害注入テスト/ |

### 3.2 テストピラミッド

```
        /\
       /E2E\         少ない（重要シナリオのみ）
      /------\        - アラートストーム防止
     /障害注入 \        - IaCデプロイ
    /----------\      中程度（主要フローをカバー）
   /統合テスト   \      - 監視階層の動作確認
  /==============\    多い（カバレッジ80%以上）
    単体テスト          - 実装フェーズで完了
```

### 3.3 カバレッジ目標

| 対象 | 目標カバレッジ | 測定方法 |
|------|--------------|---------|
| **demo-api コード** | 80%以上（実装フェーズで達成済み） | pytest-cov |
| **APIエンドポイント** | 100%（8エンドポイント全て） | 統合テスト |
| **Datadog Monitor** | 100%（L0: 7個、L2: 4個、L3: 9個、Composite: 5個） | 障害注入テスト |
| **Terraform モジュール** | 100%（level0-infra、level2-service、level3-tenant、composite） | 統合テスト（dry-run） |

---

## 4. テストスケジュール

### 4.1 マイルストーン

| Phase | フェーズ | 期間 | 主要タスク | 完了基準 |
|-------|---------|------|----------|----------|
| **Phase 0** | 単体テスト確認 | - | Coder実施済みテスト確認 | カバレッジ80%以上確認 |
| **Phase 1** | 統合テスト | 2営業日 | API統合テスト、Terraform dry-run | 統合テスト100%パス |
| **Phase 2** | E2Eテスト | 2営業日 | アラートストーム防止、IaCデプロイシナリオ | E2Eテスト100%パス、成功基準達成 |
| **Phase 3** | 障害注入テスト | 2営業日 | L0/L2/L3 Monitor障害注入テスト | 障害注入テスト100%パス |
| **Phase 4** | 報告書作成 | 1営業日 | テスト結果報告書、品質評価 | 報告書承認 |

**合計**: 7営業日

### 4.2 詳細スケジュール

| Day | タスク | 成果物 | 担当 |
|-----|------|--------|------|
| **Day 0** | 単体テスト確認（Coder実施済み） | カバレッジレポート確認 | QA |
| **Day 1** | API統合テスト（8エンドポイント） | tests/integration/test_api.py | QA |
| **Day 2** | Terraform dry-run（全モジュール） | terraform plan 結果 | QA |
| **Day 3** | E2Eテスト（アラートストーム防止） | スクリーンショット、結果レポート | QA |
| **Day 4** | E2Eテスト（IaCデプロイ） | tenant-b, tenant-c 追加成功 | QA |
| **Day 5** | 障害注入テスト（L0/L2） | 障害注入手順書、結果ログ | QA |
| **Day 6** | 障害注入テスト（L3/Composite） | 監視動作確認100%パス | QA |
| **Day 7** | テスト結果報告書作成 | テスト結果報告書.md | QA |

---

## 5. テスト環境

### 5.1 ローカル開発環境

| 項目 | 内容 |
|------|------|
| **OS** | Windows 11 |
| **開発ディレクトリ** | c:\dev2\datadog-fro-AWS-terraform |
| **Python** | 3.10+ |
| **ツール** | pytest, pytest-cov, httpx |
| **Terraform** | 1.0+ |
| **Terraform Provider** | Datadog Provider 3.x |

### 5.2 AWS環境

| リソース | 構成 |
|---------|------|
| **ECS Fargate** | demo-api コンテナ実行環境 |
| **RDS PostgreSQL** | データベース（items テーブル） |
| **ALB** | ロードバランサー |
| **VPC** | プライベートサブネット（ECS、RDS） |

### 5.3 Datadog環境

| 項目 | 内容 |
|------|------|
| **アカウント** | Datadog 無料トライアル（または既存アカウント） |
| **監視対象** | L0: 7 Monitors、L2: 4 Monitors、L3: 9 Monitors、Composite: 5 Monitors |
| **ログ管理** | CloudWatch Logs → Datadog Agent → Datadog Logs |
| **APM** | ddtrace（demo-api に統合済み） |

---

## 6. テスト体制

### 6.1 役割と責任

| 役割 | 担当者 | 責務 |
|------|-------|------|
| **QA** | QAエージェント | テスト計画策定、テストコード作成、テスト実行、結果報告 |
| **PM** | PMエージェント | テスト計画承認、進捗管理、品質判定 |
| **Coder** | Coderエージェント | 不具合修正（テスト失敗時） |
| **SRE** | SREエージェント | Terraform実行支援、AWS環境確認 |

---

## 7. 合格基準

### 7.1 フェーズ別合格基準

| フェーズ | 合格基準 | 測定方法 |
|--------|---------|---------|
| **単体テスト** | カバレッジ80%以上、全テスト合格 | pytest-cov |
| **統合テスト** | API統合テスト100%パス、Terraform dry-run 100%パス | pytest、terraform plan |
| **E2Eテスト** | 全シナリオ100%パス、PoCの成功基準3点達成 | 手動テスト、スクリーンショット |
| **障害注入テスト** | 全Monitor（25個）ALERT動作確認、リカバリー5分以内 | 障害注入手順、Datadog UI確認 |

### 7.2 PoCの成功基準

| 基準 | 判定条件 | 対応テストケース |
|------|----------|----------------|
| **アラートストーム防止** | L0障害時にL2/L3アラートが抑制されること | E2E-001（L0障害時のアラート抑制） |
| **IaCデプロイ** | tenant-b, tenant-c の追加が変数設定のみで完了すること | E2E-004（tenant-b追加）、E2E-005（tenant-c追加） |
| **親子関係の可視化** | Datadog上で階層構造が確認できること | E2E-007, E2E-008（Composite Monitor確認） |

### 7.3 品質基準

**合格条件**:
- [ ] 単体テストカバレッジ: 80%以上
- [ ] 統合テスト: 100%パス
- [ ] E2Eテスト: 100%パス
- [ ] 障害注入テスト: 100%パス
- [ ] PoCの成功基準3点: 全て達成
- [ ] Critical/High不具合: 0件

**不合格条件**:
- いずれかのフェーズで不合格
- PoCの成功基準が1点でも未達成
- Critical/High不具合が1件でも存在

---

## 8. リスクと対策

### 8.1 テストリスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| **Datadog無料トライアル期限切れ** | High | Medium | 早期にテスト開始、期限を確認 |
| **AWS環境の不安定性** | High | Low | ECS/RDS のヘルスチェック確認、バックアップ取得 |
| **Terraform state ロック競合** | Medium | Low | DynamoDB Lock使用、複数人で同時apply禁止 |
| **障害注入失敗** | Medium | Medium | 手動ALERT設定で代替、手順書を事前作成 |

---

## 9. 参照ドキュメント

| ドキュメント | パス | 用途 |
|------------|------|------|
| **要件定義書** | docs/02_要件定義/要件定義書.md | 機能要件・非機能要件確認 |
| **アプリケーション設計書** | docs/03_アプリケーション設計/ | API仕様確認 |
| **インフラ設計書** | docs/04_インフラ設計/ | Datadog Monitor仕様確認 |
| **監視設計** | docs/04_インフラ設計/01_基本設計/05_監視設計.md | Composite Monitor仕様確認 |
| **テストフェーズガイド** | .claude/docs/10_facilitation/2.5_テストフェーズ/PHASE_GUIDE.md | テスト手法確認 |

---

## 10. テストドキュメント構成

```
docs/05_テスト/
├── テスト計画書.md（本ドキュメント - 全体方針・共通事項）
├── 01_単体テスト/
│   ├── テスト計画.md
│   ├── テストシナリオ.md
│   └── テスト項目書.md
├── 02_統合テスト/
│   ├── テスト計画.md
│   ├── テストシナリオ.md
│   └── テスト項目書.md
├── 03_E2Eテスト/
│   ├── テスト計画.md
│   ├── テストシナリオ.md
│   └── テスト項目書.md
└── 04_障害注入テスト/
    ├── テスト計画.md
    ├── テストシナリオ.md
    └── テスト項目書.md
```

**各フェーズのドキュメント**:
- **テスト計画.md**: フェーズ固有の目的、スコープ、スケジュール、合格基準
- **テストシナリオ.md**: 具体的な手順、期待結果、判定基準
- **テスト項目書.md**: テストケース一覧、実行記録、結果記録

---

## 11. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |
| 2025-12-28 | 1.1 | フェーズ別ドキュメント構成に整理 | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| PM | PMエージェント |  |  |
