# E2Eテストシナリオ

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| フェーズ | E2Eテスト |
| バージョン | 1.0 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | Draft |

---

## 2. 概要

E2Eテストでは、PoCの成功基準である「アラートストーム防止」「IaCデプロイ」「親子関係可視化」を検証します。実際のDatadog環境でのエンドツーエンドシナリオを実行します。

---

## 3. アラートストーム防止検証シナリオ

### 3.1 E2E-001: L0障害時のアラート抑制

#### 3.1.1 前提条件

- [ ] 全Monitorのステータスが「OK」
- [ ] Composite Monitorが作成済み
- [ ] L0-Composite の式に「L0 Monitor のいずれか」が含まれる
- [ ] L2-Composite の式に「NOT L0-Composite」が含まれる
- [ ] L3-Composite の式に「NOT (L0-Composite OR L2-Composite)」が含まれる

#### 3.1.2 テスト手順

**ステップ1: 初期状態確認**
1. Datadog UI（Monitors > Manage Monitors）を表示
2. 全Monitorのステータスが「OK」であることを確認
3. スクリーンショット取得: `screenshots/e2e-001-step1-initial.png`

**ステップ2: L0障害発生（RDS CPU）**
1. Datadog API経由でRDS CPUメトリクスを送信
   ```bash
   curl -X POST "https://api.datadoghq.com/api/v1/series" \
     -H "Content-Type: application/json" \
     -H "DD-API-KEY: {DATADOG_API_KEY}" \
     -d '{
       "series": [{
         "metric": "aws.rds.cpuutilization",
         "points": [['"$(date +%s)"', 95]],
         "type": "gauge",
         "host": "{RDS_INSTANCE_ID}",
         "tags": ["env:poc"]
       }]
     }'
   ```
2. 5分待機（Monitor評価間隔）
3. L0 Monitor「L0-RDS-CPU」のステータス確認 → ALERT
4. スクリーンショット取得: `screenshots/e2e-001-step2-l0-alert.png`

**ステップ3: L2障害発生（ALB Health）**
1. ECS Taskを全停止
   ```bash
   aws ecs update-service --cluster {CLUSTER_NAME} --service demo-api --desired-count 0
   ```
2. 5分待機
3. L2 Monitor「L2-ALB-Health」のステータス確認 → ALERT
4. スクリーンショット取得: `screenshots/e2e-001-step3-l2-alert.png`

**ステップ4: L3障害発生（tenant-a エラーログ）**
1. tenant-a でエラーシミュレーション実行
   ```bash
   curl -X POST https://{ALB_DNS}/tenant-a/simulate/error \
     -H "Content-Type: application/json" \
     -d '{"count": 10, "message": "Simulated error for testing"}'
   ```
2. 5分待機
3. L3 Monitor「L3-Error-tenant-a」のステータス確認 → ALERT
4. スクリーンショット取得: `screenshots/e2e-001-step4-l3-alert.png`

**ステップ5: Composite Monitorアラート確認**
1. Datadog UI（Monitors > Manage Monitors）で以下を確認:
   - L0-Composite: ALERT
   - L2-Composite: ALERT（ただし通知抑制されている）
   - L3-Composite-tenant-a: ALERT（ただし通知抑制されている）
2. スクリーンショット取得: `screenshots/e2e-001-step5-composite.png`

**ステップ6: Datadog Event Stream確認**
1. Datadog Event Stream（Events > Event Stream）を表示
2. フィルタ: `alert_type:error`
3. 期待される結果: L0-Composite のみ通知送信、L2/L3は通知なし
4. スクリーンショット取得: `screenshots/e2e-001-step6-event-stream.png`

**ステップ7: 通知抑制ロジック確認**
1. L2-Composite の設定を確認（Datadog UI > Monitors > L2-Composite > Edit）
2. 式に「NOT L0-Composite」が含まれることを確認
3. L3-Composite-tenant-a の設定を確認
4. 式に「NOT (L0-Composite OR L2-Composite)」が含まれることを確認
5. スクリーンショット取得: `screenshots/e2e-001-step7-composite-formula.png`

#### 3.1.3 期待結果

| ステップ | 期待結果 | 判定基準 |
|--------|---------|---------|
| ステップ2 | L0 Monitor ALERT | L0-RDS-CPU がALERT状態 |
| ステップ3 | L2 Monitor ALERT | L2-ALB-Health がALERT状態 |
| ステップ4 | L3 Monitor ALERT | L3-Error-tenant-a がALERT状態 |
| ステップ5 | Composite Monitor全てALERT | L0/L2/L3-Composite 全てALERT |
| ステップ6 | L0-Composite のみ通知 | Event Streamに L0-Composite のみ記録 |
| ステップ7 | NOT条件確認 | 式にNOT条件が含まれる |

#### 3.1.4 合格条件

- [ ] L0障害発生時、L0-Composite のみ通知送信
- [ ] L2/L3-Composite は通知抑制（ALERT状態だが通知なし）
- [ ] Datadog Event Streamで通知履歴が確認できる
- [ ] NOT条件が正しく機能している

---

### 3.2 E2E-002: L2障害時のアラート抑制

#### 3.2.1 前提条件

- [ ] E2E-001完了後、全Monitorを「OK」に戻す
- [ ] 全Monitorのステータスが「OK」

#### 3.2.2 テスト手順

**ステップ1: 初期状態確認**
1. 全Monitorのステータスが「OK」であることを確認

**ステップ2: L2障害発生（ALB Health）**
1. ECS Taskを全停止
2. 5分待機
3. L2 Monitor「L2-ALB-Health」のステータス確認 → ALERT

**ステップ3: L3障害発生（tenant-a エラーログ）**
1. tenant-a でエラーシミュレーション実行（※ただしALBが停止しているため実行不可）
2. 代わりに手動でL3 MonitorをALERT状態に設定

**ステップ4: Composite Monitorアラート確認**
1. L0-Composite: OK
2. L2-Composite: ALERT（通知送信）
3. L3-Composite-tenant-a: ALERT（ただし通知抑制）

**ステップ5: Event Stream確認**
1. L2-Composite のみ通知送信
2. L3-Composite-tenant-a は通知なし（NOT L2-Composite により抑制）

#### 3.2.3 期待結果

- [ ] L2-Composite のみ通知送信
- [ ] L3-Composite は通知抑制
- [ ] L0-Composite は正常（OK）

---

### 3.3 E2E-003: L3障害のみ（親は正常）

#### 3.3.1 前提条件

- [ ] 全Monitorのステータスが「OK」

#### 3.3.2 テスト手順

**ステップ1: L3障害発生（tenant-a エラーログ）**
1. tenant-a でエラーシミュレーション実行
2. 5分待機
3. L3 Monitor「L3-Error-tenant-a」のステータス確認 → ALERT

**ステップ2: Composite Monitorアラート確認**
1. L0-Composite: OK
2. L2-Composite: OK
3. L3-Composite-tenant-a: ALERT（通知送信）

**ステップ3: Event Stream確認**
1. L3-Composite-tenant-a のみ通知送信
2. L0/L2-Composite は通知なし（正常のため）

#### 3.3.3 期待結果

- [ ] L3-Composite-tenant-a のみ通知送信
- [ ] L0/L2-Composite は正常（OK）

---

## 4. IaCデプロイ検証シナリオ

### 4.1 E2E-004: tenant-b 追加デプロイ

#### 4.1.1 前提条件

- [ ] Terraform初期化済み（terraform init完了）
- [ ] tenant-a のみ存在する状態

#### 4.1.2 テスト手順

**ステップ1: tfvars編集**
1. `terraform.tfvars` を開く
2. 以下を追加:
   ```hcl
   tenants = {
     "tenant-a" = { name = "Tenant A" },
     "tenant-b" = { name = "Tenant B" }  # 追加
   }
   ```

**ステップ2: terraform plan**
```bash
cd c:\dev2\datadog-fro-AWS-terraform\infra\terraform
terraform plan
```

**期待される結果**:
```
Plan: 4 to add, 0 to change, 0 to destroy
```

**ステップ3: terraform apply**
```bash
terraform apply -auto-approve
```

**期待される結果**:
```
Apply complete! Resources: 4 added, 0 changed, 0 destroyed.
```

**ステップ4: Datadog Monitor確認**
1. Datadog UI（Monitors > Manage Monitors）を表示
2. 以下が作成されていることを確認:
   - L3-Health-tenant-b
   - L3-Error-tenant-b
   - L3-Latency-tenant-b
   - L3-Composite-tenant-b
3. スクリーンショット取得: `screenshots/e2e-004-tenant-b-monitors.png`

**ステップ5: tenant-a への影響確認**
1. tenant-a のMonitorを確認
2. 期待される結果: 変更なし（terraform plan で0 to change）

#### 4.1.3 期待結果

- [ ] terraform apply 成功
- [ ] tenant-b 用 L3 Monitor 3個作成
- [ ] tenant-b 用 L3 Composite 1個作成
- [ ] tenant-a のMonitorに変更なし

---

### 4.2 E2E-005: tenant-c 追加デプロイ

#### 4.2.1 テスト手順

**ステップ1: tfvars編集**
```hcl
tenants = {
  "tenant-a" = { name = "Tenant A" },
  "tenant-b" = { name = "Tenant B" },
  "tenant-c" = { name = "Tenant C" }  # 追加
}
```

**ステップ2: terraform plan**
```bash
terraform plan
```

**期待される結果**:
```
Plan: 4 to add, 0 to change, 0 to destroy
```

**ステップ3: terraform apply**
```bash
terraform apply -auto-approve
```

**ステップ4: Datadog Monitor確認**
1. tenant-c 用 L3 Monitor 3個作成
2. tenant-c 用 L3 Composite 1個作成

#### 4.2.2 期待結果

- [ ] terraform apply 成功
- [ ] tenant-c 用 L3 Monitor 3個作成
- [ ] tenant-a, tenant-b のMonitorに変更なし

---

### 4.3 E2E-006: 既存テナントへの影響なし

#### 4.3.1 テスト手順

**ステップ1: terraform plan（tenant-b, tenant-c 追加後）**
```bash
terraform plan
```

**期待される結果**:
```
No changes. Your infrastructure matches the configuration.
```

**ステップ2: tenant-a のMonitor確認**
1. Datadog UI で tenant-a のMonitorを表示
2. 最終更新日時を確認
3. 期待される結果: tenant-b, tenant-c 追加前と同じ

#### 4.3.2 期待結果

- [ ] terraform plan で差分なし
- [ ] tenant-a のMonitorに変更なし（最終更新日時変更なし）

---

## 5. 親子関係可視化検証

### 5.1 Datadog UI確認

**ステップ1: Monitors一覧表示**
1. Datadog UI（Monitors > Manage Monitors）を表示
2. フィルタ: `tag:env:poc`
3. 階層構造が表示されることを確認
4. スクリーンショット取得: `screenshots/e2e-hierarchy.png`

**ステップ2: Composite Monitor詳細確認**
1. L0-Composite を開く
2. 式を確認: `L0-RDS-CPU || L0-RDS-Conn || ...`
3. L2-Composite を開く
4. 式を確認: `(L2-ALB-Health || L2-ECS-Task || ...) && !L0-Composite`
5. L3-Composite-tenant-a を開く
6. 式を確認: `(L3-Health-tenant-a || L3-Error-tenant-a || L3-Latency-tenant-a) && !(L0-Composite || L2-Composite)`

**ステップ3: Monitor Dependencies確認**
1. Datadog UI で Monitor Dependencies 機能を確認（もし利用可能であれば）
2. 階層構造が視覚的に表示されることを確認

---

## 6. 合格判定

### 6.1 合格条件

**以下の全条件を満たす場合、E2Eテスト合格と判定**:
- [ ] E2E-001: L0障害時のアラート抑制 成功
- [ ] E2E-002: L2障害時のアラート抑制 成功
- [ ] E2E-003: L3障害のみ 成功
- [ ] E2E-004: tenant-b 追加デプロイ 成功
- [ ] E2E-005: tenant-c 追加デプロイ 成功
- [ ] E2E-006: 既存テナントへの影響なし 確認
- [ ] 親子関係可視化 確認完了
- [ ] Critical/High不具合: 0件

### 6.2 不合格条件

以下のいずれかに該当する場合、不合格:
- E2Eテスト失敗が1件でもある
- アラートストーム防止が動作しない
- IaCデプロイ失敗（terraform apply エラー）

---

## 7. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| PM | PMエージェント |  |  |
