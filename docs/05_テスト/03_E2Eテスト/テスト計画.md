# E2Eテスト計画

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| フェーズ | E2Eテスト |
| バージョン | 1.0 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | Draft |

---

## 2. 概要

### 2.1 目的

エンドツーエンド（E2E）テストでは、ユーザーシナリオ全体を通してシステムが正常に動作することを確認します。特にPoCの成功基準である以下の3点を検証します:

1. **アラートストーム防止**: L0障害時にL2/L3アラートが抑制されること
2. **IaCデプロイ**: tenant-b, tenant-c の追加が変数設定のみで完了すること
3. **親子関係の可視化**: Datadog上で階層構造が確認できること

### 2.2 テスト対象

| シナリオ | 目的 | 優先度 |
|---------|------|--------|
| **アラートストーム防止検証** | Composite Monitorによるアラート抑制確認 | High |
| **IaCデプロイ検証** | Terraform for_eachによるテナント追加確認 | High |
| **親子関係可視化検証** | Datadog UIで階層構造確認 | High |

### 2.3 テスト方針

- **シナリオベーステスト**: 実際のユーザー操作フローを再現
- **手動テスト中心**: Datadog UI確認、スクリーンショット取得
- **テスト実施者**: QA
- **実施タイミング**: Day 3-4（テストフェーズ）

---

## 3. テストスコープ

### 3.1 アラートストーム防止検証

#### 3.1.1 テストシナリオ

| シナリオID | シナリオ名 | 目的 |
|-----------|----------|------|
| E2E-001 | L0障害時のアラート抑制 | L0-Composite のみアラート、L2/L3は抑制 |
| E2E-002 | L2障害時のアラート抑制 | L2-Composite のみアラート、L3は抑制 |
| E2E-003 | L3障害のみ（親は正常） | L3-Composite のみアラート |

#### 3.1.2 確認ポイント

- [ ] Datadog Event Stream で通知履歴を確認
- [ ] 親レイヤー障害時に子レイヤーアラートが抑制されている
- [ ] NOT条件が正しく機能している

### 3.2 IaCデプロイ検証

#### 3.2.1 テストシナリオ

| シナリオID | シナリオ名 | 目的 |
|-----------|----------|------|
| E2E-004 | tenant-b 追加デプロイ | Terraform for_eachでテナント追加 |
| E2E-005 | tenant-c 追加デプロイ | Terraform for_eachでテナント追加 |
| E2E-006 | 既存テナントへの影響なし | tenant-a のMonitorに変更なし |

#### 3.2.2 確認ポイント

- [ ] terraform apply 成功
- [ ] tenant-b, tenant-c 用のL3 Monitor作成
- [ ] tenant-a のMonitorに影響なし

### 3.3 親子関係可視化検証

#### 3.3.1 確認ポイント

- [ ] Datadog UI > Monitors > Manage Monitors で階層構造表示
- [ ] Composite Monitorの式にNOT条件が含まれる
- [ ] Monitor Dependencies（依存関係）が正しく設定されている

---

## 4. テストスケジュール

### 4.1 実施スケジュール

| Day | タスク | 成果物 |
|-----|------|--------|
| **Day 3** | アラートストーム防止検証（E2E-001〜003） | スクリーンショット、結果レポート |
| **Day 4** | IaCデプロイ検証（E2E-004〜006） | terraform apply 結果、Datadog Monitor確認 |

### 4.2 所要時間見積もり

| タスク | 所要時間 |
|------|---------|
| テスト環境セットアップ | 1時間 |
| E2E-001: L0障害注入・確認 | 2時間 |
| E2E-002: L2障害注入・確認 | 2時間 |
| E2E-003: L3障害注入・確認 | 1時間 |
| E2E-004: tenant-b 追加 | 1時間 |
| E2E-005: tenant-c 追加 | 1時間 |
| E2E-006: 既存テナント確認 | 1時間 |
| 結果レポート作成 | 2時間 |
| **合計** | **11時間（約1.5営業日）** |

---

## 5. テスト環境

### 5.1 AWS環境

| リソース | 構成 | 用途 |
|---------|------|------|
| **ECS Fargate** | demo-api コンテナ | L2/L3障害注入 |
| **RDS PostgreSQL** | データベース | L0障害シミュレーション |
| **ALB** | ロードバランサー | L2障害シミュレーション |
| **Datadog Agent** | ログ・メトリクス収集 | L0障害シミュレーション |

### 5.2 Datadog環境

| 項目 | 内容 |
|------|------|
| **Monitors** | L0: 7個、L2: 4個、L3: 9個、Composite: 5個 |
| **Event Stream** | アラート通知履歴確認 |
| **UI確認** | Monitors > Manage Monitors |

### 5.3 Terraform環境

| 項目 | 内容 |
|------|------|
| **Terraform** | 1.0+ |
| **Datadog Provider** | 3.x |
| **State管理** | DynamoDB Lock使用 |

---

## 6. 合格基準

### 6.1 テストケース合格基準

| テストシナリオ | 合格基準 |
|------------|---------|
| **E2E-001** | L0-Composite のみ通知、L2/L3-Composite は抑制 |
| **E2E-002** | L2-Composite のみ通知、L3-Composite は抑制 |
| **E2E-003** | L3-Composite のみ通知、L0/L2は正常 |
| **E2E-004** | tenant-b 追加成功、L3 Monitor 3個作成 |
| **E2E-005** | tenant-c 追加成功、L3 Monitor 3個作成 |
| **E2E-006** | tenant-a のMonitorに変更なし |

### 6.2 品質基準

**合格条件**:
- [ ] E2Eテスト: 100%パス（6/6）
- [ ] アラートストーム防止: 正常動作（PoCの成功基準）
- [ ] IaCデプロイ: 正常動作（PoCの成功基準）
- [ ] 親子関係可視化: 確認完了（PoCの成功基準）
- [ ] Critical/High不具合: 0件

**不合格条件**:
- E2Eテスト失敗が1件でもある
- アラートストーム防止が動作しない（複数Compositeが同時に通知）
- IaCデプロイ失敗（terraform apply エラー）

---

## 7. リスクと対策

### 7.1 テストリスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| **Datadog無料トライアル期限切れ** | High | Medium | 早期にテスト開始、期限確認 |
| **障害注入失敗** | Medium | Medium | 手動ALERT設定で代替 |
| **Terraform state ロック競合** | Medium | Low | DynamoDB Lock使用、手動unlock |
| **AWS環境不安定** | High | Low | ECS/RDS ヘルスチェック確認 |

### 7.2 対策の優先順位

1. **Datadog無料トライアル期限確認**: Day 0（テスト開始前）
2. **AWS環境ヘルスチェック**: Day 3（E2Eテスト開始前）
3. **Terraform state バックアップ**: Day 4（terraform apply前）

---

## 8. 参照ドキュメント

| ドキュメント | パス | 用途 |
|------------|------|------|
| **要件定義書** | docs/02_要件定義/要件定義書.md | 成功基準確認 |
| **監視設計** | docs/04_インフラ設計/01_基本設計/05_監視設計.md | Composite Monitor仕様確認 |
| **テストフェーズガイド** | .claude/docs/10_facilitation/2.5_テストフェーズ/PHASE_GUIDE.md | E2Eテスト手法確認 |

---

## 9. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| PM | PMエージェント |  |  |
