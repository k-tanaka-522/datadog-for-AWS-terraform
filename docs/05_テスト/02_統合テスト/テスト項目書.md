# 統合テスト項目書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| フェーズ | 統合テスト |
| バージョン | 2.0 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | Draft |
| 更新内容 | 単体テストとの連動を明確化（前提となる単体テスト追加） |

---

## 2. 統合テストの目的と単体テストとの関係

### 2.1 統合テストの位置づけ

**統合テスト = 単体テスト済みコンポーネントの連携検証**

- **テスト対象**: 単体テスト済みコンポーネント間の連携（API-DB、Terraform-Datadog）
- **参照設計書**:
  - 基本設計（コンポーネント間連携）: `docs/03_アプリケーション設計/01_基本設計/`
  - 基本設計（インフラ連携）: `docs/04_インフラ設計/01_基本設計/`
- **テスト方法**: ブラックボックステスト（外部から見た動作確認）

### 2.2 単体テストとの連動関係

```
単体テスト（UT-*）
  ↓ 完了・合格（前提条件）
統合テスト（IT-*）
  ↓ 完了・合格
E2Eテスト
```

**重要**: 各統合テスト項目には「前提となる単体テスト」を明記します。

---

## 3. 前提条件の確認

### 3.1 単体テスト完了チェックリスト

**以下のすべてが完了していることを確認してから統合テストを開始**:

- [ ] 単体テスト全件合格（22/22件）
- [ ] カバレッジ80%以上達成
- [ ] Terraform validate 成功
- [ ] Critical/High不具合0件

**参照**: `docs/05_テスト/01_単体テスト/テスト項目書.md § 7.1`

**未完了の場合**: 統合テストを開始せず、単体テストに戻る。

---

## 4. API統合テスト項目

### 4.1 ヘルスチェックAPI

**対応基本設計**: `docs/03_アプリケーション設計/01_基本設計/04_API設計.md § 2.1`

| テストID | テストケース | HTTP Method | URL | Request Body | 期待結果 | 前提となる単体テスト | 優先度 | 実施状況 |
|---------|------------|------------|-----|--------------|---------|----------------|--------|---------|
| IT-API-001 | グローバルヘルスチェック（RDS疎通含む） | GET | /health | - | HTTP 200, {"status": "ok", "database": "connected"} | UT-API-001（ヘルスチェック単体）<br>UT-DB-002（DB接続確認） | High | 未実施 |
| IT-API-002 | テナント別ヘルスチェック（tenant-a） | GET | /tenant-a/health | - | HTTP 200, {"status": "ok", "tenant_id": "tenant-a", "database": "connected"} | UT-API-002（テナントヘルス単体）<br>UT-DB-002（DB接続確認） | High | 未実施 |
| IT-API-003 | テナント別ヘルスチェック（tenant-b） | GET | /tenant-b/health | - | HTTP 200, {"status": "ok", "tenant_id": "tenant-b", "database": "connected"} | UT-API-003（テナントヘルス単体）<br>UT-DB-002（DB接続確認） | High | 未実施 |
| IT-API-004 | テナント別ヘルスチェック（tenant-c） | GET | /tenant-c/health | - | HTTP 200, {"status": "ok", "tenant_id": "tenant-c", "database": "connected"} | UT-API-003（テナントヘルス単体）<br>UT-DB-002（DB接続確認） | High | 未実施 |
| IT-API-005 | 不正なテナントID | GET | /invalid-tenant/health | - | HTTP 404, {"detail": "Tenant not found"} | UT-API-004（不正テナント単体） | Medium | 未実施 |

**単体テストとの違い**:
- 単体テスト: API単体のロジック確認（DBはモック）
- 統合テスト: API + RDS PostgreSQL の連携確認（実際のDB接続）

---

### 4.2 障害シミュレーションAPI

**対応基本設計**: `docs/03_アプリケーション設計/01_基本設計/04_API設計.md § 2.2`

| テストID | テストケース | HTTP Method | URL | Request Body | 期待結果 | 前提となる単体テスト | 優先度 | 実施状況 |
|---------|------------|------------|-----|--------------|---------|----------------|--------|---------|
| IT-API-006 | エラーシミュレーション（tenant-a） | POST | /tenant-a/simulate/error | {"count": 10, "message": "Simulated error for testing"} | HTTP 200, エラーログがDatadog Logsに記録される | UT-API-011（エラー生成単体） | High | 未実施 |
| IT-API-007 | レイテンシシミュレーション（tenant-a） | POST | /tenant-a/simulate/latency | {"duration_ms": 2000} | HTTP 200, 2秒以上の遅延, Datadog APMにトレース記録 | UT-API-012（レイテンシ生成単体） | High | 未実施 |

**単体テストとの違い**:
- 単体テスト: 障害シミュレーションロジックの確認
- 統合テスト: Datadog APM/Logs への統合確認（実際のDatadog環境へのデータ送信）

---

### 4.3 サンプルデータCRUD API

**対応基本設計**: `docs/03_アプリケーション設計/01_基本設計/04_API設計.md § 2.3`

| テストID | テストケース | HTTP Method | URL | Request Body | 期待結果 | 前提となる単体テスト | 優先度 | 実施状況 |
|---------|------------|------------|-----|--------------|---------|----------------|--------|---------|
| IT-API-008 | アイテム一覧取得（tenant-a） | GET | /tenant-a/items | - | HTTP 200, tenant-aのitemsリスト | UT-API-005（一覧取得単体）<br>UT-DB-002（テナント別クエリ） | High | 未実施 |
| IT-API-009 | アイテム作成（tenant-a） | POST | /tenant-a/items | {"name": "test-item", "description": "test"} | HTTP 201, {"id": 1, "name": "test-item", "tenant_id": "tenant-a"} | UT-API-006（作成単体）<br>UT-DB-001（アイテム保存） | High | 未実施 |
| IT-API-010 | アイテム詳細取得（tenant-a） | GET | /tenant-a/items/{id} | - | HTTP 200, 該当item | UT-API-007（詳細取得単体）<br>UT-DB-002（テナント別クエリ） | Medium | 未実施 |
| IT-API-011 | 他テナントのアイテムにアクセス（テナント分離確認） | GET | /tenant-a/items/{tenant-b-item-id} | - | HTTP 404, {"detail": "Item not found"} | UT-API-010（テナント分離単体）<br>UT-DB-002（テナント別クエリ） | High | 未実施 |

**単体テストとの違い**:
- 単体テスト: API単体のロジック確認（DBはモック）
- 統合テスト: API + RDS PostgreSQL の連携確認（実際のCRUD操作）

---

### 4.4 管理API

**対応基本設計**: `docs/03_アプリケーション設計/01_基本設計/04_API設計.md § 2.4`

| テストID | テストケース | HTTP Method | URL | Request Body | 期待結果 | 前提となる単体テスト | 優先度 | 実施状況 |
|---------|------------|------------|-----|--------------|---------|----------------|--------|---------|
| IT-API-012 | シャットダウン（テスト用） | POST | /admin/shutdown | - | HTTP 200, {"message": "Shutdown initiated"} | - | Low | 未実施 |

---

## 5. Terraform dry-run テスト項目

### 5.1 初回デプロイ・冪等性確認

**対応基本設計**: `docs/04_インフラ設計/01_基本設計/10_IaC方針.md`

| テストID | テストケース | 手順 | 期待結果 | 前提となる単体テスト | 優先度 | 実施状況 |
|---------|------------|------|---------|----------------|--------|---------|
| IT-TF-001 | 初回デプロイ（dry-run） | terraform plan -out=tfplan | Plan: 25 to add, 0 to change, 0 to destroy<br>L0: 7個, L2: 4個, L3: 9個, Composite: 5個 作成予定 | UT-TF-001（構文検証）<br>UT-TF-002（フォーマット確認）<br>UT-TF-003（Provider確認） | High | 未実施 |
| IT-TF-002 | 冪等性確認（2回目plan） | terraform plan（apply後） | No changes（差分なし） | UT-TF-001（構文検証）<br>UT-TF-002（フォーマット確認） | High | 未実施 |

**単体テストとの違い**:
- 単体テスト: Terraform構文・変数の検証
- 統合テスト: 全モジュールの統合確認（level0, level2, level3, composite の連携）

---

### 5.2 テナント追加

**対応基本設計**: `docs/04_インフラ設計/01_基本設計/10_IaC方針.md`

| テストID | テストケース | 手順 | 期待結果 | 前提となる単体テスト | 優先度 | 実施状況 |
|---------|------------|------|---------|----------------|--------|---------|
| IT-TF-003 | tenant-b 追加（dry-run） | tfvars に tenant-b 追加 → terraform plan | Plan: 4 to add, 0 to change, 0 to destroy<br>L3 Monitor 3個, L3 Composite 1個 追加予定 | UT-TF-004（必須変数検証）<br>UT-TF-005（変数型検証） | High | 未実施 |
| IT-TF-004 | tenant-c 追加（dry-run） | tfvars に tenant-c 追加 → terraform plan | Plan: 4 to add, 0 to change, 0 to destroy<br>L3 Monitor 3個, L3 Composite 1個 追加予定 | UT-TF-004（必須変数検証）<br>UT-TF-005（変数型検証） | High | 未実施 |

**単体テストとの違い**:
- 単体テスト: 変数定義の検証
- 統合テスト: テナント追加時の実際のTerraformモジュール連携確認（for_each の動作確認）

---

### 5.3 構文検証

**対応基本設計**: `docs/04_インフラ設計/01_基本設計/10_IaC方針.md`

| テストID | テストケース | 手順 | 期待結果 | 前提となる単体テスト | 優先度 | 実施状況 |
|---------|------------|------|---------|----------------|--------|---------|
| IT-TF-005 | 構文検証 | terraform validate | Exit code: 0, "Success!" メッセージ | UT-TF-001（構文検証単体） | High | 未実施 |

---

## 6. Datadog統合確認テスト項目

### 6.1 APM統合確認

**対応基本設計**: `docs/04_インフラ設計/01_基本設計/05_監視設計.md`

| テストID | テストケース | 確認方法 | 期待結果 | 前提となる単体テスト | 優先度 | 実施状況 |
|---------|------------|---------|---------|----------------|--------|---------|
| IT-DD-001 | demo-api サービス表示 | Datadog UI > APM > Services | demo-api サービスが表示される | UT-API-001〜013（API単体テスト） | High | 未実施 |
| IT-DD-002 | トレースデータ記録 | Datadog UI > APM > Traces | API呼び出しのトレースが記録されている | UT-API-001〜013（API単体テスト） | High | 未実施 |
| IT-DD-003 | p99レイテンシ測定 | Datadog UI > APM > Services > demo-api | p99レイテンシが表示される | UT-API-012（レイテンシ生成単体） | Medium | 未実施 |

**単体テストとの違い**:
- 単体テスト: API単体のロジック確認
- 統合テスト: Datadog APM への統合確認（実際のトレースデータ送信）

---

### 6.2 Logs統合確認

**対応基本設計**: `docs/04_インフラ設計/01_基本設計/05_監視設計.md`

| テストID | テストケース | 確認方法 | 期待結果 | 前提となる単体テスト | 優先度 | 実施状況 |
|---------|------------|---------|---------|----------------|--------|---------|
| IT-DD-004 | ログ記録確認 | Datadog UI > Logs > Explorer | demo-api のログが記録されている | UT-API-001〜013（API単体テスト） | High | 未実施 |
| IT-DD-005 | テナントID記録 | フィルタ: `service:demo-api tenant_id:tenant-a` | tenant-a のログが表示される | UT-API-002（テナントヘルス単体） | High | 未実施 |
| IT-DD-006 | エラーログ記録 | フィルタ: `service:demo-api status:error` | エラーログが記録されている（エラーシミュレーション実行後） | UT-API-011（エラー生成単体） | High | 未実施 |

**単体テストとの違い**:
- 単体テスト: ログ生成ロジックの確認
- 統合テスト: Datadog Logs への統合確認（実際のログデータ送信、テナントID記録確認）

---

## 7. テスト実行記録

### 7.1 テスト実施サマリ

| カテゴリ | 計画数 | 実施数 | 合格数 | 不合格数 | 合格率 | 前提単体テスト |
|--------|-------|-------|-------|---------|--------|------------|
| ヘルスチェックAPI | 5 | - | - | - | - | UT-API-001〜004, UT-DB-002 |
| 障害シミュレーションAPI | 2 | - | - | - | - | UT-API-011, UT-API-012 |
| CRUD API | 4 | - | - | - | - | UT-API-005〜010, UT-DB-001〜002 |
| 管理API | 1 | - | - | - | - | - |
| Terraform dry-run | 5 | - | - | - | - | UT-TF-001〜005 |
| Datadog APM統合 | 3 | - | - | - | - | UT-API-001〜013 |
| Datadog Logs統合 | 3 | - | - | - | - | UT-API-001〜013 |
| **合計** | **23** | **-** | **-** | **-** | **-** | - |

---

### 7.2 詳細テスト結果（実施後に記入）

#### API統合テスト結果

| テストID | 実施日 | 実施者 | 結果 | 備考 | 前提単体テスト確認 |
|---------|-------|-------|------|------|---------------|
| IT-API-001 | - | QA | - | - | ✅ / ❌ |
| IT-API-002 | - | QA | - | - | ✅ / ❌ |
| IT-API-003 | - | QA | - | - | ✅ / ❌ |
| IT-API-004 | - | QA | - | - | ✅ / ❌ |
| IT-API-005 | - | QA | - | - | ✅ / ❌ |
| IT-API-006 | - | QA | - | - | ✅ / ❌ |
| IT-API-007 | - | QA | - | - | ✅ / ❌ |
| IT-API-008 | - | QA | - | - | ✅ / ❌ |
| IT-API-009 | - | QA | - | - | ✅ / ❌ |
| IT-API-010 | - | QA | - | - | ✅ / ❌ |
| IT-API-011 | - | QA | - | - | ✅ / ❌ |
| IT-API-012 | - | QA | - | - | ✅ / ❌ |

#### Terraform dry-run結果

| テストID | 実施日 | 実施者 | 結果 | 備考 | 前提単体テスト確認 |
|---------|-------|-------|------|------|---------------|
| IT-TF-001 | - | QA | - | - | ✅ / ❌ |
| IT-TF-002 | - | QA | - | - | ✅ / ❌ |
| IT-TF-003 | - | QA | - | - | ✅ / ❌ |
| IT-TF-004 | - | QA | - | - | ✅ / ❌ |
| IT-TF-005 | - | QA | - | - | ✅ / ❌ |

#### Datadog統合確認結果

| テストID | 実施日 | 実施者 | 結果 | 備考 | 前提単体テスト確認 |
|---------|-------|-------|------|------|---------------|
| IT-DD-001 | - | QA | - | - | ✅ / ❌ |
| IT-DD-002 | - | QA | - | - | ✅ / ❌ |
| IT-DD-003 | - | QA | - | - | ✅ / ❌ |
| IT-DD-004 | - | QA | - | - | ✅ / ❌ |
| IT-DD-005 | - | QA | - | - | ✅ / ❌ |
| IT-DD-006 | - | QA | - | - | ✅ / ❌ |

---

## 8. テスト環境情報（実施時に記入）

### 8.1 AWS環境

| 項目 | 内容 |
|------|------|
| **ALB DNS名** | - |
| **ECS Cluster名** | - |
| **RDS Endpoint** | - |
| **VPC ID** | - |
| **実施日時** | - |

### 8.2 Datadog環境

| 項目 | 内容 |
|------|------|
| **アカウント** | - |
| **API Key（最初の4文字のみ）** | - |
| **App Key（最初の4文字のみ）** | - |
| **実施日時** | - |

---

## 9. 不具合管理

### 9.1 発見された不具合（実施時に記入）

| 不具合ID | 発見日 | テストID | 内容 | 優先度 | ステータス | 原因となった単体テスト不足 |
|---------|-------|---------|------|--------|---------|-------------------|
| - | - | - | - | - | - | - |

---

## 10. 合格判定

### 10.1 合格条件

**以下の全条件を満たす場合、統合テスト合格と判定**:
- [ ] **前提条件**: 単体テスト100%合格、カバレッジ80%以上
- [ ] API統合テスト: 100%パス（12/12）
- [ ] Terraform dry-run: 100%パス（5/5）
- [ ] Datadog統合確認: 100%パス（6/6）
- [ ] Critical/High不具合: 0件
- [ ] **単体テストとの整合性**: すべてのテスト項目が前提となる単体テストを明記している

### 10.2 判定結果（実施後に記入）

| 判定項目 | 結果 | 備考 |
|---------|------|------|
| 前提条件（単体テスト完了） | - | - |
| API統合テスト合格率 | - | - |
| Terraform dry-run合格率 | - | - |
| Datadog統合確認合格率 | - | - |
| Critical/High不具合数 | - | - |
| **総合判定** | **-** | **-** |

---

## 11. 単体テストとの整合性確認結果

### 11.1 前提となる単体テストの完了状況

| 統合テスト項目 | 前提となる単体テスト | 単体テスト完了状況 | 備考 |
|-------------|---------------|---------------|------|
| IT-API-001〜005 | UT-API-001〜004, UT-DB-002 | QA確認必要 | - |
| IT-API-006〜007 | UT-API-011, UT-API-012 | QA確認必要 | - |
| IT-API-008〜011 | UT-API-005〜010, UT-DB-001〜002 | QA確認必要 | - |
| IT-TF-001〜005 | UT-TF-001〜005 | QA確認必要 | - |
| IT-DD-001〜006 | UT-API-001〜013 | QA確認必要 | - |

**整合性判定**: QA確認後に記入

---

## 12. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |
| 2025-12-28 | 2.0 | 単体テストとの連動を明確化（前提となる単体テスト追加） | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| PM | PMエージェント |  |  |
