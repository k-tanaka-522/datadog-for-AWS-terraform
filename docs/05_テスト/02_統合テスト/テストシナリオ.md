# 統合テストシナリオ

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| フェーズ | 統合テスト |
| バージョン | 1.0 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | Draft |

---

## 2. 概要

統合テストでは、API-DB連携、Terraform-Datadog連携が正常に動作することを確認します。実際のAWS環境・Datadog環境を使用したブラックボックステストです。

---

## 3. API統合テストシナリオ

### 3.1 前提条件

- [ ] AWS環境が構築済み（ECS、RDS、ALB、VPC）
- [ ] demo-api がデプロイ済み（ECS Task実行中）
- [ ] Datadog Agent が起動済み
- [ ] テストデータがRDSに投入済み
- [ ] ALB DNS名が判明している

### 3.2 テスト手順

#### シナリオ1: グローバルヘルスチェック（IT-API-001）

**ステップ1: APIエンドポイント呼び出し**
```bash
curl -X GET https://{ALB_DNS}/health
```

**期待される応答**:
```json
{
  "status": "ok",
  "database": "connected",
  "timestamp": "2025-12-28T12:00:00Z"
}
```

**判定基準**:
- [ ] ステータスコード: 200
- [ ] "status": "ok"
- [ ] "database": "connected"
- [ ] レスポンスタイム: 500ms以内

**pytestテストコード例**:
```python
def test_global_health_check():
    response = httpx.get(f"https://{ALB_DNS}/health")
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "ok"
    assert data["database"] == "connected"
    assert response.elapsed.total_seconds() < 0.5
```

---

#### シナリオ2: テナント別ヘルスチェック（IT-API-002〜004）

**ステップ1: tenant-a ヘルスチェック**
```bash
curl -X GET https://{ALB_DNS}/tenant-a/health
```

**期待される応答**:
```json
{
  "status": "ok",
  "tenant_id": "tenant-a",
  "database": "connected",
  "timestamp": "2025-12-28T12:00:00Z"
}
```

**判定基準**:
- [ ] ステータスコード: 200
- [ ] "tenant_id": "tenant-a"（正しいテナントID）
- [ ] "status": "ok"
- [ ] "database": "connected"

**ステップ2: tenant-b, tenant-c も同様にテスト**

**pytestテストコード例**:
```python
@pytest.mark.parametrize("tenant_id", ["tenant-a", "tenant-b", "tenant-c"])
def test_tenant_health_check(tenant_id):
    response = httpx.get(f"https://{ALB_DNS}/{tenant_id}/health")
    assert response.status_code == 200
    data = response.json()
    assert data["tenant_id"] == tenant_id
    assert data["status"] == "ok"
```

---

#### シナリオ3: 不正なテナントID（IT-API-005）

**ステップ1: 存在しないテナントIDでアクセス**
```bash
curl -X GET https://{ALB_DNS}/invalid-tenant/health
```

**期待される応答**:
```json
{
  "detail": "Tenant not found"
}
```

**判定基準**:
- [ ] ステータスコード: 404
- [ ] "detail"にエラーメッセージが含まれる

---

#### シナリオ4: エラーシミュレーション（IT-API-006）

**ステップ1: tenant-a でエラーを10回発生させる**
```bash
curl -X POST https://{ALB_DNS}/tenant-a/simulate/error \
  -H "Content-Type: application/json" \
  -d '{"count": 10, "message": "Simulated error for testing"}'
```

**期待される応答**:
```json
{
  "message": "Simulated 10 errors for tenant-a"
}
```

**ステップ2: Datadog Logsでエラーログ確認**
1. Datadog UI（Logs > Explorer）を開く
2. フィルタ: `service:demo-api tenant_id:tenant-a status:error`
3. 期待される結果: エラーログが10件以上記録されている

**判定基準**:
- [ ] ステータスコード: 200（シミュレーション成功）
- [ ] Datadog Logsにエラーログが記録されている
- [ ] エラーログのメッセージが正しい

---

#### シナリオ5: レイテンシシミュレーション（IT-API-007）

**ステップ1: tenant-a で2秒遅延を発生させる**
```bash
curl -X POST https://{ALB_DNS}/tenant-a/simulate/latency \
  -H "Content-Type: application/json" \
  -d '{"duration_ms": 2000}'
```

**期待される応答**:
```json
{
  "message": "Simulated latency: 2000ms",
  "actual_duration_ms": 2005
}
```

**ステップ2: レスポンスタイム測定**
```bash
time curl -X POST https://{ALB_DNS}/tenant-a/simulate/latency \
  -H "Content-Type: application/json" \
  -d '{"duration_ms": 2000}'
```

**判定基準**:
- [ ] ステータスコード: 200
- [ ] レスポンスタイム: 2秒以上
- [ ] Datadog APMにトレースが記録されている

---

#### シナリオ6: CRUD API（IT-API-008〜011）

**ステップ1: アイテム一覧取得**
```bash
curl -X GET https://{ALB_DNS}/tenant-a/items
```

**期待される応答**:
```json
[
  {"id": 1, "name": "Item 1", "tenant_id": "tenant-a"},
  {"id": 2, "name": "Item 2", "tenant_id": "tenant-a"}
]
```

**ステップ2: アイテム作成**
```bash
curl -X POST https://{ALB_DNS}/tenant-a/items \
  -H "Content-Type: application/json" \
  -d '{"name": "test-item", "description": "test description"}'
```

**期待される応答**:
```json
{
  "id": 3,
  "name": "test-item",
  "description": "test description",
  "tenant_id": "tenant-a",
  "created_at": "2025-12-28T12:00:00Z"
}
```

**ステップ3: アイテム詳細取得**
```bash
curl -X GET https://{ALB_DNS}/tenant-a/items/3
```

**期待される応答**:
```json
{
  "id": 3,
  "name": "test-item",
  "tenant_id": "tenant-a"
}
```

**ステップ4: 他テナントのアイテムにアクセス（テナント分離確認）**
```bash
# tenant-b からアクセス（tenant-aのアイテムIDを使用）
curl -X GET https://{ALB_DNS}/tenant-b/items/3
```

**期待される応答**:
```json
{
  "detail": "Item not found"
}
```

**判定基準**:
- [ ] ステータスコード: 404（テナント分離成功）

---

## 4. Terraform dry-runシナリオ

### 4.1 前提条件

- [ ] Terraform初期化済み（terraform init完了）
- [ ] Datadog API Key / App Key が設定済み
- [ ] tfvars ファイルが準備済み

### 4.2 テスト手順

#### シナリオ7: 初回デプロイ dry-run（IT-TF-001）

**ステップ1: terraform plan実行**
```bash
cd c:\dev2\datadog-fro-AWS-terraform\infra\terraform
terraform plan -out=tfplan
```

**期待される結果**:
```
Plan: 25 to add, 0 to change, 0 to destroy
```

**ステップ2: 作成予定リソース確認**
```bash
terraform show tfplan
```

**確認事項**:
- [ ] L0 Monitor: 7個（RDS CPU/接続数/メモリ/ストレージ、ECS Tasks、VPC Flow、Datadog Agent）
- [ ] L2 Monitor: 4個（ALB Health、ECS Task異常停止、ECR脆弱性、E2Eヘルスチェック）
- [ ] L3 Monitor: 9個（tenant-a/b/c × 3種類）
- [ ] Composite Monitor: 5個（L0-Composite、L2-Composite、L3-Composite × 3テナント）

**判定基準**:
- [ ] Exit code: 0（エラーなし）
- [ ] Plan: 25 to add, 0 to change, 0 to destroy
- [ ] 削除予定リソースがない

---

#### シナリオ8: 冪等性確認（IT-TF-002）

**前提**: シナリオ7のterraform apply実行後

**ステップ1: terraform plan実行（2回目）**
```bash
terraform plan
```

**期待される結果**:
```
No changes. Your infrastructure matches the configuration.
```

**判定基準**:
- [ ] Exit code: 0
- [ ] "No changes"メッセージ表示
- [ ] 差分なし

---

#### シナリオ9: tenant-b 追加 dry-run（IT-TF-003）

**ステップ1: tfvars編集**
```hcl
# terraform.tfvars
tenants = {
  "tenant-a" = { name = "Tenant A" },
  "tenant-b" = { name = "Tenant B" }  # 追加
}
```

**ステップ2: terraform plan実行**
```bash
terraform plan
```

**期待される結果**:
```
Plan: 4 to add, 0 to change, 0 to destroy
```

**ステップ3: 作成予定リソース確認**
- [ ] L3 Monitor: 3個（Health、Error、Latency for tenant-b）
- [ ] L3 Composite: 1個（L3-Composite-tenant-b）

**判定基準**:
- [ ] Plan: 4 to add
- [ ] 既存リソース（tenant-a）に変更なし

---

#### シナリオ10: tenant-c 追加 dry-run（IT-TF-004）

**ステップ1: tfvars編集**
```hcl
# terraform.tfvars
tenants = {
  "tenant-a" = { name = "Tenant A" },
  "tenant-b" = { name = "Tenant B" },
  "tenant-c" = { name = "Tenant C" }  # 追加
}
```

**ステップ2: terraform plan実行**
```bash
terraform plan
```

**期待される結果**:
```
Plan: 4 to add, 0 to change, 0 to destroy
```

**判定基準**:
- [ ] Plan: 4 to add
- [ ] tenant-a, tenant-b に変更なし

---

#### シナリオ11: 構文検証（IT-TF-005）

**ステップ1: terraform validate実行**
```bash
terraform validate
```

**期待される結果**:
```
Success! The configuration is valid.
```

**判定基準**:
- [ ] Exit code: 0
- [ ] "Success!"メッセージ表示

---

## 5. 期待結果サマリ

### 5.1 API統合テスト

| シナリオ | 期待結果 | 優先度 |
|---------|---------|--------|
| シナリオ1: グローバルヘルスチェック | HTTP 200, "status": "ok" | High |
| シナリオ2: テナント別ヘルスチェック | HTTP 200, テナントID正しい | High |
| シナリオ3: 不正なテナントID | HTTP 404 | Medium |
| シナリオ4: エラーシミュレーション | HTTP 200, Datadog Logsに記録 | High |
| シナリオ5: レイテンシシミュレーション | HTTP 200, 2秒以上遅延 | High |
| シナリオ6: CRUD API | HTTP 200/201, テナント分離確認 | High |

### 5.2 Terraform dry-run

| シナリオ | 期待結果 | 優先度 |
|---------|---------|--------|
| シナリオ7: 初回デプロイ dry-run | Plan: 25 to add | High |
| シナリオ8: 冪等性確認 | No changes | High |
| シナリオ9: tenant-b 追加 | Plan: 4 to add | High |
| シナリオ10: tenant-c 追加 | Plan: 4 to add | High |
| シナリオ11: 構文検証 | Success! | High |

---

## 6. 合格判定

### 6.1 合格条件

**以下の全条件を満たす場合、統合テスト合格と判定**:
- [ ] API統合テスト: 全シナリオ成功（6/6）
- [ ] Terraform dry-run: 全シナリオ成功（5/5）
- [ ] Datadog APM/Logs統合確認: データ収集成功
- [ ] Critical/High不具合: 0件

### 6.2 不合格条件

以下のいずれかに該当する場合、不合格:
- API統合テスト失敗が1件でもある
- Terraform dry-run失敗が1件でもある
- Datadog統合失敗（データ収集されない）

---

## 7. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| PM | PMエージェント |  |  |
