# 統合テスト計画

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| フェーズ | 統合テスト |
| バージョン | 2.0 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | Draft |
| 更新内容 | 単体テストとの連動を明確化（前提条件追加） |

---

## 2. 概要

### 2.1 目的

モジュール間連携（API-DB、Terraform-Datadog）が正常に動作することを確認する。単体テストでは確認できない、システム全体の統合動作を検証する。

### 2.2 単体テストとの関係

**統合テスト = 単体テスト済みコンポーネントの連携検証**

```
単体テスト（UT-*）
  ↓ 完了・合格
統合テスト（IT-*）
  ↓ 完了・合格
E2Eテスト
```

**重要**: 統合テストは単体テスト完了を前提とする。

---

## 3. 前提条件

### 3.1 単体テスト完了条件

**以下のすべてが完了している必要がある**:

| 前提条件 | 確認方法 | ステータス |
|---------|---------|---------|
| ✅ 単体テスト全件合格 | `docs/05_テスト/01_単体テスト/テスト項目書.md` 参照 | Coder実施済み |
| ✅ カバレッジ80%以上 | pytest --cov=src --cov-report=term | Coder確認済み |
| ✅ Terraform validate 成功 | terraform validate | Coder実施済み |
| ✅ Critical/High不具合0件 | `docs/05_テスト/01_単体テスト/テスト項目書.md § 7.1` | - |

**前提となる単体テスト**:
- UT-API-001〜013（API単体テスト）
- UT-DB-001〜004（DB単体テスト）
- UT-TF-001〜005（Terraform単体テスト）

**前提条件を満たさない場合**: 統合テストは実施せず、単体テストに戻る。

---

### 3.2 環境準備完了条件

| 前提条件 | 確認方法 | 担当 |
|---------|---------|------|
| ✅ AWS環境構築完了 | ALB DNS解決、RDS接続確認 | SRE |
| ✅ Datadog環境準備完了 | API Key/App Key設定、Datadog UI接続確認 | SRE |
| ✅ テストデータ投入完了 | RDS PostgreSQLに初期データ投入 | SRE |

---

## 4. テストスコープ

### 4.1 API統合テスト

**基本設計との対応**: `docs/03_アプリケーション設計/01_基本設計/04_API設計.md`

#### 4.1.1 対象エンドポイント

| カテゴリ | エンドポイント数 | 優先度 | 参照設計 |
|--------|-------------|--------|---------|
| ヘルスチェック | 4（グローバル + 3テナント） | High | `04_API設計.md § 2.1` |
| 障害シミュレーション | 3（エラー、レイテンシ、CPU） | High | `04_API設計.md § 2.2` |
| CRUD API | 3（一覧、作成、詳細） | Medium | `04_API設計.md § 2.3` |
| 管理API | 1（シャットダウン） | Low | `04_API設計.md § 2.4` |

#### 4.1.2 テスト環境

| 項目 | 内容 | 参照設計 |
|------|------|---------|
| **テスト方法** | pytest + httpx（HTTP Client） | - |
| **テスト対象** | 実際のALB経由のAPI呼び出し | `01_基本設計/02_コンポーネント設計.md` |
| **データベース** | RDS PostgreSQL（テストデータ投入済み） | `01_基本設計/03_データモデル.md` |
| **Datadog** | 実際のDatadog環境にデータ送信 | `01_基本設計/05_セキュリティ設計.md` |

---

### 4.2 Terraform dry-run

**基本設計との対応**: `docs/04_インフラ設計/01_基本設計/10_IaC方針.md`

#### 4.2.1 対象モジュール

| モジュール | テスト内容 | 優先度 | 参照設計 |
|--------|----------|--------|---------|
| level0-infra | L0 Monitor（7個）の作成予定確認 | High | `02_詳細設計/level0-infra/01_モジュール詳細設計.md` |
| level2-service | L2 Monitor（4個）の作成予定確認 | High | `02_詳細設計/level2-service/01_モジュール詳細設計.md` |
| level3-tenant | L3 Monitor（9個）の作成予定確認 | High | `02_詳細設計/level3-tenant/01_モジュール詳細設計.md` |
| composite | Composite Monitor（5個）の作成予定確認 | High | `02_詳細設計/composite/01_モジュール詳細設計.md` |

#### 4.2.2 テスト項目

| テストケース | 内容 | 期待結果 | 前提となる単体テスト |
|------------|------|---------|----------------|
| 初回デプロイ dry-run | terraform plan -out=tfplan | Plan: 25 to add, 0 to change, 0 to destroy | UT-TF-001, UT-TF-002 |
| 冪等性確認 | terraform plan（apply後） | No changes | UT-TF-001, UT-TF-002 |
| tenant-b 追加 | tfvars編集 → plan | L3 Monitor 3個、L3 Composite 1個 追加予定 | UT-TF-003 |
| tenant-c 追加 | tfvars編集 → plan | L3 Monitor 3個、L3 Composite 1個 追加予定 | UT-TF-003 |

---

## 5. テストスケジュール

### 5.1 実施スケジュール

| Day | タスク | 成果物 | 前提条件 |
|-----|------|--------|---------|
| **Day 0** | 前提条件確認（単体テスト完了確認） | チェックリスト | 単体テスト全件合格 |
| **Day 1** | API統合テスト（8エンドポイント） | tests/integration/test_api.py | UT-API-001〜013完了 |
| **Day 2** | Terraform dry-run（全モジュール） | terraform plan 結果、冪等性確認 | UT-TF-001〜005完了 |

### 5.2 所要時間見積もり

| タスク | 所要時間 | 依存タスク |
|------|---------|----------|
| 前提条件確認（単体テスト結果確認） | 0.5時間 | - |
| テスト環境セットアップ | 1時間 | 前提条件確認完了 |
| API統合テストコード作成 | 3時間 | UT-API-001〜013完了 |
| API統合テスト実行 | 1時間 | API統合テストコード作成完了 |
| Terraform dry-run実施 | 2時間 | UT-TF-001〜005完了 |
| 結果レポート作成 | 1時間 | すべてのテスト完了 |
| **合計** | **8.5時間（約1営業日）** | - |

---

## 6. テスト環境

### 6.1 ローカル環境

| 項目 | 内容 |
|------|------|
| **OS** | Windows 11 |
| **開発ディレクトリ** | c:\dev2\datadog-fro-AWS-terraform |
| **Python** | 3.10+ |
| **pytest** | 最新版 |
| **httpx** | APIテスト用HTTPクライアント |
| **Terraform** | 1.0+ |

### 6.2 AWS環境

| リソース | 構成 |
|---------|------|
| **ALB** | demo-api へのロードバランシング |
| **ECS Fargate** | demo-api コンテナ実行環境 |
| **RDS PostgreSQL** | データベース（items テーブル） |
| **VPC** | プライベートサブネット（ECS、RDS） |

### 6.3 Datadog環境

| 項目 | 内容 |
|------|------|
| **アカウント** | Datadog 無料トライアル（または既存アカウント） |
| **API Key / App Key** | 環境変数に設定済み |
| **監視対象** | demo-api（APM、Logs、Monitors） |

---

## 7. テストデータ

### 7.1 テストテナント

| テナントID | 用途 |
|-----------|------|
| tenant-a | 既存テナント（初期構成） |
| tenant-b | 追加テナント（Terraform dry-run確認用） |
| tenant-c | 追加テナント（Terraform dry-run確認用） |

### 7.2 テストアイテム

| アイテム名 | テナントID | 用途 |
|----------|-----------|------|
| test-item-1 | tenant-a | CRUD API確認用 |
| test-item-2 | tenant-a | CRUD API確認用 |
| test-item-3 | tenant-b | テナント分離確認用 |

---

## 8. 合格基準

### 8.1 テストケース合格基準

| テストレベル | 合格基準 | 測定方法 | 前提となる単体テスト |
|------------|---------|---------|----------------|
| **API統合テスト** | 100%パス（8エンドポイント） | pytest実行結果 | UT-API-001〜013（100%合格） |
| **Terraform dry-run** | 100%パス（5ケース） | terraform plan 結果 | UT-TF-001〜005（100%合格） |

### 8.2 品質基準

**合格条件**:
- [ ] **前提条件**: 単体テスト100%合格、カバレッジ80%以上
- [ ] API統合テスト: 100%パス（8/8）
- [ ] Terraform dry-run: 100%パス（5/5）
- [ ] Datadog APM/Logs統合確認: データ収集成功
- [ ] Critical/High不具合: 0件

**不合格条件**:
- **前提条件未達**: 単体テストが完了していない
- API統合テスト失敗が1件でもある
- Terraform dry-run失敗が1件でもある
- Datadog統合失敗（データ収集されない）

---

## 9. リスクと対策

### 9.1 テストリスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| **単体テスト未完了** | High | Medium | Day 0で前提条件確認、未完了なら統合テスト延期 |
| **ALB DNS解決失敗** | High | Low | /etc/hosts 設定、AWS CLI確認 |
| **RDS接続失敗** | High | Low | Security Group確認、接続文字列確認 |
| **Datadog API Key無効** | Medium | Low | 環境変数確認、API Key再生成 |
| **Terraform state ロック** | Medium | Low | DynamoDB Lock確認、手動unlock |

### 9.2 対策の優先順位

1. **単体テスト完了確認**: テスト開始前（Day 0）
2. **AWS環境ヘルスチェック**: テスト開始前（Day 1開始前）
3. **Datadog API Key確認**: テスト開始前（Day 1開始前）
4. **Terraform state バックアップ**: terraform plan前（Day 2開始前）

---

## 10. 参照ドキュメント

| ドキュメント | パス | 用途 |
|------------|------|------|
| **単体テスト** | | |
| 単体テスト項目書 | `docs/05_テスト/01_単体テスト/テスト項目書.md` | 前提条件確認 |
| **基本設計** | | |
| API設計 | `docs/03_アプリケーション設計/01_基本設計/04_API設計.md` | APIエンドポイント仕様確認 |
| 監視設計 | `docs/04_インフラ設計/01_基本設計/05_監視設計.md` | Datadog Monitor仕様確認 |
| **詳細設計** | | |
| アプリ詳細設計INDEX | `docs/03_アプリケーション設計/02_詳細設計/INDEX.md` | モジュール構成確認 |
| インフラ詳細設計INDEX | `docs/04_インフラ設計/02_詳細設計/INDEX.md` | Terraformモジュール構成確認 |
| **技術標準** | | |
| Python技術標準 | `.claude/docs/40_standards/41_app/languages/python.md` | テストコード規約確認 |
| Terraform技術標準 | `.claude/docs/40_standards/46_iac/terraform.md` | Terraformテスト規約確認 |

---

## 11. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |
| 2025-12-28 | 2.0 | 単体テストとの連動を明確化（前提条件追加） | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| PM | PMエージェント |  |  |
