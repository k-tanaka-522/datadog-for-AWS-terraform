# 障害注入テスト項目書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| フェーズ | 障害注入テスト |
| バージョン | 1.0 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | Draft |

---

## 2. L0レイヤー障害注入テスト項目

| テストID | Monitor | 障害注入方法 | 期待結果 | 優先度 | 実施状況 |
|---------|---------|------------|---------|--------|---------|
| MON-L0-001 | L0-RDS-CPU | Datadog API経由でCPU 95%メトリクス送信 | 5分以内にALERT状態、通知送信 | High | 未実施 |
| MON-L0-002 | L0-RDS-Conn | 手動ALERT設定（Datadog UI） | ALERT状態、通知送信 | Medium | 未実施 |
| MON-L0-003 | L0-RDS-Mem | 手動ALERT設定（Datadog UI） | ALERT状態、通知送信 | Medium | 未実施 |
| MON-L0-004 | L0-RDS-Storage | 手動ALERT設定（Datadog UI） | ALERT状態、通知送信 | Medium | 未実施 |
| MON-L0-005 | L0-ECS-Tasks | aws ecs stop-task | 5分以内にALERT状態、通知送信 | High | 未実施 |
| MON-L0-006 | L0-VPC-Flow | 手動ALERT設定（Datadog UI） | ALERT状態、通知送信 | Low | 未実施 |
| MON-L0-007 | L0-Agent | Datadog Agent Task停止（aws ecs stop-task） | 5分以内にALERT状態、通知送信 | Medium | 未実施 |

---

## 3. L2レイヤー障害注入テスト項目

| テストID | Monitor | 障害注入方法 | 期待結果 | 優先度 | 実施状況 |
|---------|---------|------------|---------|--------|---------|
| MON-L2-001 | L2-ALB-Health | ECS Task全停止（aws ecs update-service --desired-count 0） | 5分以内にALERT状態、通知送信 | High | 未実施 |
| MON-L2-002 | L2-ECS-Task | aws ecs stop-task | 5分以内にALERT状態、通知送信 | High | 未実施 |
| MON-L2-003 | L2-ECR-Vuln | 手動ALERT設定（Datadog UI） | ALERT状態、通知送信 | Low | 未実施 |
| MON-L2-004 | L2-E2E-Health（FR-002-5） | ECS Task全停止により/healthエンドポイント失敗 | 5分以内にALERT状態、通知送信 | High | 未実施 |

---

## 4. L3レイヤー障害注入テスト項目（tenant-a）

| テストID | Monitor | 障害注入方法 | 期待結果 | 優先度 | 実施状況 |
|---------|---------|------------|---------|--------|---------|
| MON-L3-001 | L3-Health-tenant-a（FR-003-1） | 手動ALERT設定（または/health失敗） | 5分以内にALERT状態、通知送信 | High | 未実施 |
| MON-L3-002 | L3-Error-tenant-a | POST /tenant-a/simulate/error {"count": 10, "message": "..."} | 5分以内にALERT状態、通知送信、Datadog Logsに10件以上記録 | High | 未実施 |
| MON-L3-003 | L3-Latency-tenant-a | POST /tenant-a/simulate/latency {"duration_ms": 2000}を10回実行 | 5分以内にALERT状態、通知送信、p99レイテンシ > 1秒 | High | 未実施 |

**注意**: tenant-b, tenant-c も同様に実施（計9個のMonitor）

---

## 5. Composite Monitor検証テスト項目

| テストID | Composite Monitor | テスト方法 | 期待結果 | 優先度 | 実施状況 |
|---------|------------------|----------|---------|--------|---------|
| MON-COMP-001 | L0-Composite | いずれかのL0 MonitorをALERT状態にする | L0-Composite がALERT状態、通知送信 | High | 未実施 |
| MON-COMP-002 | L2-Composite | L2 MonitorをALERT、L0は正常 | L2-Composite がALERT状態、通知送信 | High | 未実施 |
| MON-COMP-003 | L2-Composite（L0障害時） | L0 MonitorをALERT、L2 MonitorもALERT | L2-Composite は抑制（NOT L0-Composite により）、通知なし | High | 未実施 |
| MON-COMP-004 | L3-Composite-tenant-a | L3 Monitor（tenant-a）をALERT、L0/L2は正常 | L3-Composite-tenant-a がALERT状態、通知送信 | High | 未実施 |
| MON-COMP-005 | L3-Composite-tenant-a（L0/L2障害時） | L0またはL2 MonitorをALERT、L3もALERT | L3-Composite-tenant-a は抑制（NOT (L0 OR L2)-Composite により）、通知なし | High | 未実施 |

---

## 6. リカバリーテスト項目

| テストID | テストケース | 手順 | 期待結果 | 優先度 | 実施状況 |
|---------|------------|------|---------|--------|---------|
| MON-REC-001 | L0 Monitor復旧 | 障害解消後5分待機 | 5分以内にOK状態、リカバリー通知送信 | High | 未実施 |
| MON-REC-002 | L2 Monitor復旧 | 障害解消後5分待機 | 5分以内にOK状態、リカバリー通知送信 | High | 未実施 |
| MON-REC-003 | L3 Monitor復旧 | 障害解消後5分待機 | 5分以内にOK状態、リカバリー通知送信 | High | 未実施 |
| MON-REC-004 | Composite Monitor復旧 | 全子Monitorが復旧 | Composite MonitorもOK状態 | High | 未実施 |
| MON-REC-005 | 全レイヤー障害→復旧 | L0→L2→L3の順に復旧 | 段階的に復旧、通知順序正しい（L0→L2→L3） | High | 未実施 |

---

## 7. テスト実行記録

### 7.1 テスト実施サマリ

| カテゴリ | 計画数 | 実施数 | 合格数 | 不合格数 | 合格率 |
|--------|-------|-------|-------|---------|--------|
| L0レイヤー障害注入 | 7 | - | - | - | - |
| L2レイヤー障害注入 | 4 | - | - | - | - |
| L3レイヤー障害注入（tenant-a） | 3 | - | - | - | - |
| L3レイヤー障害注入（tenant-b） | 3 | - | - | - | - |
| L3レイヤー障害注入（tenant-c） | 3 | - | - | - | - |
| Composite Monitor検証 | 5 | - | - | - | - |
| リカバリーテスト | 5 | - | - | - | - |
| **合計** | **30** | **-** | **-** | **-** | **-** |

### 7.2 詳細テスト結果（実施後に記入）

#### L0レイヤー障害注入

| テストID | 実施日 | 実施者 | 結果 | 障害注入時刻 | ALERT検知時刻 | 検知時間 | 備考 |
|---------|-------|-------|------|-----------|------------|---------|------|
| MON-L0-001 | - | QA | - | - | - | - | - |
| MON-L0-002 | - | QA | - | - | - | - | - |
| MON-L0-003 | - | QA | - | - | - | - | - |
| MON-L0-004 | - | QA | - | - | - | - | - |
| MON-L0-005 | - | QA | - | - | - | - | - |
| MON-L0-006 | - | QA | - | - | - | - | - |
| MON-L0-007 | - | QA | - | - | - | - | - |

#### L2レイヤー障害注入

| テストID | 実施日 | 実施者 | 結果 | 障害注入時刻 | ALERT検知時刻 | 検知時間 | 備考 |
|---------|-------|-------|------|-----------|------------|---------|------|
| MON-L2-001 | - | QA | - | - | - | - | - |
| MON-L2-002 | - | QA | - | - | - | - | - |
| MON-L2-003 | - | QA | - | - | - | - | - |
| MON-L2-004 | - | QA | - | - | - | - | - |

#### L3レイヤー障害注入（全テナント）

| テストID | 実施日 | 実施者 | 結果 | 障害注入時刻 | ALERT検知時刻 | 検知時間 | 備考 |
|---------|-------|-------|------|-----------|------------|---------|------|
| MON-L3-001 (tenant-a) | - | QA | - | - | - | - | - |
| MON-L3-002 (tenant-a) | - | QA | - | - | - | - | - |
| MON-L3-003 (tenant-a) | - | QA | - | - | - | - | - |
| MON-L3-001 (tenant-b) | - | QA | - | - | - | - | - |
| MON-L3-002 (tenant-b) | - | QA | - | - | - | - | - |
| MON-L3-003 (tenant-b) | - | QA | - | - | - | - | - |
| MON-L3-001 (tenant-c) | - | QA | - | - | - | - | - |
| MON-L3-002 (tenant-c) | - | QA | - | - | - | - | - |
| MON-L3-003 (tenant-c) | - | QA | - | - | - | - | - |

#### Composite Monitor検証

| テストID | 実施日 | 実施者 | 結果 | 通知送信 | 通知抑制 | 備考 |
|---------|-------|-------|------|---------|---------|------|
| MON-COMP-001 | - | QA | - | - | - | - |
| MON-COMP-002 | - | QA | - | - | - | - |
| MON-COMP-003 | - | QA | - | - | - | - |
| MON-COMP-004 | - | QA | - | - | - | - |
| MON-COMP-005 | - | QA | - | - | - | - |

#### リカバリーテスト

| テストID | 実施日 | 実施者 | 結果 | 障害解消時刻 | 復旧確認時刻 | リカバリー時間 | 備考 |
|---------|-------|-------|------|-----------|------------|------------|------|
| MON-REC-001 | - | QA | - | - | - | - | - |
| MON-REC-002 | - | QA | - | - | - | - | - |
| MON-REC-003 | - | QA | - | - | - | - | - |
| MON-REC-004 | - | QA | - | - | - | - | - |
| MON-REC-005 | - | QA | - | - | - | - | - |

---

## 8. 障害注入コマンド集

### 8.1 L0レイヤー障害注入コマンド

#### RDS CPU高負荷シミュレーション
```bash
curl -X POST "https://api.datadoghq.com/api/v1/series" \
  -H "Content-Type: application/json" \
  -H "DD-API-KEY: ${DATADOG_API_KEY}" \
  -d '{
    "series": [{
      "metric": "aws.rds.cpuutilization",
      "points": [['"$(date +%s)"', 95]],
      "type": "gauge",
      "host": "rds-instance-id",
      "tags": ["env:poc"]
    }]
  }'
```

#### ECS Task停止
```bash
aws ecs stop-task --cluster ${CLUSTER_NAME} --task ${TASK_ARN} --reason "Testing L0 Monitor"
```

#### Datadog Agent停止
```bash
aws ecs stop-task --cluster ${CLUSTER_NAME} --task ${AGENT_TASK_ARN} --reason "Testing L0 Monitor"
```

### 8.2 L2レイヤー障害注入コマンド

#### ECS Task全停止（ALB Health失敗）
```bash
aws ecs update-service --cluster ${CLUSTER_NAME} --service demo-api --desired-count 0
```

#### ECS Task再起動（リカバリー）
```bash
aws ecs update-service --cluster ${CLUSTER_NAME} --service demo-api --desired-count 2
```

### 8.3 L3レイヤー障害注入コマンド

#### エラーシミュレーション
```bash
curl -X POST https://${ALB_DNS}/tenant-a/simulate/error \
  -H "Content-Type: application/json" \
  -d '{"count": 10, "message": "Simulated error for testing"}'
```

#### レイテンシシミュレーション（10回繰り返し）
```bash
for i in {1..10}; do
  curl -X POST https://${ALB_DNS}/tenant-a/simulate/latency \
    -H "Content-Type: application/json" \
    -d '{"duration_ms": 2000}'
  sleep 1
done
```

#### CPU負荷シミュレーション
```bash
curl -X GET https://${ALB_DNS}/tenant-a/simulate/cpu
```

---

## 9. 不具合管理

### 9.1 発見された不具合（実施時に記入）

| 不具合ID | 発見日 | テストID | Monitor | 内容 | 優先度 | ステータス |
|---------|-------|---------|---------|------|--------|---------|
| - | - | - | - | - | - | - |

---

## 10. 合格判定

### 10.1 合格条件

**以下の全条件を満たす場合、障害注入テスト合格と判定**:
- [ ] L0 Monitor（7個）: 100%パス（7/7）
- [ ] L2 Monitor（4個）: 100%パス（4/4）
- [ ] L3 Monitor（9個）: 100%パス（9/9）
- [ ] Composite Monitor（5個）: 100%パス（5/5）
- [ ] リカバリーテスト: 100%パス（5/5）
- [ ] 検知時間: 5分以内（NFR-007準拠）
- [ ] リカバリー時間: 5分以内（NFR-007準拠）
- [ ] Critical/High不具合: 0件

### 10.2 判定結果（実施後に記入）

| 判定項目 | 結果 | 備考 |
|---------|------|------|
| L0レイヤー合格率 | - | - |
| L2レイヤー合格率 | - | - |
| L3レイヤー合格率 | - | - |
| Composite Monitor合格率 | - | - |
| リカバリーテスト合格率 | - | - |
| 平均検知時間 | - | - |
| 平均リカバリー時間 | - | - |
| Critical/High不具合数 | - | - |
| **総合判定** | **-** | **-** |

---

## 11. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| PM | PMエージェント |  |  |
