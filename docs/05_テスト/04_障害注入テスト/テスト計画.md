# 障害注入テスト計画

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| フェーズ | 障害注入テスト |
| バージョン | 1.0 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | Draft |

---

## 2. 概要

### 2.1 目的

障害注入テストでは、意図的に障害を発生させてDatadog Monitorが正しくアラートを発火することを確認します。L0/L2/L3の各レイヤーで障害を注入し、監視動作を検証します。

### 2.1 目的

障害注入テストでは、意図的に障害を発生させてDatadog Monitorが正しくアラートを発火することを確認します。L0/L2/L3の各レイヤーで障害を注入し、監視動作を検証します。

### 2.2 テスト対象

| レイヤー | テスト対象 | Monitor数 | 優先度 |
|--------|----------|---------|--------|
| **L0: インフラ監視** | RDS CPU/接続数/メモリ/ストレージ、ECS Tasks、VPC Flow、Datadog Agent | 7個 | High |
| **L2: サービス監視** | ALB Health、ECS Task異常停止、ECR脆弱性、E2Eヘルスチェック | 4個 | High |
| **L3: テナント監視** | テナント別ヘルスチェック、エラーログ、レイテンシ | 9個（3種類×3テナント） | High |
| **Composite Monitor** | L0/L2/L3 親子関係、アラート抑制 | 5個 | High |

### 2.3 テスト方針

- **障害注入テスト**: 意図的に障害を発生させて監視動作を確認
- **手動テスト中心**: Datadog UI確認、AWS CLI操作、APIリクエスト
- **リカバリーテスト含む**: 障害解消後の復旧確認
- **テスト実施者**: QA
- **実施タイミング**: Day 5-6（テストフェーズ）

---

## 3. テストスコープ

### 3.1 L0レイヤー障害注入

| Monitor | 障害注入方法 | 優先度 |
|---------|------------|--------|
| L0-RDS-CPU | Datadog API経由でメトリクス送信（CPU 95%） | High |
| L0-RDS-Conn | 手動ALERT設定 | Medium |
| L0-RDS-Mem | 手動ALERT設定 | Medium |
| L0-RDS-Storage | 手動ALERT設定 | Medium |
| L0-ECS-Tasks | aws ecs stop-task | High |
| L0-VPC-Flow | 手動ALERT設定 | Low |
| L0-Agent | Datadog Agent Task停止 | Medium |

### 3.2 L2レイヤー障害注入

| Monitor | 障害注入方法 | 優先度 |
|---------|------------|--------|
| L2-ALB-Health | ECS Task全停止（aws ecs update-service --desired-count 0） | High |
| L2-ECS-Task | aws ecs stop-task | High |
| L2-ECR-Vuln | 手動ALERT設定 | Low |
| L2-E2E-Health | /health エンドポイント失敗（ECS停止により自動的に失敗） | High |

### 3.3 L3レイヤー障害注入

| Monitor | 障害注入方法 | 優先度 |
|---------|------------|--------|
| L3-Health-tenant-a | 手動ALERT設定（または/health失敗） | High |
| L3-Error-tenant-a | POST /tenant-a/simulate/error {"count": 10, "message": "..."} | High |
| L3-Latency-tenant-a | POST /tenant-a/simulate/latency {"duration_ms": 2000} | High |

**注意**: tenant-b, tenant-c も同様に実施（計9個のMonitor）

---

## 4. 障害注入API仕様

### 4.1 エラーシミュレーションAPI

**エンドポイント**: `POST /{tenant_id}/simulate/error`

**Request Body**:
```json
{
  "count": 10,
  "message": "Simulated error for testing"
}
```

**Response**:
```json
{
  "message": "Simulated 10 errors for tenant-a"
}
```

### 4.2 レイテンシシミュレーションAPI

**エンドポイント**: `POST /{tenant_id}/simulate/latency`

**Request Body**:
```json
{
  "duration_ms": 2000
}
```

**Response**:
```json
{
  "message": "Simulated latency: 2000ms",
  "actual_duration_ms": 2005
}
```

### 4.3 CPU負荷シミュレーションAPI

**エンドポイント**: `GET /{tenant_id}/simulate/cpu`

**Response**:
```json
{
  "message": "CPU load simulated",
  "duration_seconds": 10
}
```

---

## 5. テストスケジュール

### 5.1 実施スケジュール

| Day | タスク | 成果物 |
|-----|------|--------|
| **Day 5** | L0/L2障害注入テスト | 障害注入手順書、結果ログ |
| **Day 6** | L3障害注入テスト、Composite Monitor確認 | 監視動作確認100%パス |

### 5.2 所要時間見積もり

| タスク | 所要時間 |
|------|---------|
| 障害注入手順書作成 | 1時間 |
| L0障害注入テスト（7個） | 3時間 |
| L2障害注入テスト（4個） | 2時間 |
| L3障害注入テスト（9個） | 3時間 |
| Composite Monitor確認（5個） | 2時間 |
| リカバリーテスト | 2時間 |
| 結果レポート作成 | 1時間 |
| **合計** | **14時間（約2営業日）** |

---

## 6. テスト環境

### 6.1 AWS環境

| リソース | 用途 |
|---------|------|
| **ECS Fargate** | Task停止（L0/L2障害注入） |
| **RDS PostgreSQL** | メトリクス送信（L0障害注入） |
| **ALB** | ヘルスチェック失敗（L2障害注入） |
| **Datadog Agent** | Task停止（L0障害注入） |

### 6.2 Datadog環境

| 項目 | 内容 |
|------|------|
| **Monitors** | L0: 7個、L2: 4個、L3: 9個、Composite: 5個 |
| **Event Stream** | アラート通知確認 |
| **API** | メトリクス送信用 |

---

## 7. 合格基準

### 7.1 テストケース合格基準

| レイヤー | 合格基準 | 測定方法 |
|--------|---------|---------|
| **L0 Monitor** | 100%パス（7/7） | 障害注入後5分以内にALERT状態遷移 |
| **L2 Monitor** | 100%パス（4/4） | 障害注入後5分以内にALERT状態遷移 |
| **L3 Monitor** | 100%パス（9/9） | 障害注入後5分以内にALERT状態遷移 |
| **Composite Monitor** | 100%パス（5/5） | NOT条件によるアラート抑制確認 |
| **リカバリー** | 5分以内に復旧 | 障害解消後5分以内にOK状態遷移 |

### 7.2 品質基準

**合格条件**:
- [ ] 全Monitor（25個）が障害注入時にALERT状態遷移
- [ ] Composite Monitorが正しく動作（親子関係確認）
- [ ] リカバリー時間5分以内（NFR-007準拠）
- [ ] Critical/High不具合: 0件

**不合格条件**:
- Monitorが障害注入時にALERT状態に遷移しない
- Composite Monitorが誤動作（アラートストーム発生）
- リカバリー時間が5分を超える

---

## 8. リスクと対策

### 8.1 テストリスク

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| **AWS環境破壊** | High | Low | 本番環境では実施しない、バックアップ取得 |
| **Datadog無料トライアル期限切れ** | High | Medium | 早期にテスト開始 |
| **障害注入失敗** | Medium | Medium | 手動ALERT設定で代替 |
| **リカバリー失敗** | Medium | Low | 手順書を事前作成 |

### 8.2 対策の優先順位

1. **AWS環境バックアップ**: テスト開始前
2. **Datadog無料トライアル期限確認**: テスト開始前
3. **障害注入手順書作成**: Day 5開始前
4. **リカバリー手順書作成**: Day 5開始前

---

## 9. 参照ドキュメント

| ドキュメント | パス | 用途 |
|------------|------|------|
| **監視設計** | docs/04_インフラ設計/01_基本設計/05_監視設計.md | Monitor仕様確認 |
| **API設計** | docs/03_アプリケーション設計/02_詳細設計/02_API設計.md | 障害注入API仕様確認 |
| **テストフェーズガイド** | .claude/docs/10_facilitation/2.5_テストフェーズ/PHASE_GUIDE.md | 障害注入テスト手法確認 |

---

## 10. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| PM | PMエージェント |  |  |
