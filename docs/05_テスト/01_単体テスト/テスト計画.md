# 単体テスト計画

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| フェーズ | 単体テスト |
| バージョン | 1.0 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | 実装フェーズで完了済み |

---

## 2. 概要

### 2.1 目的

単体テストは実装フェーズでCoderによって既に完了済みです。本ドキュメントは、実施済みの単体テストの内容を記録し、カバレッジを確認するためのものです。

### 2.2 テスト対象

| コンポーネント | テスト対象 | テストツール |
|------------|----------|------------|
| **demo-api** | Python 3.10+ / FastAPI | pytest, pytest-cov |
| **Terraform** | Terraform 1.0+ / Datadog Provider 3.x | terraform validate |

### 2.3 テスト方針

- **ホワイトボックステスト**: 内部実装（コード）の確認
- **カバレッジ目標**: 80%以上
- **テスト実施者**: Coder（実装フェーズで完了）
- **テスト確認者**: QA（カバレッジレポート確認）

---

## 3. テストスコープ

### 3.1 demo-api 単体テスト

#### 3.1.1 テスト対象コンポーネント

| モジュール | テスト対象関数/クラス | 優先度 |
|--------|----------------|--------|
| **APIエンドポイント** | ヘルスチェック、テナント別ヘルスチェック、CRUD API | High |
| **データベースアクセス層** | SQLAlchemy モデル、クエリ関数 | High |
| **障害シミュレーション** | エラー生成、レイテンシ生成 | Medium |
| **Datadog統合** | ddtrace 統合、ログ出力 | Medium |

#### 3.1.2 テストケースパターン

| パターン | 説明 | 例 |
|--------|------|------|
| **正常系** | 期待される入力で正常動作を確認 | `test_health_check_success()` |
| **異常系** | 不正な入力でエラーハンドリングを確認 | `test_invalid_tenant_id()` |
| **境界値** | 最大値・最小値・境界値での動作確認 | `test_max_item_name_length()` |
| **NULL/空値** | NULL・空文字列での動作確認 | `test_empty_item_name()` |

### 3.2 Terraform モジュール単体テスト

#### 3.2.1 テスト対象モジュール

| モジュール | テスト内容 | 優先度 |
|--------|---------|--------|
| **level0-infra** | L0 Monitor定義の構文検証 | High |
| **level2-service** | L2 Monitor定義の構文検証 | High |
| **level3-tenant** | L3 Monitor定義の構文検証、for_each動作確認 | High |
| **composite** | Composite Monitor定義の構文検証、NOT条件確認 | High |

#### 3.2.2 テストケース

| テストID | テストケース | コマンド | 期待結果 |
|---------|------------|---------|---------|
| UT-TF-001 | Terraform構文検証 | `terraform validate` | Exit code: 0 |
| UT-TF-002 | Terraform fmt確認 | `terraform fmt -check` | フォーマット済み |
| UT-TF-003 | Provider設定確認 | `terraform providers` | Datadog Provider 3.x |

---

## 4. カバレッジ目標

### 4.1 コードカバレッジ

| 対象 | 目標カバレッジ | 測定方法 |
|------|--------------|---------|
| **demo-api全体** | 80%以上 | pytest-cov |
| **APIエンドポイント** | 90%以上 | pytest-cov（関数単位） |
| **データベースアクセス層** | 85%以上 | pytest-cov（関数単位） |
| **障害シミュレーション** | 75%以上 | pytest-cov（関数単位） |

### 4.2 カバレッジレポート確認手順

```bash
# カバレッジレポート生成
cd c:\dev2\datadog-fro-AWS-terraform
pytest tests/unit/ --cov=src --cov-report=html --cov-report=term

# HTMLレポート確認
open htmlcov/index.html
```

### 4.3 カバレッジ不足時の対応

| カバレッジ | 対応方針 |
|----------|---------|
| 80%以上 | 合格 |
| 70-79% | 警告（重要な関数がカバーされていればOK） |
| 70%未満 | 不合格（Coderに追加テスト依頼） |

---

## 5. テスト環境

### 5.1 ローカル環境

| 項目 | 内容 |
|------|------|
| **OS** | Windows 11 |
| **開発ディレクトリ** | c:\dev2\datadog-fro-AWS-terraform |
| **Python** | 3.10+ |
| **pytest** | 最新版 |
| **pytest-cov** | 最新版 |
| **Terraform** | 1.0+ |

### 5.2 テストデータ

| データ種別 | 内容 |
|---------|------|
| **モックデータ** | RDS接続、Datadog APM（pytest-mock使用） |
| **テストテナント** | tenant-test-a, tenant-test-b |
| **テストアイテム** | items テーブル（メモリ内DB使用） |

---

## 6. テスト実施記録

### 6.1 実施状況

| 項目 | 内容 |
|------|------|
| **実施日** | 実装フェーズで完了 |
| **実施者** | Coder |
| **テストコード格納場所** | tests/unit/ |
| **カバレッジレポート** | coverage/ |

### 6.2 カバレッジ結果（Coder実施済み）

**確認事項**:
- [ ] pytest実行結果: 全テスト合格
- [ ] カバレッジレポート: 80%以上達成
- [ ] tests/unit/ にテストコードが存在する
- [ ] coverage/ にカバレッジレポートが存在する

**QAの役割**:
- 上記4点を確認し、単体テストが適切に実施されていることを確認する
- カバレッジ不足があればCoderに追加テスト依頼

---

## 7. 合格基準

### 7.1 テストケース合格基準

| 基準 | 目標値 | 測定方法 |
|------|--------|---------|
| **全テスト合格率** | 100% | pytest実行結果 |
| **カバレッジ** | 80%以上 | pytest-cov |
| **Terraform構文検証** | Exit code: 0 | terraform validate |

### 7.2 品質基準

**合格条件**:
- [ ] pytest実行結果: 全テスト合格（失敗0件）
- [ ] カバレッジ: 80%以上
- [ ] Terraform validate: Exit code 0
- [ ] 重大な欠陥なし（Critical/High不具合0件）

**不合格条件**:
- pytest失敗が1件でもある
- カバレッジ80%未満
- Terraform validate失敗

---

## 8. 参照ドキュメント

| ドキュメント | パス | 用途 |
|------------|------|------|
| **Python技術標準** | .claude/docs/40_standards/41_app/languages/python.md | テストコード規約確認 |
| **Terraform技術標準** | .claude/docs/40_standards/46_iac/terraform.md | Terraformテスト規約確認 |
| **単体テストガイド** | .claude/docs/10_facilitation/2.5_テストフェーズ/PHASE_GUIDE.md | テスト手法確認 |

---

## 9. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| Coder | Coderエージェント | 実装フェーズで完了 | ✅ |
| PM | PMエージェント |  |  |
