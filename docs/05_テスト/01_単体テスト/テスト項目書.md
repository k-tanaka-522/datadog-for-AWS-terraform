# 単体テスト項目書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Datadog for AWS Terraform PoC |
| フェーズ | 単体テスト |
| バージョン | 2.0 |
| 作成日 | 2025-12-28 |
| 作成者 | QA |
| ステータス | 実装フェーズで完了済み |
| 更新内容 | 設計書との連動を明確化（詳細設計参照を追加） |

---

## 2. 単体テストの目的と設計書との関係

### 2.1 単体テストの位置づけ

**単体テスト = 詳細設計の検証**

- **テスト対象**: 詳細設計で定義された各関数・クラス単位
- **参照設計書**: `docs/03_アプリケーション設計/02_詳細設計/`
- **テスト方法**: ホワイトボックステスト（内部実装を知った上でのテスト）

### 2.2 設計書とテストの対応関係

```
詳細設計書（関数/クラス定義）
    ↓
単体テスト項目書（このドキュメント）
    ↓
テストコード（tests/unit/*.py）
```

**重要**: 各テスト項目には「対応する詳細設計セクション」を明記します。

---

## 3. demo-api 単体テスト項目

### 3.1 ヘルスチェックAPI

**対応設計**: `docs/03_アプリケーション設計/02_詳細設計/controllers/health.md`

| テストID | テストケース | 入力データ | 期待結果 | 対応する詳細設計 | 優先度 | 実施状況 |
|---------|------------|----------|---------|--------------|--------|---------|
| UT-API-001 | グローバルヘルスチェック | GET /health | HTTP 200, {"status": "ok", "database": "connected"} | `health.md § 4.1 get_health()` | High | Coder実施済み |
| UT-API-002 | テナント別ヘルスチェック（tenant-a） | GET /tenant-a/health | HTTP 200, {"tenant_id": "tenant-a", "status": "ok"} | `health.md § 4.2 get_tenant_health()` | High | Coder実施済み |
| UT-API-003 | テナント別ヘルスチェック（tenant-b） | GET /tenant-b/health | HTTP 200, {"tenant_id": "tenant-b", "status": "ok"} | `health.md § 4.2 get_tenant_health()` | High | Coder実施済み |
| UT-API-004 | 不正なテナントID | GET /invalid-tenant/health | HTTP 404, {"detail": "Tenant not found"} | `health.md § 4.2 get_tenant_health()`<br>`services/tenant_service.md § 4.1 validate_tenant()` | Medium | Coder実施済み |

**設計書の主要機能との対応**:
- `health_controller.py::get_health()` → UT-API-001
- `health_controller.py::get_tenant_health()` → UT-API-002, UT-API-003, UT-API-004
- `tenant_service.py::validate_tenant()` → UT-API-004

---

### 3.2 CRUD API

**対応設計**: `docs/03_アプリケーション設計/02_詳細設計/controllers/items.md`

| テストID | テストケース | 入力データ | 期待結果 | 対応する詳細設計 | 優先度 | 実施状況 |
|---------|------------|----------|---------|--------------|--------|---------|
| UT-API-005 | アイテム一覧取得 | GET /tenant-a/items | HTTP 200, []または[{...}] | `items.md § 4.1 get_items()`<br>`services/items_service.md § 4.1 get_items()` | High | Coder実施済み |
| UT-API-006 | アイテム作成（正常系） | POST /tenant-a/items {"name": "test", "description": "test"} | HTTP 201, {"id": 1, "name": "test", "tenant_id": "tenant-a"} | `items.md § 4.2 create_item()`<br>`services/items_service.md § 4.2 create_item()` | High | Coder実施済み |
| UT-API-007 | アイテム詳細取得 | GET /tenant-a/items/1 | HTTP 200, {"id": 1, "name": "test"} | `items.md § 4.3 get_item()`<br>`services/items_service.md § 4.3 get_item()` | Medium | Coder実施済み |
| UT-API-008 | アイテム名空文字列（異常系） | POST /tenant-a/items {"name": "", "description": "test"} | HTTP 422（Validation Error） | `items.md § 7 例外処理` | Medium | Coder実施済み |
| UT-API-009 | アイテム名長すぎる（境界値） | POST /tenant-a/items {"name": "x" * 256} | HTTP 422（Validation Error） | `items.md § 7 例外処理` | Low | Coder実施済み |
| UT-API-010 | テナント分離確認 | tenant-a でアイテム作成 → tenant-b からアクセス | HTTP 404 | `items.md § 4.3 get_item()`<br>`repositories/items_repository.md § 4.1 get_items_by_tenant()` | High | Coder実施済み |

**設計書の主要機能との対応**:
- `items_controller.py::get_items()` → UT-API-005
- `items_controller.py::create_item()` → UT-API-006, UT-API-008, UT-API-009
- `items_controller.py::get_item()` → UT-API-007, UT-API-010
- `items_repository.py::get_items_by_tenant()` → UT-API-010（テナント分離）

---

### 3.3 障害シミュレーションAPI

**対応設計**: `docs/03_アプリケーション設計/02_詳細設計/controllers/simulate.md`

| テストID | テストケース | 入力データ | 期待結果 | 対応する詳細設計 | 優先度 | 実施状況 |
|---------|------------|----------|---------|--------------|--------|---------|
| UT-API-011 | エラーシミュレーション | POST /tenant-a/simulate/error {"count": 10, "message": "test"} | HTTP 200, {"message": "Simulated 10 errors..."} | `simulate.md § 4.1 simulate_error()`<br>`services/monitoring_service.md § 4.1 generate_errors()` | High | Coder実施済み |
| UT-API-012 | レイテンシシミュレーション | POST /tenant-a/simulate/latency {"duration_ms": 2000} | HTTP 200, 2秒以上の遅延 | `simulate.md § 4.2 simulate_latency()`<br>`services/monitoring_service.md § 4.2 generate_latency()` | High | Coder実施済み |
| UT-API-013 | CPU負荷シミュレーション | GET /tenant-a/simulate/cpu | HTTP 200, CPU負荷発生 | `simulate.md § 4.3 simulate_cpu()` | Medium | Coder実施済み |

**設計書の主要機能との対応**:
- `simulate_controller.py::simulate_error()` → UT-API-011
- `simulate_controller.py::simulate_latency()` → UT-API-012
- `simulate_controller.py::simulate_cpu()` → UT-API-013
- `monitoring_service.py::generate_errors()` → UT-API-011
- `monitoring_service.py::generate_latency()` → UT-API-012

---

### 3.4 データベースアクセス層

**対応設計**: `docs/03_アプリケーション設計/02_詳細設計/repositories/items_repository.md`

| テストID | テストケース | 入力データ | 期待結果 | 対応する詳細設計 | 優先度 | 実施状況 |
|---------|------------|----------|---------|--------------|--------|---------|
| UT-DB-001 | アイテム保存 | Item(name="test", tenant_id="tenant-a") | 自動採番ID、created_at設定 | `items_repository.md § 4.3 save_item()`<br>`models/item.md § 3 クラス設計` | High | Coder実施済み |
| UT-DB-002 | テナント別クエリ | filter(tenant_id="tenant-a") | tenant-aのアイテムのみ返却 | `items_repository.md § 4.1 get_items_by_tenant()` | High | Coder実施済み |
| UT-DB-003 | アイテム更新 | item.name = "updated" → db.commit() | 更新成功 | `items_repository.md § 4.4 update_item()` | Medium | Coder実施済み |
| UT-DB-004 | アイテム削除 | db.delete(item) → db.commit() | 削除成功 | `items_repository.md § 4.5 delete_item()` | Medium | Coder実施済み |

**設計書の主要機能との対応**:
- `items_repository.py::save_item()` → UT-DB-001
- `items_repository.py::get_items_by_tenant()` → UT-DB-002
- `items_repository.py::update_item()` → UT-DB-003
- `items_repository.py::delete_item()` → UT-DB-004
- `item.py（SQLAlchemy Model）` → UT-DB-001

---

## 4. Terraform モジュール単体テスト項目

### 4.1 構文検証

**対応設計**: `docs/04_インフラ設計/02_詳細設計/root/01_ルートモジュール詳細設計.md`

| テストID | テストケース | コマンド | 期待結果 | 対応する詳細設計 | 優先度 | 実施状況 |
|---------|------------|---------|---------|--------------|--------|---------|
| UT-TF-001 | Terraform構文検証 | terraform validate | Success! The configuration is valid. | `root/01_ルートモジュール詳細設計.md § 6.1` | High | Coder実施済み |
| UT-TF-002 | Terraformフォーマット確認 | terraform fmt -check -recursive | Exit code 0 | `root/01_ルートモジュール詳細設計.md § 6.1` | Medium | Coder実施済み |
| UT-TF-003 | Provider設定確認 | terraform providers | Datadog Provider 3.x 表示 | `root/01_ルートモジュール詳細設計.md § 1.3 providers.tf` | High | Coder実施済み |

**設計書の主要機能との対応**:
- `providers.tf` → UT-TF-003
- `versions.tf` → UT-TF-001
- `main.tf`, `variables.tf` → UT-TF-001, UT-TF-002

---

### 4.2 変数検証

**対応設計**: `docs/04_インフラ設計/02_詳細設計/root/01_ルートモジュール詳細設計.md`

| テストID | テストケース | 入力データ | 期待結果 | 対応する詳細設計 | 優先度 | 実施状況 |
|---------|------------|----------|---------|--------------|--------|---------|
| UT-TF-004 | 必須変数不足（異常系） | terraform validate（変数未設定） | Error: Missing required variable | `root/01_ルートモジュール詳細設計.md § 1.2 variables.tf` | Medium | Coder実施済み |
| UT-TF-005 | 変数型検証 | 不正な型の変数設定 | Error: Invalid value for variable | `root/01_ルートモジュール詳細設計.md § 1.2 variables.tf` | Low | Coder実施済み |

**設計書の主要機能との対応**:
- `variables.tf`（必須変数定義） → UT-TF-004
- `variables.tf`（型定義） → UT-TF-005

---

## 5. カバレッジ確認項目

### 5.1 コードカバレッジ確認

**対応設計**: すべての詳細設計（全モジュール）

| 確認項目 | コマンド | 目標値 | 確認結果 | 対応する詳細設計 |
|---------|---------|--------|---------|--------------|
| 全体カバレッジ | pytest --cov=src --cov-report=term | 80%以上 | Coder確認済み | 全モジュール |
| HTMLレポート生成 | pytest --cov=src --cov-report=html | coverage/index.html生成 | Coder確認済み | - |
| カバレッジ詳細確認 | open coverage/index.html | 各モジュールのカバレッジ確認 | QA確認必要 | - |

---

### 5.2 カバレッジ不足箇所の特定

**対応設計**: 各モジュールの詳細設計 § 8 テスト方針

| モジュール | 期待カバレッジ | 確認方法 | 対応方針 | 対応する詳細設計 |
|---------|-------------|---------|---------|--------------|
| src/api.py | 90%以上 | coverage/index.html | カバレッジ不足があればCoderに追加テスト依頼 | `controllers/*.md § 8` |
| src/database.py | 85%以上 | coverage/index.html | カバレッジ不足があればCoderに追加テスト依頼 | `repositories/database.md § 8` |
| src/models.py | 95%以上 | coverage/index.html | モデル定義は高カバレッジ必須 | `models/item.md § 8` |
| src/simulate.py | 75%以上 | coverage/index.html | 障害シミュレーションは一部未カバーでもOK | `controllers/simulate.md § 8` |

---

## 6. QA確認チェックリスト

### 6.1 テストコード確認

- [ ] tests/unit/ ディレクトリにテストコードが存在する
- [ ] テストファイル命名規則: `test_*.py`
- [ ] テスト関数命名規則: `test_*`
- [ ] pytest実行結果: 全テスト合格
- [ ] **設計書との対応**: 各テストが詳細設計の関数/クラスをカバーしているか

### 6.2 カバレッジ確認

- [ ] pytest-cov 実行結果: 80%以上
- [ ] coverage/ ディレクトリにレポートが存在する
- [ ] HTMLレポートで各モジュールのカバレッジを確認
- [ ] カバレッジ不足箇所の洗い出し
- [ ] **設計書との対応**: 詳細設計 § 8 テスト方針のカバレッジ目標を満たしているか

### 6.3 Terraform確認

- [ ] terraform validate 成功
- [ ] terraform fmt -check 成功
- [ ] terraform providers でDatadog Provider確認
- [ ] **設計書との対応**: root/01_ルートモジュール詳細設計.md § 6.1 の検証項目を満たしているか

### 6.4 不具合確認

- [ ] Critical/High不具合: 0件
- [ ] Medium不具合: 許容範囲内（2件以下）
- [ ] Low不具合: 記録済み

---

## 7. 実施結果サマリ

### 7.1 テスト実施状況

| カテゴリ | 計画数 | 実施数 | 合格数 | 不合格数 | 合格率 | 対応設計書 |
|--------|-------|-------|-------|---------|--------|----------|
| ヘルスチェックAPI | 4 | Coder実施済み | - | - | - | `controllers/health.md` |
| CRUD API | 6 | Coder実施済み | - | - | - | `controllers/items.md` |
| 障害シミュレーションAPI | 3 | Coder実施済み | - | - | - | `controllers/simulate.md` |
| データベースアクセス層 | 4 | Coder実施済み | - | - | - | `repositories/items_repository.md` |
| Terraform構文検証 | 3 | Coder実施済み | - | - | - | `root/01_ルートモジュール詳細設計.md` |
| Terraform変数検証 | 2 | Coder実施済み | - | - | - | `root/01_ルートモジュール詳細設計.md` |
| **合計** | **22** | **Coder実施済み** | **QA確認必要** | **-** | **-** | - |

### 7.2 カバレッジ結果

| 対象 | 目標値 | 実測値 | 判定 |
|------|--------|--------|------|
| 全体カバレッジ | 80%以上 | QA確認必要 | - |
| APIエンドポイント | 90%以上 | QA確認必要 | - |
| データベースアクセス層 | 85%以上 | QA確認必要 | - |

---

## 8. 合格判定

### 8.1 合格条件

**以下の全条件を満たす場合、単体テスト合格と判定**:
- [ ] pytest実行結果: 全テスト合格（失敗0件）
- [ ] カバレッジ: 80%以上
- [ ] Terraform validate: Success
- [ ] Critical/High不具合: 0件
- [ ] **設計書との整合性**: すべてのテスト項目が詳細設計の関数/クラスに対応している

### 8.2 QA確認後の判定

**QA確認項目**:
1. Coderが実施した単体テストの結果を確認
2. カバレッジレポートを確認
3. 不合格条件に該当しないか確認
4. 合格条件を全て満たしているか確認
5. **設計書との整合性確認**: テスト項目が詳細設計の関数/クラスをカバーしているか

**判定結果**: QA確認後に記入

---

## 9. 設計書との整合性確認結果

### 9.1 詳細設計との対応関係

| 詳細設計ファイル | テスト項目数 | 対応テストID | カバー率 |
|---------------|----------|-----------|---------|
| `controllers/health.md` | 4 | UT-API-001〜004 | 100% |
| `controllers/items.md` | 6 | UT-API-005〜010 | 100% |
| `controllers/simulate.md` | 3 | UT-API-011〜013 | 100% |
| `repositories/items_repository.md` | 4 | UT-DB-001〜004 | 100% |
| `root/01_ルートモジュール詳細設計.md` | 5 | UT-TF-001〜005 | 100% |

**整合性判定**: ✅ すべての詳細設計が単体テストでカバーされている

---

## 10. 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|----------|--------|
| 2025-12-28 | 1.0 | 初版作成 | QA |
| 2025-12-28 | 2.0 | 設計書との連動を明確化（詳細設計参照を追加） | QA |

---

**承認欄**:

| 役割 | 氏名 | 承認日 | サイン |
|------|------|--------|--------|
| QA | QAエージェント | 2025-12-28 | ✅ |
| PM | PMエージェント |  |  |
