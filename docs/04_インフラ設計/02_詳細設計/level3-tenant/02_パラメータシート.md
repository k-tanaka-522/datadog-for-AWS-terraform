# level3-tenant モジュール パラメータシート

## 1. 概要

このドキュメントは、level3-tenant モジュールで使用するパラメータの定義を記載します。

---

## 2. 閾値パラメータ

### 2.1 エラーログ監視パラメータ

| パラメータ名 | デフォルト値 | 単位 | Critical | Warning | 説明 |
|------------|------------|------|---------|---------|------|
| `errors_threshold` | 10 | 件/5分 | 10 | 5 | エラーログ数の閾値（5分間） |

**閾値の根拠**:
- **10件/5分**: 通常運用時のエラーログ数を調査し、異常な急増を検知
- **Warning 5件**: 閾値の50%で警告

### 2.2 レイテンシ監視パラメータ

| パラメータ名 | デフォルト値 | 単位 | Critical | Warning | 説明 |
|------------|------------|------|---------|---------|------|
| `latency_threshold` | 1000 | ms | 1000 | 500 | レイテンシ閾値（p99） |

**閾値の根拠**:
- **1000ms（1秒）**: ユーザー体験の許容範囲
- **Warning 500ms**: 閾値の50%で警告

### 2.3 ヘルスチェック監視パラメータ

| パラメータ名 | 値 | 説明 |
|------------|-----|------|
| ヘルスチェック間隔（固定） | 60秒 | Datadog Agent HTTP Check の間隔 |
| 失敗判定回数 | 2回連続 | 2回連続失敗でアラート |

---

## 3. テナント定義

### 3.1 terraform.tfvars でのテナント定義

```hcl
tenants = {
  tenant-a = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
  tenant-b = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
  tenant-c = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
}
```

### 3.2 テナント別の閾値カスタマイズ例

```hcl
tenants = {
  tenant-free = {
    errors_threshold  = 20   # 無料プランは閾値を緩く
    latency_threshold = 2000
  }
  tenant-standard = {
    errors_threshold  = 10   # 標準プラン
    latency_threshold = 1000
  }
  tenant-premium = {
    errors_threshold  = 5    # プレミアムプランは厳しい閾値
    latency_threshold = 500
  }
}
```

---

## 4. 通知先パラメータ

### 4.1 通知チャネル定義

| 階層 | 通知先 | 対応者 | 緊急度 | 通知形式 |
|------|-------|-------|--------|---------|
| L3 Composite | `@slack-tenant-{tenant_id}-alerts` | 開発チーム | Medium | Slack |
| L3 Composite | `@dev-team@example.com` | 開発チーム | Medium | Email |

### 4.2 terraform.tfvars での設定例

```hcl
notification_channels = [
  "@slack-tenant-alerts",
  "@dev-team@example.com"
]
```

**テナント別の通知先**（将来拡張）:
```hcl
# 将来的にテナント別の通知先を設定可能
tenants = {
  tenant-a = {
    errors_threshold  = 10
    latency_threshold = 1000
    notification_channels = ["@slack-tenant-a-alerts"]
  }
}
```

---

## 5. タグパラメータ

### 5.1 自動付与タグ

level3-tenant モジュールでは、以下のタグが自動付与されます。

| タグキー | タグ値 | 説明 |
|---------|-------|------|
| `layer` | `l3` | 監視階層（L3固定） |
| `tenant` | `${tenant_id}` | テナント識別子（動的） |
| `severity` | `high` / `medium` | アラートの重要度 |

---

## 6. ヘルスチェックURL

### 6.1 URL命名規則

```
https://${app_domain}/${tenant_id}/health
```

**例**:
- tenant-a: `https://myapp.example.com/tenant-a/health`
- tenant-b: `https://myapp.example.com/tenant-b/health`

---

## 7. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| モジュール詳細設計 | [01_モジュール詳細設計.md](01_モジュール詳細設計.md) |
| 構築手順書 | [03_構築手順書.md](03_構築手順書.md) |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.0
**ステータス**: Draft
