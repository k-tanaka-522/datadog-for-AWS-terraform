# level3-tenant モジュール 構築手順書

## 1. 概要

このドキュメントは、level3-tenant モジュールを使用して L3 Monitor を構築する手順を記載します。

**重要**: このモジュールは**for_each**でテナントを動的に展開します。

---

## 2. 事前準備

### 2.1 環境変数の設定

```powershell
$env:TF_VAR_datadog_api_key = $env:DD_API_KEY
$env:TF_VAR_datadog_app_key = $env:DD_APP_KEY
```

---

## 3. Terraform 初期化

### 3.1 terraform.tfvars の作成

```hcl
# terraform.tfvars

# アプリケーションドメイン
app_domain = "myapp.example.com"

# テナント定義⭐
tenants = {
  tenant-a = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
  tenant-b = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
  tenant-c = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
}

# 通知先
notification_channels = [
  "@slack-tenant-alerts"
]

# 共通タグ
tags = {
  project     = "datadog-poc"
  environment = "poc"
  managed_by  = "terraform"
}
```

---

## 4. terraform plan（dry-run）

```powershell
terraform plan -out=tfplan
```

**期待される出力**:
```
Plan: 9 to add, 0 to change, 0 to destroy.

  # module.level3_tenant["tenant-a"] が作成される（3個のMonitor）
  # module.level3_tenant["tenant-b"] が作成される（3個のMonitor）
  # module.level3_tenant["tenant-c"] が作成される（3個のMonitor）
```

---

## 5. terraform apply（本番実行）

```powershell
terraform apply tfplan
```

**期待される出力**:
```
Apply complete! Resources: 9 added, 0 changed, 0 destroyed.
```

---

## 6. 確認方法

### 6.1 Datadog UI での確認

1. Datadog UI → **Monitors** → **Manage Monitors** を開く
2. タグフィルター: `layer:l3` で絞り込み
3. 9個の Monitor が作成されていることを確認（3テナント × 3Monitor）

**期待される Monitor 一覧**:
| Monitor名 | タグ |
|----------|------|
| [L3] tenant-a ヘルスチェック | layer:l3, tenant:tenant-a |
| [L3] tenant-a エラーログ数 | layer:l3, tenant:tenant-a |
| [L3] tenant-a レイテンシ（p99） | layer:l3, tenant:tenant-a |
| [L3] tenant-b ヘルスチェック | layer:l3, tenant:tenant-b |
| ... | ... |

---

## 7. テナント追加手順

### 7.1 terraform.tfvars を編集

```hcl
tenants = {
  tenant-a = { errors_threshold = 10, latency_threshold = 1000 }
  tenant-b = { errors_threshold = 10, latency_threshold = 1000 }
  tenant-c = { errors_threshold = 10, latency_threshold = 1000 }
  tenant-d = { errors_threshold = 10, latency_threshold = 1000 }  # ← 追加
}
```

### 7.2 terraform plan（差分確認）

```powershell
terraform plan -out=tfplan
```

**期待される出力**:
```
Plan: 3 to add, 0 to change, 0 to destroy.

  # module.level3_tenant["tenant-d"] が作成される（3個のMonitor）
```

**重要**: 既存テナント（tenant-a/b/c）には影響なし。

### 7.3 terraform apply

```powershell
terraform apply tfplan
```

---

## 8. テナント削除手順

### 8.1 terraform.tfvars を編集

```hcl
tenants = {
  tenant-a = { errors_threshold = 10, latency_threshold = 1000 }
  tenant-b = { errors_threshold = 10, latency_threshold = 1000 }
  # tenant-c を削除
}
```

### 8.2 terraform plan → apply

```powershell
terraform plan -out=tfplan
terraform apply tfplan
```

**期待される出力**:
```
Plan: 0 to add, 0 to change, 3 to destroy.

  # module.level3_tenant["tenant-c"] が削除される（3個のMonitor）
```

---

## 9. トラブルシューティング

### 9.1 よくあるエラー

#### エラー1: `for_each argument is invalid`

**原因**: `tenants` 変数がmap型でない

**対処**: terraform.tfvars を確認
```hcl
# ✅ 正しい
tenants = {
  tenant-a = { errors_threshold = 10, latency_threshold = 1000 }
}

# ❌ 間違い
tenants = ["tenant-a", "tenant-b"]
```

---

## 10. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| モジュール詳細設計 | [01_モジュール詳細設計.md](01_モジュール詳細設計.md) |
| パラメータシート | [02_パラメータシート.md](02_パラメータシート.md) |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.0
**ステータス**: Draft
