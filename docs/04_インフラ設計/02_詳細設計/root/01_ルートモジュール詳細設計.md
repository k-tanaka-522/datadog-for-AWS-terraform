# ルートモジュール詳細設計

## 1. 概要

ルートモジュールは、level0-infra, level2-service, level3-tenant, composite の4つのモジュールを統合し、全体のTerraform構成を管理します。

---

## 2. ディレクトリ構成

```
terraform/
├── main.tf                     # モジュール呼び出し⭐
├── variables.tf                # 変数定義⭐
├── outputs.tf                  # 出力定義⭐
├── providers.tf                # Provider設定（Datadog、AWS）⭐
├── backend.tf                  # State管理（S3 + DynamoDB）⭐
├── versions.tf                 # Terraform/Provider バージョン指定⭐
├── terraform.tfvars            # 変数値（Gitにコミットしない）⭐
├── terraform.tfvars.example    # サンプル（Gitにコミット）
└── modules/                    # 再利用可能なモジュール
    ├── level0-infra/
    ├── level2-service/
    ├── level3-tenant/
    └── composite/
```

---

## 3. main.tf の詳細

### 3.1 全体構成

```hcl
# main.tf
# ルートモジュール: 全モジュールの統合

# L0 インフラ監視モジュール
module "level0_infra" {
  source = "./modules/level0-infra"

  rds_instance_id   = var.rds_instance_id
  ecs_cluster_name  = var.ecs_cluster_name
  rds_cpu_threshold = var.rds_cpu_threshold

  notification_channels = var.notification_channels_l0
  tags                  = var.common_tags
}

# L2 サービス監視モジュール
module "level2_service" {
  source = "./modules/level2-service"

  alb_target_group     = var.alb_target_group
  alb_fqdn             = var.alb_fqdn  # ⭐ 追加
  ecs_cluster_name     = var.ecs_cluster_name
  ecr_repository_name  = var.ecr_repository_name

  notification_channels = var.notification_channels_l2
  tags                  = var.common_tags
}

# L3 テナント監視モジュール（for_each でテナント展開）⭐
module "level3_tenant" {
  for_each = var.tenants
  source   = "./modules/level3-tenant"

  tenant_id          = each.key
  health_check_url   = "https://${var.app_domain}/${each.key}/health"
  errors_threshold   = each.value.errors_threshold
  latency_threshold  = each.value.latency_threshold

  notification_channels = var.notification_channels_l3
  tags                  = merge(var.common_tags, { tenant = each.key })
}

# Composite Monitor モジュール
module "composite" {
  source = "./modules/composite"

  l0_monitor_ids = module.level0_infra.monitor_ids
  l2_monitor_ids = module.level2_service.monitor_ids
  l3_monitor_ids = {
    for tenant_id, tenant_module in module.level3_tenant :
    tenant_id => tenant_module.monitor_ids
  }
  tenants = var.tenants

  notification_channels = var.notification_channels_composite
  tags                  = var.common_tags
}
```

**重要なポイント**:
- **for_each**: `module.level3_tenant` はテナントごとに動的展開
- **依存関係**: Composite Monitor は L0/L2/L3 の Monitor ID を参照
- **alb_fqdn**: FR-002-5（E2Eヘルスチェック）で使用

---

## 4. variables.tf の詳細

### 4.1 変数定義

```hcl
# variables.tf
# ルートモジュールの変数定義

# Datadog API Key/APP Key（環境変数から注入）
variable "datadog_api_key" {
  description = "Datadog API Key"
  type        = string
  sensitive   = true
}

variable "datadog_app_key" {
  description = "Datadog APP Key"
  type        = string
  sensitive   = true
}

# AWS リソース識別子
variable "rds_instance_id" {
  description = "RDS インスタンス識別子（例: myapp-db）"
  type        = string
}

variable "ecs_cluster_name" {
  description = "ECS Cluster 名（例: myapp-cluster）"
  type        = string
}

variable "alb_target_group" {
  description = "ALB Target Group 名（例: myapp-tg）"
  type        = string
}

variable "alb_fqdn" {
  description = "ALB FQDN（例: myapp-1234567890.ap-northeast-1.elb.amazonaws.com）⭐ FR-002-5で使用"
  type        = string
}

variable "ecr_repository_name" {
  description = "ECR リポジトリ名（例: myapp）"
  type        = string
  default     = "myapp"
}

variable "app_domain" {
  description = "アプリケーションドメイン（例: myapp.example.com）"
  type        = string
}

# 閾値
variable "rds_cpu_threshold" {
  description = "RDS CPU使用率の閾値（%）"
  type        = number
  default     = 95
}

# テナント定義⭐
variable "tenants" {
  description = "テナント定義（テナントID → 閾値）"
  type = map(object({
    errors_threshold  = number
    latency_threshold = number
  }))
}

# 通知先（階層別）
variable "notification_channels_l0" {
  description = "L0 Composite の通知先"
  type        = list(string)
  default     = []
}

variable "notification_channels_l2" {
  description = "L2 Composite の通知先"
  type        = list(string)
  default     = []
}

variable "notification_channels_l3" {
  description = "L3 Composite の通知先"
  type        = list(string)
  default     = []
}

variable "notification_channels_composite" {
  description = "Composite Monitor の通知先"
  type        = list(string)
  default     = []
}

# 共通タグ
variable "common_tags" {
  description = "全Monitor に付与する共通タグ"
  type        = map(string)
  default     = {
    project     = "datadog-poc"
    environment = "poc"
    managed_by  = "terraform"
  }
}
```

---

## 5. providers.tf の詳細

```hcl
# providers.tf
# Provider 設定

terraform {
  required_version = ">= 1.5.0"

  required_providers {
    datadog = {
      source  = "DataDog/datadog"
      version = "~> 3.30"
    }
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "datadog" {
  api_key = var.datadog_api_key
  app_key = var.datadog_app_key
}

provider "aws" {
  region = "ap-northeast-1"
}
```

**重要**:
- Datadog Provider: `~> 3.30` を使用
- AWS Provider: メトリクス確認用（Terraform実行には不要）

---

## 6. backend.tf の詳細

```hcl
# backend.tf
# Terraform State 管理（S3 + DynamoDB）

terraform {
  backend "s3" {
    bucket         = "datadog-terraform-state"
    key            = "datadog-monitors/terraform.tfstate"
    region         = "ap-northeast-1"
    encrypt        = true
    dynamodb_table = "terraform-state-lock"
  }
}
```

**前提条件**:
- S3バケット `datadog-terraform-state` が作成済み
- DynamoDBテーブル `terraform-state-lock` が作成済み

**S3バケット作成コマンド**:
```bash
aws s3 mb s3://datadog-terraform-state --region ap-northeast-1
aws s3api put-bucket-versioning \
  --bucket datadog-terraform-state \
  --versioning-configuration Status=Enabled
```

**DynamoDBテーブル作成コマンド**:
```bash
aws dynamodb create-table \
  --table-name terraform-state-lock \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST
```

---

## 7. versions.tf の詳細

```hcl
# versions.tf
# Terraform/Provider バージョン指定

terraform {
  required_version = ">= 1.5.0"

  required_providers {
    datadog = {
      source  = "DataDog/datadog"
      version = "~> 3.30"
    }
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}
```

---

## 8. outputs.tf の詳細

```hcl
# outputs.tf
# 出力定義

output "l0_monitor_ids" {
  description = "L0 Monitor のIDリスト"
  value       = module.level0_infra.monitor_ids
}

output "l2_monitor_ids" {
  description = "L2 Monitor のIDリスト"
  value       = module.level2_service.monitor_ids
}

output "l3_monitor_ids" {
  description = "L3 Monitor のIDリスト（テナントごと）"
  value = {
    for tenant_id, tenant_module in module.level3_tenant :
    tenant_id => tenant_module.monitor_ids
  }
}

output "composite_monitor_ids" {
  description = "Composite Monitor のIDリスト"
  value       = module.composite.composite_ids
}
```

**出力例**:
```
l0_monitor_ids = {
  "rds_cpu"     = "123456789"
  "rds_conn"    = "123456790"
  ...
}

l3_monitor_ids = {
  "tenant-a" = {
    "health_check" = "123456800"
    "error_logs"   = "123456801"
    "latency"      = "123456802"
  }
  "tenant-b" = { ... }
}

composite_monitor_ids = {
  "l0" = "123456810"
  "l2" = "123456811"
  "l3" = {
    "tenant-a" = "123456812"
    "tenant-b" = "123456813"
  }
}
```

---

## 9. terraform.tfvars.example の詳細

```hcl
# terraform.tfvars.example
# このファイルをコピーして terraform.tfvars を作成してください
# cp terraform.tfvars.example terraform.tfvars

# ⚠️ Datadog API Key/APP Key は環境変数で注入してください:
#   $env:TF_VAR_datadog_api_key = $env:DD_API_KEY
#   $env:TF_VAR_datadog_app_key = $env:DD_APP_KEY
# terraform.tfvarsには一切記載しないでください

# AWS リソース識別子（例）
rds_instance_id     = "myapp-db"
ecs_cluster_name    = "myapp-cluster"
alb_target_group    = "myapp-tg"
alb_fqdn            = "myapp-1234567890.ap-northeast-1.elb.amazonaws.com"  # ⭐ 追加
ecr_repository_name = "myapp"
app_domain          = "myapp.example.com"

# テナント定義
tenants = {
  tenant-a = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
}

# 通知先
notification_channels_l0 = ["@slack-ops-alerts-critical"]
notification_channels_l2 = ["@slack-ops-alerts-high"]
notification_channels_l3 = ["@slack-tenant-alerts"]
notification_channels_composite = ["@slack-ops-alerts"]

# 共通タグ
common_tags = {
  project     = "datadog-poc"
  environment = "poc"
  managed_by  = "terraform"
}
```

---

## 10. .gitignore の設定

```
# Terraform State（機密情報含む）
*.tfstate
*.tfstate.backup
.terraform/
.terraform.lock.hcl

# 変数ファイル（機密情報含む）
terraform.tfvars
*.auto.tfvars

# ログファイル
terraform-debug.log
crash.log
```

**重要**: terraform.tfvars は絶対にGitにコミットしないでください。

---

## 11. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| 環境別パラメータ | [02_環境別パラメータ.md](02_環境別パラメータ.md) |
| デプロイ手順書 | [03_デプロイ手順書.md](03_デプロイ手順書.md) |
| 基本設計（IaC方針） | [../../01_基本設計/10_IaC方針.md](../../01_基本設計/10_IaC方針.md) |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.1
**ステータス**: Draft
**変更履歴**:
- 1.0 (2025-12-28): 初版作成
- 1.1 (2025-12-28): `alb_fqdn` 変数追加（High優先度 #1 対応）
