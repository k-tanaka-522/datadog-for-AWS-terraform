# デプロイ手順書

## 1. 概要

このドキュメントは、Terraform を使用して Datadog 監視設定を構築する手順を記載します。

**重要**: 必ず terraform plan（dry-run）で差分を確認してから terraform apply を実行してください。

---

## 2. 初回デプロイ

### 2.1 事前準備

#### S3バケット・DynamoDBテーブルの作成

```bash
# S3バケット作成
aws s3 mb s3://datadog-terraform-state --region ap-northeast-1
aws s3api put-bucket-versioning \
  --bucket datadog-terraform-state \
  --versioning-configuration Status=Enabled

# DynamoDBテーブル作成
aws dynamodb create-table \
  --table-name terraform-state-lock \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST
```

#### 環境変数の設定

```powershell
# Datadog API Key/APP Key を環境変数に設定
$env:TF_VAR_datadog_api_key = $env:DD_API_KEY
$env:TF_VAR_datadog_app_key = $env:DD_APP_KEY

# 確認
echo $env:TF_VAR_datadog_api_key
echo $env:TF_VAR_datadog_app_key
```

#### terraform.tfvars の作成

```bash
# サンプルをコピー
cp terraform.tfvars.example terraform.tfvars

# 編集
# terraform.tfvars を編集して、AWS リソース識別子、テナント定義等を設定
```

### 2.2 Terraform 初期化

```powershell
# Terraform 初期化
terraform init
```

**期待される出力**:
```
Initializing modules...
- level0_infra in modules/level0-infra
- level2_service in modules/level2-service
- level3_tenant in modules/level3-tenant
- composite in modules/composite

Initializing the backend...

Successfully configured the backend "s3"! Terraform will automatically
use this backend unless the backend configuration changes.

Initializing provider plugins...
- Finding DataDog/datadog versions matching "~> 3.30"...
- Finding hashicorp/aws versions matching "~> 5.0"...
- Installing DataDog/datadog v3.30.0...
- Installing hashicorp/aws v5.30.0...

Terraform has been successfully initialized!
```

### 2.3 terraform plan（dry-run）

```powershell
# plan実行（差分確認）
terraform plan -out=tfplan
```

**期待される出力**:
```
Plan: 23 to add, 0 to change, 0 to destroy.

  # L0 Monitor: 7個
  # L2 Monitor: 4個（FR-002-5含む）
  # L3 Monitor: 9個（3テナント × 3Monitor）
  # Composite Monitor: 5個（L0/L2/L3×3）
  # 合計: 23個（7 + 4 + 9 + 3 = 23）
```

**確認ポイント**:
- [ ] 合計23個のリソースが作成される ⭐ 更新
- [ ] L0 Monitor: 7個（RDS、ECS、VPC、Agent）
- [ ] L2 Monitor: 4個（ALB、ECS Task、ECR、**FR-002-5**） ⭐ 更新
- [ ] L3 Monitor: 9個（tenant-a/b/c、各3個）
- [ ] Composite Monitor: 5個（L0/L2/L3×3）
- [ ] AWS リソース識別子が正しい（rds_instance_id, ecs_cluster_name 等）
- [ ] 通知先が正しい（@slack-ops-alerts-critical 等）

**内訳**:
| 層 | Monitor種別 | 個数 | 詳細 |
|----|-----------|------|------|
| L0 | 個別Monitor | 7 | RDS CPU/Conn/Mem/Storage、ECS Tasks、VPC Flow、Agent |
| L0 | Composite | 1 | L0-Composite |
| L2 | 個別Monitor | 4 | ALB Health、ECS Task、ECR Vuln、**FR-002-5（E2E）** ⭐ |
| L2 | Composite | 1 | L2-Composite |
| L3 | 個別Monitor | 9 | tenant-a/b/c × 3（Health、Error、Latency） |
| L3 | Composite | 3 | L3-Composite × 3テナント |
| **合計** | | **23** | **7 + 1 + 4 + 1 + 9 + 3 = 23** ⭐ |

### 2.4 terraform apply（本番実行）

```powershell
# plan で確認済みの内容を適用
terraform apply tfplan
```

**期待される出力**:
```
module.level0_infra.datadog_monitor.rds_cpu: Creating...
module.level0_infra.datadog_monitor.rds_conn: Creating...
...

Apply complete! Resources: 23 added, 0 changed, 0 destroyed.

Outputs:

l0_monitor_ids = {
  "rds_cpu"     = "123456789"
  "rds_conn"    = "123456790"
  ...
}

l3_monitor_ids = {
  "tenant-a" = {
    "health_check" = "123456800"
    "error_logs"   = "123456801"
    "latency"      = "123456802"
  }
  ...
}

composite_monitor_ids = {
  "l0" = "123456810"
  "l2" = "123456811"
  "l3" = {
    "tenant-a" = "123456812"
    "tenant-b" = "123456813"
    "tenant-c" = "123456814"
  }
}
```

**所要時間**: 約5〜10分（23個の Monitor 作成）

---

## 3. 確認方法

### 3.1 Datadog UI での確認

1. Datadog UI → **Monitors** → **Manage Monitors** を開く
2. タグフィルター: `project:datadog-poc` で絞り込み
3. 23個の Monitor が作成されていることを確認

**階層別の確認**:
- `layer:l0` で絞り込み → 7個のL0 Monitor + 1個のL0 Composite
- `layer:l2` で絞り込み → 4個のL2 Monitor + 1個のL2 Composite
- `layer:l3` で絞り込み → 9個のL3 Monitor + 3個のL3 Composite

### 3.2 terraform output での確認

```powershell
# 作成した Monitor のID一覧を表示
terraform output
```

---

## 4. テナント追加デプロイ

### 4.1 terraform.tfvars を編集

```hcl
tenants = {
  tenant-a = { errors_threshold = 10, latency_threshold = 1000 }
  tenant-b = { errors_threshold = 10, latency_threshold = 1000 }
  tenant-c = { errors_threshold = 10, latency_threshold = 1000 }
  tenant-d = { errors_threshold = 10, latency_threshold = 1000 }  # ← 追加
}
```

### 4.2 terraform plan（差分確認）

```powershell
terraform plan -out=tfplan
```

**期待される出力**:
```
Plan: 4 to add, 0 to change, 0 to destroy.

  # module.level3_tenant["tenant-d"] が作成される（3個のMonitor）
  # module.composite.datadog_monitor.l3_composite["tenant-d"] が作成される（1個のComposite）
```

**重要**: 既存テナント（tenant-a/b/c）には影響なし。

### 4.3 terraform apply

```powershell
terraform apply tfplan
```

**所要時間**: 約2〜3分（4個の Monitor 作成）

---

## 5. 変更デプロイ

### 5.1 閾値を変更する場合

```hcl
# terraform.tfvars を編集
rds_cpu_threshold = 90  # 95 → 90 に変更
```

```powershell
# plan で差分確認
terraform plan -out=tfplan

# 期待される出力
# Plan: 0 to add, 1 to change, 0 to destroy.
# ~ module.level0_infra.datadog_monitor.rds_cpu

# apply
terraform apply tfplan
```

---

## 6. テナント削除

### 6.1 terraform.tfvars を編集

```hcl
tenants = {
  tenant-a = { errors_threshold = 10, latency_threshold = 1000 }
  tenant-b = { errors_threshold = 10, latency_threshold = 1000 }
  # tenant-c を削除
}
```

```powershell
# plan で差分確認
terraform plan -out=tfplan

# 期待される出力
# Plan: 0 to add, 0 to change, 4 to destroy.
# - module.level3_tenant["tenant-c"]
# - module.composite.datadog_monitor.l3_composite["tenant-c"]

# apply
terraform apply tfplan
```

---

## 7. 削除（PoC終了時）

```powershell
# ⚠️ 全ての Monitor を削除
terraform destroy
```

**確認プロンプト**:
```
Do you really want to destroy all resources?
  Terraform will destroy all your managed infrastructure, as shown above.
  There is no undo. Only 'yes' will be accepted to confirm.

  Enter a value: yes
```

**注**: 本番環境では `terraform destroy` は原則禁止。

---

## 8. ロールバック手順

### 8.1 State のバックアップ

```powershell
# State をファイルに保存
terraform state pull > terraform.tfstate.backup
```

### 8.2 特定のリソースを削除

```powershell
# 特定の Monitor を削除
terraform destroy -target=module.level3_tenant["tenant-d"]
```

---

## 9. トラブルシューティング

### 9.1 よくあるエラー

| エラー | 原因 | 対処 |
|------|------|------|
| `Error: Invalid provider credentials` | Datadog API Key/APP Key が未設定 | 環境変数を再設定 |
| `Error: Backend initialization required` | S3バケットが存在しない | S3バケットを作成 |
| `Error: DynamoDB table not found` | DynamoDBテーブルが存在しない | DynamoDBテーブルを作成 |
| `Error: Monitor already exists` | 手動作成したMonitorと名前が重複 | 既存Monitorを削除、または terraform import |
| `Error: for_each argument is invalid` | `tenants` 変数がmap型でない | terraform.tfvars を確認 |

### 9.2 デバッグ方法

```powershell
# Terraform ログレベルを DEBUG に設定
$env:TF_LOG = "DEBUG"
terraform plan

# ログをファイルに保存
terraform plan 2>&1 | Out-File -FilePath terraform-debug.log
```

---

## 10. CI/CD統合（本番推奨、参考）

### 10.1 GitHub Actions 例

```yaml
# .github/workflows/terraform.yml
name: Terraform CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        run: terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        env:
          TF_VAR_datadog_api_key: ${{ secrets.DATADOG_API_KEY }}
          TF_VAR_datadog_app_key: ${{ secrets.DATADOG_APP_KEY }}

      - name: Terraform Apply（mainブランチのみ）
        if: github.ref == 'refs/heads/main'
        run: terraform apply tfplan
```

**注**: PoCではCI/CD不要。本番移行時に導入推奨。

---

## 11. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| ルートモジュール詳細設計 | [01_ルートモジュール詳細設計.md](01_ルートモジュール詳細設計.md) |
| 環境別パラメータ | [02_環境別パラメータ.md](02_環境別パラメータ.md) |
| 基本設計（IaC方針） | [../../01_基本設計/10_IaC方針.md](../../01_基本設計/10_IaC方針.md) |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.1
**ステータス**: Draft
**変更履歴**:
- 1.0 (2025-12-28): 初版作成
- 1.1 (2025-12-28): Monitor数を22→23個に修正（Medium優先度 #1 対応）、内訳表を追加
