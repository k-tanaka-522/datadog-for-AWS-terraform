# composite モジュール 構築手順書

## 1. 概要

このドキュメントは、composite モジュールを使用して Composite Monitor を構築する手順を記載します。

**重要**: Composite Monitor は L0/L2/L3 の Monitor ID に依存するため、**level0-infra, level2-service, level3-tenant モジュールを先に構築してください**。

---

## 2. 事前準備

### 2.1 前提条件

以下のモジュールが構築済みであること:
- level0-infra モジュール（L0 Monitor 作成済み）
- level2-service モジュール（L2 Monitor 作成済み）
- level3-tenant モジュール（L3 Monitor 作成済み）

---

## 3. terraform plan（dry-run）

```powershell
terraform plan -out=tfplan
```

**期待される出力**:
```
Plan: 5 to add, 0 to change, 0 to destroy.

  # module.composite.datadog_monitor.l0_composite will be created
  # module.composite.datadog_monitor.l2_composite will be created
  # module.composite.datadog_monitor.l3_composite["tenant-a"] will be created
  # module.composite.datadog_monitor.l3_composite["tenant-b"] will be created
  # module.composite.datadog_monitor.l3_composite["tenant-c"] will be created
```

**確認ポイント**:
- L0-Composite: 1個
- L2-Composite: 1個
- L3-Composite: テナント数分（例: 3個）

---

## 4. terraform apply（本番実行）

```powershell
terraform apply tfplan
```

**期待される出力**:
```
Apply complete! Resources: 5 added, 0 to change, 0 destroyed.
```

---

## 5. 確認方法

### 5.1 Datadog UI での確認

1. Datadog UI → **Monitors** → **Manage Monitors** を開く
2. タグフィルター: `composite:true` で絞り込み
3. 5個の Composite Monitor が作成されていることを確認

**期待される Composite Monitor 一覧**:
| Monitor名 | タグ |
|----------|------|
| [L0 Composite] インフラ基盤障害 | layer:l0, composite:true, severity:critical |
| [L2 Composite] サービスレイヤー障害 | layer:l2, composite:true, severity:high |
| [L3 Composite] tenant-a 障害 | layer:l3, composite:true, tenant:tenant-a, severity:medium |
| [L3 Composite] tenant-b 障害 | layer:l3, composite:true, tenant:tenant-b, severity:medium |
| [L3 Composite] tenant-c 障害 | layer:l3, composite:true, tenant:tenant-c, severity:medium |

### 5.2 Composite Monitor の詳細確認

**L0-Composite Monitor をクリック** → 以下を確認:
- **Query**: `123456789 || 123456790 || ...` （L0 Monitor のID）
- **Thresholds**: なし（Composite Monitorは閾値なし）
- **Message**: 通知先が含まれているか

---

## 6. アラート抑制の動作テスト

### 6.1 L0障害時のアラート抑制テスト

**手順**:
1. L0 Monitor（例: L0-RDS-CPU）をアラート状態にする
   - RDS CPU使用率を95%超に設定
2. Datadog UI で以下を確認:
   - L0-Composite: ALERT（通知される）
   - L2-Composite: OK（L0障害中は抑制される）
   - L3-Composite: OK（L0障害中は抑制される）
3. Slack通知を確認:
   - L0-Composite のアラートのみ通知

**期待結果**: L2/L3アラートは抑制され、L0アラートのみ通知される。

---

## 7. トラブルシューティング

### 7.1 よくあるエラー

#### エラー1: `Monitor ID not found`

**原因**: L0/L2/L3 Monitor が作成されていない

**対処**: level0-infra, level2-service, level3-tenant モジュールを先に構築してください。

#### エラー2: `Invalid query syntax`

**原因**: Composite Monitorのクエリ構文が誤っている（`!` を使用している等）

**対処**: `NOT` を使用してください。
```hcl
# ✅ 正しい
query = "(${id1} || ${id2}) && NOT ${id3}"

# ❌ 間違い
query = "(${id1} || ${id2}) && !${id3}"
```

---

## 8. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| モジュール詳細設計 | [01_モジュール詳細設計.md](01_モジュール詳細設計.md) |
| パラメータシート | [02_パラメータシート.md](02_パラメータシート.md) |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.0
**ステータス**: Draft
