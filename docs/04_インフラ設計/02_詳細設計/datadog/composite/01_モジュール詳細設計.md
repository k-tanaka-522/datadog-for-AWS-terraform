# composite モジュール詳細設計

## 1. モジュール概要

### 責務
Composite Monitor を作成し、L0/L2/L3の親子関係によるアラート抑制を実現します。

**核心の仕組み**:
```
L0 障害発生 → L2/L3 アラート抑制
L2 障害発生 → L3 アラート抑制
L3 障害発生 → テナント固有の問題として通知
```

### Composite Monitor 一覧

| Composite Monitor | 論理式 | 抑制対象 |
|------------------|--------|---------|
| L0-Composite | L0-RDS-CPU \|\| L0-RDS-Conn \|\| ... | L2/L3を抑制 |
| L2-Composite | (L2-ALB-Health \|\| L2-ECS-Task \|\| L2-ECR-Vuln \|\| **FR-002-5**) && NOT L0-Composite | L3を抑制 |
| L3-Composite（tenant-a） | (L3-Health \|\| L3-Error \|\| L3-Latency) && NOT L0-Composite && NOT L2-Composite | 抑制なし |

### 基本設計との対応
- [05_監視設計.md § 3 Composite Monitor の設計](../../01_基本設計/05_監視設計.md)
- [10_IaC方針.md § 3.4](../../01_基本設計/10_IaC方針.md)

---

## 2. ディレクトリ構成

```
modules/composite/
├── main.tf           # モジュールのエントリーポイント
├── variables.tf      # 入力変数定義
├── outputs.tf        # 出力定義（Composite Monitor ID等）
└── composites.tf     # Composite Monitor の定義
```

---

## 3. variables.tf の詳細

### 入力変数一覧

| 変数名 | 型 | デフォルト値 | 説明 |
|-------|------|------------|------|
| `l0_monitor_ids` | map(string) | - | L0 Monitor のIDマップ（例: {rds_cpu = "123", ...}） |
| `l2_monitor_ids` | map(string) | - | L2 Monitor のIDマップ（**FR-002-5を含む**） |
| `l3_monitor_ids` | map(map(string)) | - | L3 Monitor のIDマップ（テナントごと） |
| `tenants` | map(object) | - | テナント定義 |
| `notification_channels` | list(string) | [] | 通知先（Slack、Email等） |
| `tags` | map(string) | {} | Monitor に付与するタグ |

### variables.tf 実装例

```hcl
variable "l0_monitor_ids" {
  description = "L0 Monitor のIDマップ"
  type        = map(string)
}

variable "l2_monitor_ids" {
  description = <<-EOT
    L2 Monitor のIDマップ
    例: {
      alb_health = "123",
      ecs_task_stopped = "456",
      ecr_vulnerability = "789",
      e2e_health_check = "012"  # FR-002-5（E2Eヘルスチェック）
    }
  EOT
  type        = map(string)
}

variable "l3_monitor_ids" {
  description = "L3 Monitor のIDマップ（テナントごと）"
  type        = map(map(string))
  # 例:
  # {
  #   "tenant-a" = { health_check = "123", error_logs = "456", latency = "789" }
  #   "tenant-b" = { health_check = "124", error_logs = "457", latency = "790" }
  # }
}

variable "tenants" {
  description = "テナント定義"
  type = map(object({
    errors_threshold  = number
    latency_threshold = number
  }))
}

variable "notification_channels" {
  description = "通知先（Slack、Email、PagerDuty等）"
  type        = list(string)
  default     = []
}

variable "tags" {
  description = "Monitor に付与するタグ"
  type        = map(string)
  default     = {}
}
```

---

## 4. composites.tf の詳細

### 4.1 L0-Composite Monitor

```hcl
# L0 Composite Monitor
resource "datadog_monitor" "l0_composite" {
  name    = "[L0 Composite] インフラ基盤障害"
  type    = "composite"
  query   = join(" || ", [
    for monitor_id in values(var.l0_monitor_ids) : "${monitor_id}"
  ])
  message = <<-EOT
    [L0 Composite] インフラ基盤で障害が発生しました。
    - 影響: 全テナント
    - 対応: インフラチームが調査中

    詳細: {{#is_alert}}
    以下のL0 Monitorがアラート状態です:
    {{#each alerting_monitors}}
    - {{this.name}}
    {{/each}}
    {{/is_alert}}

    ${join("\n", var.notification_channels)}
  EOT

  tags = concat(
    ["layer:l0", "composite:true", "severity:critical"],
    [for k, v in var.tags : "${k}:${v}"]
  )

  notify_no_data    = false
  renotify_interval = 0
}
```

**クエリ構文の説明**:
- `join(" || ", [for monitor_id in values(var.l0_monitor_ids) : "${monitor_id}"])`
- 例: `"123456789 || 123456790 || 123456791 || ..."`
- いずれかのL0 Monitor がALERT状態になれば、L0-Composite がALERT

### 4.2 L2-Composite Monitor

```hcl
# L2 Composite Monitor
resource "datadog_monitor" "l2_composite" {
  name    = "[L2 Composite] サービスレイヤー障害"
  type    = "composite"
  query   = "(${join(" || ", [for monitor_id in values(var.l2_monitor_ids) : "${monitor_id}"])}) && NOT ${datadog_monitor.l0_composite.id}"
  message = <<-EOT
    [L2 Composite] サービスレイヤーで障害が発生しました。
    - 影響: 該当サービス
    - 対応: アプリケーションチームが調査中

    詳細: {{#is_alert}}
    以下のL2 Monitorがアラート状態です:
    {{#each alerting_monitors}}
    - {{this.name}}
    {{/each}}
    {{/is_alert}}

    注: L0障害中の場合、このアラートは抑制されます。

    ${join("\n", var.notification_channels)}
  EOT

  tags = concat(
    ["layer:l2", "composite:true", "severity:high"],
    [for k, v in var.tags : "${k}:${v}"]
  )

  notify_no_data    = false
  renotify_interval = 0
}
```

**クエリ構文の説明**:
- `(L2-ALB-Health || L2-ECS-Task || L2-ECR-Vuln || FR-002-5) && NOT L0-Composite`
- `values(var.l2_monitor_ids)` により、**level2-service モジュールから渡されたすべてのMonitor IDを自動的に含む**
- **FR-002-5（E2Eヘルスチェック）も自動的に含まれる**（level2-service の outputs.tf で追加されるため）
- `NOT ${datadog_monitor.l0_composite.id}`: L0-Composite がALERT時、L2-Composite はアラートしない
- **重要**: `NOT` を使用（`!` ではない、Datadog標準構文）

### 4.3 L3-Composite Monitor（テナントごとに for_each で作成）

```hcl
# L3 Composite Monitor（テナントごと）
resource "datadog_monitor" "l3_composite" {
  for_each = var.tenants

  name    = "[L3 Composite] ${each.key} 障害"
  type    = "composite"
  query   = "(${join(" || ", [for monitor_id in values(var.l3_monitor_ids[each.key]) : "${monitor_id}"])}) && NOT ${datadog_monitor.l0_composite.id} && NOT ${datadog_monitor.l2_composite.id}"
  message = <<-EOT
    [L3 Composite] ${each.key} で障害が発生しました。
    - 影響: ${each.key} のみ
    - 対応: 開発チームが調査中

    詳細: {{#is_alert}}
    以下のL3 Monitorがアラート状態です:
    {{#each alerting_monitors}}
    - {{this.name}}
    {{/each}}
    {{/is_alert}}

    注: L0/L2障害中の場合、このアラートは抑制されます。

    ${join("\n", var.notification_channels)}
  EOT

  tags = concat(
    ["layer:l3", "tenant:${each.key}", "composite:true", "severity:medium"],
    [for k, v in var.tags : "${k}:${v}"]
  )

  notify_no_data    = false
  renotify_interval = 0
}
```

**クエリ構文の説明**:
- `(FR-003-1 || L3-Error || L3-Latency) && NOT L0-Composite && NOT L2-Composite`
- `values(var.l3_monitor_ids[each.key])` により、**level3-tenant モジュールから渡されたすべてのMonitor IDを自動的に含む**
- `&& NOT L0-Composite && NOT L2-Composite`: L0/L2障害時、L3-Composite はアラートしない
- **for_each**: テナントごとにL3-Composite Monitor を作成

---

## 5. outputs.tf の詳細

### 出力定義

```hcl
output "composite_ids" {
  description = "Composite Monitor のIDリスト"
  value = {
    l0 = datadog_monitor.l0_composite.id
    l2 = datadog_monitor.l2_composite.id
    l3 = {
      for tenant_id, composite_monitor in datadog_monitor.l3_composite :
      tenant_id => composite_monitor.id
    }
  }
}

output "composite_names" {
  description = "Composite Monitor の名前リスト"
  value = {
    l0 = datadog_monitor.l0_composite.name
    l2 = datadog_monitor.l2_composite.name
    l3 = {
      for tenant_id, composite_monitor in datadog_monitor.l3_composite :
      tenant_id => composite_monitor.name
    }
  }
}
```

---

## 6. main.tf の詳細

**注**: このモジュールでは main.tf は空でも問題ありません（すべての Composite Monitor 定義は composites.tf に記載）。

```hcl
# composite モジュール
# Composite Monitor の作成（L0/L2/L3の親子関係によるアラート抑制）
#
# 依存: composites.tf, variables.tf, outputs.tf
```

---

## 7. アラート抑制の動作確認

### 7.1 シナリオ1: L0障害（RDS CPU高騰）

**発生**:
1. RDS CPU使用率が95%を超える → L0-RDS-CPU が ALERT
2. L0-Composite が ALERT（L0-RDS-CPU がトリガー）
3. 派生的に、ECS Taskがタイムアウトで異常停止 → L2-ECS-Task が ALERT
4. 派生的に、tenant-a のエラーログが増加 → L3-Error-tenant-a が ALERT

**Composite Monitor の判定**:
- L0-Composite: ALERT（通知する）
- L2-Composite: `(L2-ECS-Task = ALERT) && NOT L0-Composite` → FALSE（通知しない）
- L3-Composite-tenant-a: `(L3-Error-tenant-a = ALERT) && NOT L0-Composite && NOT L2-Composite` → FALSE（通知しない）

**結果**: L0-Composite のアラートのみ通知され、アラート地獄を回避。

### 7.2 シナリオ2: L2障害（E2Eヘルスチェック失敗、FR-002-5）

**発生**:
1. **ALB→API→RDS のE2Eヘルスチェックが失敗 → FR-002-5 が ALERT**
2. **L2-Composite が ALERT（FR-002-5 がトリガー）**
3. 派生的に、tenant-a のヘルスチェックが失敗 → FR-003-1 が ALERT

**Composite Monitor の判定**:
- L0-Composite: OK（L0は正常）
- **L2-Composite**: `(FR-002-5 = ALERT) && NOT L0-Composite` → **TRUE（通知する）**
- L3-Composite-tenant-a: `(FR-003-1 = ALERT) && NOT L0-Composite && NOT L2-Composite` → FALSE（通知しない）

**結果**: L2-Composite のアラートのみ通知。L3アラートは抑制。

### 7.3 シナリオ3: L2障害（ECS Task異常停止）

**発生**:
1. ECS Taskがアプリケーションバグで異常停止 → L2-ECS-Task が ALERT
2. L2-Composite が ALERT
3. 派生的に、tenant-a のヘルスチェックが失敗 → L3-Health-tenant-a が ALERT

**Composite Monitor の判定**:
- L0-Composite: OK（L0は正常）
- L2-Composite: `(L2-ECS-Task = ALERT) && NOT L0-Composite` → TRUE（通知する）
- L3-Composite-tenant-a: `(L3-Health-tenant-a = ALERT) && NOT L0-Composite && NOT L2-Composite` → FALSE（通知しない）

**結果**: L2-Composite のアラートのみ通知。

### 7.4 シナリオ4: L3障害（tenant-a のみの問題）

**発生**:
1. tenant-a のアプリケーションコードにバグ → L3-Error-tenant-a が ALERT

**Composite Monitor の判定**:
- L0-Composite: OK
- L2-Composite: OK
- L3-Composite-tenant-a: `(L3-Error-tenant-a = ALERT) && NOT L0-Composite && NOT L2-Composite` → TRUE（通知する）

**結果**: L3-Composite-tenant-a のアラートを通知。

---

## 8. 依存関係

### モジュール間の依存

```mermaid
graph TD
    L0[level0-infra モジュール]
    L2[level2-service モジュール<br/>FR-002-5含む]
    L3[level3-tenant モジュール<br/>for_each: tenants]
    Comp[composite モジュール]

    L0 -->|monitor_ids| Comp
    L2 -->|monitor_ids<br/>FR-002-5含む| Comp
    L3 -->|monitor_ids| Comp

    style Comp fill:#ffaadd
```

### 外部依存

| リソース | 依存内容 |
|---------|---------|
| Datadog Provider | `DataDog/datadog` (~> 3.30) |

**重要**: Composite Monitor は L0/L2/L3 の Monitor ID に依存するため、**最後に実装**します。

---

## 9. 実装時の注意事項

### 9.1 Composite Monitor のクエリ構文

**Datadog Composite Monitor の仕様**:
- 論理演算子: `&&` (AND), `||` (OR), `NOT` (否定)
- Monitor ID参照: `${id}` 形式
- **`!` は使用できません** → `NOT` を使用

**✅ 正しい構文**:
```hcl
query = "(${id1} || ${id2}) && NOT ${id3}"
```

**❌ 間違った構文**:
```hcl
query = "(${id1} || ${id2}) && !${id3}"  # ! は使用できない
```

### 9.2 Monitor ID の参照

**Terraform リソース参照**:
```hcl
datadog_monitor.l0_composite.id  # L0-Composite Monitor のID
```

**変数からの参照**:
```hcl
var.l0_monitor_ids["rds_cpu"]  # L0-RDS-CPU Monitor のID
```

### 9.3 L2 Monitor ID の動的取得

**重要**: `var.l2_monitor_ids` は level2-service モジュールの outputs.tf で定義されたすべてのMonitor IDを含みます。

**level2-service モジュールの outputs.tf**:
```hcl
output "monitor_ids" {
  value = merge(
    {
      alb_health         = datadog_monitor.alb_health.id
      ecs_task_stopped   = datadog_monitor.ecs_task_stopped.id
      ecr_vulnerability  = datadog_monitor.ecr_vulnerability.id
    },
    var.e2e_health_check_enabled ? {
      e2e_health_check = datadog_synthetics_test.e2e_health_check[0].monitor_id
    } : {}
  )
}
```

**結果**: `var.l2_monitor_ids` には以下が含まれる（e2e_health_check_enabled=true の場合）:
- `alb_health`
- `ecs_task_stopped`
- `ecr_vulnerability`
- **`e2e_health_check`（FR-002-5）**

**Composite Monitor のクエリ**:
```hcl
query = "(${join(" || ", [for monitor_id in values(var.l2_monitor_ids) : "${monitor_id}"])}) && NOT ${datadog_monitor.l0_composite.id}"
```

**展開後のクエリ**（概念図）:
```
(alb_health_id || ecs_task_stopped_id || ecr_vulnerability_id || e2e_health_check_id) && NOT l0_composite_id
```

**メリット**: level2-service モジュールで Monitor を追加しても、composite モジュールの変更は不要。

---

## 10. テスト方法

### 10.1 単体テスト

```powershell
# modules/composite ディレクトリでテスト
cd modules/composite

# terraform init
terraform init

# terraform plan（変数を渡す）
terraform plan \
  -var='l0_monitor_ids={"rds_cpu"="123"}' \
  -var='l2_monitor_ids={"alb_health"="456","e2e_health_check"="999"}' \
  -var='l3_monitor_ids={"tenant-a"={"health_check"="789"}}' \
  -var='tenants={"tenant-a"={errors_threshold=10,latency_threshold=1000}}'
```

**期待される出力**:
```
Plan: 3 to add, 0 to change, 0 to destroy.
# L0-Composite, L2-Composite, L3-Composite(tenant-a)
```

### 10.2 L2-Composite Monitor の確認

**Datadog UI での確認**:
1. **Monitors → Manage Monitors** を開く
2. `[L2 Composite] サービスレイヤー障害` を選択
3. **Query** タブで以下を確認:
   ```
   (456 || 789 || 012 || 999) && NOT 123
   ```
   - `999`: FR-002-5（E2Eヘルスチェック）のMonitor ID
   - `123`: L0-Composite のMonitor ID

---

## 11. 監視数の変更（FR-002-5追加による影響）

### 修正前

| Composite Monitor | 含まれるMonitor数 |
|------------------|-----------------|
| L0-Composite | 7個（変更なし） |
| L2-Composite | 3個 |
| L3-Composite（テナントごと） | 3個（変更なし） |

### 修正後（FR-002-5追加）

| Composite Monitor | 含まれるMonitor数 |
|------------------|-----------------|
| L0-Composite | 7個（変更なし） |
| L2-Composite | **4個**（FR-002-5追加） |
| L3-Composite（テナントごと） | 3個（変更なし） |

**影響**: L2-Composite のクエリに FR-002-5 が自動的に含まれる（level2-service の outputs.tf で追加されるため、composite モジュールの変更は不要）。

---

## 12. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| 基本設計（監視設計） | [../../01_基本設計/05_監視設計.md](../../01_基本設計/05_監視設計.md) |
| パラメータシート | [02_パラメータシート.md](02_パラメータシート.md) |
| 構築手順書 | [03_構築手順書.md](03_構築手順書.md) |
| Datadog Composite Monitor ドキュメント | https://docs.datadoghq.com/monitors/types/composite/ |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.1
**ステータス**: Draft
**変更履歴**:
- 1.0 (2025-12-28): 初版作成
- 1.1 (2025-12-28): FR-002-5（E2Eヘルスチェック）がL2-Compositeに自動的に含まれることを明記、動作シナリオ追加
