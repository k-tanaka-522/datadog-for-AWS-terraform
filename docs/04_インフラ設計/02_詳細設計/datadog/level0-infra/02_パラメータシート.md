# level0-infra モジュール パラメータシート

## 1. 概要

このドキュメントは、level0-infra モジュールで使用するパラメータの定義を記載します。

---

## 2. 閾値パラメータ

### 2.1 RDS 監視パラメータ

| パラメータ名 | デフォルト値 | 単位 | Critical | Warning | 説明 |
|------------|------------|------|---------|---------|------|
| `rds_cpu_threshold` | 95 | % | 95% | 80% | RDS CPU使用率の閾値 |
| `rds_conn_threshold` | 90 | % | 90% | 70% | RDS 接続数の閾値（max_connectionsに対する%） |
| `rds_mem_threshold` | 10 | % | 10% | 20% | RDS 空きメモリの閾値（この値を**下回る**とアラート） |
| `rds_storage_threshold` | 5 | % | 5% | 10% | RDS 空きストレージの閾値（この値を**下回る**とアラート） |

**閾値の根拠**:
- **RDS CPU 95%**: PostgreSQL では CPU 95%超えで性能劣化が顕著
- **RDS 接続数 90%**: max_connections に達するとエラー（FATAL: sorry, too many clients）
- **RDS メモリ 10%**: メモリ不足でディスクI/Oが増加し、レイテンシ悪化
- **RDS ストレージ 5%**: ストレージフルでDB停止を回避するため余裕を持った閾値

### 2.2 ECS 監視パラメータ

| パラメータ名 | デフォルト値 | 単位 | Critical | Warning | 説明 |
|------------|------------|------|---------|---------|------|
| `ecs_tasks_threshold` | 0 | 個 | 0 | 1 | ECS Running Tasks の閾値（この値以下でアラート） |

**閾値の根拠**:
- **ECS Tasks 0**: サービス停止を意味するため、即座にアラート
- **Warning 1**: 冗長性が失われた状態（最低2タスク推奨）

### 2.3 VPC Flow Logs 監視パラメータ

| パラメータ名 | デフォルト値 | 単位 | Critical | Warning | 説明 |
|------------|------------|------|---------|---------|------|
| VPC Flow Logs (固定) | 100 | パケット/5分 | 100 | 50 | 5分間で100パケット以上のREJECTでアラート |

**閾値の根拠**:
- 通常時のREJECTパケット数を調査し、異常な急増を検知
- PoCでは固定値、本番では Anomaly Detection 推奨

---

## 3. 通知先パラメータ

### 3.1 通知チャネル定義

| 階層 | 通知先 | 対応者 | 緊急度 | 通知形式 |
|------|-------|-------|--------|---------|
| L0 Composite | `@slack-ops-alerts-critical` | インフラチーム（24/7） | Critical | Slack |
| L0 Composite | `@pagerduty-infra-team` | インフラチーム（24/7） | Critical | PagerDuty |

### 3.2 terraform.tfvars での設定例

```hcl
notification_channels = [
  "@slack-ops-alerts-critical",
  "@pagerduty-infra-team"
]
```

**注**: Datadog Integration で Slack、PagerDuty の設定が事前に必要です。

---

## 4. タグパラメータ

### 4.1 自動付与タグ

level0-infra モジュールでは、以下のタグが自動付与されます。

| タグキー | タグ値 | 説明 |
|---------|-------|------|
| `layer` | `l0` | 監視階層（L0固定） |
| `resource` | `rds` / `ecs` / `vpc` / `agent` | 監視対象リソース種別 |
| `severity` | `critical` / `high` | アラートの重要度 |

### 4.2 共通タグ（terraform.tfvars で設定）

```hcl
tags = {
  project     = "datadog-poc"
  environment = "poc"
  managed_by  = "terraform"
}
```

**最終的なタグ**（例: RDS CPU Monitor）:
```
layer:l0
resource:rds
severity:critical
project:datadog-poc
environment:poc
managed_by:terraform
```

---

## 5. 環境別パラメータ

### 5.1 PoC環境（1環境のみ）

**RDS インスタンス識別子**:
```hcl
rds_instance_id = "myapp-db"
```

**ECS Cluster 名**:
```hcl
ecs_cluster_name = "myapp-cluster"
```

**閾値（デフォルト値を使用）**:
- `rds_cpu_threshold`: 95
- `rds_conn_threshold`: 90
- `rds_mem_threshold`: 10
- `rds_storage_threshold`: 5
- `ecs_tasks_threshold`: 0

### 5.2 本番移行時の環境差分（参考）

| 環境 | RDS CPU閾値 | RDS 接続数閾値 | ECS Tasks閾値 | 備考 |
|------|-----------|--------------|--------------|------|
| PoC | 95% | 90% | 0 | デフォルト値 |
| Staging | 90% | 85% | 1 | 本番より厳しい閾値でテスト |
| Production | 85% | 80% | 2 | 早期アラートで余裕を持った対応 |

**本番環境の terraform.tfvars 例**:
```hcl
rds_cpu_threshold = 85
rds_conn_threshold = 80
ecs_tasks_threshold = 2
```

---

## 6. パラメータ検証ルール

### 6.1 必須パラメータ

以下のパラメータは必須です（デフォルト値なし）:

- `rds_instance_id`: RDS インスタンス識別子
- `ecs_cluster_name`: ECS Cluster 名

**terraform apply 時のエラー例**（パラメータ未設定）:
```
Error: Missing required variable

  on variables.tf line 1:
   1: variable "rds_instance_id" {

The variable "rds_instance_id" must be set.
```

### 6.2 閾値の妥当性チェック

**RDS CPU閾値**:
- 範囲: 0〜100（%）
- 推奨: 80〜95

**RDS 接続数閾値**:
- 範囲: 0〜100（%）
- 推奨: 80〜90

**RDS メモリ・ストレージ閾値**:
- 範囲: 0〜100（%）
- 推奨: 5〜20（空きメモリ・ストレージが**この値を下回る**とアラート）

---

## 7. パラメータのカスタマイズ例

### 7.1 閾値を厳しくする例

```hcl
# terraform.tfvars
rds_cpu_threshold = 80  # 95% → 80% に変更（早期アラート）
rds_cpu_warning   = 60  # 80% → 60% に変更
```

### 7.2 通知先を追加する例

```hcl
# terraform.tfvars
notification_channels = [
  "@slack-ops-alerts-critical",
  "@pagerduty-infra-team",
  "@ops-team@example.com"  # Email通知を追加
]
```

### 7.3 タグをカスタマイズする例

```hcl
# terraform.tfvars
tags = {
  project     = "datadog-poc"
  environment = "poc"
  managed_by  = "terraform"
  owner       = "infra-team"  # カスタムタグ追加
  cost_center = "engineering"
}
```

---

## 8. メトリクス収集の確認方法

### 8.1 Datadog Metrics Explorer での確認

**RDS メトリクス確認**:
```
Metrics Explorer → `aws.rds.cpuutilization` → Filter: `dbinstanceidentifier:myapp-db`
```

**ECS メトリクス確認**:
```
Metrics Explorer → `aws.ecs.running_tasks_count` → Filter: `clustername:myapp-cluster`
```

**VPC Flow Logs 確認**:
```
Logs Explorer → `source:vpc-flow-logs` → Filter: `status:reject`
```

**Datadog Agent 確認**:
```
Metrics Explorer → `datadog.agent.up` → Filter: `*`
```

### 8.2 メトリクスが収集されない場合

**原因と対処**:

| メトリクス | 原因 | 対処 |
|---------|------|------|
| `aws.rds.cpuutilization` | AWS Integration 未設定 | Datadog UI → Integrations → AWS → Install Integration |
| `aws.ecs.running_tasks_count` | ECS Metrics 未有効 | AWS Integration で ECS にチェック |
| `vpc.flow.anomaly` | VPC Flow Logs 未収集 | CloudWatch Logs → Datadog Log Forwarder 設定 |
| `datadog.agent.up` | Agent 未インストール | ECS タスクに Datadog Agent コンテナ追加 |

---

## 9. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| モジュール詳細設計 | [01_モジュール詳細設計.md](01_モジュール詳細設計.md) |
| 構築手順書 | [03_構築手順書.md](03_構築手順書.md) |
| 基本設計（監視設計） | [../../01_基本設計/05_監視設計.md](../../01_基本設計/05_監視設計.md) |
| 基本設計（セキュリティ設計） | [../../01_基本設計/03_セキュリティ設計.md](../../01_基本設計/03_セキュリティ設計.md) |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.0
**ステータス**: Draft
