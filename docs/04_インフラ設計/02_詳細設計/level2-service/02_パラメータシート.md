# level2-service モジュール パラメータシート

## 1. 概要

このドキュメントは、level2-service モジュールで使用するパラメータの定義を記載します。

---

## 2. 閾値パラメータ

### 2.1 ALB 監視パラメータ

| パラメータ名 | デフォルト値 | 単位 | Critical | Warning | 説明 |
|------------|------------|------|---------|---------|------|
| `alb_healthy_host_threshold` | 0 | 個 | 0 | 1 | ALB ヘルシーホスト数の閾値（この値以下でアラート） |

**閾値の根拠**:
- **ALB Healthy Hosts 0**: サービス停止を意味するため、即座にアラート
- **Warning 1**: 冗長性が失われた状態（最低2ホスト推奨）

### 2.2 ECS Task 監視パラメータ

| パラメータ名 | デフォルト値 | 単位 | Critical | 説明 |
|------------|------------|------|---------|------|
| ECS Task Event (固定) | 0 | イベント/5分 | 0 | 5分間でエラーイベントが1件以上でアラート |

**閾値の根拠**:
- ECS Task の異常停止は即座に対応が必要なため、1件でもアラート

### 2.3 ECR 脆弱性監視パラメータ

| パラメータ名 | デフォルト値 | 単位 | Critical | 説明 |
|------------|------------|------|---------|------|
| ECR Critical Vulnerability (固定) | 0 | 件 | 0 | Critical脆弱性が1件以上でアラート |

**閾値の根拠**:
- Critical脆弱性は即座に対応が必要なため、1件でもアラート
- Medium以下の脆弱性は別途定期レビューで対応

---

## 3. 通知先パラメータ

### 3.1 通知チャネル定義

| 階層 | 通知先 | 対応者 | 緊急度 | 通知形式 |
|------|-------|-------|--------|---------|
| L2 Composite | `@slack-ops-alerts-high` | アプリケーションチーム | High | Slack |
| L2 Composite | `@app-team@example.com` | アプリケーションチーム | High | Email |

### 3.2 terraform.tfvars での設定例

```hcl
notification_channels = [
  "@slack-ops-alerts-high",
  "@app-team@example.com"
]
```

---

## 4. タグパラメータ

### 4.1 自動付与タグ

level2-service モジュールでは、以下のタグが自動付与されます。

| タグキー | タグ値 | 説明 |
|---------|-------|------|
| `layer` | `l2` | 監視階層（L2固定） |
| `resource` | `alb` / `ecs` / `ecr` | 監視対象リソース種別 |
| `severity` | `critical` / `high` | アラートの重要度 |

### 4.2 共通タグ（terraform.tfvars で設定）

```hcl
tags = {
  project     = "datadog-poc"
  environment = "poc"
  managed_by  = "terraform"
}
```

---

## 5. 環境別パラメータ

### 5.1 PoC環境（1環境のみ）

**ALB Target Group 名**:
```hcl
alb_target_group = "myapp-tg"
```

**ECS Cluster 名**:
```hcl
ecs_cluster_name = "myapp-cluster"
```

**ECR リポジトリ名**:
```hcl
ecr_repository_name = "myapp"
```

**閾値（デフォルト値を使用）**:
- `alb_healthy_host_threshold`: 0

---

## 6. メトリクス収集の確認方法

### 6.1 Datadog Metrics Explorer での確認

**ALB メトリクス確認**:
```
Metrics Explorer → `aws.applicationelb.healthy_host_count` → Filter: `targetgroup:myapp-tg`
```

**ECS イベント確認**:
```
Logs Explorer → `source:ecs` → Filter: `status:error`
```

**ECR 脆弱性確認**:
```
Metrics Explorer → `aws.ecr.vulnerability.critical` → Filter: `repository_name:myapp`
```

---

## 7. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| モジュール詳細設計 | [01_モジュール詳細設計.md](01_モジュール詳細設計.md) |
| 構築手順書 | [03_構築手順書.md](03_構築手順書.md) |
| 基本設計（監視設計） | [../../01_基本設計/05_監視設計.md](../../01_基本設計/05_監視設計.md) |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.0
**ステータス**: Draft
