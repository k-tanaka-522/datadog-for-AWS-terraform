# level2-service モジュール 構築手順書

## 1. 概要

このドキュメントは、level2-service モジュールを使用して L2 Monitor を構築する手順を記載します。

---

## 2. 事前準備

### 2.1 必要な権限

| サービス | 必要な権限 | 用途 |
|---------|----------|------|
| Datadog | API Key、APP Key | Monitor作成 |
| AWS | ReadOnlyAccess | メトリクス収集確認用 |

### 2.2 環境変数の設定

```powershell
# Datadog API Key/APP Key を環境変数に設定
$env:TF_VAR_datadog_api_key = $env:DD_API_KEY
$env:TF_VAR_datadog_app_key = $env:DD_APP_KEY
```

### 2.3 Datadog AWS Integration の確認

L2 Monitor は AWS メトリクス（ALB、ECS、ECR）を使用します。事前に Datadog AWS Integration が有効であることを確認してください。

**確認手順**:
1. Datadog UI → Integrations → AWS を開く
2. AWS アカウントが接続されていることを確認
3. ALB、ECS、ECR にチェックが入っていることを確認

---

## 3. Terraform 初期化

### 3.1 terraform.tfvars の作成

```hcl
# terraform.tfvars

# AWS リソース識別子
alb_target_group     = "myapp-tg"
ecs_cluster_name     = "myapp-cluster"
ecr_repository_name  = "myapp"

# 閾値（デフォルト値を使用する場合は省略可）
alb_healthy_host_threshold = 0

# 通知先
notification_channels = [
  "@slack-ops-alerts-high"
]

# 共通タグ
tags = {
  project     = "datadog-poc"
  environment = "poc"
  managed_by  = "terraform"
}
```

### 3.2 terraform init 実行

```powershell
terraform init
```

---

## 4. terraform plan（dry-run）

### 4.1 plan 実行

```powershell
terraform plan -out=tfplan
```

**期待される出力**:
```
Plan: 3 to add, 0 to change, 0 to destroy.

  # module.level2_service.datadog_monitor.alb_health will be created
  # module.level2_service.datadog_monitor.ecs_task_stopped will be created
  # module.level2_service.datadog_monitor.ecr_vulnerability will be created
```

---

## 5. terraform apply（本番実行）

### 5.1 apply 実行

```powershell
terraform apply tfplan
```

**期待される出力**:
```
module.level2_service.datadog_monitor.alb_health: Creating...
module.level2_service.datadog_monitor.ecs_task_stopped: Creating...
module.level2_service.datadog_monitor.ecr_vulnerability: Creating...

Apply complete! Resources: 3 added, 0 changed, 0 destroyed.
```

---

## 6. 確認方法

### 6.1 Datadog UI での確認

1. Datadog UI → **Monitors** → **Manage Monitors** を開く
2. タグフィルター: `layer:l2` で絞り込み
3. 3個の Monitor が作成されていることを確認
   - [L2] ALB Target Group Health
   - [L2] ECS Task 異常停止
   - [L2] ECR 脆弱性（Critical）

---

## 7. テスト実行（動作確認）

### 7.1 L2-ALB-Health Monitor のテスト

**手順**:
1. AWS コンソール → EC2 → Target Groups → myapp-tg を開く
2. ターゲットを手動で Unhealthy にする（または ECS タスクを停止）
3. Datadog UI → Monitors → [L2] ALB Target Group Health を開く
4. ステータスが `ALERT` になることを確認

### 7.2 L2-ECS-Task Monitor のテスト

**手順**:
1. AWS CLI で ECS タスクを停止
   ```bash
   aws ecs stop-task --cluster myapp-cluster --task <task-id>
   ```
2. Datadog UI → Monitors → [L2] ECS Task 異常停止 を開く
3. ステータスが `ALERT` になることを確認

---

## 8. トラブルシューティング

### 8.1 よくあるエラー

#### エラー1: `aws.applicationelb.healthy_host_count` が表示されない

**原因**: Datadog AWS Integration で ALB にチェックが入っていない

**対処**:
1. Datadog UI → Integrations → AWS → ALB にチェック
2. 5〜10分待ってメトリクスが収集されることを確認

#### エラー2: ECS イベントが検知されない

**原因**: Datadog Event Collection が有効でない

**対処**:
1. Datadog UI → Integrations → AWS → Event Collection を有効化
2. CloudWatch Events → Datadog への転送設定を確認

---

## 9. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| モジュール詳細設計 | [01_モジュール詳細設計.md](01_モジュール詳細設計.md) |
| パラメータシート | [02_パラメータシート.md](02_パラメータシート.md) |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.0
**ステータス**: Draft
