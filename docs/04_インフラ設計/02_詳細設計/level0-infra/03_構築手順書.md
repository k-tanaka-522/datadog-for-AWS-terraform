# level0-infra モジュール 構築手順書

## 1. 概要

このドキュメントは、level0-infra モジュールを使用して L0 Monitor を構築する手順を記載します。

---

## 2. 事前準備

### 2.1 必要な権限

| サービス | 必要な権限 | 用途 |
|---------|----------|------|
| Datadog | API Key、APP Key | Monitor作成 |
| AWS | ReadOnlyAccess | メトリクス収集確認用（Terraform実行には不要） |

### 2.2 環境変数の設定

**PowerShell（Windows）**:
```powershell
# Datadog API Key/APP Key を環境変数に設定
$env:TF_VAR_datadog_api_key = $env:DD_API_KEY
$env:TF_VAR_datadog_app_key = $env:DD_APP_KEY

# 確認
echo $env:TF_VAR_datadog_api_key
echo $env:TF_VAR_datadog_app_key
```

**Bash（Linux/Mac）**:
```bash
# Datadog API Key/APP Key を環境変数に設定
export TF_VAR_datadog_api_key=$DD_API_KEY
export TF_VAR_datadog_app_key=$DD_APP_KEY

# 確認
echo $TF_VAR_datadog_api_key
echo $TF_VAR_datadog_app_key
```

**注**: API Key は Datadog UI → Organization Settings → API Keys で取得してください。

### 2.3 Datadog AWS Integration の確認

L0 Monitor は AWS メトリクス（RDS、ECS）を使用します。事前に Datadog AWS Integration が有効であることを確認してください。

**確認手順**:
1. Datadog UI → Integrations → AWS を開く
2. AWS アカウントが接続されていることを確認
3. RDS、ECS にチェックが入っていることを確認

### 2.4 VPC Flow Logs の設定（L0-VPC-Flow Monitor 用）

**CloudWatch Logs への送信設定**:
```bash
# AWS CLI で VPC Flow Logs を有効化
aws ec2 create-flow-logs \
  --resource-type VPC \
  --resource-ids vpc-xxxxxxxx \
  --traffic-type ALL \
  --log-destination-type cloud-watch-logs \
  --log-group-name /aws/vpc/flow-logs
```

**Datadog Log Forwarder の設定**:
1. Datadog UI → Integrations → AWS → Log Collection
2. CloudWatch Logs → Datadog への転送設定を実施

### 2.5 Datadog Agent の設定（L0-Agent Monitor 用）

**ECS タスクに Datadog Agent コンテナを追加**（例）:
```json
{
  "name": "datadog-agent",
  "image": "datadog/agent:latest",
  "environment": [
    {
      "name": "DD_API_KEY",
      "value": "YOUR_API_KEY"
    },
    {
      "name": "DD_SITE",
      "value": "datadoghq.com"
    }
  ]
}
```

---

## 3. Terraform 初期化

### 3.1 ディレクトリ構成の確認

```
terraform/
├── main.tf
├── variables.tf
├── outputs.tf
├── providers.tf
├── backend.tf
├── terraform.tfvars  # このファイルを作成
└── modules/
    └── level0-infra/
        ├── main.tf
        ├── variables.tf
        ├── outputs.tf
        └── monitors.tf
```

### 3.2 terraform.tfvars の作成

```hcl
# terraform.tfvars

# AWS リソース識別子
rds_instance_id  = "myapp-db"
ecs_cluster_name = "myapp-cluster"

# 閾値（デフォルト値を使用する場合は省略可）
rds_cpu_threshold = 95
rds_conn_threshold = 90
rds_mem_threshold = 10
rds_storage_threshold = 5
ecs_tasks_threshold = 0

# 通知先
notification_channels = [
  "@slack-ops-alerts-critical"
]

# 共通タグ
tags = {
  project     = "datadog-poc"
  environment = "poc"
  managed_by  = "terraform"
}
```

### 3.3 terraform init 実行

```powershell
# Terraform 初期化
terraform init
```

**期待される出力**:
```
Initializing modules...
- level0_infra in modules/level0-infra

Initializing the backend...

Initializing provider plugins...
- Finding DataDog/datadog versions matching "~> 3.30"...
- Installing DataDog/datadog v3.30.0...

Terraform has been successfully initialized!
```

---

## 4. terraform plan（dry-run）

### 4.1 plan 実行

```powershell
# plan実行（差分確認）
terraform plan -out=tfplan
```

**期待される出力**:
```
Terraform will perform the following actions:

  # module.level0_infra.datadog_monitor.rds_cpu will be created
  + resource "datadog_monitor" "rds_cpu" {
      + id      = (known after apply)
      + name    = "[L0] RDS CPU使用率"
      + type    = "metric alert"
      + query   = "avg(last_5m):avg:aws.rds.cpuutilization{dbinstanceidentifier:myapp-db} > 95"
      + tags    = ["layer:l0", "resource:rds", "severity:critical", "project:datadog-poc", "environment:poc", "managed_by:terraform"]
      ...
    }

  # module.level0_infra.datadog_monitor.rds_conn will be created
  ...

Plan: 7 to add, 0 to change, 0 to destroy.
```

### 4.2 plan 結果の確認ポイント

**✅ 確認項目**:
- [ ] 7個の Monitor が作成される（rds_cpu, rds_conn, rds_mem, rds_storage, ecs_tasks, vpc_flow, agent）
- [ ] `rds_instance_id` が正しい（例: myapp-db）
- [ ] `ecs_cluster_name` が正しい（例: myapp-cluster）
- [ ] 閾値が意図した値になっている（例: rds_cpu_threshold = 95）
- [ ] 通知先が正しい（例: @slack-ops-alerts-critical）
- [ ] タグが正しい（layer:l0、resource:rds 等）

**❌ NG パターン**:
- `Error: Missing required variable` → terraform.tfvars でパラメータ設定漏れ
- `Plan: 0 to add` → モジュール呼び出しが正しくない

---

## 5. terraform apply（本番実行）

### 5.1 apply 実行

```powershell
# plan で確認済みの内容を適用
terraform apply tfplan
```

**期待される出力**:
```
module.level0_infra.datadog_monitor.rds_cpu: Creating...
module.level0_infra.datadog_monitor.rds_conn: Creating...
module.level0_infra.datadog_monitor.rds_mem: Creating...
module.level0_infra.datadog_monitor.rds_storage: Creating...
module.level0_infra.datadog_monitor.ecs_tasks: Creating...
module.level0_infra.datadog_monitor.vpc_flow: Creating...
module.level0_infra.datadog_monitor.agent: Creating...

module.level0_infra.datadog_monitor.rds_cpu: Creation complete after 2s [id=123456789]
module.level0_infra.datadog_monitor.rds_conn: Creation complete after 2s [id=123456790]
...

Apply complete! Resources: 7 added, 0 changed, 0 destroyed.
```

### 5.2 所要時間

- **初回デプロイ**: 約2〜5分（7個の Monitor 作成）

---

## 6. 確認方法

### 6.1 Datadog UI での確認

**手順**:
1. Datadog UI → **Monitors** → **Manage Monitors** を開く
2. タグフィルター: `layer:l0` で絞り込み
3. 以下の7個の Monitor が作成されていることを確認

**期待される Monitor 一覧**:
| Monitor名 | タグ | ステータス |
|----------|------|----------|
| [L0] RDS CPU使用率 | layer:l0, resource:rds, severity:critical | OK |
| [L0] RDS 接続数 | layer:l0, resource:rds, severity:critical | OK |
| [L0] RDS メモリ | layer:l0, resource:rds, severity:critical | OK |
| [L0] RDS ストレージ | layer:l0, resource:rds, severity:critical | OK |
| [L0] ECS Running Tasks | layer:l0, resource:ecs, severity:critical | OK |
| [L0] VPC Flow Logs 異常 | layer:l0, resource:vpc, severity:high | OK |
| [L0] Datadog Agent 死活 | layer:l0, resource:agent, severity:critical | OK |

### 6.2 Monitor の詳細確認

**Monitor をクリック** → 以下を確認:
- **Query**: メトリクスクエリが正しいか
- **Thresholds**: Critical、Warning の閾値が正しいか
- **Message**: 通知メッセージに `@slack-ops-alerts-critical` が含まれているか
- **Tags**: `layer:l0`, `resource:rds`, `severity:critical`, `project:datadog-poc` 等が付与されているか

### 6.3 terraform output での確認

```powershell
# 作成した Monitor のID一覧を表示
terraform output
```

**期待される出力**:
```
l0_monitor_ids = {
  "rds_cpu"     = "123456789"
  "rds_conn"    = "123456790"
  "rds_mem"     = "123456791"
  "rds_storage" = "123456792"
  "ecs_tasks"   = "123456793"
  "vpc_flow"    = "123456794"
  "agent"       = "123456795"
}
```

---

## 7. テスト実行（動作確認）

### 7.1 L0-RDS-CPU Monitor のテスト

**目的**: RDS CPU使用率が閾値を超えた際にアラートが発火することを確認

**手順**:
1. RDS に負荷をかける（pgbench等のベンチマークツール）
2. CPU使用率が95%を超えるまで負荷を継続
3. Datadog UI → Monitors → [L0] RDS CPU使用率 を開く
4. ステータスが `ALERT` になることを確認
5. Slack に通知が届くことを確認

**負荷テストツール例（PostgreSQL）**:
```bash
# pgbench で負荷テスト
pgbench -h myapp-db.xxxx.ap-northeast-1.rds.amazonaws.com -U postgres -c 10 -t 1000
```

### 7.2 L0-ECS-Tasks Monitor のテスト

**目的**: ECS タスクが0になった際にアラートが発火することを確認

**手順**:
1. AWS CLI で ECS タスクを停止
   ```bash
   aws ecs stop-task --cluster myapp-cluster --task <task-id>
   ```
2. Datadog UI → Monitors → [L0] ECS Running Tasks を開く
3. ステータスが `ALERT` になることを確認
4. Slack に通知が届くことを確認

---

## 8. トラブルシューティング

### 8.1 よくあるエラー

#### エラー1: `Error: Invalid provider credentials`

**原因**: Datadog API Key/APP Key が未設定

**対処**:
```powershell
# 環境変数を再設定
$env:TF_VAR_datadog_api_key = $env:DD_API_KEY
$env:TF_VAR_datadog_app_key = $env:DD_APP_KEY
```

#### エラー2: `Error: Monitor already exists`

**原因**: 手動で作成した Monitor と名前が重複

**対処**:
1. Datadog UI で既存の Monitor を削除
2. または、terraform import で既存 Monitor を State に取り込む
   ```powershell
   terraform import module.level0_infra.datadog_monitor.rds_cpu 123456789
   ```

#### エラー3: `Plan: 0 to add, 0 to change, 0 to destroy.`

**原因**: モジュール呼び出しが正しくない、または terraform.tfvars が読み込まれていない

**対処**:
1. main.tf でモジュール呼び出しを確認
   ```hcl
   module "level0_infra" {
     source = "./modules/level0-infra"
     ...
   }
   ```
2. terraform.tfvars が terraform/ ディレクトリ直下にあることを確認

### 8.2 メトリクスが収集されない場合

#### 問題: `aws.rds.cpuutilization` が表示されない

**原因**: Datadog AWS Integration が有効でない

**対処**:
1. Datadog UI → Integrations → AWS → Install Integration
2. AWS アカウントを接続
3. RDS にチェックを入れる
4. 5〜10分待ってメトリクスが収集されることを確認

#### 問題: `vpc.flow.anomaly` が表示されない

**原因**: VPC Flow Logs が CloudWatch Logs に送信されていない

**対処**:
1. AWS コンソール → VPC → Flow Logs を確認
2. CloudWatch Logs へのログ送信を有効化
3. Datadog Log Forwarder Lambda を設定

#### 問題: `datadog.agent.up` が表示されない

**原因**: Datadog Agent が起動していない

**対処**:
1. ECS タスクに Datadog Agent コンテナを追加
2. Agent コンテナが起動していることを確認
   ```bash
   aws ecs describe-tasks --cluster myapp-cluster --tasks <task-id>
   ```

---

## 9. ロールバック手順

### 9.1 Monitor の削除

**全 Monitor を削除する場合**:
```powershell
terraform destroy
```

**特定の Monitor を削除する場合**:
```powershell
# rds_cpu Monitor のみ削除
terraform destroy -target=module.level0_infra.datadog_monitor.rds_cpu
```

**注**: Composite Monitor が L0 Monitor を参照している場合、先に Composite Monitor を削除してください。

### 9.2 State のバックアップ

**削除前に State をバックアップ**:
```powershell
# State をファイルに保存
terraform state pull > terraform.tfstate.backup
```

**リストア**（S3 Backend の場合は不要）:
```powershell
terraform state push terraform.tfstate.backup
```

---

## 10. 変更デプロイ手順

### 10.1 閾値を変更する場合

**手順**:
1. terraform.tfvars を編集
   ```hcl
   rds_cpu_threshold = 90  # 95 → 90 に変更
   ```
2. plan で差分確認
   ```powershell
   terraform plan -out=tfplan
   ```
3. 差分を確認（期待される出力）
   ```
   Plan: 0 to add, 1 to change, 0 to destroy.

   # module.level0_infra.datadog_monitor.rds_cpu will be updated in-place
   ~ resource "datadog_monitor" "rds_cpu" {
       ~ query = "avg(last_5m):avg:aws.rds.cpuutilization{dbinstanceidentifier:myapp-db} > 90"
       ~ thresholds = {
           ~ critical = 90
         }
     }
   ```
4. apply で適用
   ```powershell
   terraform apply tfplan
   ```

### 10.2 通知先を追加する場合

**手順**:
1. terraform.tfvars を編集
   ```hcl
   notification_channels = [
     "@slack-ops-alerts-critical",
     "@pagerduty-infra-team"  # 追加
   ]
   ```
2. plan → apply

---

## 11. 次のステップ

level0-infra モジュールの構築が完了したら、以下のモジュールに進みます:

1. **level2-service モジュール** - L2 Monitor 作成
2. **level3-tenant モジュール** - L3 Monitor 作成（テナントごと）
3. **composite モジュール** - Composite Monitor 作成（L0/L2/L3の親子関係）

---

## 12. 関連ドキュメント

| ドキュメント | パス |
|------------|------|
| モジュール詳細設計 | [01_モジュール詳細設計.md](01_モジュール詳細設計.md) |
| パラメータシート | [02_パラメータシート.md](02_パラメータシート.md) |
| ルートモジュール デプロイ手順書 | [../root/03_デプロイ手順書.md](../root/03_デプロイ手順書.md) |
| 基本設計（監視設計） | [../../01_基本設計/05_監視設計.md](../../01_基本設計/05_監視設計.md) |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.0
**ステータス**: Draft
