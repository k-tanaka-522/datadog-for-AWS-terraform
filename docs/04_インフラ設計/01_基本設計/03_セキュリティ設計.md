# セキュリティ設計

## 1. 概要

本PoCでは、Datadog監視設定を構築する際のセキュリティ要件を定義します。
主要な観点は以下の3点です:

1. **Datadog API Key/APP Key の安全な管理**
2. **IAM権限の最小化**（Terraform実行、AWS監視対象アクセス）
3. **Terraform State の保護**

## 2. Datadog API Key/APP Key 管理

### 2.1 シークレット情報

| 項目 | 用途 | セキュリティレベル |
|------|------|----------------|
| Datadog API Key | Datadog Agent がメトリクスを送信 | **最重要** |
| Datadog APP Key | Terraform が Monitor を作成・更新 | **重要** |

**重要**: これらのKeyは**絶対にコードにハードコードしない**。

### 2.2 管理方法（推奨）

#### 開発環境（Windows PoC環境）

**環境変数で管理**:

```powershell
# PowerShell で環境変数設定
$env:DD_API_KEY = "your_datadog_api_key_here"
$env:DD_APP_KEY = "your_datadog_app_key_here"

# 永続化（ユーザー環境変数）
[System.Environment]::SetEnvironmentVariable("DD_API_KEY", "your_api_key", "User")
[System.Environment]::SetEnvironmentVariable("DD_APP_KEY", "your_app_key", "User")
```

**Terraform での参照**:

```hcl
# terraform/providers.tf
provider "datadog" {
  api_key = var.datadog_api_key
  app_key = var.datadog_app_key
}

# terraform/variables.tf
variable "datadog_api_key" {
  description = "Datadog API Key（環境変数から注入）"
  type        = string
  sensitive   = true
}

variable "datadog_app_key" {
  description = "Datadog APP Key（環境変数から注入）"
  type        = string
  sensitive   = true
}

# terraform/terraform.tfvars（Gitにコミットしない）
# datadog_api_key は環境変数 TF_VAR_datadog_api_key で注入
# datadog_app_key は環境変数 TF_VAR_datadog_app_key で注入
```

**実行時**:

```powershell
# 環境変数を Terraform に自動注入
$env:TF_VAR_datadog_api_key = $env:DD_API_KEY
$env:TF_VAR_datadog_app_key = $env:DD_APP_KEY

# Terraform 実行
terraform plan
terraform apply
```

#### 本番環境（将来）

**AWS Secrets Manager 推奨**:

```hcl
# Secrets Manager からキーを取得
data "aws_secretsmanager_secret" "datadog_api_key" {
  name = "datadog/api_key"
}

data "aws_secretsmanager_secret_version" "datadog_api_key" {
  secret_id = data.aws_secretsmanager_secret.datadog_api_key.id
}

provider "datadog" {
  api_key = jsondecode(data.aws_secretsmanager_secret_version.datadog_api_key.secret_string)["api_key"]
  app_key = jsondecode(data.aws_secretsmanager_secret_version.datadog_api_key.secret_string)["app_key"]
}
```

**メリット**:
- ローテーション機能
- アクセス監査（CloudTrail）
- IAMによる細かいアクセス制御

**注**: PoCでは環境変数管理、本番移行時にSecrets Manager推奨。

### 2.3 .gitignore 設定（必須）

```gitignore
# Terraform シークレット情報
terraform.tfvars
*.tfvars
.terraform/
*.tfstate
*.tfstate.backup

# 環境変数ファイル
.env
.env.local

# Datadog設定ファイル（シークレット含む場合）
datadog.yaml
```

**重要**: `terraform.tfvars` は絶対にGitにコミットしない。

### 2.4 Datadog Agent へのAPI Key注入

ECS Task Definition で環境変数を設定:

```json
{
  "containerDefinitions": [
    {
      "name": "datadog-agent",
      "image": "gcr.io/datadoghq/agent:latest",
      "environment": [
        {
          "name": "DD_API_KEY",
          "value": "環境変数またはSecrets Managerから注入"
        },
        {
          "name": "DD_SITE",
          "value": "datadoghq.com"
        }
      ]
    }
  ]
}
```

**本番推奨**: ECS Task Definition で `secrets` フィールドを使用し、Secrets Managerから注入。

```json
{
  "secrets": [
    {
      "name": "DD_API_KEY",
      "valueFrom": "arn:aws:secretsmanager:ap-northeast-1:123456789012:secret:datadog/api_key"
    }
  ]
}
```

## 3. IAM権限設計

### 3.1 Terraform実行用IAMロール

Terraform が以下のAWS操作を実施するため、最小権限のIAMポリシーを付与します:

| 操作 | 必要な権限 | 理由 |
|------|-----------|------|
| CloudWatch Metrics 読み取り | `cloudwatch:GetMetricStatistics` | Datadog MonitorでAWSメトリクスを参照 |
| RDS 情報読み取り | `rds:DescribeDBInstances` | RDS識別子を取得 |
| ECS 情報読み取り | `ecs:DescribeClusters`, `ecs:DescribeServices` | ECS Cluster/Service名を取得 |
| VPC Flow Logs 読み取り | `logs:DescribeLogGroups` | VPC Flow Logs グループ名を取得 |
| S3（Terraform State） | `s3:GetObject`, `s3:PutObject`, `s3:ListBucket` | State管理 |
| DynamoDB（State Lock） | `dynamodb:GetItem`, `dynamodb:PutItem`, `dynamodb:DeleteItem` | State Lock |

**IAMポリシー例**:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:GetMetricStatistics",
        "cloudwatch:ListMetrics",
        "rds:DescribeDBInstances",
        "ecs:DescribeClusters",
        "ecs:DescribeServices",
        "logs:DescribeLogGroups"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::datadog-terraform-state",
        "arn:aws:s3:::datadog-terraform-state/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:GetItem",
        "dynamodb:PutItem",
        "dynamodb:DeleteItem"
      ],
      "Resource": "arn:aws:dynamodb:ap-northeast-1:123456789012:table/terraform-state-lock"
    }
  ]
}
```

**注**: PoCでは管理者権限を使用可能ですが、本番移行時は上記の最小権限を適用推奨。

### 3.2 Datadog Agent 用IAMロール（ECS Task Role）

Datadog Agent がCloudWatch Metrics を取得するためのIAMロール:

| 操作 | 必要な権限 | 理由 |
|------|-----------|------|
| CloudWatch Metrics 読み取り | `cloudwatch:GetMetricStatistics`, `cloudwatch:ListMetrics` | RDS/ECS等のメトリクス取得 |
| EC2 メタデータ読み取り | `ec2:DescribeInstances`, `ec2:DescribeTags` | ECS Taskのタグ情報取得 |
| ECS メタデータ読み取り | `ecs:ListTasks`, `ecs:DescribeTasks` | ECS Taskの情報取得 |

**IAMポリシー例**:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "cloudwatch:GetMetricStatistics",
        "cloudwatch:ListMetrics",
        "ec2:DescribeInstances",
        "ec2:DescribeTags",
        "ecs:ListTasks",
        "ecs:DescribeTasks"
      ],
      "Resource": "*"
    }
  ]
}
```

**注**: 既存ECS Task Roleに上記権限が付与されているか確認してください。

## 4. Terraform State のセキュリティ

### 4.1 State管理方針

Terraform State には**センシティブ情報**（Datadog Monitor ID、AWS ARN等）が含まれるため、安全に管理します。

| 項目 | 値 | 理由 |
|------|-----|------|
| State保存先 | S3バケット（暗号化有効） | チーム共有、バージョン管理 |
| State Lock | DynamoDB テーブル | 同時実行防止 |
| S3暗号化 | AES-256（SSE-S3） | State内のシークレット保護 |
| バージョニング | 有効 | 誤削除時の復旧 |
| パブリックアクセス | 無効 | 外部流出防止 |

### 4.2 S3バケット設定

**バケット作成（初回のみ）**:

```bash
# S3バケット作成
aws s3 mb s3://datadog-terraform-state --region ap-northeast-1

# バージョニング有効化
aws s3api put-bucket-versioning \
  --bucket datadog-terraform-state \
  --versioning-configuration Status=Enabled

# 暗号化有効化
aws s3api put-bucket-encryption \
  --bucket datadog-terraform-state \
  --server-side-encryption-configuration '{
    "Rules": [
      {
        "ApplyServerSideEncryptionByDefault": {
          "SSEAlgorithm": "AES256"
        }
      }
    ]
  }'

# パブリックアクセスブロック
aws s3api put-public-access-block \
  --bucket datadog-terraform-state \
  --public-access-block-configuration \
    BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
```

### 4.3 DynamoDB テーブル設定

**テーブル作成（初回のみ）**:

```bash
aws dynamodb create-table \
  --table-name terraform-state-lock \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region ap-northeast-1
```

### 4.4 backend.tf 設定

```hcl
# terraform/backend.tf
terraform {
  backend "s3" {
    bucket         = "datadog-terraform-state"
    key            = "datadog-monitors/terraform.tfstate"
    region         = "ap-northeast-1"
    encrypt        = true
    dynamodb_table = "terraform-state-lock"
  }
}
```

**重要**: `backend.tf` に**シークレット情報は含まない**（バケット名、テーブル名のみ）。

## 5. Security Groups 設計（再掲）

### ECS Task Security Group

| 方向 | プロトコル | ポート | 送信元/送信先 | 用途 | セキュリティ考慮 |
|------|-----------|--------|--------------|------|---------------|
| Inbound | HTTP | 8080 | ALB SG | ALBからのトラフィック | ALB SGに限定 |
| Outbound | HTTPS | 443 | 0.0.0.0/0 | Datadog API通信 | **必須**（Datadog SaaS） |
| Outbound | PostgreSQL | 5432 | RDS SG | RDSへの接続 | RDS SGに限定 |

**注**: Outbound HTTPS (443) は Datadog通信に必須ですが、送信先を制限できません（Datadog SaaSはグローバルIPで変動）。

**セキュリティ強化**: PrivateLink（VPC Endpoint）を使用すれば、インターネット経由を回避可能（本番推奨）。

### RDS Security Group

| 方向 | プロトコル | ポート | 送信元/送信先 | 用途 | セキュリティ考慮 |
|------|-----------|--------|--------------|------|---------------|
| Inbound | PostgreSQL | 5432 | ECS SG | ECSからのDB接続 | ECS SGに限定 |
| Outbound | - | - | - | 不要 | - |

**最小権限の原則**: RDSはInbound 5432のみ許可、Outboundは不要。

## 6. 暗号化設計

### 6.1 通信の暗号化

| 通信経路 | プロトコル | 暗号化方式 | 備考 |
|---------|-----------|-----------|------|
| ECS → Datadog SaaS | HTTPS | TLS 1.2+ | Datadog API 通信 |
| ALB → ECS | HTTP | なし | VPC内通信のためHTTP許容（既存設定） |
| ECS → RDS | PostgreSQL | TLS（SSL強制推奨）⭐ | セキュリティ強化 |

**セキュリティ強化案**:
- ALB → ECS 間もHTTPSにする（証明書管理が必要）
- **RDS で `rds.force_ssl=1` を設定し、SSL強制（必須）**⭐

#### RDS SSL強制設定

**パラメータグループ設定**:

```bash
# パラメータグループ作成（既存の場合はスキップ）
aws rds create-db-parameter-group \
  --db-parameter-group-name myapp-postgres-params \
  --db-parameter-group-family postgres15 \
  --description "Custom parameter group for SSL enforcement"

# rds.force_ssl を 1 に設定
aws rds modify-db-parameter-group \
  --db-parameter-group-name myapp-postgres-params \
  --parameters "ParameterName=rds.force_ssl,ParameterValue=1,ApplyMethod=immediate"

# RDS インスタンスに適用
aws rds modify-db-instance \
  --db-instance-identifier myapp-db \
  --db-parameter-group-name myapp-postgres-params \
  --apply-immediately
```

**Terraform での実装**:

```hcl
resource "aws_db_parameter_group" "postgres_ssl" {
  name        = "myapp-postgres-params"
  family      = "postgres15"
  description = "Custom parameter group for SSL enforcement"

  parameter {
    name  = "rds.force_ssl"
    value = "1"
  }
}

resource "aws_db_instance" "myapp" {
  # ... 他の設定 ...
  parameter_group_name = aws_db_parameter_group.postgres_ssl.name
}
```

**検証**:

```bash
# RDS に接続してSSL確認
psql "host=myapp-db.xxxx.ap-northeast-1.rds.amazonaws.com port=5432 dbname=myapp user=admin sslmode=require"

# SSL接続確認クエリ
SELECT ssl_is_used();  # true であればSSL接続成功
```

**重要**: PoC環境でも SSL強制を適用し、本番移行時に問題がないことを確認してください。

### 6.2 データの暗号化

| データ | 暗号化方式 | キー管理 | 備考 |
|------|-----------|---------|------|
| Terraform State（S3） | AES-256 | SSE-S3 | AWS管理キー |
| RDS（既存） | AES-256 | AWS KMS | 既存設定 |
| CloudWatch Logs | AES-256 | AWS KMS（オプション） | 既存設定 |

**注**: Datadog SaaS 内のデータはDatadog側で暗号化（ユーザー側で制御不可）。

## 7. アクセス制御

### 7.1 Datadog UI のアクセス制御

| 項目 | 設計値 | 備考 |
|------|--------|------|
| ユーザー認証 | Datadog アカウント（メール + パスワード） | 2FAを推奨 |
| ロール | Admin, Standard, Read-Only | 運用チームはStandard推奨 |
| SSO | 未使用（PoCのため） | 本番ではOkta等のSSOを推奨 |

### 7.2 Terraform 実行権限

| 環境 | 実行者 | 認証方法 | 備考 |
|------|-------|---------|------|
| PoC（ローカル） | インフラチーム | IAMユーザー（AWS CLI） | 手動実行 |
| 本番（将来） | CI/CD（GitHub Actions等） | IAMロール（OIDC） | 自動化 |

## 8. 監査・ログ

### 8.1 AWS CloudTrail（推奨）

| 項目 | 設計値 | 備考 |
|------|--------|------|
| 有効化 | 推奨 | Terraform実行のAWS API操作を記録 |
| ログ保存先 | S3（別バケット） | 90日間保持推奨 |
| 監視対象 | S3（State）、DynamoDB（Lock）、CloudWatch | 異常アクセス検知 |

**注**: PoCではCloudTrail有効化は任意ですが、本番では必須。

### 8.2 Terraform 実行ログ

```powershell
# Terraform 実行ログを記録
terraform plan -out=tfplan 2>&1 | Tee-Object -FilePath "logs/terraform-plan-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"
terraform apply tfplan 2>&1 | Tee-Object -FilePath "logs/terraform-apply-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"
```

**重要**: ログには**シークレット情報が含まれる可能性**があるため、Gitにコミットしない。

### 8.3 Datadog Audit Trail

Datadog は Monitor の変更履歴を記録します。

| 項目 | 値 | 備考 |
|------|-----|------|
| 有効化 | デフォルトで有効 | Datadog UI で確認可能 |
| 記録内容 | Monitor作成・更新・削除 | Terraform実行も記録 |
| 保持期間 | 90日間 | Datadog プランに依存 |

## 9. セキュリティチェックリスト

### 開発環境（PoC）

- [ ] Datadog API Key/APP Key を環境変数で管理
- [ ] `.gitignore` に `terraform.tfvars`, `.env` を追加
- [ ] Terraform State を S3 + 暗号化で管理
- [ ] DynamoDB で State Lock を有効化
- [ ] ECS Task SG の Outbound HTTPS (443) を許可
- [ ] **RDS で SSL 強制（`rds.force_ssl=1`）を設定**⭐
- [ ] IAM権限を確認（最小権限ではなくてもOK）

### 本番環境（将来）

- [ ] Datadog API Key を AWS Secrets Manager で管理
- [ ] IAM権限を最小化（上記ポリシー例を適用）
- [ ] CloudTrail を有効化
- [ ] **RDS で SSL 強制（`rds.force_ssl=1`）を確認**⭐
- [ ] ALB → ECS 間を HTTPS 化
- [ ] Datadog PrivateLink（VPC Endpoint）を検討
- [ ] Datadog UI で 2FA 有効化
- [ ] SSO（Okta等）を導入

## 10. インシデント対応

### Datadog API Key 漏洩時の対応

| ステップ | 対応 | 所要時間 |
|--------|------|---------|
| 1. 検知 | GitHub Advanced Security、Datadog Audit Trail | 即座 |
| 2. 無効化 | Datadog UI で API Key を削除 | 5分以内 |
| 3. 再発行 | 新しい API Key を発行 | 5分以内 |
| 4. 更新 | 環境変数 / Secrets Manager を更新 | 10分以内 |
| 5. 再デプロイ | Terraform apply、ECS Task 再起動 | 10分以内 |

**合計所要時間**: 30分以内

### Terraform State 誤削除時の対応

| ステップ | 対応 | 所要時間 |
|--------|------|---------|
| 1. 検知 | terraform plan でエラー検知 | 即座 |
| 2. 復旧 | S3 バージョニングから復元 | 5分以内 |
| 3. 確認 | terraform plan で差分なしを確認 | 5分以内 |

**合計所要時間**: 10分以内

## 11. 関連ドキュメント

| ドキュメント | パス |
|-------------|------|
| システム構成図 | [01_システム構成図.md](01_システム構成図.md) |
| ネットワーク設計 | [02_ネットワーク設計.md](02_ネットワーク設計.md) |
| バックアップ設計 | [06_バックアップ設計.md](06_バックアップ設計.md) |
| IaC構成方針 | [10_IaC方針.md](10_IaC方針.md) |
| セキュリティ基準 | .claude/docs/40_standards/49_common/security.md |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.1
**ステータス**: Draft
**変更履歴**:
- 1.1 (2025-12-28): RDS SSL強制を「必須」に変更、設定手順とTerraform実装例を追記
