# バックアップ設計

## 1. 概要

本PoCでは、Datadog監視設定を Terraform で管理します。そのため、バックアップ対象は以下の2つです:

1. **Terraform State（最重要）**: 監視設定の状態管理
2. **Terraformコード**: 監視設定のIaCコード

**注**: AWS既存リソース（RDS、ECS等）のバックアップは既存設計に従います（PoCスコープ外）。

## 2. Terraform State のバックアップ

### 2.1 バックアップ対象

| 項目 | 保存先 | 内容 |
|------|-------|------|
| terraform.tfstate | S3バケット | Datadog Monitor ID、AWS ARN等の状態情報 |
| terraform.tfstate.backup | S3バケット（バージョニング） | 前回の tfstate |

**重要**: Terraform State には Monitor ID、API Key（参照のみ）等のセンシティブ情報が含まれるため、安全に保管します。

### 2.2 バックアップ方式

#### S3 バージョニング（自動バックアップ）

```bash
# S3バケット作成（初回のみ）
aws s3 mb s3://datadog-terraform-state --region ap-northeast-1

# バージョニング有効化
aws s3api put-bucket-versioning \
  --bucket datadog-terraform-state \
  --versioning-configuration Status=Enabled
```

**メリット**:
- 自動的に全バージョンを保持
- 誤削除時に過去バージョンから復元可能
- 追加コストは低い（差分のみ保存）

**バージョン保持ポリシー**:

| 項目 | 設定値 | 理由 |
|------|-------|------|
| バージョン保持期間 | 無期限（削除しない） | PoCは短期間のため全バージョン保持 |
| 本番推奨 | 90日間 | コスト削減 |

#### ライフサイクルポリシー（本番推奨）

```json
{
  "Rules": [
    {
      "Id": "DeleteOldVersions",
      "Status": "Enabled",
      "NoncurrentVersionExpiration": {
        "NoncurrentDays": 90
      }
    }
  ]
}
```

**適用コマンド**:

```bash
aws s3api put-bucket-lifecycle-configuration \
  --bucket datadog-terraform-state \
  --lifecycle-configuration file://lifecycle.json
```

### 2.3 復元手順

#### 誤削除時の復元

```bash
# バージョン一覧を確認
aws s3api list-object-versions \
  --bucket datadog-terraform-state \
  --prefix datadog-monitors/terraform.tfstate

# 特定バージョンを復元
aws s3api copy-object \
  --bucket datadog-terraform-state \
  --copy-source datadog-terraform-state/datadog-monitors/terraform.tfstate?versionId=<VERSION_ID> \
  --key datadog-monitors/terraform.tfstate
```

**所要時間**: 5分以内

#### 破損時の復元

```bash
# 最新バージョンが破損している場合、1つ前のバージョンをダウンロード
aws s3api get-object \
  --bucket datadog-terraform-state \
  --key datadog-monitors/terraform.tfstate \
  --version-id <PREVIOUS_VERSION_ID> \
  terraform.tfstate.backup

# ローカルで terraform.tfstate を置き換え
mv terraform.tfstate.backup terraform.tfstate

# terraform refresh で状態を同期
terraform refresh
```

**所要時間**: 10分以内

### 2.4 暗号化設計

| 項目 | 設計値 | 理由 |
|------|--------|------|
| 暗号化方式 | AES-256（SSE-S3） | AWS管理キー（追加コストなし） |
| 転送時の暗号化 | TLS 1.2+ | Terraform → S3 間の通信 |

**暗号化設定**:

```bash
aws s3api put-bucket-encryption \
  --bucket datadog-terraform-state \
  --server-side-encryption-configuration '{
    "Rules": [
      {
        "ApplyServerSideEncryptionByDefault": {
          "SSEAlgorithm": "AES256"
        }
      }
    ]
  }'
```

## 3. Terraformコードのバックアップ

### 3.1 バックアップ対象

| 項目 | 保存先 | 内容 |
|------|-------|------|
| Terraform コード（*.tf） | Git リポジトリ | Monitor定義、モジュール、変数 |
| terraform.tfvars | ローカルのみ（Gitにコミットしない） | テナント定義、閾値 |

**重要**: `terraform.tfvars` にはシークレット情報（API Key等）が含まれる可能性があるため、Gitにコミットしません。

### 3.2 Git によるバージョン管理

#### リポジトリ構成

```
datadog-fro-AWS-terraform/
├── .git/
├── .gitignore              # terraform.tfvars を除外
├── terraform/
│   ├── main.tf
│   ├── variables.tf
│   ├── outputs.tf
│   ├── providers.tf
│   ├── backend.tf
│   ├── modules/
│   │   ├── level0-infra/
│   │   ├── level2-service/
│   │   ├── level3-tenant/
│   │   └── composite/
│   └── terraform.tfvars.example  # サンプル（Gitにコミット）
└── docs/
```

#### .gitignore 設定

```gitignore
# Terraform
terraform.tfvars
*.tfvars
.terraform/
*.tfstate
*.tfstate.backup

# シークレット情報
.env
.env.local
```

#### terraform.tfvars.example（サンプル）

```hcl
# terraform/terraform.tfvars.example
# このファイルをコピーして terraform.tfvars を作成してください

# Datadog API Key/APP Key は環境変数 TF_VAR_datadog_api_key, TF_VAR_datadog_app_key で注入
# datadog_api_key = "your_api_key_here"  # コメントアウト
# datadog_app_key = "your_app_key_here"  # コメントアウト

tenants = {
  tenant-a = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
  tenant-b = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
  tenant-c = {
    errors_threshold  = 10
    latency_threshold = 1000
  }
}
```

### 3.3 Git バックアップ方針

| 項目 | 設計値 | 理由 |
|------|--------|------|
| リモートリポジトリ | GitHub（プライベートリポジトリ） | チーム共有、履歴管理 |
| ブランチ戦略 | main（本番）、develop（開発） | PoCはmainのみでも可 |
| タグ | v1.0.0, v1.1.0 等 | リリースバージョン管理 |

**定期バックアップ**: 開発者が毎日 `git push` することで自動的にリモートにバックアップ。

### 3.4 復元手順

#### リポジトリ消失時の復元

```bash
# GitHub からクローン
git clone https://github.com/yourorg/datadog-fro-AWS-terraform.git
cd datadog-fro-AWS-terraform/terraform

# terraform.tfvars を再作成（環境変数から）
# （または、チームメンバーから共有）

# Terraform 初期化
terraform init

# State を S3 から自動取得
terraform plan
```

**所要時間**: 10分以内

#### 特定バージョンへのロールバック

```bash
# 過去のタグにロールバック
git checkout v1.0.0

# Terraform apply
terraform plan
terraform apply
```

**所要時間**: 15分以内

## 4. DynamoDB State Lock のバックアップ

### 4.1 バックアップ対象

| 項目 | 内容 | 重要度 |
|------|------|--------|
| DynamoDB テーブル（terraform-state-lock） | Terraform の同時実行ロック情報 | 低（再作成可能） |

**注**: DynamoDB State Lock は一時的な情報のため、バックアップ不要。消失してもテーブルを再作成すれば問題なし。

### 4.2 復元手順（消失時）

```bash
# DynamoDB テーブルを再作成
aws dynamodb create-table \
  --table-name terraform-state-lock \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region ap-northeast-1
```

**所要時間**: 1分以内

## 5. バックアップ・復旧目標

### 5.1 目標値

| 項目 | 目標値 | 備考 |
|------|--------|------|
| RTO（復旧時間目標） | 15分以内 | Terraform State復元 + apply |
| RPO（復旧ポイント目標） | 5分以内 | S3バージョニングによる自動バックアップ |

### 5.2 復旧シナリオ別の所要時間

| シナリオ | 原因 | 復旧手順 | 所要時間 |
|---------|------|---------|---------|
| Terraform State 誤削除 | 手動削除、バグ | S3バージョニングから復元 | 5分以内 |
| Terraform State 破損 | apply失敗、手動編集 | 前回バージョンから復元 + refresh | 10分以内 |
| Git リポジトリ消失 | GitHub障害、誤削除 | GitHub からクローン | 10分以内 |
| DynamoDB テーブル消失 | 手動削除 | テーブル再作成 | 1分以内 |
| **最悪ケース**（全消失） | - | Git + S3 からフル復元 | **15分以内** |

## 6. バックアップの検証

### 6.1 定期検証（推奨）

| 検証内容 | 頻度 | 担当者 |
|---------|------|-------|
| S3 バージョニング確認 | 週1回 | インフラチーム |
| Terraform State 復元テスト | 月1回 | インフラチーム |
| Git バックアップ確認 | 週1回 | 開発チーム |

**注**: PoCでは検証不要ですが、本番移行時は定期検証を推奨。

### 6.2 復元テスト手順

```bash
# テスト用ディレクトリを作成
mkdir -p /tmp/terraform-restore-test
cd /tmp/terraform-restore-test

# S3 から State をダウンロード
aws s3 cp s3://datadog-terraform-state/datadog-monitors/terraform.tfstate .

# Terraform 初期化
terraform init -backend=false

# State を確認
terraform show

# 問題なければテスト完了
```

## 7. 災害対策（DR）設計

### 7.1 DR対象リソース

| リソース | プライマリ | DR | 同期方法 |
|---------|----------|-----|---------|
| Terraform State（S3） | ap-northeast-1 | ap-northeast-3（大阪）| S3 Cross-Region Replication（オプション） |
| Git リポジトリ | GitHub（グローバル） | - | GitHub側で自動冗長化 |
| DynamoDB（State Lock） | ap-northeast-1 | 再作成可能 | バックアップ不要 |

**注**: PoCではDR不要。本番移行時に S3 Cross-Region Replication を検討。

### 7.2 S3 Cross-Region Replication（本番推奨）

```bash
# レプリケーション先バケット作成（大阪リージョン）
aws s3 mb s3://datadog-terraform-state-dr --region ap-northeast-3

# レプリケーションルール設定
aws s3api put-bucket-replication \
  --bucket datadog-terraform-state \
  --replication-configuration file://replication-config.json
```

**replication-config.json**:

```json
{
  "Role": "arn:aws:iam::123456789012:role/S3ReplicationRole",
  "Rules": [
    {
      "Status": "Enabled",
      "Priority": 1,
      "Filter": {},
      "Destination": {
        "Bucket": "arn:aws:s3:::datadog-terraform-state-dr",
        "ReplicationTime": {
          "Status": "Enabled",
          "Time": {
            "Minutes": 15
          }
        }
      }
    }
  ]
}
```

**メリット**: 東京リージョン障害時も、大阪リージョンから復旧可能。

## 8. バックアップコスト試算

### 8.1 PoC環境コスト（概算）

| 項目 | 月額（USD） | 備考 |
|------|-----------|------|
| S3 ストレージ（State） | $0.01 | 1GB未満 |
| S3 バージョニング | $0.05 | 過去バージョン5個程度 |
| DynamoDB（State Lock） | $0.00 | オンデマンド、アクセス少ない |
| **合計** | **$0.06/月** | **ほぼ無料** |

### 8.2 本番環境コスト（概算）

| 項目 | 月額（USD） | 備考 |
|------|-----------|------|
| S3 ストレージ（State） | $0.10 | 10GB程度 |
| S3 バージョニング（90日保持） | $0.50 | ライフサイクルポリシー適用 |
| S3 Cross-Region Replication | $0.20 | 大阪リージョンへ複製 |
| DynamoDB（State Lock） | $0.00 | オンデマンド |
| **合計** | **$0.80/月** | **低コスト** |

## 9. バックアップチェックリスト

### PoC開始前（必須）

- [ ] S3バケット作成（datadog-terraform-state）
- [ ] S3 バージョニング有効化
- [ ] S3 暗号化有効化（SSE-S3）
- [ ] S3 パブリックアクセスブロック設定
- [ ] DynamoDB テーブル作成（terraform-state-lock）
- [ ] .gitignore に terraform.tfvars を追加
- [ ] terraform.tfvars.example を作成

### PoC期間中（推奨）

- [ ] 毎日 Git に push（自動バックアップ）
- [ ] 週1回 S3 バージョン確認
- [ ] 月1回 復元テスト実施

### 本番移行時（必須）

- [ ] S3 ライフサイクルポリシー設定（90日保持）
- [ ] S3 Cross-Region Replication 設定（DR）
- [ ] CloudTrail 有効化（監査ログ）
- [ ] 定期バックアップ検証の運用手順書作成

## 10. 関連ドキュメント

| ドキュメント | パス |
|-------------|------|
| セキュリティ設計 | [03_セキュリティ設計.md](03_セキュリティ設計.md) |
| IaC構成方針 | [10_IaC方針.md](10_IaC方針.md) |
| 要件定義書 | ../../02_要件定義/要件定義書.md |

---

**作成日**: 2025-12-28
**作成者**: Infra-Architect
**バージョン**: 1.0
**ステータス**: Draft
