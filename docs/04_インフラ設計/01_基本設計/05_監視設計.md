# ç›£è¦–è¨­è¨ˆ(Composite Monitor)

## 1. æ¦‚è¦

æœ¬PoCã®**æœ€é‡è¦è¨­è¨ˆ**ã§ã™ã€‚Datadog Composite Monitor ã‚’ä½¿ç”¨ã—ãŸ**4éšå±¤ç›£è¦–(L0/L1/L2/L3)**ã«ã‚ˆã‚Šã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚¹ãƒˆãƒ¼ãƒ ã‚’é˜²æ­¢ã—ã€éšœå®³åŸå› ã®è¿…é€Ÿãªç‰¹å®šã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### è¨­è¨ˆã®æ ¸å¿ƒ

```
L0(ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯)éšœå®³ â†’ L1/L2/L3ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
L1(ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆ)éšœå®³ â†’ L2/L3ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
L2(ã‚µãƒ¼ãƒ“ã‚¹)éšœå®³ â†’ L3ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
L3(ãƒ†ãƒŠãƒ³ãƒˆ)éšœå®³ â†’ ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ã®å•é¡Œã¨ã—ã¦é€šçŸ¥
```

**ç›®çš„**: é‹ç”¨ãƒãƒ¼ãƒ ãŒã€Œæ ¹æœ¬åŸå› ã€ã®ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿ã‚’å—ã‘å–ã‚Šã€æ´¾ç”Ÿã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç„¡è¦–ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## 1.5 è¨­è¨ˆæ€æƒ³

### ã‚¢ãƒ©ãƒ¼ãƒˆã‚¹ãƒˆãƒ¼ãƒ é˜²æ­¢ã®3ã¤ã®æŸ±

æœ¬è¨­è¨ˆã¯ä»¥ä¸‹ã®3ã¤ã®æŸ±ã§ã‚¢ãƒ©ãƒ¼ãƒˆã‚¹ãƒˆãƒ¼ãƒ ã‚’é˜²æ­¢ã—ã¾ã™ã€‚

| æŸ± | æ‰‹æ³• | åŠ¹æœ | å®Ÿè£…çŠ¶æ³ |
|----|------|------|---------|
| **Composite Monitor** | è¤‡åˆæ¡ä»¶ã®ãƒ–ãƒ¼ãƒ«è«–ç†çµåˆ | èª¤æ¤œçŸ¥70%å‰Šæ¸› | âœ… PoCå®Ÿè£… |
| **Webhook + Downtime API** | ä¾å­˜é–¢ä¿‚ãƒ™ãƒ¼ã‚¹ã®å‹•çš„ãƒŸãƒ¥ãƒ¼ãƒˆ | ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰éšœå®³å¯¾å¿œ | âš ï¸ å°†æ¥æ‹¡å¼µ |
| **çµ±ä¸€ã‚¿ã‚°è¨­è¨ˆ** | `layer:`, `service:`, `env:` ã«ã‚ˆã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ç®¡ç† | ä¸€æ‹¬æ“ä½œå¯èƒ½ | âœ… PoCå®Ÿè£… |

### ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚¤ã‚ºå‰Šæ¸›ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

| æ–½ç­– | åŠ¹æœ | å®Ÿè£…é›£æ˜“åº¦ | PoCå¯¾å¿œ |
|------|------|-----------|--------|
| Composite Monitor | è¤‡åˆæ¡ä»¶ã§èª¤æ¤œçŸ¥70%å‰Šæ¸› | ä¸­ | âœ… |
| é€šçŸ¥ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚° | ãƒ›ã‚¹ãƒˆâ†’ã‚µãƒ¼ãƒ“ã‚¹å˜ä½ã§90%å‰Šæ¸› | ä½ | âœ… |
| è©•ä¾¡ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ‹¡å¤§ | ä¸€æ™‚ã‚¹ãƒ‘ã‚¤ã‚¯ã«ã‚ˆã‚‹èª¤æ¤œçŸ¥æ’é™¤ | ä½ | âœ… |
| Recovery Threshold | ãƒ•ãƒ©ãƒƒãƒ”ãƒ³ã‚°é˜²æ­¢(é–¾å€¤å·®ã‚’ã¤ã‘ã‚‹) | ä½ | âœ… |
| Webhookä¾å­˜é–¢ä¿‚æŠ‘åˆ¶ | ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰éšœå®³æ™‚ã®é›†ç´„ | é«˜ | âš ï¸ å°†æ¥ |
| Scheduled Downtime | è¨ˆç”»ä½œæ¥­æ™‚ã®ã‚¼ãƒ­ãƒã‚¤ã‚º | ä½ | âš ï¸ å°†æ¥ |

### æ¨å¥¨é–¾å€¤ã®æ ¹æ‹ 

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | Warning | Critical | æ ¹æ‹  |
|-----------|---------|----------|------|
| p95/p99 ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | 500ms | 1000ms | ä¸€èˆ¬çš„ãªWeb APIã®SLA |
| ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ¼ãƒˆ | 1% | 5% | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æãªã‚ãªã„ç›®å®‰ |
| RDS CPU | 80% | 95% | 15åˆ†ç¶™ç¶šã§ã‚¢ãƒ©ãƒ¼ãƒˆ |
| RDS æ¥ç¶šæ•° | max_connectionsã®80% | 90% | æ¯æ¸‡å‰ã«æ¤œçŸ¥ |

### Unified Service Tagging

ECS Fargateç’°å¢ƒã§APMã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ãŸã‚ã®å¿…é ˆè¨­å®š:

| ç’°å¢ƒå¤‰æ•° | ç”¨é€” | ä¾‹ |
|---------|------|-----|
| `DD_SERVICE` | ã‚µãƒ¼ãƒ“ã‚¹è­˜åˆ¥ | `demo-api` |
| `DD_ENV` | ç’°å¢ƒè­˜åˆ¥ | `poc` |
| `DD_VERSION` | ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¿½è·¡ | `1.0.0` |
| `DD_APM_ENABLED` | APMãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°æœ‰åŠ¹åŒ– | `true` |
| `DD_APM_NON_LOCAL_TRAFFIC` | ä»–ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã®ãƒˆãƒ¬ãƒ¼ã‚¹å—ä¿¡ | `true` |

**å‚ç…§**: Datadogå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - Unified Service Tagging

### ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ãƒ„ãƒ¼ãƒ«é¸æŠã®åˆ¤æ–­åŸºæº–

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | ä¸»è¦ãƒ„ãƒ¼ãƒ« | è£œåŠ©ãƒ„ãƒ¼ãƒ« | ç†ç”± |
|---------|-----------|-----------|------|
| **L0 (APM)** | APM Agent | ãªã— | ECS Fargate ã§ã¯ `datadog.agent.up` ä¸å¯ã€APMãƒˆãƒ¬ãƒ¼ã‚¹ç–é€šã§ç›£è¦– |
| **L1 (RDS)** | AWSã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ + DBM | ãªã— | RDSä¸Šã«Agentä¸å¯ã€ãƒªãƒ¢ãƒ¼ãƒˆDBMã§æ·±ã„æ´å¯Ÿ |
| **L1 (ECS)** | ç„¡åŠ¹åŒ– | L2ã®ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–ã§ä»£æ›¿ | CloudWatché€£æºã§ECSãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ä¸å¯ã®ãŸã‚ |
| **L2 (E2E)** | Synthetics Monitoring | ãªã— | å¤–éƒ¨ã‹ã‚‰ã®æ­»æ´»ç›£è¦– |
| **L3 (ãƒ†ãƒŠãƒ³ãƒˆ)** | APM + Logs + Synthetics | ãªã— | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã®è©³ç´°ç›£è¦– |

### CloudWatch ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã®é…å»¶ç‰¹æ€§

| æ–¹å¼ | é…å»¶ | æ¨å¥¨ç”¨é€” |
|------|------|---------|
| API Polling(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) | 15ã€œ20åˆ† | éã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç›£è¦– |
| CloudWatch Metric Streams | 2ã€œ3åˆ† | ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç›£è¦–(ALB, Lambda) |

**æ³¨**: PoCæ®µéšã§ã¯API Pollingã‚’ä½¿ç”¨ã€‚æœ¬ç•ªç§»è¡Œæ™‚ã¯Metric Streamsã‚’æ¤œè¨ã€‚

## 2. ç›£è¦–éšå±¤ã®å®šç¾©

### ç›£è¦–éšå±¤ã®å…¨ä½“åƒ

æœ¬è¨­è¨ˆã§ã¯**L0/L1/L2/L3ã®4å±¤æ§‹æˆ**ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

| å±¤ | è²¬å‹™ | ç›£è¦–å¯¾è±¡ | å½±éŸ¿ç¯„å›² |
|-----|------|---------|---------|
| **L0** | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŸºç›¤ç›£è¦– | Datadog Agent(APMãƒˆãƒ¬ãƒ¼ã‚¹ç–é€š) | å…¨ãƒ†ãƒŠãƒ³ãƒˆ |
| **L1** | ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆåŸºç›¤ç›£è¦– | RDS | å…¨ãƒ†ãƒŠãƒ³ãƒˆ |
| **L2** | ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«ç›£è¦– | ALBã€ECS Taskã€ECRã€**E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯** | å…¨ãƒ†ãƒŠãƒ³ãƒˆ |
| **L3** | ãƒ†ãƒŠãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ç›£è¦– | Syntheticsã€APMã‚¨ãƒ©ãƒ¼ã€ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· | è©²å½“ãƒ†ãƒŠãƒ³ãƒˆã®ã¿ |

### 2.1 L0: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŸºç›¤ç›£è¦–

**è²¬å‹™**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŸºç›¤ã®å¥å…¨æ€§ã‚’ç›£è¦–ã€‚L0éšœå®³ã¯L1/L2/L3ã«å½±éŸ¿ã‚’åŠã¼ã™ã€‚

| Monitor ID | ç›£è¦–å¯¾è±¡ | ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | é–¾å€¤ | å½±éŸ¿ç¯„å›² |
|-----------|---------|---------|------|---------|
| L0-Agent | Datadog Agent æ­»æ´» / APMãƒˆãƒ¬ãƒ¼ã‚¹ç–é€š | `trace.fastapi.request.hits` | < 1 (5åˆ†é–“) | å…¨ãƒ†ãƒŠãƒ³ãƒˆ |

**é‡è¦å¤‰æ›´**:
- ECS Fargateã§ã¯ `datadog.agent.up` ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚§ãƒƒã‚¯ãŒé€ä¿¡ã•ã‚Œãªã„åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€**APMãƒˆãƒ¬ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ç›£è¦–**ã«å¤‰æ›´
- æ–°ã‚¯ã‚¨ãƒª: `sum(last_5m):sum:trace.fastapi.request.hits{env:poc}.as_count() < 1`
- APMãƒˆãƒ¬ãƒ¼ã‚¹ç–é€šã‚’ç›£è¦–ã™ã‚‹ã“ã¨ã§ã€Agent + ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ­»æ´»ã‚’ç¢ºèª

**é‡è¦**: L0éšœå®³ã¯å…¨ãƒ†ãƒŠãƒ³ãƒˆã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€L0ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«æ™‚ã¯L1/L2/L3ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶ã€‚

### 2.2 L1: ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆåŸºç›¤ç›£è¦–

**è²¬å‹™**: ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆåŸºç›¤ã®å¥å…¨æ€§ã‚’ç›£è¦–ã€‚L1éšœå®³ã¯L2/L3ã«å½±éŸ¿ã‚’åŠã¼ã™ã€‚

| Monitor ID | ç›£è¦–å¯¾è±¡ | ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | é–¾å€¤ | å½±éŸ¿ç¯„å›² | çŠ¶æ…‹ |
|-----------|---------|---------|------|---------|------|
| L1-RDS-CPU | RDS CPUä½¿ç”¨ç‡ | `aws.rds.cpuutilization` | > 95% | å…¨ãƒ†ãƒŠãƒ³ãƒˆ | âœ… æœ‰åŠ¹ |
| L1-RDS-Conn | RDS æ¥ç¶šæ•° | `aws.rds.database_connections` | > 90 | å…¨ãƒ†ãƒŠãƒ³ãƒˆ | âœ… æœ‰åŠ¹ |
| L1-RDS-Mem | RDS ãƒ¡ãƒ¢ãƒª | `aws.rds.freeable_memory` | < 1GB | å…¨ãƒ†ãƒŠãƒ³ãƒˆ | âœ… æœ‰åŠ¹ |
| L1-RDS-Storage | RDS ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | `aws.rds.free_storage_space` | < 5GB | å…¨ãƒ†ãƒŠãƒ³ãƒˆ | âœ… æœ‰åŠ¹ |
| L1-ECS-Tasks | ECS Running Tasks | `aws.ecs.service.desired` | = 0 | å…¨ãƒ†ãƒŠãƒ³ãƒˆ | âŒ ç„¡åŠ¹åŒ– |

**é‡è¦å¤‰æ›´**:
- **L1-ECS-Tasks ç„¡åŠ¹åŒ–**: CloudWatché€£æºã§ECSãƒ¡ãƒˆãƒªã‚¯ã‚¹(`aws.ecs.service.desired`)ãŒå–å¾—ã§ããªã„ãŸã‚ç„¡åŠ¹åŒ–
- **ä»£æ›¿**: L2ã®ECS Taskç•°å¸¸åœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–ã§ä»£æ›¿

**é‡è¦**: L1éšœå®³ã¯å…¨ãƒ†ãƒŠãƒ³ãƒˆã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€L1ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«æ™‚ã¯L2/L3ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶ã€‚

### 2.3 L2: ã‚µãƒ¼ãƒ“ã‚¹ç›£è¦–

**è²¬å‹™**: AWSã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¥å…¨æ€§ã‚’ç›£è¦–ã€‚L2éšœå®³ã¯ãƒ†ãƒŠãƒ³ãƒˆã«å½±éŸ¿ã‚’åŠã¼ã™ã€‚

| Monitor ID | ç›£è¦–å¯¾è±¡ | ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | é–¾å€¤ | å½±éŸ¿ç¯„å›² |
|-----------|---------|---------|------|---------|
| L2-ALB-Health | ALB Target Group Health | `aws.applicationelb.healthy_host_count` | = 0 | å…¨ãƒ†ãƒŠãƒ³ãƒˆ |
| L2-ECS-Task | ECS Task ç•°å¸¸åœæ­¢ | `ecs.task.stopped` (Event) | ã‚¤ãƒ™ãƒ³ãƒˆæ¤œçŸ¥ | è©²å½“ãƒ†ãƒŠãƒ³ãƒˆ |
| L2-ECR-Vuln | ECR è„†å¼±æ€§ | `aws.ecr.vulnerability.critical` | > 0 | è©²å½“ã‚¤ãƒ¡ãƒ¼ã‚¸ |
| **FR-002-5** | **ALBâ†’APIâ†’RDS E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯** | **Synthetic Monitoring** | **HTTP 200ä»¥å¤–ã€ã¾ãŸã¯å¿œç­”æ™‚é–“5ç§’è¶…** | **å…¨ãƒ†ãƒŠãƒ³ãƒˆ** |

**é‡è¦**: L2éšœå®³ã¯ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€L2ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«æ™‚ã¯è©²å½“ãƒ†ãƒŠãƒ³ãƒˆã®L3ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶ã€‚

#### L2-ECS-Task Monitor ã‚¯ã‚¨ãƒªè©³ç´°

**Type**: Event Monitor

**Query**:
```
events("source:ecs status:error ecs.cluster-name:myapp-cluster").rollup("count").last("5m") > 0
```

**è§£èª¬**:
- `source:ecs`: ECSã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
- `status:error`: ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿
- `ecs.cluster-name:myapp-cluster`: å¯¾è±¡ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æŒ‡å®š
- 5åˆ†é–“ã§ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãŒ1ä»¶ä»¥ä¸Šç™ºç”Ÿã—ãŸã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆ

**Datadog Provider ã§ã®å®Ÿè£…ä¾‹**:
```hcl
resource "datadog_monitor" "ecs_task_stopped" {
  name    = "[L2] ECS Task ç•°å¸¸åœæ­¢"
  type    = "event-v2 alert"
  query   = "events(\"source:ecs status:error ecs.cluster-name:myapp-cluster\").rollup(\"count\").last(\"5m\") > 0"
  message = <<-EOT
    [L2] ECS TaskãŒç•°å¸¸åœæ­¢ã—ã¾ã—ãŸã€‚
    - Cluster: myapp-cluster
    - å½±éŸ¿: è©²å½“ãƒ†ãƒŠãƒ³ãƒˆ
  EOT

  tags = ["layer:l2", "resource:ecs", "severity:high"]
}
```

#### FR-002-5: ALBâ†’APIâ†’RDS E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

**ç›®çš„**: ALBçµŒç”±ã§ECSâ†’RDSã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ç–é€šã‚’ç¢ºèªã—ã€ã‚¤ãƒ³ãƒ•ãƒ©å…¨ä½“ã®å¥å…¨æ€§ã‚’ç›£è¦–ã€‚

**ç›£è¦–æ–¹å¼**: Datadog Synthetic Monitoring (HTTP Check)

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `https://{ALB_FQDN}/health`
- ãƒ†ãƒŠãƒ³ãƒˆIDãªã—(å…¨ä½“ç–é€šç¢ºèª)
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§å®Ÿè£…ãŒå¿…è¦

**ç¢ºèªå†…å®¹**:
1. ALB â†’ ECS Fargate ã®ç–é€š
2. ECS Fargate â†’ RDS ã®ç–é€š(`SELECT 1` ã‚¯ã‚¨ãƒªå®Ÿè¡Œ)
3. HTTP 200 ãƒ¬ã‚¹ãƒãƒ³ã‚¹
4. å¿œç­”æ™‚é–“ < 5ç§’

**ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶**:
- HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ200ä»¥å¤–
- å¿œç­”æ™‚é–“ãŒ5ç§’è¶…
- 3å›é€£ç¶šå¤±æ•—ã§ã‚¢ãƒ©ãƒ¼ãƒˆ

**Datadog Provider ã§ã®å®Ÿè£…ä¾‹**:
```hcl
resource "datadog_synthetics_test" "e2e_health_check" {
  name    = "[L2] ALBâ†’APIâ†’RDS E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
  type    = "api"
  subtype = "http"
  status  = "live"

  request_definition {
    method = "GET"
    url    = "https://${var.alb_fqdn}/health"
  }

  assertion {
    type     = "statusCode"
    operator = "is"
    target   = "200"
  }

  assertion {
    type     = "responseTime"
    operator = "lessThan"
    target   = "5000"  # 5ç§’
  }

  locations = ["aws:ap-northeast-1"]

  options_list {
    tick_every = 300  # 5åˆ†ã”ã¨
    retry {
      count    = 2
      interval = 300
    }
  }

  message = <<-EOT
    [L2] ALBâ†’APIâ†’RDS E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚
    - URL: https://${var.alb_fqdn}/health
    - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ(ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ã®å¯èƒ½æ€§)
    - ç¢ºèªå†…å®¹: ALB â†’ ECS â†’ RDS ç–é€š
  EOT

  tags = ["layer:l2", "resource:e2e", "severity:critical"]
}
```

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å®Ÿè£…è¦ä»¶**:
- `/health` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…
- RDSã¸ã®ç–é€šç¢ºèª(`SELECT 1` ã‚¯ã‚¨ãƒªå®Ÿè¡Œ)
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:
  ```json
  {
    "status": "ok",
    "database": "connected",
    "timestamp": "2025-12-28T12:34:56.789Z"
  }
  ```

**å‚ç…§**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆæ›¸(å­˜åœ¨ã™ã‚‹å ´åˆ)ã¨æ•´åˆã•ã›ã¦ãã ã•ã„ã€‚

### 2.4 L3: ãƒ†ãƒŠãƒ³ãƒˆç›£è¦–

**è²¬å‹™**: ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ã®å•é¡Œã‚’ç›£è¦–ã€‚L3éšœå®³ã¯ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ã®å•é¡Œã€‚

| Monitor ID(ä¾‹: tenant-a) | ç›£è¦–å¯¾è±¡ | ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | é–¾å€¤ | å½±éŸ¿ç¯„å›² |
|---------------------------|---------|---------|------|---------|
| **FR-003-1** | **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯(RDSç–é€šå«ã‚€)** | **Synthetics Test** | **HTTP 200ä»¥å¤–ã€ã¾ãŸã¯å¿œç­”æ™‚é–“2ç§’è¶…** | tenant-a ã®ã¿ |
| **L3-APM-Error** | **APMã‚¨ãƒ©ãƒ¼æ•°** | **`trace.fastapi.request.errors`** | **> 10/5åˆ†** | tenant-a ã®ã¿ |
| **L3-Log-Error** | **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ•°** | **`logs("status:error")`** | **> 10/5åˆ†** | tenant-a ã®ã¿ |
| L3-Latency-tenant-a | ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·(p99) | `trace.fastapi.request.p99` | > 1ç§’ | tenant-a ã®ã¿ |

**é‡è¦å¤‰æ›´**:
- **Synthetics Test**: å¤–éƒ¨ã‹ã‚‰ã®E2Eç›£è¦–ã€ALB â†’ ECS â†’ RDSç–é€šç¢ºèª
- **L3-APM-Error**: APMã‚¨ãƒ©ãƒ¼æ•°ç›£è¦–ã‚’æ–°è¦è¿½åŠ (`trace.fastapi.request.errors`)
- **L3-Log-Error**: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç›£è¦–ã‚’æ–°è¦è¿½åŠ (Log Monitor)
- **L3-Latency**: å¤‰æ›´ãªã—(APM p99)

**é‡è¦**: L3éšœå®³ã¯ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ã®å•é¡Œ(ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚°ã€ãƒ‡ãƒ¼ã‚¿ç•°å¸¸ç­‰)ã¨ã—ã¦é€šçŸ¥ã€‚

#### FR-003-1: ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯(RDSç–é€šå«ã‚€ã€Synthetics Test)

**ç›®çš„**: ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ALB â†’ ECS â†’ RDS ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ç–é€šã‚’ç¢ºèªã€‚

**ç›£è¦–æ–¹å¼**: Datadog Synthetic Monitoring (HTTP Check)

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `https://{ALB_FQDN}/{tenant_id}/health`
- ãƒ†ãƒŠãƒ³ãƒˆIDã‚’å«ã‚€(ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ç–é€šç¢ºèª)
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§å®Ÿè£…ãŒå¿…è¦

**ç¢ºèªå†…å®¹**:
1. ALB â†’ ECS Fargate ã®ç–é€š
2. **ECS Fargate â†’ RDS ã®ç–é€š(`SELECT 1 FROM {tenant_table} WHERE tenant_id = '{tenant_id}' LIMIT 1` ã‚¯ã‚¨ãƒªå®Ÿè¡Œ)**
3. HTTP 200 ãƒ¬ã‚¹ãƒãƒ³ã‚¹
4. å¿œç­”æ™‚é–“ < 2ç§’

**L2(FR-002-5)ã¨ã®é•ã„**:
| é …ç›® | L2(FR-002-5) | L3(FR-003-1) |
|------|---------------|---------------|
| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | `/health` | `/{tenant_id}/health` |
| ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥ | ãªã— | ã‚ã‚Š |
| RDSã‚¯ã‚¨ãƒª | `SELECT 1` | `SELECT 1 FROM {tenant_table} WHERE tenant_id = '{tenant_id}' LIMIT 1` |
| å¿œç­”æ™‚é–“é–¾å€¤ | 5ç§’ | 2ç§’ |
| å½±éŸ¿ç¯„å›² | å…¨ãƒ†ãƒŠãƒ³ãƒˆ | è©²å½“ãƒ†ãƒŠãƒ³ãƒˆã®ã¿ |
| ã‚¢ãƒ©ãƒ¼ãƒˆæŠ‘åˆ¶ | L0/L1éšœå®³æ™‚ã«æŠ‘åˆ¶ | L0/L1/L2éšœå®³æ™‚ã«æŠ‘åˆ¶ |

**ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶**:
- HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ200ä»¥å¤–
- å¿œç­”æ™‚é–“ãŒ2ç§’è¶…
- 2å›é€£ç¶šå¤±æ•—ã§ã‚¢ãƒ©ãƒ¼ãƒˆ

**Datadog Provider ã§ã®å®Ÿè£…ä¾‹(Synthetics Test)**:
```hcl
resource "datadog_synthetics_test" "health_check" {
  name    = "[L3 Synthetics] ${var.tenant_id} ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯(E2Eç–é€šç¢ºèª)"
  type    = "api"
  subtype = "http"
  status  = "live"

  request_definition {
    method = "GET"
    url    = "https://${var.alb_fqdn}/${var.tenant_id}/health"
  }

  assertion {
    type     = "statusCode"
    operator = "is"
    target   = "200"
  }

  assertion {
    type     = "body"
    operator = "contains"
    target   = "\"status\":\"ok\""
  }

  assertion {
    type     = "responseTime"
    operator = "lessThan"
    target   = "2000"  # 2ç§’ä»¥å†…
  }

  locations = ["aws:ap-northeast-1"]

  options_list {
    tick_every = 60  # 1åˆ†é–“éš”

    retry {
      count    = 2
      interval = 300
    }
  }

  message = <<-EOT
    [L3 Synthetics] ${var.tenant_id} ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯(E2Eç–é€šç¢ºèª)ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚
    - URL: https://${var.alb_fqdn}/${var.tenant_id}/health
    - å½±éŸ¿: ${var.tenant_id} ã®ã¿
    - ç¢ºèªå†…å®¹: å¤–éƒ¨ã‹ã‚‰ã® ALB â†’ ECS â†’ RDS(tenant_id='${var.tenant_id}')ç–é€š
  EOT

  tags = ["layer:l3", "tenant:${var.tenant_id}", "severity:high", "type:synthetics"]
}
```

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å®Ÿè£…è¦ä»¶**:
- `/{tenant_id}/health` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…
- RDSã¸ã®ç–é€šç¢ºèª(ãƒ†ãƒŠãƒ³ãƒˆIDã§ãƒ•ã‚£ãƒ«ã‚¿ã—ãŸã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ)
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:
  ```json
  {
    "status": "ok",
    "tenant_id": "tenant-a",
    "database": "connected",
    "query": "SELECT 1 FROM tenants WHERE tenant_id = 'tenant-a' LIMIT 1",
    "timestamp": "2025-12-28T12:34:56.789Z"
  }
  ```

**å‚ç…§**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆæ›¸(å­˜åœ¨ã™ã‚‹å ´åˆ)ã¨æ•´åˆã•ã›ã¦ãã ã•ã„ã€‚

#### L3-APM-Error: APMã‚¨ãƒ©ãƒ¼æ•°ç›£è¦–(æ–°è¦è¿½åŠ )

**ç›®çš„**: ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã®APMã‚¨ãƒ©ãƒ¼æ•°ã‚’ç›£è¦–ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã€‚

**ç›£è¦–æ–¹å¼**: Metric Alert Monitor (APM)

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: `trace.fastapi.request.errors`

**ã‚¯ã‚¨ãƒªä¾‹**:
```
sum(last_5m):default_zero(sum:trace.fastapi.request.errors{service:demo-api}.as_count()) > 10
```

**ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶**:
- 5åˆ†é–“ã§ã‚¨ãƒ©ãƒ¼æ•°ãŒ10ä»¶è¶…(critical)
- 5åˆ†é–“ã§ã‚¨ãƒ©ãƒ¼æ•°ãŒ5ä»¶è¶…(warning)

**Datadog Provider ã§ã®å®Ÿè£…ä¾‹**:
```hcl
resource "datadog_monitor" "apm_errors" {
  name    = "[L3 APM] ${var.tenant_id} ã‚¨ãƒ©ãƒ¼æ•°"
  type    = "metric alert"
  query   = "sum(last_5m):default_zero(sum:trace.fastapi.request.errors{service:${var.service_name}}.as_count()) > ${var.errors_threshold}"
  message = <<-EOT
    [L3 APM] ${var.tenant_id} ã§APMã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
    - ã‚¨ãƒ©ãƒ¼æ•°: {{value}}
    - å½±éŸ¿: ${var.tenant_id}
    - ç¢ºèªå†…å®¹: APM ãƒˆãƒ¬ãƒ¼ã‚¹ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª

    â€» L1/L2 éšœå®³æ™‚ã¯ã“ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¯ Composite Monitor ã«ã‚ˆã‚ŠæŠ‘åˆ¶ã•ã‚Œã¾ã™ã€‚
  EOT

  monitor_thresholds {
    critical = var.errors_threshold
    warning  = floor(var.errors_threshold / 2)
  }

  tags = ["layer:l3", "tenant:${var.tenant_id}", "severity:medium", "type:apm"]

  notify_no_data    = false
  renotify_interval = 0
}
```

#### L3-Log-Error: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç›£è¦–(æ–°è¦è¿½åŠ )

**ç›®çš„**: ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ•°ã‚’ç›£è¦–ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã€‚

**ç›£è¦–æ–¹å¼**: Log Alert Monitor

**ã‚¯ã‚¨ãƒªä¾‹**:
```
logs("status:error service:demo-api").rollup("count").last("5m") > 10
```

**ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶**:
- 5åˆ†é–“ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ•°ãŒ10ä»¶è¶…(critical)
- 5åˆ†é–“ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ•°ãŒ5ä»¶è¶…(warning)

**Datadog Provider ã§ã®å®Ÿè£…ä¾‹**:
```hcl
resource "datadog_monitor" "error_logs" {
  name    = "[L3 Log] ${var.tenant_id} ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ•°"
  type    = "log alert"
  query   = "logs(\"status:error service:demo-api\").rollup(\"count\").last(\"5m\") > ${var.errors_threshold}"
  message = <<-EOT
    [L3 Log] ${var.tenant_id} ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒæ€¥å¢—ã—ã¦ã„ã¾ã™ã€‚
    - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ•°: {{value}}
    - å½±éŸ¿: ${var.tenant_id}
    - ç¢ºèªå†…å®¹: Log Explorer ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª

    â€» L1/L2 éšœå®³æ™‚ã¯ã“ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¯ Composite Monitor ã«ã‚ˆã‚ŠæŠ‘åˆ¶ã•ã‚Œã¾ã™ã€‚
  EOT

  monitor_thresholds {
    critical = var.errors_threshold
    warning  = floor(var.errors_threshold / 2)
  }

  tags = ["layer:l3", "tenant:${var.tenant_id}", "severity:medium", "type:log"]

  notify_no_data    = false
  renotify_interval = 0
}
```

#### L3-Latency: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·(p99)ç›£è¦–

**ç›®çš„**: ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·(p99)ã‚’ç›£è¦–ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ã‚’æ¤œçŸ¥ã€‚

**ç›£è¦–æ–¹å¼**: APM Monitor

**ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: `trace.fastapi.request` (p99)

**ã‚¯ã‚¨ãƒªä¾‹**:
```
avg(last_5m):p99:trace.fastapi.request{service:demo-api} > 1000
```

**ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶**:
- p99ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ1000msè¶…(critical)
- p99ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ500msè¶…(warning)

**Datadog Provider ã§ã®å®Ÿè£…ä¾‹**:
```hcl
resource "datadog_monitor" "latency" {
  name    = "[L3] ${var.tenant_id} ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·(p99)"
  type    = "metric alert"
  query   = "avg(last_5m):p99:trace.fastapi.request{service:${var.service_name}} > ${var.latency_threshold}"
  message = <<-EOT
    [L3] ${var.tenant_id} ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·(p99)ãŒ${var.latency_threshold}msã‚’è¶…ãˆã¾ã—ãŸã€‚
    - Latency: {{value}}ms
    - å½±éŸ¿: ${var.tenant_id} ã®ã¿
  EOT

  monitor_thresholds {
    critical = var.latency_threshold
    warning  = floor(var.latency_threshold * 0.5)
  }

  tags = ["layer:l3", "tenant:${var.tenant_id}", "severity:medium"]

  notify_no_data    = false
  renotify_interval = 0
}
```

## 3. Composite Monitor ã®è¨­è¨ˆ

### 3.1 Composite Monitor ã®æ§‹é€ 

```mermaid
graph TB
    subgraph "Composite Monitor: L0-Network"
        L0_Composite[L0-Composite<br/>ORæ¼”ç®—]
        L0_Agent[L0-Agent<br/>APMãƒˆãƒ¬ãƒ¼ã‚¹ç–é€š]

        L0_Agent --> L0_Composite
    end

    subgraph "Composite Monitor: L1-Compute"
        L1_Composite[L1-Composite<br/>ORæ¼”ç®—]
        L1_RDS_CPU[L1-RDS-CPU]
        L1_RDS_Conn[L1-RDS-Conn]
        L1_RDS_Mem[L1-RDS-Mem]
        L1_RDS_Storage[L1-RDS-Storage]

        L1_RDS_CPU --> L1_Composite
        L1_RDS_Conn --> L1_Composite
        L1_RDS_Mem --> L1_Composite
        L1_RDS_Storage --> L1_Composite
    end

    subgraph "Composite Monitor: L2-Service"
        L2_Composite[L2-Composite<br/>ORæ¼”ç®—]
        L2_ALB[L2-ALB-Health]
        L2_Task[L2-ECS-Task]
        L2_ECR[L2-ECR-Vuln]
        L2_E2E[FR-002-5: E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯]

        L2_ALB --> L2_Composite
        L2_Task --> L2_Composite
        L2_ECR --> L2_Composite
        L2_E2E --> L2_Composite
    end

    subgraph "Composite Monitor: L3-Tenant(tenant-a)"
        L3_Composite_A[L3-Composite-tenant-a<br/>ORæ¼”ç®—]
        L3_Synthetics_A[FR-003-1: Synthetics<br/>ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯]
        L3_APM_Error_A[L3-APM-Error<br/>APMã‚¨ãƒ©ãƒ¼æ•°]
        L3_Log_Error_A[L3-Log-Error<br/>ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ•°]
        L3_Latency_A[L3-Latency-tenant-a<br/>ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·p99]

        L3_Synthetics_A --> L3_Composite_A
        L3_APM_Error_A --> L3_Composite_A
        L3_Log_Error_A --> L3_Composite_A
        L3_Latency_A --> L3_Composite_A
    end

    %% ã‚¢ãƒ©ãƒ¼ãƒˆæŠ‘åˆ¶ã®è¦ªå­é–¢ä¿‚
    L0_Composite -.->|L0 ALERTæ™‚ã€L1/L2/L3æŠ‘åˆ¶| L1_Composite
    L0_Composite -.->|L0 ALERTæ™‚ã€L2/L3æŠ‘åˆ¶| L2_Composite
    L0_Composite -.->|L0 ALERTæ™‚ã€L3æŠ‘åˆ¶| L3_Composite_A
    L1_Composite -.->|L1 ALERTæ™‚ã€L2/L3æŠ‘åˆ¶| L2_Composite
    L1_Composite -.->|L1 ALERTæ™‚ã€L3æŠ‘åˆ¶| L3_Composite_A
    L2_Composite -.->|L2 ALERTæ™‚ã€L3æŠ‘åˆ¶| L3_Composite_A

    style L0_Composite fill:#ff9999
    style L1_Composite fill:#ffcc99
    style L2_Composite fill:#ffff99
    style L3_Composite_A fill:#99ccff
```

### 3.2 Composite Monitor ã®è«–ç†å¼

#### L0-Composite(ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŸºç›¤ Composite)

```
L0-Composite =
  L0-Agent
```

**æ„å‘³**: L0-Agent(APMãƒˆãƒ¬ãƒ¼ã‚¹ç–é€š)ãŒALERTçŠ¶æ…‹ã«ãªã‚Œã°ã€L0-Composite ãŒALERTã€‚

**é‡è¦å¤‰æ›´**: ECS Fargateã§ã¯ `datadog.agent.up` ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚§ãƒƒã‚¯ãŒé€ä¿¡ã•ã‚Œãªã„ãŸã‚ã€APMãƒˆãƒ¬ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ç›£è¦–ã«å¤‰æ›´ã€‚

#### L1-Composite(ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆåŸºç›¤ Composite)

```
L1-Composite =
  (L1-RDS-CPU OR L1-RDS-Conn OR L1-RDS-Mem OR L1-RDS-Storage)
  AND NOT L0-Composite
```

**æ„å‘³**: ã„ãšã‚Œã‹ã®L1-RDS Monitor ãŒALERTã€ã‹ã¤L0-CompositeãŒALERTã§ãªã„å ´åˆã®ã¿ã€L1-Composite ãŒALERTã€‚

**é‡è¦å¤‰æ›´**: L1-ECS-Tasks ã‚’å‰Šé™¤(CloudWatché€£æºã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ä¸å¯ã®ãŸã‚)

**é‡è¦**: `AND NOT L0-Composite` ã«ã‚ˆã‚Šã€L0éšœå®³ä¸­ã¯L1ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶ã€‚

#### L2-Composite(ã‚µãƒ¼ãƒ“ã‚¹ Composite)

```
L2-Composite =
  (L2-ALB-Health OR L2-ECS-Task OR L2-ECR-Vuln OR FR-002-5)
  AND NOT L0-Composite
  AND NOT L1-Composite
```

**æ„å‘³**: ã„ãšã‚Œã‹ã®L2 Monitor ãŒALERTã€ã‹ã¤L0/L1-CompositeãŒALERTã§ãªã„å ´åˆã®ã¿ã€L2-Composite ãŒALERTã€‚

**é‡è¦**: `AND NOT L0-Composite AND NOT L1-Composite` ã«ã‚ˆã‚Šã€L0/L1éšœå®³ä¸­ã¯L2ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶ã€‚

#### L3-Composite(ãƒ†ãƒŠãƒ³ãƒˆ Compositeã€ä¾‹: tenant-a)

```
L3-Composite-tenant-a =
  (FR-003-1 OR L3-APM-Error OR L3-Log-Error OR L3-Latency-tenant-a)
  AND NOT L0-Composite
  AND NOT L1-Composite
  AND NOT L2-Composite
```

**æ„å‘³**: ã„ãšã‚Œã‹ã®L3 Monitor ãŒALERTã€ã‹ã¤L0/L1/L2-CompositeãŒALERTã§ãªã„å ´åˆã®ã¿ã€L3-Composite ãŒALERTã€‚

**é‡è¦å¤‰æ›´**:
- FR-003-1ã¯ Synthetics Test ã«å¤‰æ›´
- L3-APM-Error ã‚’è¿½åŠ 
- L3-Log-Error ã‚’è¿½åŠ 

**é‡è¦**: `AND NOT L0-Composite AND NOT L1-Composite AND NOT L2-Composite` ã«ã‚ˆã‚Šã€L0/L1/L2éšœå®³ä¸­ã¯L3ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶ã€‚

## 4. ã‚¢ãƒ©ãƒ¼ãƒˆæŠ‘åˆ¶ã®ã‚·ãƒŠãƒªã‚ª

### ã‚·ãƒŠãƒªã‚ª1: L0éšœå®³(APMãƒˆãƒ¬ãƒ¼ã‚¹é€”çµ¶)

```
[ç™ºç”Ÿ]
1. Datadog Agentåœæ­¢ã¾ãŸã¯ã‚¢ãƒ—ãƒªåœæ­¢ â†’ L0-Agent ãŒ ALERT
2. L0-Composite ãŒ ALERT(L0-Agent ãŒãƒˆãƒªã‚¬ãƒ¼)
3. æ´¾ç”Ÿçš„ã«ã€RDSæ¥ç¶šæ•°æ¸›å°‘ â†’ L1-RDS-Conn ãŒ ALERT
4. æ´¾ç”Ÿçš„ã«ã€FR-002-5(E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯)ãŒå¤±æ•— â†’ FR-002-5 ãŒ ALERT
5. æ´¾ç”Ÿçš„ã«ã€tenant-a ã®SyntheticsãŒå¤±æ•— â†’ FR-003-1 ãŒ ALERT

[Composite Monitor ã®åˆ¤å®š]
- L0-Composite: ALERT(é€šçŸ¥ã™ã‚‹)
- L1-Composite: (L1-RDS-Conn = ALERT) AND NOT L0-Composite â†’ FALSE(é€šçŸ¥ã—ãªã„)
- L2-Composite: (FR-002-5 = ALERT) AND NOT L0-Composite AND NOT L1-Composite â†’ FALSE(é€šçŸ¥ã—ãªã„)
- L3-Composite-tenant-a: (FR-003-1 = ALERT) AND NOT L0-Composite AND NOT L1-Composite AND NOT L2-Composite â†’ FALSE(é€šçŸ¥ã—ãªã„)

[é‹ç”¨ãƒãƒ¼ãƒ ã¸ã®é€šçŸ¥]
- L0-Composite ã®ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿é€šçŸ¥
- é‹ç”¨ãƒãƒ¼ãƒ ã¯ã€ŒAPMãƒˆãƒ¬ãƒ¼ã‚¹é€”çµ¶ã€ã‚’èªè­˜ã—ã€Agent/ã‚¢ãƒ—ãƒªã‚’èª¿æŸ»
```

**çµæœ**: ã‚¢ãƒ©ãƒ¼ãƒˆåœ°ç„ã‚’å›é¿ã€‚é‹ç”¨ãƒãƒ¼ãƒ ã¯æ ¹æœ¬åŸå› (Agent/ã‚¢ãƒ—ãƒª)ã®ã¿ã«é›†ä¸­ã€‚

### ã‚·ãƒŠãƒªã‚ª2: L1éšœå®³(RDS CPUé«˜é¨°)

```
[ç™ºç”Ÿ]
1. RDS CPUä½¿ç”¨ç‡ãŒ95%ã‚’è¶…ãˆã‚‹ â†’ L1-RDS-CPU ãŒ ALERT
2. L1-Composite ãŒ ALERT(L1-RDS-CPU ãŒãƒˆãƒªã‚¬ãƒ¼)
3. æ´¾ç”Ÿçš„ã«ã€FR-002-5(E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯)ãŒå¤±æ•— â†’ FR-002-5 ãŒ ALERT
4. æ´¾ç”Ÿçš„ã«ã€tenant-a ã®APMã‚¨ãƒ©ãƒ¼ãŒå¢—åŠ  â†’ L3-APM-Error ãŒ ALERT

[Composite Monitor ã®åˆ¤å®š]
- L0-Composite: OK(L0ã¯æ­£å¸¸)
- L1-Composite: (L1-RDS-CPU = ALERT) AND NOT L0-Composite â†’ TRUE(é€šçŸ¥ã™ã‚‹)
- L2-Composite: (FR-002-5 = ALERT) AND NOT L0-Composite AND NOT L1-Composite â†’ FALSE(é€šçŸ¥ã—ãªã„)
- L3-Composite-tenant-a: (L3-APM-Error = ALERT) AND NOT L0-Composite AND NOT L1-Composite AND NOT L2-Composite â†’ FALSE(é€šçŸ¥ã—ãªã„)

[é‹ç”¨ãƒãƒ¼ãƒ ã¸ã®é€šçŸ¥]
- L1-Composite ã®ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿é€šçŸ¥
- é‹ç”¨ãƒãƒ¼ãƒ ã¯ã€ŒRDS CPUé«˜é¨°ã€ã‚’èªè­˜ã—ã€RDSã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ã‚’å®Ÿæ–½
```

**çµæœ**: L2/L3ã‚¢ãƒ©ãƒ¼ãƒˆã¯æŠ‘åˆ¶ã•ã‚Œã€é‹ç”¨ãƒãƒ¼ãƒ ã¯ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆå±¤ã®å•é¡Œã«é›†ä¸­ã€‚

### ã‚·ãƒŠãƒªã‚ª3: L2éšœå®³(E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—)

```
[ç™ºç”Ÿ]
1. ALBâ†’APIâ†’RDS ã®E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•— â†’ FR-002-5 ãŒ ALERT
2. L2-Composite ãŒ ALERT(FR-002-5 ãŒãƒˆãƒªã‚¬ãƒ¼)
3. æ´¾ç”Ÿçš„ã«ã€tenant-a ã®SyntheticsãŒå¤±æ•— â†’ FR-003-1 ãŒ ALERT

[Composite Monitor ã®åˆ¤å®š]
- L0-Composite: OK(L0ã¯æ­£å¸¸)
- L1-Composite: OK(L1ã¯æ­£å¸¸)
- L2-Composite: (FR-002-5 = ALERT) AND NOT L0-Composite AND NOT L1-Composite â†’ TRUE(é€šçŸ¥ã™ã‚‹)
- L3-Composite-tenant-a: (FR-003-1 = ALERT) AND NOT L0-Composite AND NOT L1-Composite AND NOT L2-Composite â†’ FALSE(é€šçŸ¥ã—ãªã„)

[é‹ç”¨ãƒãƒ¼ãƒ ã¸ã®é€šçŸ¥]
- L2-Composite ã®ã‚¢ãƒ©ãƒ¼ãƒˆã®ã¿é€šçŸ¥
- é‹ç”¨ãƒãƒ¼ãƒ ã¯ã€ŒE2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—ã€ã‚’èªè­˜ã—ã€ALB/ECS/RDSç–é€šã‚’ç¢ºèª
```

**çµæœ**: L3ã‚¢ãƒ©ãƒ¼ãƒˆã¯æŠ‘åˆ¶ã•ã‚Œã€é‹ç”¨ãƒãƒ¼ãƒ ã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å•é¡Œã«é›†ä¸­ã€‚

### ã‚·ãƒŠãƒªã‚ª4: L3éšœå®³(tenant-a ã®ã¿ã®å•é¡Œ)

```
[ç™ºç”Ÿ]
1. tenant-a ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã«ãƒã‚° â†’ L3-APM-Error ãŒ ALERT
2. tenant-a ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚‚å¢—åŠ  â†’ L3-Log-Error ãŒ ALERT
3. tenant-a ã®Syntheticsã‚‚å•é¡Œãªã— â†’ FR-003-1 ã¯ OK

[Composite Monitor ã®åˆ¤å®š]
- L0-Composite: OK(L0ã¯æ­£å¸¸)
- L1-Composite: OK(L1ã¯æ­£å¸¸)
- L2-Composite: OK(L2ã¯æ­£å¸¸)
- L3-Composite-tenant-a: (L3-APM-Error = ALERT OR L3-Log-Error = ALERT) AND NOT L0-Composite AND NOT L1-Composite AND NOT L2-Composite â†’ TRUE(é€šçŸ¥ã™ã‚‹)

[é‹ç”¨ãƒãƒ¼ãƒ ã¸ã®é€šçŸ¥]
- L3-Composite-tenant-a ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€šçŸ¥
- é‹ç”¨ãƒãƒ¼ãƒ ã¯ã€Œtenant-a å›ºæœ‰ã®å•é¡Œã€ã¨èªè­˜ã—ã€é–‹ç™ºãƒãƒ¼ãƒ ã« escalate
```

**çµæœ**: ãƒ†ãƒŠãƒ³ãƒˆå›ºæœ‰ã®å•é¡Œã¨ã—ã¦æ­£ã—ãé€šçŸ¥ã€‚ä»–ã®ãƒ†ãƒŠãƒ³ãƒˆã«å½±éŸ¿ãªã—ã€‚

## 5. Monitor è©³ç´°è¨­è¨ˆ

### 5.1 L0 Monitor è©³ç´°

#### L0-Agent(APMãƒˆãƒ¬ãƒ¼ã‚¹ç–é€š)

```yaml
Type: Metric Monitor
Query: sum(last_5m):sum:trace.fastapi.request.hits{env:poc}.as_count() < 1
Message: |
  [L0] APMãƒˆãƒ¬ãƒ¼ã‚¹ãŒé€”çµ¶ãˆã¾ã—ãŸ(Agent ã¾ãŸã¯ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢ã®å¯èƒ½æ€§)ã€‚
  - Service: demo-api
  - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ(ç›£è¦–åœæ­¢ã¾ãŸã¯ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢)

  ç¢ºèªäº‹é …:
  - ECS ã‚¿ã‚¹ã‚¯ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹
  - Datadog Agent ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹
  - DD_API_KEY ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

Thresholds:
  critical: 1

Tags:
  - layer:l0-infra
  - resource:apm
  - severity:critical

notify_no_data: true
no_data_timeframe: 10
```

**é‡è¦å¤‰æ›´**: ECS Fargateã§ã¯ `datadog.agent.up` ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚§ãƒƒã‚¯ãŒé€ä¿¡ã•ã‚Œãªã„ãŸã‚ã€APMãƒˆãƒ¬ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ç›£è¦–ã«å¤‰æ›´ã€‚

### 5.2 L1 Monitor è©³ç´°

#### L1-RDS-CPU(RDS CPUä½¿ç”¨ç‡)

```yaml
Type: Metric Monitor
Query: avg(last_5m):avg:aws.rds.cpuutilization{dbinstanceidentifier:myapp-db} > 95
Message: |
  [L1] RDS CPUä½¿ç”¨ç‡ãŒ95%ã‚’è¶…ãˆã¾ã—ãŸã€‚
  - DB: {{dbinstanceidentifier.name}}
  - CPU: {{value}}%
  - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ

Thresholds:
  critical: 95
  warning: 80

Tags:
  - layer:l1-compute
  - resource:rds
  - severity:critical
```

#### L1-RDS-Conn(RDS æ¥ç¶šæ•°)

```yaml
Type: Metric Monitor
Query: avg(last_5m):avg:aws.rds.database_connections{dbinstanceidentifier:myapp-db} > 90
Message: |
  [L1] RDS æ¥ç¶šæ•°ãŒ90ã‚’è¶…ãˆã¾ã—ãŸã€‚
  - DB: {{dbinstanceidentifier.name}}
  - æ¥ç¶šæ•°: {{value}}
  - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ

Thresholds:
  critical: 90
  warning: 60

Tags:
  - layer:l1-compute
  - resource:rds
  - severity:critical
```

#### L1-RDS-Mem(RDS ãƒ¡ãƒ¢ãƒª)

```yaml
Type: Metric Monitor
Query: avg(last_5m):avg:aws.rds.freeable_memory{dbinstanceidentifier:myapp-db} < 1073741824
Message: |
  [L1] RDS ç©ºããƒ¡ãƒ¢ãƒªãŒ1GBã‚’ä¸‹å›ã‚Šã¾ã—ãŸã€‚
  - DB: {{dbinstanceidentifier.name}}
  - ç©ºããƒ¡ãƒ¢ãƒª: {{value}}ãƒã‚¤ãƒˆ
  - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ

  å¯¾å¿œ: RDSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã®å¤‰æ›´ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

Thresholds:
  critical: 1073741824  # 1GB
  warning: 2147483648   # 2GB

Tags:
  - layer:l1-compute
  - resource:rds
  - severity:critical
```

#### L1-RDS-Storage(RDS ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸)

```yaml
Type: Metric Monitor
Query: avg(last_5m):avg:aws.rds.free_storage_space{dbinstanceidentifier:myapp-db} < 5368709120
Message: |
  [L1] RDS ç©ºãã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒ5GBã‚’ä¸‹å›ã‚Šã¾ã—ãŸã€‚
  - DB: {{dbinstanceidentifier.name}}
  - ç©ºãã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: {{value}}ãƒã‚¤ãƒˆ
  - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ

  å¯¾å¿œ: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æ‹¡å¼µã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

Thresholds:
  critical: 5368709120   # 5GB
  warning: 10737418240   # 10GB

Tags:
  - layer:l1-compute
  - resource:rds
  - severity:critical
```

#### L1-ECS-Tasks(ç„¡åŠ¹åŒ–)

**çŠ¶æ…‹**: âŒ ç„¡åŠ¹åŒ–

**ç†ç”±**: CloudWatché€£æºã§ECSãƒ¡ãƒˆãƒªã‚¯ã‚¹(`aws.ecs.service.desired`)ãŒå–å¾—ã§ããªã„ãŸã‚ç„¡åŠ¹åŒ–ã€‚

**ä»£æ›¿**: L2ã®[L2] ECS Task ç•°å¸¸åœæ­¢ Monitor ã§ ECS ã‚¤ãƒ™ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®ç›£è¦–ã‚’å®Ÿæ–½ã€‚

### 5.3 L2 Monitor è©³ç´°

#### L2-ALB-Health(ALB Target Group Health)

```yaml
Type: Metric Monitor
Query: avg(last_5m):avg:aws.applicationelb.healthy_host_count{targetgroup:myapp-tg} <= 0
Message: |
  [L2] ALB Target Groupã®ãƒ˜ãƒ«ã‚·ãƒ¼ãƒ›ã‚¹ãƒˆãŒ0ã«ãªã‚Šã¾ã—ãŸã€‚
  - Target Group: {{targetgroup.name}}
  - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ(ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢)

Thresholds:
  critical: 0
  warning: 1

Tags:
  - layer:l2
  - resource:alb
  - severity:critical
```

#### L2-ECS-Task(ECS Taskç•°å¸¸åœæ­¢)

```yaml
Type: Event Monitor
Query: events("source:ecs status:error ecs.cluster-name:myapp-cluster").rollup("count").last("5m") > 0
Message: |
  [L2] ECS TaskãŒç•°å¸¸åœæ­¢ã—ã¾ã—ãŸã€‚
  - Cluster: myapp-cluster
  - å½±éŸ¿: è©²å½“ãƒ†ãƒŠãƒ³ãƒˆ

Thresholds:
  critical: 0

Tags:
  - layer:l2
  - resource:ecs
  - severity:high
```

#### FR-002-5: ALBâ†’APIâ†’RDS E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

```yaml
Type: Synthetic Monitoring (HTTP Check)
Request:
  Method: GET
  URL: https://{ALB_FQDN}/health

Assertions:
  - statusCode is 200
  - responseTime lessThan 5000 (ms)

Message: |
  [L2] ALBâ†’APIâ†’RDS E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚
  - URL: https://{ALB_FQDN}/health
  - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ(ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ã®å¯èƒ½æ€§)
  - ç¢ºèªå†…å®¹: ALB â†’ ECS â†’ RDS ç–é€š

Thresholds:
  critical: 3å›é€£ç¶šå¤±æ•—

Tags:
  - layer:l2
  - resource:e2e
  - severity:critical

Locations:
  - aws:ap-northeast-1

Frequency: 5åˆ†ã”ã¨
```

### 5.4 L3 Monitor è©³ç´°

#### FR-003-1: ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯(Synthetics Test)

```yaml
Type: Synthetic Monitoring (HTTP Check)
Request:
  Method: GET
  URL: https://{ALB_FQDN}/{tenant_id}/health

Assertions:
  - statusCode is 200
  - body contains "\"status\":\"ok\""
  - responseTime lessThan 2000 (ms)

Message: |
  [L3 Synthetics] ${var.tenant_id} ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯(E2Eç–é€šç¢ºèª)ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚
  - URL: ${var.health_check_url}
  - å½±éŸ¿: ${var.tenant_id} ã®ã¿
  - ç¢ºèªå†…å®¹: å¤–éƒ¨ã‹ã‚‰ã® ALB â†’ ECS â†’ RDS(tenant_id='${var.tenant_id}')ç–é€š

  å¯¾å¿œ: ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
  1. ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãŒæ­£å¸¸ã‹(ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é€šéã—ã¦ã„ã‚‹ã‹)
  2. ECS ã‚¿ã‚¹ã‚¯ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹
  3. ${var.tenant_id} ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒæ­£å¸¸ã‹
  4. /{tenant_id}/health ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£å¸¸ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã‹

Tags:
  - layer:l3
  - tenant:${var.tenant_id}
  - severity:high
  - type:synthetics

Locations:
  - aws:ap-northeast-1

Frequency: 1åˆ†ã”ã¨

Retry:
  count: 2
  interval: 5åˆ†
```

#### L3-APM-Error: APMã‚¨ãƒ©ãƒ¼æ•°ç›£è¦–

```yaml
Type: Metric Alert Monitor
Query: sum(last_5m):default_zero(sum:trace.fastapi.request.errors{service:demo-api}.as_count()) > 10
Message: |
  [L3 APM] ${var.tenant_id} ã§APMã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚
  - ã‚¨ãƒ©ãƒ¼æ•°: {{value}}
  - å½±éŸ¿: ${var.tenant_id}
  - ç¢ºèªå†…å®¹: APM ãƒˆãƒ¬ãƒ¼ã‚¹ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª

  â€» L1/L2 éšœå®³æ™‚ã¯ã“ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¯ Composite Monitor ã«ã‚ˆã‚ŠæŠ‘åˆ¶ã•ã‚Œã¾ã™ã€‚

Thresholds:
  critical: 10
  warning: 5

Tags:
  - layer:l3
  - tenant:${var.tenant_id}
  - severity:medium
  - type:apm

notify_no_data: false
```

#### L3-Log-Error: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç›£è¦–

```yaml
Type: Log Alert Monitor
Query: logs("status:error service:demo-api").rollup("count").last("5m") > 10
Message: |
  [L3 Log] ${var.tenant_id} ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒæ€¥å¢—ã—ã¦ã„ã¾ã™ã€‚
  - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ•°: {{value}}
  - å½±éŸ¿: ${var.tenant_id}
  - ç¢ºèªå†…å®¹: Log Explorer ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª

  â€» L1/L2 éšœå®³æ™‚ã¯ã“ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¯ Composite Monitor ã«ã‚ˆã‚ŠæŠ‘åˆ¶ã•ã‚Œã¾ã™ã€‚

Thresholds:
  critical: 10
  warning: 5

Tags:
  - layer:l3
  - tenant:${var.tenant_id}
  - severity:medium
  - type:log

notify_no_data: false
```

#### L3-Latency: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·(p99)

```yaml
Type: APM Monitor
Query: avg(last_5m):p99:trace.fastapi.request{service:demo-api} > 1000
Message: |
  [L3] ${var.tenant_id} ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·(p99)ãŒ1000msã‚’è¶…ãˆã¾ã—ãŸã€‚
  - Latency: {{value}}ms
  - å½±éŸ¿: ${var.tenant_id} ã®ã¿

Thresholds:
  critical: 1000
  warning: 500

Tags:
  - layer:l3
  - tenant:${var.tenant_id}
  - severity:medium

notify_no_data: false
```

## 6. Composite Monitor ã®è©³ç´°è¨­è¨ˆ

### 6.1 L0-Composite

```yaml
Type: Composite Monitor
Query: |
  L0-Agent

Message: |
  [L0 Composite] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŸºç›¤ã§éšœå®³ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
  - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ
  - å¯¾å¿œ: ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ ãŒèª¿æŸ»ä¸­

Tags:
  - layer:l0
  - composite:true
  - severity:critical

Notification:
  - Slack: #ops-alerts-critical
  - PagerDuty: ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ 
```

### 6.2 L1-Composite

```yaml
Type: Composite Monitor
Query: |
  (L1-RDS-CPU || L1-RDS-Conn || L1-RDS-Mem || L1-RDS-Storage)
  && NOT L0-Composite

Message: |
  [L1 Composite] ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆåŸºç›¤ã§éšœå®³ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
  - å½±éŸ¿: å…¨ãƒ†ãƒŠãƒ³ãƒˆ
  - å¯¾å¿œ: ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ ãŒèª¿æŸ»ä¸­

  æ³¨: L0éšœå®³ä¸­ã®å ´åˆã€ã“ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¯æŠ‘åˆ¶ã•ã‚Œã¾ã™ã€‚

Tags:
  - layer:l1
  - composite:true
  - severity:critical

Notification:
  - Slack: #ops-alerts-critical
  - PagerDuty: ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ 
```

### 6.3 L2-Composite

```yaml
Type: Composite Monitor
Query: |
  (L2-ALB-Health || L2-ECS-Task || L2-ECR-Vuln || FR-002-5)
  && NOT L0-Composite
  && NOT L1-Composite

Message: |
  [L2 Composite] ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§éšœå®³ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
  - å½±éŸ¿: è©²å½“ã‚µãƒ¼ãƒ“ã‚¹
  - å¯¾å¿œ: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ ãŒèª¿æŸ»ä¸­

  æ³¨: L0/L1éšœå®³ä¸­ã®å ´åˆã€ã“ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¯æŠ‘åˆ¶ã•ã‚Œã¾ã™ã€‚

Tags:
  - layer:l2
  - composite:true
  - severity:high

Notification:
  - Slack: #ops-alerts-high
  - Email: app-team@example.com
```

### 6.4 L3-Composite-tenant-a

```yaml
Type: Composite Monitor
Query: |
  (FR-003-1 || L3-APM-Error || L3-Log-Error || L3-Latency-tenant-a)
  && NOT L0-Composite
  && NOT L1-Composite
  && NOT L2-Composite

Message: |
  [L3 Composite] tenant-a ã§éšœå®³ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
  - å½±éŸ¿: tenant-a ã®ã¿
  - å¯¾å¿œ: é–‹ç™ºãƒãƒ¼ãƒ ãŒèª¿æŸ»ä¸­

  æ³¨: L0/L1/L2éšœå®³ä¸­ã®å ´åˆã€ã“ã®ã‚¢ãƒ©ãƒ¼ãƒˆã¯æŠ‘åˆ¶ã•ã‚Œã¾ã™ã€‚

Tags:
  - layer:l3
  - tenant:tenant-a
  - composite:true
  - severity:medium

Notification:
  - Slack: #tenant-a-alerts
  - Email: dev-team@example.com
```

## 7. ãƒ†ãƒŠãƒ³ãƒˆè¿½åŠ æ™‚ã®ç›£è¦–è¨­è¨ˆ

### 7.1 ãƒ†ãƒŠãƒ³ãƒˆè¿½åŠ ãƒ•ãƒ­ãƒ¼

```
1. tfvars ã«ãƒ†ãƒŠãƒ³ãƒˆè¿½åŠ 
   tenants = {
     tenant-a = { errors_threshold = 10, latency_threshold = 1000 }
     tenant-b = { errors_threshold = 10, latency_threshold = 1000 }  # è¿½åŠ 
   }

2. terraform plan(dry-run)
   - L3 Monitor(4å€‹)ãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   - L3 Composite Monitor(1å€‹)ãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

3. terraform apply
   - è‡ªå‹•çš„ã« tenant-b ç”¨ã® L3 Monitor ãŒä½œæˆã•ã‚Œã‚‹
   - è‡ªå‹•çš„ã« tenant-b ç”¨ã® L3 Composite Monitor ãŒä½œæˆã•ã‚Œã‚‹
```

### 7.2 ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã®é–¾å€¤ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

```hcl
# terraform/terraform.tfvars
tenants = {
  tenant-a = {
    errors_threshold  = 10  # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°é–¾å€¤
    latency_threshold = 1000  # ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·é–¾å€¤(ms)
  }
  tenant-b = {
    errors_threshold  = 20  # tenant-b ã¯é–¾å€¤ã‚’ç·©ãè¨­å®š
    latency_threshold = 1500
  }
  tenant-c = {
    errors_threshold  = 5  # tenant-c ã¯é–¾å€¤ã‚’å³ã—ãè¨­å®š
    latency_threshold = 500
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**: ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚‹SLA/é–¾å€¤ã‚’è¨­å®šå¯èƒ½ã€‚

## 8. ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥è¨­è¨ˆ

### 8.1 é€šçŸ¥å…ˆã®éšå±¤åŒ–

| éšå±¤ | é€šçŸ¥å…ˆ | å¯¾å¿œè€… | ç·Šæ€¥åº¦ |
|------|-------|-------|--------|
| L0 Composite | Slack: #ops-alerts-critical<br/>PagerDuty: ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ  | ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ (24/7) | Critical(å³åº§å¯¾å¿œ) |
| L1 Composite | Slack: #ops-alerts-critical<br/>PagerDuty: ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ  | ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ (24/7) | Critical(å³åº§å¯¾å¿œ) |
| L2 Composite | Slack: #ops-alerts-high<br/>Email: app-team@example.com | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒ  | High(1æ™‚é–“ä»¥å†…) |
| L3 Composite | Slack: #tenant-{tenant_id}-alerts<br/>Email: dev-team@example.com | é–‹ç™ºãƒãƒ¼ãƒ  | Medium(å–¶æ¥­æ™‚é–“å†…) |

### 8.2 é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

#### L0 Composite é€šçŸ¥ä¾‹

```
ğŸš¨ [CRITICAL] L0 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³

éšœå®³å†…å®¹: APMãƒˆãƒ¬ãƒ¼ã‚¹ãŒé€”çµ¶ãˆã¾ã—ãŸ
å½±éŸ¿ç¯„å›²: å…¨ãƒ†ãƒŠãƒ³ãƒˆ
å¯¾å¿œè€…: ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ 
å¯¾å¿œçŠ¶æ³: èª¿æŸ»ä¸­

è©³ç´°: https://app.datadoghq.com/monitors/12345
```

#### L3 Composite é€šçŸ¥ä¾‹

```
âš ï¸ [MEDIUM] L3 ãƒ†ãƒŠãƒ³ãƒˆéšœå®³

éšœå®³å†…å®¹: tenant-a ã®APMã‚¨ãƒ©ãƒ¼ãŒ5åˆ†é–“ã§10ä»¶ã‚’è¶…ãˆã¾ã—ãŸ
å½±éŸ¿ç¯„å›²: tenant-a ã®ã¿
å¯¾å¿œè€…: é–‹ç™ºãƒãƒ¼ãƒ 
å¯¾å¿œçŠ¶æ³: èª¿æŸ»ä¸­

è©³ç´°: https://app.datadoghq.com/monitors/67890
```

## 9. ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒæœŸé–“

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ä¿æŒæœŸé–“ | å‚™è€ƒ |
|---------|---------|------|
| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | 15ãƒ¶æœˆ | Datadog æ¨™æº–ãƒ—ãƒ©ãƒ³ |
| ãƒ­ã‚° | 15æ—¥é–“ | Datadog ãƒ­ã‚°ç®¡ç†ãƒ—ãƒ©ãƒ³(ã‚ªãƒ—ã‚·ãƒ§ãƒ³) |
| ãƒˆãƒ¬ãƒ¼ã‚¹ | 15æ—¥é–“ | Datadog APM ãƒ—ãƒ©ãƒ³(ã‚ªãƒ—ã‚·ãƒ§ãƒ³) |
| ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ | 90æ—¥é–“ | Datadog Audit Trail |

**æ³¨**: PoCã§ã¯ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ã®ä¿æŒæœŸé–“ã«å¾“ã„ã¾ã™ã€‚

## 10. ç›£è¦–è¨­è¨ˆã®æ¤œè¨¼æ–¹æ³•

### 10.1 PoCæ¤œè¨¼ã‚·ãƒŠãƒªã‚ª

| ã‚·ãƒŠãƒªã‚ª | æ“ä½œ | æœŸå¾…çµæœ |
|---------|------|---------|
| L0éšœå®³ãƒ†ã‚¹ãƒˆ | ECS Tasksã‚’æ‰‹å‹•åœæ­¢(`aws ecs update-service --desired-count 0`) | L0-Composite ã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆã€L1/L2/L3ã¯æŠ‘åˆ¶ |
| L1éšœå®³ãƒ†ã‚¹ãƒˆ | RDS CPUè² è·ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã§95%è¶…ã«è¨­å®š | L1-Composite ã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆã€L2/L3ã¯æŠ‘åˆ¶ |
| L2éšœå®³ãƒ†ã‚¹ãƒˆ(E2E) | `/health` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ„å›³çš„ã«å¤±æ•— | L2-Composite ã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆã€L3ã¯æŠ‘åˆ¶ |
| L2éšœå®³ãƒ†ã‚¹ãƒˆ(ECS) | ECS Taskã‚’æ‰‹å‹•åœæ­¢(`aws ecs stop-task`) | L2-Composite ã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆã€L3ã¯æŠ‘åˆ¶ |
| L3éšœå®³ãƒ†ã‚¹ãƒˆ | tenant-a ã®ã‚¢ãƒ—ãƒªã§æ„å›³çš„ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ | L3-Composite-tenant-a ã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆ |

### 10.2 æ¤œè¨¼æ‰‹é †(è©³ç´°ã¯è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã§å®šç¾©)

```bash
# L0éšœå®³ãƒ†ã‚¹ãƒˆ(ECS Taskså…¨åœæ­¢)
aws ecs update-service --cluster myapp-cluster --service demo-api --desired-count 0

# L1éšœå®³ãƒ†ã‚¹ãƒˆ(RDS CPUè² è·)
# â€»è©³ç´°æ‰‹é †ã¯åˆ¥é€”å®šç¾©(AWS CLI ã¾ãŸã¯æ‰‹å‹•æ“ä½œ)

# L2éšœå®³ãƒ†ã‚¹ãƒˆ(E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—)
curl -X POST https://myapp.example.com/admin/disable-health

# L2éšœå®³ãƒ†ã‚¹ãƒˆ(ECS Taskåœæ­¢)
aws ecs stop-task --cluster myapp-cluster --task <task-id>

# L3éšœå®³ãƒ†ã‚¹ãƒˆ(ã‚¢ãƒ—ãƒªã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ)
curl -X POST https://myapp.example.com/tenant-a/trigger-error
```

## 11. ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ—æ¤œè¨¼

### 11.1 ç›®çš„
APM Service Mapã«ã‚ˆã‚Šã€ALB â†’ ECS â†’ RDS ã®ä¾å­˜é–¢ä¿‚ã‚’å¯è¦–åŒ–ã—ã€éšœå®³æ™‚ã®å½±éŸ¿ç¯„å›²ã‚’æŠŠæ¡ã™ã‚‹ã€‚

### 11.2 å‰ææ¡ä»¶
- Unified Service Tagging(DD_SERVICE, DD_ENV, DD_VERSION)ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- APMãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨(DD_APM_ENABLED=true)
- Datadog Agent ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒECSã‚¿ã‚¹ã‚¯ã§ç¨¼åƒã—ã¦ã„ã‚‹ã“ã¨

### 11.3 æ¤œè¨¼é …ç›®

| é …ç›® | ç¢ºèªå ´æ‰€ | æœŸå¾…çµæœ |
|------|---------|---------|
| ã‚µãƒ¼ãƒ“ã‚¹è¡¨ç¤º | APM > Service Map | `demo-api` ãŒè¡¨ç¤ºã•ã‚Œã‚‹ |
| ä¾å­˜é–¢ä¿‚ | Service Map | `demo-api â†’ postgresql` ã®çŸ¢å°è¡¨ç¤º |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚° | APM > Service Catalog | `version:1.0.0` ä»˜ä¸ç¢ºèª |
| ãƒˆãƒ¬ãƒ¼ã‚¹è¿½è·¡ | APM > Traces | `/tenant-a/items` â†’ RDSã‚¯ã‚¨ãƒªã¾ã§è¿½è·¡å¯èƒ½ |
| ã‚¨ãƒ©ãƒ¼è¿½è·¡ | APM > Traces (status:error) | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç®‡æ‰€ãŒç‰¹å®šå¯èƒ½ |

### 11.4 æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ—ç¢ºèª**
1. Datadog > APM > Service Map ã‚’é–‹ã
2. `demo-api` ã‚µãƒ¼ãƒ“ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. `demo-api â†’ postgresql` ã®ä¾å­˜é–¢ä¿‚ãŒçŸ¢å°ã§è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

**ã‚¹ãƒ†ãƒƒãƒ—2: ãƒˆãƒ¬ãƒ¼ã‚¹è¿½è·¡ç¢ºèª**
```bash
# æ­£å¸¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
curl -X GET https://${ALB_DNS}/tenant-a/items

# Datadog > APM > Traces ã§ç¢ºèª
# ãƒ•ã‚£ãƒ«ã‚¿: service:demo-api
# æœŸå¾…: fastapi.request â†’ postgresql.query ã®ã‚¹ãƒ‘ãƒ³éšå±¤
```

**ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹ç¢ºèª**
```bash
# ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
curl -X POST https://${ALB_DNS}/tenant-a/simulate/error \
  -H "Content-Type: application/json" \
  -d '{"count": 1}'

# Datadog > APM > Traces ã§ç¢ºèª
# ãƒ•ã‚£ãƒ«ã‚¿: service:demo-api status:error
# æœŸå¾…: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç®‡æ‰€ã¨ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒç¢ºèªå¯èƒ½
```

## 12. æ§‹é€ åŒ–ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä»•æ§˜

### 12.1 æ¦‚è¦

L3ç›£è¦–(ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·)ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã¯æ§‹é€ åŒ–ãƒ­ã‚°(JSONå½¢å¼)ã§å‡ºåŠ›ã—ã¾ã™ã€‚

### 12.2 ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä»•æ§˜

**JSONå½¢å¼(æ¨å¥¨)**:

```json
{
  "timestamp": "2025-12-28T12:34:56.789Z",
  "level": "error",
  "message": "Database connection timeout",
  "tenant": "tenant-a",
  "service": "myapp",
  "trace_id": "abc123def456",
  "span_id": "789ghi012jkl",
  "error": {
    "type": "DatabaseError",
    "stack": "..."
  },
  "request": {
    "method": "GET",
    "path": "/api/users",
    "user_id": "user-123"
  }
}
```

### 12.3 å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ | ä¾‹ |
|---------|------|------|------|
| `timestamp` | ISO8601 | ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— | `2025-12-28T12:34:56.789Z` |
| `level` | string | ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«(`error`, `warn`, `info`, `debug`) | `error` |
| `message` | string | ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ | `Database connection timeout` |
| `tenant` | string | ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥å­(**L3ç›£è¦–ã§å¿…é ˆ**) | `tenant-a` |
| `service` | string | ã‚µãƒ¼ãƒ“ã‚¹å | `myapp` |

### 12.4 æ¨å¥¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ | ä¾‹ |
|---------|------|------|------|
| `trace_id` | string | Datadog APM ãƒˆãƒ¬ãƒ¼ã‚¹ID | `abc123def456` |
| `span_id` | string | Datadog APM ã‚¹ãƒ‘ãƒ³ID | `789ghi012jkl` |
| `error.type` | string | ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ— | `DatabaseError` |
| `error.stack` | string | ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ | `...` |
| `request.method` | string | HTTPãƒ¡ã‚½ãƒƒãƒ‰ | `GET` |
| `request.path` | string | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ã‚¹ | `/api/users` |

### 12.5 ãƒ­ã‚°å‡ºåŠ›å…ˆ

| ç’°å¢ƒ | å‡ºåŠ›å…ˆ | å‚™è€ƒ |
|------|--------|------|
| ECS Fargate | CloudWatch Logs | Datadog AgentãŒè‡ªå‹•åé›† |
| ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º | stdout | JSONå½¢å¼ã§å‡ºåŠ› |

### 12.6 Datadog ãƒ­ã‚°ãƒ‘ãƒ¼ã‚¹è¨­å®š

**Datadog UI ã§ã®è¨­å®š**(Logs â†’ Configuration â†’ Pipelines):

```yaml
# Pipeline: myapp-logs
Processor:
  - type: grok-parser
    name: Parse JSON logs
    source: message
    samples:
      - '{"timestamp":"2025-12-28T12:34:56.789Z","level":"error","message":"test","tenant":"tenant-a"}'
    grok:
      supportRules: ''
      matchRules: '%{data:json}'
  - type: json-parser
    name: Extract JSON fields
    source: json
```

**ã¾ãŸã¯ã€Terraform ã§è¨­å®š**:

```hcl
resource "datadog_logs_custom_pipeline" "myapp_logs" {
  name       = "myapp-logs"
  is_enabled = true

  filter {
    query = "service:myapp"
  }

  processor {
    json_parser {
      name    = "Extract JSON fields"
      sources = ["message"]
    }
  }
}
```

### 12.7 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆã¨ã®æ•´åˆæ€§

**å‚ç…§**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆæ›¸(å­˜åœ¨ã™ã‚‹å ´åˆ)ã¨æ§‹é€ åŒ–ãƒ­ã‚°ä»•æ§˜ã‚’æ•´åˆã•ã›ã¦ãã ã•ã„ã€‚

- ãƒ­ã‚®ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒª: ã‚¢ãƒ—ãƒªå´ã§é¸å®š(ä¾‹: Winston, Bunyan, structlogç­‰)
- ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥å­ã®æ³¨å…¥æ–¹æ³•: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è‡ªå‹•æ³¨å…¥
- Datadog APMçµ±åˆ: `trace_id`, `span_id` ã®è‡ªå‹•æ³¨å…¥

## 13. ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤æ¸¬å®šæ–¹æ³•

### 13.1 æ¸¬å®šæŒ‡æ¨™

| æŒ‡æ¨™ | æ¸¬å®šæ–¹æ³• | ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ |
|------|---------|------------|
| MTTD(Mean Time To Detect) | ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«ã€œæ¤œçŸ¥ã¾ã§ã®æ™‚é–“ | éšœå®³æ¤œçŸ¥ã®è¿…é€Ÿæ€§ |
| MTTR(Mean Time To Resolve) | ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«ã€œå¾©æ—§ã¾ã§ã®æ™‚é–“ | éšœå®³å¾©æ—§ã®è¿…é€Ÿæ€§ |
| ã‚¢ãƒ©ãƒ¼ãƒˆç²¾åº¦(Precision) | çœŸé™½æ€§ã‚¢ãƒ©ãƒ¼ãƒˆæ•° / å…¨ã‚¢ãƒ©ãƒ¼ãƒˆæ•° | ã‚¢ãƒ©ãƒ¼ãƒˆç–²åŠ´ã®å‰Šæ¸› |
| L0/L1/L2/L3 ã‚¢ãƒ©ãƒ¼ãƒˆæ¯”ç‡ | å„éšå±¤ã®ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç”Ÿé »åº¦ | æ ¹æœ¬åŸå› ã®å¯è¦–åŒ– |

### 13.2 Datadog Metrics ã§ã®è¨ˆæ¸¬

**Custom Metric é€ä¿¡**(Datadog Agent ã¾ãŸã¯ API):

```python
# Pythonä¾‹(Datadog API)
from datadog import statsd

# ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œé–‹å§‹
statsd.event(
    title="Alert Response Started",
    text="L0-Composite Alert",
    tags=["layer:l0", "phase:detection"]
)

# ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œå®Œäº†
statsd.event(
    title="Alert Resolved",
    text="L0-Composite Resolved",
    tags=["layer:l0", "phase:resolution"]
)

# MTTRè¨ˆç®—(Datadog UI ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹è¨ˆæ¸¬)
# Events â†’ MTTD/MTTR Dashboard
```

### 13.3 ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨­è¨ˆ

**Datadog Dashboard**(Terraform ã§ä½œæˆå¯èƒ½):

```hcl
resource "datadog_dashboard" "mttr_dashboard" {
  title       = "MTTD/MTTR Dashboard"
  description = "ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾å¿œæ™‚é–“ã®å¯è¦–åŒ–"
  layout_type = "ordered"

  widget {
    timeseries_definition {
      title = "MTTR(å¹³å‡å¾©æ—§æ™‚é–“)"
      request {
        q = "avg:alert.resolution.duration{*} by {layer}"
      }
    }
  }

  widget {
    query_value_definition {
      title = "ä»Šæœˆã®å¹³å‡MTTR"
      request {
        q          = "avg:alert.resolution.duration{*}"
        aggregator = "avg"
      }
    }
  }
}
```

**æ¸¬å®šæ–¹æ³•**:
1. ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«æ™‚ã« `detection` ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
2. å¾©æ—§æ™‚ã« `resolution` ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
3. Datadog Events APIã§ `resolution.duration` ã‚’è¨ˆç®—
4. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤ã‚’å¯è¦–åŒ–

## 14. ç›£è¦–æ•°ã®å¤‰æ›´

### ä¿®æ­£å‰ã®ç›£è¦–æ•°(3å±¤æ§‹æˆ)

| å±¤ | ç›£è¦–æ•° |
|-----|--------|
| L0 | 7å€‹ |
| L2 | 3å€‹ |
| L3(ãƒ†ãƒŠãƒ³ãƒˆã”ã¨) | 3å€‹ |

### ä¿®æ­£å¾Œã®ç›£è¦–æ•°(4å±¤æ§‹æˆ)

| å±¤ | ç›£è¦–æ•° |
|-----|--------|
| L0(ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯) | 1å€‹(APMãƒˆãƒ¬ãƒ¼ã‚¹ç–é€š) |
| L1(ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆ) | 4å€‹(RDSÃ—4) |
| L2(ã‚µãƒ¼ãƒ“ã‚¹) | 4å€‹(ALBÃ—1ã€ECS TaskÃ—1ã€ECRÃ—1ã€E2EÃ—1) |
| L3(ãƒ†ãƒŠãƒ³ãƒˆã”ã¨) | 4å€‹(SyntheticsÃ—1ã€APM ErrorÃ—1ã€Log ErrorÃ—1ã€LatencyÃ—1) |

**é‡è¦ãªå¤‰æ›´**:
- **L0**: `datadog.agent.up` ã‚µãƒ¼ãƒ“ã‚¹ãƒã‚§ãƒƒã‚¯ã‹ã‚‰ APMãƒˆãƒ¬ãƒ¼ã‚¹ç–é€šç›£è¦–ã«å¤‰æ›´(ECS Fargateåˆ¶é™ã®ãŸã‚)
- **L1**: ECS Tasksç›£è¦–ã‚’å‰Šé™¤(CloudWatché€£æºã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ä¸å¯ã®ãŸã‚)
- **L3**: Synthetics Testè¿½åŠ ã€APM Errorè¿½åŠ ã€Log Errorè¿½åŠ 

**å½±éŸ¿**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã®æ›´æ–°ãŒå¿…è¦ã€‚

## 15. é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | ãƒ‘ã‚¹ |
|-------------|------|
| ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³ | [01_ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³.md](01_ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³.md) |
| IaCæ§‹æˆæ–¹é‡ | [10_IaCæ–¹é‡.md](10_IaCæ–¹é‡.md) |
| è¦ä»¶å®šç¾©æ›¸ | ../../02_è¦ä»¶å®šç¾©/è¦ä»¶å®šç¾©æ›¸.md |

---

**ä½œæˆæ—¥**: 2025-12-28
**ä½œæˆè€…**: Infra-Architect
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.5
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Draft
**é‡è¦åº¦**: â˜…â˜…â˜…â˜…â˜…(æœ¬PoCã®æ ¸å¿ƒ)
**å¤‰æ›´å±¥æ­´**:
- 1.1 (2025-12-28): L2-ECS-Taskã‚¯ã‚¨ãƒªå…·ä½“åŒ–ã€L3-Healthãƒã‚§ãƒƒã‚¯å®Ÿè£…æ–¹æ³•æ˜ç¤ºã€æ§‹é€ åŒ–ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä»•æ§˜è¿½è¨˜ã€MTTRæ¸¬å®šæ–¹æ³•è¿½è¨˜
- 1.2 (2025-12-28): L1çœç•¥ã®ç†ç”±ã‚’æ˜è¨˜ã€FR-002-5(L2 E2Eãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯)è¿½åŠ ã€FR-003-1(L3ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯)å¼·åŒ–(RDSç–é€šå«ã‚€)
- 1.3 (2025-12-31): ç›£è¦–éšå±¤ã‚’3å±¤(L0/L2/L3)ã‹ã‚‰4å±¤(L0/L1/L2/L3)ã«å¤‰æ›´ã€L1ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆå±¤ã‚’è¿½åŠ ã€Composite Monitorè¦ªå­é–¢ä¿‚ã‚’æ›´æ–°ã€å…¨ã‚·ãƒŠãƒªã‚ªã‚’4å±¤å¯¾å¿œã«ä¿®æ­£
- 1.4 (2025-12-31): Â§11 ã‚µãƒ¼ãƒ“ã‚¹ãƒãƒƒãƒ—æ¤œè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã€Unified Service Taggingã«DD_VERSIONè¿½è¨˜
- 1.5 (2025-12-31): L3ç›£è¦–æ§‹æˆå¤‰æ›´ã‚’åæ˜ (Synthetics Testè¿½åŠ ã€APM Errorè¿½åŠ ã€Log Errorè¿½åŠ ã€Latencyå¤‰æ›´ãªã—)ã€L0ç›£è¦–ã‚’APMãƒˆãƒ¬ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ç›£è¦–ã«å¤‰æ›´(ECS Fargateåˆ¶é™å¯¾å¿œ)ã€L1-ECS-Tasksç„¡åŠ¹åŒ–(CloudWatché€£æºåˆ¶é™å¯¾å¿œ)ã€Â§14 ç›£è¦–æ•°ã®å¤‰æ›´ã‚’æ›´æ–°
